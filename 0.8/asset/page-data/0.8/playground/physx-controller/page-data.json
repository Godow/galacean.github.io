{"componentChunkName":"component---src-templates-playground-tsx","path":"/0.8/playground/physx-controller","result":{"pageContext":{"node":{"internal":{"content":"(function (global, factory) {\n  if (typeof define === \"function\" && define.amd) {\n    define([\"@oasis-engine-toolkit/controls\", \"oasis-engine\", \"@oasis-engine/physics-physx\"], factory);\n  } else if (typeof exports !== \"undefined\") {\n    factory(require(\"@oasis-engine-toolkit/controls\"), require(\"oasis-engine\"), require(\"@oasis-engine/physics-physx\"));\n  } else {\n    var mod = {\n      exports: {}\n    };\n    factory(global[\"@oasisEngineToolkit/controls\"], global.oasisEngine, global[\"@oasisEngine/physicsPhysx\"]);\n    global.index = mod.exports;\n  }\n})(typeof globalThis !== \"undefined\" ? globalThis : typeof self !== \"undefined\" ? self : this, function (_controls, _oasisEngine, _physicsPhysx) {\n  \"use strict\";\n\n  function _inheritsLoose(subClass, superClass) { subClass.prototype = Object.create(superClass.prototype); subClass.prototype.constructor = subClass; _setPrototypeOf(subClass, superClass); }\n\n  function _setPrototypeOf(o, p) { _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) { o.__proto__ = p; return o; }; return _setPrototypeOf(o, p); }\n\n  function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }\n\n  function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); Object.defineProperty(Constructor, \"prototype\", { writable: false }); return Constructor; }\n\n  _oasisEngine.Logger.enable();\n\n  var State;\n\n  (function (State) {\n    State[\"Run\"] = \"Run\";\n    State[\"Idle\"] = \"Idle\";\n    State[\"Jump\"] = \"Jump_In\";\n    State[\"Fall\"] = \"Fall\";\n    State[\"Landing\"] = \"Landing\";\n  })(State || (State = {}));\n\n  var AnimationState = /*#__PURE__*/function () {\n    function AnimationState() {\n      this._state = State.Idle;\n      this._lastKey = null;\n    }\n\n    var _proto = AnimationState.prototype;\n\n    _proto.setMoveKey = function setMoveKey(value) {\n      this._lastKey = value;\n\n      if (this._state === State.Fall || this._state === State.Jump) {\n        return;\n      }\n\n      if (this._lastKey === null && (this._state === State.Run || this._state === State.Idle)) {\n        this._state = State.Idle;\n      } else {\n        this._state = State.Run;\n      }\n    };\n\n    _proto.setJumpKey = function setJumpKey() {\n      this._state = State.Jump;\n    };\n\n    _proto.setFallKey = function setFallKey() {\n      this._state = State.Fall;\n    };\n\n    _proto.setIdleKey = function setIdleKey() {\n      if (this._state == State.Jump) {\n        return;\n      }\n\n      if (this._state === State.Fall) {\n        this._state = State.Landing;\n      }\n\n      if (this._state === State.Landing) {\n        this._state = State.Idle;\n      }\n    };\n\n    _createClass(AnimationState, [{\n      key: \"state\",\n      get: function get() {\n        return this._state;\n      }\n    }]);\n\n    return AnimationState;\n  }();\n\n  var ControllerScript = /*#__PURE__*/function (_Script) {\n    _inheritsLoose(ControllerScript, _Script);\n\n    function ControllerScript() {\n      var _this;\n\n      for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n        args[_key] = arguments[_key];\n      }\n\n      _this = _Script.call.apply(_Script, [this].concat(args)) || this;\n      _this._camera = void 0;\n      _this._character = void 0;\n      _this._controller = void 0;\n      _this._animator = void 0;\n      _this._displacement = new _oasisEngine.Vector3();\n      _this._forward = new _oasisEngine.Vector3();\n      _this._cross = new _oasisEngine.Vector3();\n      _this._lastKey = true;\n      _this._predictPosition = new _oasisEngine.Vector3();\n      _this._rotMat = new _oasisEngine.Matrix();\n      _this._rotation = new _oasisEngine.Quaternion();\n      _this._newRotation = new _oasisEngine.Quaternion();\n      _this._yAxisMove = new _oasisEngine.Vector3();\n      _this._up = new _oasisEngine.Vector3(0, 1, 0);\n      _this._animationState = new AnimationState();\n      _this._animationName = void 0;\n      _this._fallAccumulateTime = 0;\n      return _this;\n    }\n\n    var _proto2 = ControllerScript.prototype;\n\n    _proto2.onAwake = function onAwake() {\n      this._controller = this.entity.getComponent(_oasisEngine.CharacterController);\n    };\n\n    _proto2.targetCamera = function targetCamera(camera) {\n      this._camera = camera;\n    };\n\n    _proto2.targetCharacter = function targetCharacter(character) {\n      this._character = character;\n      this._animator = character.getComponent(_oasisEngine.Animator);\n    };\n\n    _proto2.onUpdate = function onUpdate(deltaTime) {\n      var inputManager = this.engine.inputManager;\n\n      if (inputManager.isKeyHeldDown()) {\n        this._camera.transform.getWorldForward(this._forward);\n\n        this._forward.y = 0;\n\n        this._forward.normalize();\n\n        this._cross.set(this._forward.z, 0, -this._forward.x);\n\n        var animationSpeed = 0.02;\n        var animationState = this._animationState;\n        var displacement = this._displacement;\n\n        if (inputManager.isKeyHeldDown(_oasisEngine.Keys.KeyW)) {\n          animationState.setMoveKey(_oasisEngine.Keys.KeyW);\n\n          _oasisEngine.Vector3.scale(this._forward, animationSpeed, displacement);\n        }\n\n        if (inputManager.isKeyHeldDown(_oasisEngine.Keys.KeyS)) {\n          animationState.setMoveKey(_oasisEngine.Keys.KeyS);\n\n          _oasisEngine.Vector3.scale(this._forward, -animationSpeed, displacement);\n        }\n\n        if (inputManager.isKeyHeldDown(_oasisEngine.Keys.KeyA)) {\n          animationState.setMoveKey(_oasisEngine.Keys.KeyA);\n\n          _oasisEngine.Vector3.scale(this._cross, animationSpeed, displacement);\n        }\n\n        if (inputManager.isKeyHeldDown(_oasisEngine.Keys.KeyD)) {\n          animationState.setMoveKey(_oasisEngine.Keys.KeyD);\n\n          _oasisEngine.Vector3.scale(this._cross, -animationSpeed, displacement);\n        }\n\n        if (inputManager.isKeyDown(_oasisEngine.Keys.Space)) {\n          animationState.setJumpKey();\n          displacement.set(0, 0.05, 0);\n        }\n      } else {\n        this._animationState.setMoveKey(null);\n\n        this._displacement.set(0, 0, 0);\n      }\n\n      this._playAnimation();\n    };\n\n    _proto2.onPhysicsUpdate = function onPhysicsUpdate() {\n      var physicsManager = this.engine.physicsManager;\n      var gravity = physicsManager.gravity;\n      var fixedTimeStep = physicsManager.fixedTimeStep;\n      this._fallAccumulateTime += fixedTimeStep;\n      var character = this._controller;\n      character.move(this._displacement, 0.0001, fixedTimeStep);\n      var transform = this._character.transform;\n      var yAxisMove = this._yAxisMove;\n      yAxisMove.set(0, gravity.y * fixedTimeStep * this._fallAccumulateTime, 0);\n      var flag = character.move(yAxisMove, 0.0001, fixedTimeStep);\n\n      if (flag & _oasisEngine.ControllerCollisionFlag.Down) {\n        this._fallAccumulateTime = 0;\n\n        this._animationState.setIdleKey();\n      } else {\n        this._animationState.setFallKey();\n      }\n\n      this._playAnimation();\n\n      if (this._displacement.x != 0 || this._displacement.z != 0) {\n        this._predictPosition.copyFrom(transform.worldPosition);\n\n        this._predictPosition.subtract(this._displacement);\n\n        _oasisEngine.Matrix.lookAt(transform.worldPosition, this._predictPosition, this._up, this._rotMat);\n\n        this._rotMat.getRotation(this._rotation).invert();\n\n        var currentRot = transform.rotationQuaternion;\n\n        _oasisEngine.Quaternion.slerp(currentRot, this._rotation, 0.1, this._newRotation);\n\n        transform.rotationQuaternion = this._newRotation;\n      }\n    };\n\n    _proto2._playAnimation = function _playAnimation() {\n      if (this._animationName !== this._animationState.state) {\n        this._animator.crossFade(this._animationState.state, 0.1);\n\n        this._animationName = this._animationState.state;\n      }\n    };\n\n    return ControllerScript;\n  }(_oasisEngine.Script);\n\n  function addPlane(rootEntity, size, position, rotation) {\n    var mtl = new _oasisEngine.PBRMaterial(rootEntity.engine);\n    mtl.baseColor.set(0.03179807202597362, 0.3939682161541871, 0.41177952549087604, 1);\n    mtl.renderFace = _oasisEngine.RenderFace.Double;\n    var planeEntity = rootEntity.createChild();\n    var renderer = planeEntity.addComponent(_oasisEngine.MeshRenderer);\n    renderer.mesh = _oasisEngine.PrimitiveMesh.createPlane(rootEntity.engine, size.x, size.y);\n    renderer.setMaterial(mtl);\n    planeEntity.transform.position = position;\n    planeEntity.transform.rotationQuaternion = rotation;\n    var physicsPlane = new _oasisEngine.PlaneColliderShape();\n    physicsPlane.isTrigger = false;\n    var planeCollider = planeEntity.addComponent(_oasisEngine.StaticCollider);\n    planeCollider.addShape(physicsPlane);\n    return planeEntity;\n  }\n\n  function addBox(rootEntity, size, position, rotation) {\n    var mtl = new _oasisEngine.PBRMaterial(rootEntity.engine);\n    mtl.roughness = 0;\n    mtl.baseColor.set(1, 1, 0, 1.0);\n    var boxEntity = rootEntity.createChild();\n    var renderer = boxEntity.addComponent(_oasisEngine.MeshRenderer);\n    renderer.mesh = _oasisEngine.PrimitiveMesh.createCuboid(rootEntity.engine, size.x, size.y, size.z);\n    renderer.setMaterial(mtl);\n    boxEntity.transform.position = position;\n    boxEntity.transform.rotationQuaternion = rotation;\n    var physicsBox = new _oasisEngine.BoxColliderShape();\n    physicsBox.size = size;\n    physicsBox.isTrigger = false;\n    var boxCollider = boxEntity.addComponent(_oasisEngine.StaticCollider);\n    boxCollider.addShape(physicsBox);\n    return boxEntity;\n  }\n\n  function addStair(rootEntity, size, position, rotation) {\n    var mtl = new _oasisEngine.PBRMaterial(rootEntity.engine);\n    mtl.roughness = 0.5;\n    mtl.baseColor.set(0.9, 0.9, 0.9, 1.0);\n\n    var mesh = _oasisEngine.PrimitiveMesh.createCuboid(rootEntity.engine, size.x, size.y, size.z);\n\n    var stairEntity = rootEntity.createChild();\n    stairEntity.transform.position = position;\n    stairEntity.transform.rotationQuaternion = rotation;\n    var boxCollider = stairEntity.addComponent(_oasisEngine.StaticCollider);\n    {\n      var level = stairEntity.createChild();\n      var renderer = level.addComponent(_oasisEngine.MeshRenderer);\n      renderer.mesh = mesh;\n      renderer.setMaterial(mtl);\n      var physicsBox = new _oasisEngine.BoxColliderShape();\n      physicsBox.size = size;\n      boxCollider.addShape(physicsBox);\n    }\n    {\n      var _level = stairEntity.createChild();\n\n      _level.transform.setPosition(0, 0.3, 0.5);\n\n      var _renderer = _level.addComponent(_oasisEngine.MeshRenderer);\n\n      _renderer.mesh = mesh;\n\n      _renderer.setMaterial(mtl);\n\n      var _physicsBox = new _oasisEngine.BoxColliderShape();\n\n      _physicsBox.size = size;\n\n      _physicsBox.setPosition(0, 0.3, 0.5);\n\n      boxCollider.addShape(_physicsBox);\n    }\n    {\n      var _level2 = stairEntity.createChild();\n\n      _level2.transform.setPosition(0, 0.6, 1);\n\n      var _renderer2 = _level2.addComponent(_oasisEngine.MeshRenderer);\n\n      _renderer2.mesh = mesh;\n\n      _renderer2.setMaterial(mtl);\n\n      var _physicsBox2 = new _oasisEngine.BoxColliderShape();\n\n      _physicsBox2.size = size;\n\n      _physicsBox2.setPosition(0, 0.6, 1);\n\n      boxCollider.addShape(_physicsBox2);\n    }\n    {\n      var _level3 = stairEntity.createChild();\n\n      _level3.transform.setPosition(0, 0.9, 1.5);\n\n      var _renderer3 = _level3.addComponent(_oasisEngine.MeshRenderer);\n\n      _renderer3.mesh = mesh;\n\n      _renderer3.setMaterial(mtl);\n\n      var _physicsBox3 = new _oasisEngine.BoxColliderShape();\n\n      _physicsBox3.size = size;\n\n      _physicsBox3.setPosition(0, 0.9, 1.5);\n\n      boxCollider.addShape(_physicsBox3);\n    }\n    return stairEntity;\n  }\n\n  function textureAndAnimationLoader(engine, materials, animator, animatorStateMachine) {\n    engine.resourceManager.load(\"https://gw.alipayobjects.com/zos/OasisHub/440001585/6990/T_Doggy_1_diffuse.png\").then(function (res) {\n      for (var i = 0, n = materials.length; i < n; i++) {\n        var material = materials[i];\n        material.baseTexture = res;\n      }\n    });\n    engine.resourceManager.load(\"https://gw.alipayobjects.com/zos/OasisHub/440001585/3072/T_Doggy_normal.png\").then(function (res) {\n      for (var i = 0, n = materials.length; i < n; i++) {\n        var material = materials[i];\n        material.normalTexture = res;\n      }\n    });\n    engine.resourceManager.load(\"https://gw.alipayobjects.com/zos/OasisHub/440001585/5917/T_Doggy_roughness.png\").then(function (res) {\n      for (var i = 0, n = materials.length; i < n; i++) {\n        var material = materials[i];\n        material.roughnessMetallicTexture = res;\n      }\n    });\n    engine.resourceManager.load(\"https://gw.alipayobjects.com/zos/OasisHub/440001585/2547/T_Doggy_1_ao.png\").then(function (res) {\n      for (var i = 0, n = materials.length; i < n; i++) {\n        var material = materials[i];\n        material.occlusionTexture = res;\n      }\n    });\n    engine.resourceManager.load(\"https://gw.alipayobjects.com/os/OasisHub/440001585/7205/Anim_Run.gltf\").then(function (res) {\n      var animations = res.animations;\n\n      if (animations) {\n        animations.forEach(function (clip) {\n          var animatorState = animatorStateMachine.addState(clip.name);\n          animatorState.clip = clip;\n        });\n      }\n    });\n    engine.resourceManager.load(\"https://gw.alipayobjects.com/os/OasisHub/440001585/3380/Anim_Idle.gltf\").then(function (res) {\n      var animations = res.animations;\n\n      if (animations) {\n        animations.forEach(function (clip) {\n          var animatorState = animatorStateMachine.addState(clip.name);\n          animatorState.clip = clip;\n        });\n        animator.play(State.Idle);\n        engine.run();\n      }\n    });\n    engine.resourceManager.load(\"https://gw.alipayobjects.com/os/OasisHub/440001585/5703/Anim_Landing.gltf\").then(function (res) {\n      var animations = res.animations;\n\n      if (animations) {\n        animations.forEach(function (clip) {\n          var animatorState = animatorStateMachine.addState(clip.name);\n          animatorState.clip = clip;\n        });\n      }\n    });\n    engine.resourceManager.load(\"https://gw.alipayobjects.com/os/OasisHub/440001585/3275/Anim_Fall.gltf\").then(function (res) {\n      var animations = res.animations;\n\n      if (animations) {\n        animations.forEach(function (clip) {\n          var animatorState = animatorStateMachine.addState(clip.name);\n          animatorState.clip = clip;\n        });\n      }\n    });\n    engine.resourceManager.load(\"https://gw.alipayobjects.com/os/OasisHub/440001585/2749/Anim_Jump_In.gltf\").then(function (res) {\n      var animations = res.animations;\n\n      if (animations) {\n        animations.forEach(function (clip) {\n          var animatorState = animatorStateMachine.addState(clip.name);\n          animatorState.clip = clip;\n        });\n      }\n    });\n  } //----------------------------------------------------------------------------------------------------------------------\n\n\n  _physicsPhysx.PhysXPhysics.initialize().then(function () {\n    var engine = new _oasisEngine.WebGLEngine(\"canvas\");\n    engine.physicsManager.initialize(_physicsPhysx.PhysXPhysics);\n    engine.canvas.width = window.innerWidth * _oasisEngine.SystemInfo.devicePixelRatio;\n    engine.canvas.height = window.innerHeight * _oasisEngine.SystemInfo.devicePixelRatio;\n    var scene = engine.sceneManager.activeScene;\n    var background = scene.background;\n    var rootEntity = scene.createRootEntity(); // camera\n\n    var cameraEntity = rootEntity.createChild(\"camera_node\");\n    cameraEntity.transform.position.set(4, 4, -4);\n    cameraEntity.addComponent(_oasisEngine.Camera);\n    cameraEntity.addComponent(_controls.OrbitControl);\n    var lightNode = rootEntity.createChild(\"light_node\");\n    lightNode.transform.setPosition(10, 10, 10);\n    lightNode.transform.lookAt(new _oasisEngine.Vector3(0, 0, 0));\n    lightNode.addComponent(_oasisEngine.DirectLight);\n    var entity = cameraEntity.createChild(\"text\");\n    entity.transform.position = new _oasisEngine.Vector3(0, 3.5, -10);\n    var renderer = entity.addComponent(_oasisEngine.TextRenderer);\n    renderer.color = new _oasisEngine.Color();\n    renderer.text = \"Use `WASD` to move character and `Space` to jump\";\n    renderer.font = _oasisEngine.Font.createFromOS(entity.engine, \"Arial\");\n    renderer.fontSize = 40; // Create sky\n\n    var sky = background.sky;\n    var skyMaterial = new _oasisEngine.SkyBoxMaterial(engine);\n    background.mode = _oasisEngine.BackgroundMode.Sky;\n    sky.material = skyMaterial;\n    sky.mesh = _oasisEngine.PrimitiveMesh.createCuboid(engine, 1, 1, 1);\n    addPlane(rootEntity, new _oasisEngine.Vector2(10, 6), new _oasisEngine.Vector3(), new _oasisEngine.Quaternion());\n    var slope = new _oasisEngine.Quaternion();\n\n    _oasisEngine.Quaternion.rotationEuler(45, 0, 0, slope);\n\n    addBox(rootEntity, new _oasisEngine.Vector3(4, 4, 0.01), new _oasisEngine.Vector3(0, 0, 1), slope.normalize());\n    addStair(rootEntity, new _oasisEngine.Vector3(1, 0.3, 0.5), new _oasisEngine.Vector3(3, 0, 1), new _oasisEngine.Quaternion());\n    engine.resourceManager.load({\n      type: _oasisEngine.AssetType.Env,\n      url: \"https://gw.alipayobjects.com/os/bmw-prod/09904c03-0d23-4834-aa73-64e11e2287b0.bin\"\n    }).then(function (ambientLight) {\n      scene.ambientLight = ambientLight;\n      skyMaterial.textureCubeMap = ambientLight.specularTexture;\n      skyMaterial.textureDecodeRGBM = true;\n    });\n    engine.resourceManager.load(\"https://gw.alipayobjects.com/os/OasisHub/440001585/5407/Doggy_Demo.gltf\").then(function (asset) {\n      var defaultSceneRoot = asset.defaultSceneRoot;\n      var controllerEntity = rootEntity.createChild(\"controller\");\n      controllerEntity.addChild(defaultSceneRoot); // animator\n\n      defaultSceneRoot.transform.setPosition(0, -0.35, 0);\n      var animator = defaultSceneRoot.addComponent(_oasisEngine.Animator);\n      var animatorController = new _oasisEngine.AnimatorController();\n      var layer = new _oasisEngine.AnimatorControllerLayer(\"layer\");\n      var animatorStateMachine = new _oasisEngine.AnimatorStateMachine();\n      animatorController.addLayer(layer);\n      animator.animatorController = animatorController;\n      layer.stateMachine = animatorStateMachine; // controller\n\n      var physicsCapsule = new _oasisEngine.CapsuleColliderShape();\n      physicsCapsule.radius = 0.15;\n      physicsCapsule.height = 0.2;\n      var characterController = controllerEntity.addComponent(_oasisEngine.CharacterController);\n      characterController.addShape(physicsCapsule);\n      var userController = controllerEntity.addComponent(ControllerScript);\n      userController.targetCamera(cameraEntity);\n      userController.targetCharacter(defaultSceneRoot);\n      textureAndAnimationLoader(engine, asset.materials, animator, animatorStateMachine);\n    });\n  });\n});"},"name":"physx-controller","id":"bd78ad2d-42ba-59c9-a5b8-6838519af019"}}},"staticQueryHashes":[]}