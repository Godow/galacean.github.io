(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{"2m7x":function(e,t,n){"use strict";n.r(t),n.d(t,"default",(function(){return p}));var a=n("HaE+"),r=n("KQm4"),o=n("o0o1"),i=n.n(o),s=n("ZAJm"),l=n("AFWD"),c=n("iJzs"),u=n("q1tI"),d=n.n(u),h=n("Ac47"),f=(n("Qr5y"),{sunset:"https://gw.alipayobjects.com/os/bmw-prod/09904c03-0d23-4834-aa73-64e11e2287b0.bin",pisa:"https://gw.alipayobjects.com/os/bmw-prod/871e960f-874f-4dc6-aa69-2e8fda8b5795.bin",park:"https://gw.alipayobjects.com/os/bmw-prod/c147a528-4394-4335-9431-f98df73602e6.bin",foot_2K:"https://gw.alipayobjects.com/os/bmw-prod/f0a011c2-ffba-4f70-866e-63974fff4ba9.bin"}),m=function(){function e(){var t=this;this.textures={},this.env={},this.engine=new c.WebGLEngine("canvas-gltf-viewer",{alpha:!0}),this.scene=this.engine.sceneManager.activeScene,this.skyMaterial=new c.SkyBoxMaterial(this.engine),this.rootEntity=this.scene.createRootEntity("root"),this.cameraEntity=this.rootEntity.createChild("camera"),this.gltfRootEntity=this.rootEntity.createChild("gltf"),this.lightEntity1=this.rootEntity.createChild("light1"),this.lightEntity2=this.rootEntity.createChild("light2"),this.camera=this.cameraEntity.addComponent(c.Camera),this.controler=this.cameraEntity.addComponent(l.OrbitControl),this.light1=this.lightEntity1.addComponent(c.DirectLight),this.light2=this.lightEntity2.addComponent(c.DirectLight),this.gui=new window.dat.GUI,this.materialFolder=null,this.animationFolder=null,this.sceneFolder=null,this.lightFolder=null,this.state={background:!0,env:"park",lights:!0,lightColor1:e.colorToGui(new c.Color(1,1,1)),lightColor2:e.colorToGui(new c.Color(1,1,1)),lightIntensity1:1,lightIntensity2:1},this._materials=[],this._boundingBox=new c.BoundingBox,this._center=new c.Vector3,this._extent=new c.Vector3,this.$spinner=document.getElementById("spinner"),this.$dropZone=document.getElementById("dropZone"),this.$input=document.getElementById("input");var n=this.gui.domElement.style;n.position="relative",n.top="68px",n.right="-12px",this.loadEnv(this.state.env).then((function(){t.initScene(),t.initDropZone(),t.addSceneGUI(),t.initDefaultDebugMesh()}))}e.guiToColor=function(e,t){t.setValue(e[0]/255,e[1]/255,e[2]/255,t.a)},e.colorToGui=function(e){void 0===e&&(e=new c.Color(1,1,1));var t=[];return t[0]=255*e.r,t[1]=255*e.g,t[2]=255*e.b,t};var t=e.prototype;return t.loadEnv=function(e){var t=this;return new Promise((function(n){t.engine.resourceManager.load({type:c.AssetType.Env,url:f[e]}).then((function(a){t.env[e]=a,t.scene.ambientLight=a,t.skyMaterial.textureCubeMap=a.specularTexture,t.skyMaterial.textureDecodeRGBM=!0,n(!0)}))}))},t.initScene=function(){var e=this;this.engine.canvas.resizeByClientSize(),this.controler.minDistance=0,this.state.background&&(this.scene.background.mode=c.BackgroundMode.Sky),this.state.lights||(this.light1.enabled=this.light2.enabled=!1),this.light1.intensity=this.state.lightIntensity1,this.light2.intensity=this.state.lightIntensity2,this.lightEntity1.transform.setRotation(-45,0,0),this.lightEntity2.transform.setRotation(-45,180,0),this.scene.background.solidColor=new c.Color(0,0,0,0),this.scene.background.sky.material=this.skyMaterial,this.scene.background.sky.mesh=c.PrimitiveMesh.createCuboid(this.engine,1,1,1),this.engine.run(),window.onresize=function(){e.engine.canvas.resizeByClientSize()}},t.addSceneGUI=function(){var t=this,n=this.gui;this.sceneFolder&&n.removeFolder(this.sceneFolder),this.sceneFolder&&n.removeFolder(this.lightFolder),this.sceneFolder=n.addFolder("Scene"),this.sceneFolder.add(this.state,"background").onChange((function(e){t.scene.background.mode=e?c.BackgroundMode.Sky:c.BackgroundMode.SolidColor})),this.lightFolder=n.addFolder("Lighting"),this.lightFolder.add(this.state,"env",Object(r.a)(Object.keys(f))).name("IBL").onChange((function(e){t.loadEnv(e)})),this.lightFolder.add(this.state,"lights").onChange((function(e){t.light1.enabled=t.light2.enabled=e})),this.lightFolder.addColor(this.state,"lightColor1").onChange((function(n){e.guiToColor(n,t.light1.color)})),this.lightFolder.addColor(this.state,"lightColor2").onChange((function(n){e.guiToColor(n,t.light2.color)})),this.lightFolder.add(this.state,"lightIntensity1",0,2).onChange((function(e){t.light1.intensity=e})),this.lightFolder.add(this.state,"lightIntensity2",0,2).onChange((function(e){t.light2.intensity=e})),this.sceneFolder.open(),this.lightFolder.open()},t.initDefaultDebugMesh=function(){var e=c.PrimitiveMesh.createSphere(this.engine,5,64),t=new c.PBRMaterial(this.engine);t.metallic=1,t.roughness=0,t.name="default";var n=this.gltfRootEntity.addComponent(c.MeshRenderer);n.mesh=e,n.setMaterial(t),this.addMaterialGUI([t]),this.setCenter([n])},t.setCenter=function(e){var t=this._boundingBox,n=this._center,a=this._extent;t.min.setValue(0,0,0),t.max.setValue(0,0,0),e.forEach((function(e){c.BoundingBox.merge(e.bounds,t,t)})),t.getExtent(a);var r=a.length();t.getCenter(n),this.controler.target.setValue(n.x,n.y,n.z),this.cameraEntity.transform.setPosition(n.x,n.y,3*r),this.camera.farClipPlane=12*r,this.camera.nearClipPlane=r/100,this.controler.maxDistance=10*r},t.initDropZone=function(){var e=this;new window.SimpleDropzone.SimpleDropzone(document.body,this.$input).on("drop",(function(t){var n=t.files;return e.loadFileMaps(n)}))},t.loadFileMaps=function(e){var t,n=this,a=/\.(gltf|glb)$/i,r=/\.(jpg|jpeg|png)$/i,o=/\.(hdr|hdri)$/i,i="gltf",s={},l=Array.from(e);if(l.some((function(e){var n=e[1];return!!a.test(n.name)&&(i=RegExp.$1,t=n,!0)})),l.forEach((function(e){var t=e[1];if(!a.test(t.name)){var i=URL.createObjectURL(t),l=t.name;s[l]=i,r.test(l)?n.addTexture(l,i):o.test(l)&&n.addEnv(l,i)}})),t){this.dropStart();var c=URL.createObjectURL(t);this.loadModel(c,s,i)}},t.loadModel=function(e,t,n){var a=this;this.destoryGLTF(),"gltf"===n.toLowerCase()?this.engine.resourceManager.load({type:c.AssetType.JSON,url:e}).then((function(e){e.buffers.concat(e.images).forEach((function(e){if(e){var n=e.uri;if(n){var a=n.lastIndexOf("/");a>-1&&(n=n.substr(a+1)),t[n]&&(e.uri=t[n])}}}));var n=new Blob([JSON.stringify(e)]),r=URL.createObjectURL(n);a.engine.resourceManager.load({type:c.AssetType.Prefab,url:r+"#.gltf"}).then((function(e){a.handleGltfResource(e)})).catch((function(){a.dropError()}))})):this.engine.resourceManager.load({type:c.AssetType.Prefab,url:e+"#.glb"}).then((function(e){a.handleGltfResource(e)})).catch((function(){a.dropError()}))},t.handleGltfResource=function(e){var t=e.defaultSceneRoot,n=e.materials,a=e.animations;console.log(e),this.dropSuccess(),this.gltfRootEntity=t,this.rootEntity.addChild(t);var r=[];t.getComponentsIncludeChildren(c.MeshRenderer,r),this.setCenter(r),this.addMaterialGUI(n),this.loadAnimationGUI(a)},t.addTexture=function(e,t){var n=this;Object.keys(this.textures).find((function(t){return t===e}))?console.warn(e+" 已经存在，请更换图片名字重新上传"):this.engine.resourceManager.load({type:c.AssetType.Texture2D,url:t}).then((function(t){n.textures[e]=t,n.addMaterialGUI(),console.log("图片上传成功！",e)}))},t.addEnv=function(){var e=Object(a.a)(i.a.mark((function e(t,n){var a,r,o,l,u,d;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.engine.resourceManager.load({url:n,type:"HDR-RGBE"});case 2:a=e.sent,r=s.IBLBaker.fromTextureCubeMap(a,s.DecodeMode.RGBE),o=new c.SphericalHarmonics3,s.SphericalHarmonics3Baker.fromTextureCubeMap(a,s.DecodeMode.RGBE,o),l=Object(s.toBuffer)(r,o),Object(s.downloadArrayBuffer)(l,t),u=new Blob([l],{type:"text/plain"}),d=URL.createObjectURL(u),this.state.env=t,f[t]=d,this.loadEnv(t),this.addSceneGUI(),this.addMaterialGUI();case 15:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}(),t.dropStart=function(){this.$dropZone.classList.add("hide"),this.$spinner.classList.remove("hide")},t.dropError=function(){this.$dropZone.classList.remove("hide"),this.$spinner.classList.add("hide")},t.dropSuccess=function(){this.$dropZone.classList.add("hide"),this.$spinner.classList.add("hide")},t.destoryGLTF=function(){this.gltfRootEntity.destroy()},t.addMaterialGUI=function(t){var n=this,a=this.gui;this.materialFolder&&(a.removeFolder(this.materialFolder),this.materialFolder=null);var o=t||this._materials;if(this._materials=o,o.length){var i=this.materialFolder=a.addFolder("Material"),s={};o.forEach((function(t){if(t instanceof c.PBRBaseMaterial||t instanceof c.UnlitMaterial){t.name||(t.name="default");var a={opacity:t.baseColor.a,baseColor:e.colorToGui(t.baseColor),emissiveColor:e.colorToGui(t.emissiveColor),specularColor:e.colorToGui(t.specularColor),baseTexture:t.baseTexture?"origin":"",roughnessMetallicTexture:t.roughnessMetallicTexture?"origin":"",normalTexture:t.normalTexture?"origin":"",emissiveTexture:t.emissiveTexture?"origin":"",occlusionTexture:t.occlusionTexture?"origin":"",specularGlossinessTexture:t.specularGlossinessTexture?"origin":""},o={baseTexture:t.baseTexture,roughnessMetallicTexture:t.roughnessMetallicTexture,normalTexture:t.normalTexture,emissiveTexture:t.emissiveTexture,occlusionTexture:t.occlusionTexture,specularGlossinessTexture:t.specularGlossinessTexture},l=i.addFolder(s[t.name]?t.name+"_"+(s[t.name]+1):t.name);if(s[t.name]=null==s[t.name]?1:s[t.name]+1,t instanceof c.PBRMaterial){var u=l.addFolder("Metallic-Roughness props");u.add(t,"metallic",0,1).step(.01),u.add(t,"roughness",0,1).step(.01),u.add(a,"roughnessMetallicTexture",["None","origin"].concat(Object(r.a)(Object.keys(n.textures)))).onChange((function(e){t.roughnessMetallicTexture="None"===e?null:n.textures[e]||o.roughnessMetallicTexture})),u.open()}else if(t instanceof c.PBRSpecularMaterial){var d=l.addFolder("Specular-Glossiness props");d.add(t,"glossiness",0,1).step(.01),d.addColor(a,"specularColor").onChange((function(n){e.guiToColor(n,t.specularColor)})),d.add(a,"specularGlossinessTexture",["None","origin"].concat(Object(r.a)(Object.keys(n.textures)))).onChange((function(e){t.specularGlossinessTexture="None"===e?null:n.textures[e]||o.specularGlossinessTexture})),d.open()}else t instanceof c.UnlitMaterial&&(l.add(a,"baseTexture",["None","origin"].concat(Object(r.a)(Object.keys(n.textures)))).onChange((function(e){t.baseTexture="None"===e?null:n.textures[e]||o.baseTexture})),l.addColor(a,"baseColor").onChange((function(n){e.guiToColor(n,t.baseColor)})));if(!(t instanceof c.UnlitMaterial)){var h=l.addFolder("Common props");h.add(a,"opacity",0,1).step(.01).onChange((function(e){t.baseColor.a=e})),h.add(t,"isTransparent"),h.add(t,"alphaCutoff",0,1).step(.01),h.addColor(a,"baseColor").onChange((function(n){e.guiToColor(n,t.baseColor)})),h.addColor(a,"emissiveColor").onChange((function(n){e.guiToColor(n,t.emissiveColor)})),h.add(a,"baseTexture",["None","origin"].concat(Object(r.a)(Object.keys(n.textures)))).onChange((function(e){t.baseTexture="None"===e?null:n.textures[e]||o.baseTexture})),h.add(a,"normalTexture",["None","origin"].concat(Object(r.a)(Object.keys(n.textures)))).onChange((function(e){t.normalTexture="None"===e?null:n.textures[e]||o.normalTexture})),h.add(a,"emissiveTexture",["None","origin"].concat(Object(r.a)(Object.keys(n.textures)))).onChange((function(e){t.emissiveTexture="None"===e?null:n.textures[e]||o.emissiveTexture})),h.add(a,"occlusionTexture",["None","origin"].concat(Object(r.a)(Object.keys(n.textures)))).onChange((function(e){t.occlusionTexture="None"===e?null:n.textures[e]||o.occlusionTexture})),h.open()}}})),i.open()}},t.loadAnimationGUI=function(e){if(this.animationFolder&&(this.gui.removeFolder(this.animationFolder),this.animationFolder=null),null!=e&&e.length){this.animationFolder=this.gui.addFolder("Animation"),this.animationFolder.open();var t=this.gltfRootEntity.getComponent(c.Animator);t.play(e[0].name);var n={animation:e[0].name};this.animationFolder.add(n,"animation",["None"].concat(Object(r.a)(e.map((function(e){return e.name}))))).onChange((function(e){"None"===e?t.speed=0:(t.speed=1,t.play(e))}))}},e}();function p(e){return Object(u.useEffect)((function(){var e,t=[{dom:null,url:"https://gw.alipayobjects.com/os/lib/dat.gui/0.7.7/build/dat.gui.min.js"},{dom:null,url:"https://gw.alipayobjects.com/os/lib/simple-dropzone/0.8.1/dist/simple-dropzone.umd.js"}];return Promise.all(t.map((function(e){return new Promise((function(t){var n=document.createElement("script");n.type="text/javascript",document.body.appendChild(n),n.onload=function(){t(void 0)},n.src=e.url,e.dom=n}))}))).then((function(){e=new m})),function(){t.forEach((function(e){document.body.removeChild(e.dom)})),e.gui.destroy(),e.engine.destroy()}})),d.a.createElement(d.a.Fragment,null,d.a.createElement(h.a,e,d.a.createElement("div",{className:"page-gltf-view"},d.a.createElement("canvas",{id:"canvas-gltf-viewer",style:{width:"100%",height:"calc(100vh - 64px)"}}),d.a.createElement("div",{id:"dropZone",className:"dropZone"},d.a.createElement("img",{className:"upload",src:"https://gw.alipayobjects.com/mdn/rms_7c464e/afts/img/A*-sHKTYv5U94AAAAAAAAAAAAAARQnAQ"}),d.a.createElement("input",{id:"input",type:"file",className:"input",multiple:!0}),d.a.createElement("p",null,"Drop your glTF2.0、images、HDRs here!")),d.a.createElement("div",{id:"spinner",className:"spinner hide"}),d.a.createElement("script",{type:"module",src:"./src/index.ts"}))))}},Qr5y:function(e,t,n){},ZAJm:function(e,t,n){n("j+VE"),n("PF2M"),n("IZzc"),function(e,t){"use strict";function n(e,t){return(n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var a,r,o=Math.PI;t.resourceLoader("HDR-RGBE",["hdr"])(((a=function(e){var a,r;function i(){return e.apply(this,arguments)||this}return r=e,(a=i).prototype=Object.create(r.prototype),a.prototype.constructor=a,n(a,r),i._convertToCubemap=function(e,t,n,a){if(!e)throw"ConvertPanoramaToCubemap: input cannot be null";if(e.length!=t*n*4)throw"ConvertPanoramaToCubemap: input size is wrong";return[this._createCubemapData(a,this._faceRight,e,t,n),this._createCubemapData(a,this._faceLeft,e,t,n),this._createCubemapData(a,this._faceUp,e,t,n),this._createCubemapData(a,this._faceBottom,e,t,n),this._createCubemapData(a,this._faceFront,e,t,n),this._createCubemapData(a,this._faceBack,e,t,n)]},i._createCubemapData=function(e,t,n,a,r){for(var o=new Uint8Array(e*e*4),i=this._tempVector3.setValue(0,0,0).add(t[1]).subtract(t[0]).scale(1/e),s=this._temp2Vector3.setValue(0,0,0).add(t[3]).subtract(t[2]).scale(1/e),l=1/e,c=0,u=0;u<e;u++){for(var d=this._temp3Vector3.setValue(0,0,0).add(t[0]),h=this._temp4Vector3.setValue(0,0,0).add(t[2]),f=0;f<e;f++){var m=this._temp5Vector3.setValue(0,0,0).add(h).subtract(d).scale(c).add(d);m.normalize();var p=this._calcProjectionSpherical(m,n,a,r),g=u*e*4+4*f;o[g]=p.r,o[g+1]=p.g,o[g+2]=p.b,o[g+3]=p.a,d.add(i),h.add(s)}c+=l}return o},i._calcProjectionSpherical=function(e,n,a,r){for(var i=Math.atan2(e.z,-e.x),s=Math.acos(e.y);i<-o;)i+=2*o;for(;i>o;)i-=2*o;var l=i/o,c=s/o;l=.5*l+.5;var u=Math.round(l*a);u<0?u=0:u>=a&&(u=a-1);var d=Math.round(c*r);d<0?d=0:d>=r&&(d=r-1);var h=(r-d-1)*a*4+4*u,f=n[h],m=n[h+1],p=n[h+2],g=n[h+3];return new t.Color(f,m,p,g)},i._readStringLine=function(e,t){for(var n="",a="",r=t;r<e.length-t&&"\n"!=(a=String.fromCharCode(e[r]));r++)n+=a;return n},i._parseHeader=function(e){var t,n,a=this._readStringLine(e,0);if("#"!=a[0]||"?"!=a[1])throw"Bad HDR Format.";var r=!1,o=!1,i=0;do{i+=a.length+1,"FORMAT=32-bit_rle_rgbe"==(a=this._readStringLine(e,i))?o=!0:0==a.length&&(r=!0)}while(!r);if(!o)throw"HDR Bad header format, unsupported FORMAT";i+=a.length+1,a=this._readStringLine(e,i);var s=/^\-Y (.*) \+X (.*)$/g.exec(a);if(!s||s.length<3)throw"HDR Bad header format, no size";if(n=parseInt(s[2]),t=parseInt(s[1]),n<8||n>32767)throw"HDR Bad header format, unsupported size";return{height:t,width:n,dataPosition:i+=a.length+1}},i._readPixels=function(e,t,n){for(var a=t,r=e.byteLength,o=new Uint8Array(4*t*n),i=0,s=0,l=4*a,c=new Uint8Array(4),u=new Uint8Array(l),d=n;d>0&&s<r;){if(c[0]=e[s++],c[1]=e[s++],c[2]=e[s++],c[3]=e[s++],2!=c[0]||2!=c[1]||(c[2]<<8|c[3])!=a)throw"HDR Bad header format, wrong scan line width";for(var h=0,f=void 0;h<l&&s<r;){var m=(f=e[s++])>128;if(m&&(f-=128),0===f||h+f>l)throw"HDR Bad Format, bad scanline data (run)";if(m)for(var p=e[s++],g=0;g<f;g++)u[h++]=p;else u.set(e.subarray(s,s+f),h),h+=f,s+=f}for(var v=a,b=0;b<v;b++){var C=0;o[i]=u[b+C],C+=a,o[i+1]=u[b+C],C+=a,o[i+2]=u[b+C],C+=a,o[i+3]=u[b+C],i+=4}d--}return o},i._RGBEToLinear=function(e){var t=Math.pow(2,e.a-128)/255;e.r*=t,e.g*=t,e.b*=t,e.a=1},i._linearToRGBM=function(e,t){var n=Math.max(e.r,Math.max(e.g,e.b)),a=Math.min(n/t,1),r=65025/((a=Math.ceil(255*a))*t);e.r*=r,e.g*=r,e.b*=r,e.a*=a},i.prototype.load=function(e,n){return new t.AssetPromise((function(a,r){var o=n.engine;n.load({url:e.url,type:t.AssetType.Buffer}).then((function(e){for(var n=new Uint8Array(e),r=i._parseHeader(n),s=r.width,l=r.height,c=r.dataPosition,u=i._readPixels(n.subarray(c),s,l),d=l>>1,h=i._convertToCubemap(u,s,l,d),f=new t.TextureCube(o,d),m=0;m<6;m++)f.setPixelBuffer(t.TextureCubeFace.PositiveX+m,h[m],0);f.generateMipmaps(),a(f)})).catch(r)}))},i}(t.Loader))._rightBottomBack=new t.Vector3(1,-1,-1),a._rightBottomFront=new t.Vector3(1,-1,1),a._rightUpBack=new t.Vector3(1,1,-1),a._rightUpFront=new t.Vector3(1,1,1),a._leftBottomBack=new t.Vector3(-1,-1,-1),a._leftBottomFront=new t.Vector3(-1,-1,1),a._leftUpBack=new t.Vector3(-1,1,-1),a._leftUpFront=new t.Vector3(-1,1,1),a._faceRight=[a._rightBottomBack,a._rightBottomFront,a._rightUpBack,a._rightUpFront],a._faceLeft=[a._leftBottomFront,a._leftBottomBack,a._leftUpFront,a._leftUpBack],a._faceUp=[a._leftBottomFront,a._rightBottomFront,a._leftBottomBack,a._rightBottomBack],a._faceBottom=[a._leftUpBack,a._rightUpBack,a._leftUpFront,a._rightUpFront],a._faceFront=[a._leftBottomBack,a._rightBottomBack,a._leftUpBack,a._rightUpBack],a._faceBack=[a._rightBottomFront,a._leftBottomFront,a._rightUpFront,a._leftUpFront],a._tempVector3=new t.Vector3,a._temp2Vector3=new t.Vector3,a._temp3Vector3=new t.Vector3,a._temp4Vector3=new t.Vector3,a._temp5Vector3=new t.Vector3,a)),e.DecodeMode=void 0,(r=e.DecodeMode||(e.DecodeMode={}))[r.Linear=0]="Linear",r[r.Gamma=1]="Gamma",r[r.RGBE=2]="RGBE",r[r.RGBM=3]="RGBM",t.Shader.create("Oasis-IBL-baker","\nattribute vec3 POSITION;\nattribute vec2 TEXCOORD_0;\n\nvarying vec2 v_uv;\n\nvoid main(){\n    gl_Position = vec4( POSITION.xzy , 1.0);\n    gl_Position.y *= -1.0;\n    v_uv = TEXCOORD_0;\n}\n",'\nvarying vec2 v_uv;\n\nuniform samplerCube environmentMap;\nuniform float face;\nuniform float lodRoughness;\nuniform float u_textureSize;\n\n#define PI 3.14159265359\n#define RECIPROCAL_PI 0.31830988618\n\nconst uint SAMPLE_COUNT = 4096u;\n\n\nfloat pow2( const in float x ) {\n    return x * x;\n}\n\nvec4 RGBEToLinear(vec4 value) {\n    return vec4( value.rgb * exp2( value.a * 255.0 - 128.0 ), 1.0 );\n}\n\nvec4 RGBMToLinear(vec4 value, float maxRange ) {\n    return vec4( value.rgb * value.a * maxRange, 1.0 );\n}\n\nvec4 gammaToLinear(vec4 srgbIn){\n    return vec4( pow(srgbIn.rgb, vec3(2.2)), srgbIn.a);\n}\n\n\nvec4 toLinear(vec4 color){\n    vec4 linear;\n    #if (DECODE_MODE == 0)\n        linear = color;\n    #elif (DECODE_MODE == 1)\n        linear = gammaToLinear(color);\n    #elif (DECODE_MODE == 2)\n        linear = RGBEToLinear(color);\n    #elif (DECODE_MODE == 3)\n        linear = RGBMToLinear(color, 5.0);\n    #endif\n\n    return linear;\n}\n\n\nvec4 linearToRGBE(vec4 value ) {\n\tfloat maxComponent = max( max( value.r, value.g ), value.b );\n\tfloat fExp = clamp( ceil( log2( maxComponent ) ), -128.0, 127.0 );\n\treturn vec4( value.rgb / exp2( fExp ), ( fExp + 128.0 ) / 255.0 );\n}\n\n\nvec4 LinearToRGBM(vec4 value, float maxRange ) {\n    float maxRGB = max( value.r, max( value.g, value.b ) );\n    float M = clamp( maxRGB / maxRange, 0.0, 1.0 );\n    M = ceil( M * 255.0 ) / 255.0;\n    return vec4( value.rgb / ( M * maxRange ), M );\n}\n\n// Microfacet Models for Refraction through Rough Surfaces - equation (33)\n// http://graphicrants.blogspot.com/2013/08/specular-brdf-reference.html\n// alpha is "roughness squared" in Disney’s reparameterization\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\n\tfloat a2 = pow2( alpha );\n\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0; // avoid alpha = 0 with dotNH = 1\n\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n\n}\n\n\n\n// https://learnopengl.com/PBR/IBL/Specular-IBL\n// Hammersley\nfloat radicalInverse_VdC(uint bits) \n{\n    bits = (bits << 16u) | (bits >> 16u);\n    bits = ((bits & 0x55555555u) << 1u) | ((bits & 0xAAAAAAAAu) >> 1u);\n    bits = ((bits & 0x33333333u) << 2u) | ((bits & 0xCCCCCCCCu) >> 2u);\n    bits = ((bits & 0x0F0F0F0Fu) << 4u) | ((bits & 0xF0F0F0F0u) >> 4u);\n    bits = ((bits & 0x00FF00FFu) << 8u) | ((bits & 0xFF00FF00u) >> 8u);\n    return float(bits) * 2.3283064365386963e-10; // / 0x100000000\n}\n\nvec2 hammersley(uint i, uint N)\n{\n    return vec2(float(i)/float(N), radicalInverse_VdC(i));\n}\n\n// WebGL1 fallback\nfloat VanDerCorpus(uint n, uint base)\n{\n    float invBase = 1.0 / float(base);\n    float denom   = 1.0;\n    float result  = 0.0;\n\n    for(uint i = 0u; i < 32u; ++i)\n    {\n        if(n > 0u)\n        {\n            denom   = mod(float(n), 2.0);\n            result += denom * invBase;\n            invBase = invBase / 2.0;\n            n       = uint(float(n) / 2.0);\n        }\n    }\n\n    return result;\n}\n// ----------------------------------------------------------------------------\nvec2 HammersleyNoBitOps(uint i, uint N)\n{\n    return vec2(float(i)/float(N), VanDerCorpus(i, 2u));\n}\n\n\nvec3 importanceSampleGGX(vec2 Xi, vec3 N, float roughness)\n{\n    float a = roughness * roughness;\n\n    float phi = 2.0 * PI * Xi.x;\n    float cosTheta = sqrt((1.0 - Xi.y) / (1.0 + (a*a - 1.0) * Xi.y));\n    float sinTheta = sqrt(1.0 - cosTheta*cosTheta);\n\n    // from spherical coordinates to cartesian coordinates\n    vec3 H;\n    H.x = cos(phi) * sinTheta;\n    H.y = sin(phi) * sinTheta;\n    H.z = cosTheta;\n\n    // from tangent-space vector to world-space sample vector\n    vec3 up        = abs(N.z) < 0.999 ? vec3(0.0, 0.0, 1.0) : vec3(1.0, 0.0, 0.0);\n    vec3 tangent   = normalize(cross(up, N));\n    vec3 bitangent = cross(N, tangent);\n\n    vec3 sampleVec = tangent * H.x + bitangent * H.y + N * H.z;\n    return normalize(sampleVec);\n}\n\n\nvec3 specular(vec3 N) {\n    vec3 R = N;\n    vec3 V = R;\n\n    float totalWeight = 0.0;   \n    vec3 prefilteredColor = vec3(0.0);     \n\n    for(uint i = 0u; i < SAMPLE_COUNT; ++i)\n    {\n        vec2 Xi = hammersley(i, SAMPLE_COUNT);\n        vec3 H  = importanceSampleGGX(Xi, N, lodRoughness);\n        vec3 L  = normalize(2.0 * dot(V, H) * H - V);\n\n        float NdotL = max(dot(N, L), 0.0);\n        \n        if(NdotL > 0.0)\n        {\n            float dotNH = dot(N,H);\n            float D   = D_GGX(lodRoughness, dotNH);\n            float pdf = (D * dotNH / (4.0 * dotNH)) + 0.0001; \n            float saTexel  = 4.0 * PI / (6.0 * u_textureSize * u_textureSize);\n            float saSample = 1.0 / (float(SAMPLE_COUNT) * pdf + 0.0001);\n            float mipLevel = lodRoughness == 0.0 ? 0.0 : 0.5 * log2(saSample / saTexel); \n            \n            vec4 samplerColor = textureCubeLodEXT(environmentMap, L, mipLevel);\n            vec3 linearColor = toLinear(samplerColor).rgb;\n\n            prefilteredColor += linearColor * NdotL;\n            totalWeight      += NdotL;\n        }\n    }\n    prefilteredColor = prefilteredColor / totalWeight;\n    return prefilteredColor;\n}\n\nvoid main() \n{\n    float cx = v_uv.x * 2. - 1.;\n    float cy = v_uv.y * 2. - 1.;\n\n    vec3 dir = vec3(0.);\n    if (face == 0.) { // PX\n        dir = vec3( 1.,  cy, -cx);\n    }\n    else if (face == 1.) { // NX\n        dir = vec3(-1.,  cy,  cx);\n    }\n    else if (face == 2.) { // PY\n        dir = vec3( cx,  1., -cy);\n    }\n    else if (face == 3.) { // NY\n        dir = vec3( cx, -1.,  cy);\n    }\n    else if (face == 4.) { // PZ\n        dir = vec3( cx,  cy,  1.);\n    }\n    else if (face == 5.) { // NZ\n        dir = vec3(-cx,  cy, -1.);\n    }\n    dir = normalize(dir);\n\n    if (lodRoughness == 0.) {\n        gl_FragColor = toLinear(textureCube(environmentMap, dir));\n    } else {\n        vec3 integratedBRDF = specular(dir);\n        gl_FragColor = vec4(integratedBRDF, 1.);\n    }\n    \n    gl_FragColor = LinearToRGBM(gl_FragColor, 5.0);\n\n}\n');var i=function(){function e(){}return e.fromTextureCubeMap=function(e,n){var a=e.engine,r=e.filterMode,o=a.sceneManager.activeScene,i=a.isPaused,s=e.width,l=e.mipmapCount;a.pause();var c=new t.Scene(a);a.sceneManager.activeScene=c;var u=c.createRootEntity("IBL Baker Entity"),d=u.addComponent(t.Camera);d.enableFrustumCulling=!1;var h=new t.Material(a,t.Shader.find("Oasis-IBL-baker")),f=u.addComponent(t.MeshRenderer),m=h.shaderData;f.mesh=t.PrimitiveMesh.createPlane(a,2,2),f.setMaterial(h);var p=new t.TextureCube(a,s);e.filterMode=t.TextureFilterMode.Trilinear,p.filterMode=t.TextureFilterMode.Trilinear;var g=new t.RenderTarget(a,s,s,p);g.autoGenerateMipmaps=!1,d.renderTarget=g,m.setTexture("environmentMap",e),m.setFloat("u_textureSize",s),m.enableMacro("DECODE_MODE",n+"");for(var v=0;v<6;v++)for(var b=0;b<l;b++){m.setFloat("face",v);var C=b/(l-1);m.setFloat("lodRoughness",C),d.render(t.TextureCubeFace.PositiveX+v,b)}return d.renderTarget=null,c.destroy(),g.destroy(),a.sceneManager.activeScene=o,e.filterMode=r,!i&&a.resume(),p},e}(),s=function(){function n(){}return n.fromTextureCubeMap=function(n,a,r){r.scale(0);for(var o=n.width,i=new Uint8Array(o*o*4),s=this._tempColor,l=this._tempVector,c=2/o,u=0,d=0;d<6;d++){n.getPixelBuffer(t.TextureCubeFace.PositiveX+d,0,0,o,o,0,i);for(var h=.5*c-1,f=0;f<o;f++){for(var m=.5*c-1,p=0;p<o;p++){var g=f*o*4+4*p;switch(a){case e.DecodeMode.Linear:s.setValue(i[g],i[g+1],i[g+2],0);break;case e.DecodeMode.Gamma:s.setValue(t.Color.gammaToLinearSpace(i[g]/255),t.Color.gammaToLinearSpace(i[g+1]/255),t.Color.gammaToLinearSpace(i[g+2]/255),0);break;case e.DecodeMode.RGBE:this._RGBEToLinear(i[g],i[g+1],i[g+2],i[g+3],s);break;case e.DecodeMode.RGBM:this._RGBMToLinear(i[g],i[g+1],i[g+2],i[g+3],s)}switch(d){case t.TextureCubeFace.PositiveX:l.setValue(1,-h,-m);break;case t.TextureCubeFace.NegativeX:l.setValue(-1,-h,m);break;case t.TextureCubeFace.PositiveY:l.setValue(m,1,h);break;case t.TextureCubeFace.NegativeY:l.setValue(m,-1,-h);break;case t.TextureCubeFace.PositiveZ:l.setValue(m,-h,1);break;case t.TextureCubeFace.NegativeZ:l.setValue(-m,-h,-1)}var v=4/(l.length()*l.lengthSquared());u+=v,r.addLight(l.normalize(),s,v),m+=c}h+=c}}r.scale(4*Math.PI/u)},n._RGBEToLinear=function(e,t,n,a,r){if(0===a)r.setValue(0,0,0,1);else{var o=Math.pow(2,a-128)/255;r.setValue(e*o,t*o,n*o,1)}},n._RGBMToLinear=function(e,t,n,a,r){var o=a/13005;r.setValue(e*o,t*o,n*o,1)},n}();s._tempColor=new t.Color,s._tempVector=new t.Vector3,e.IBLBaker=i,e.SphericalHarmonics3Baker=s,e.downloadArrayBuffer=function(e,t){var n=document.createElement("a");n.style.display="none",document.body.appendChild(n);var a=new Blob([e],{type:"text/plain"}),r=URL.createObjectURL(a);n.href=r,n.href=URL.createObjectURL(a),n.download=t+".env",n.click(),URL.revokeObjectURL(n.href),document.body.removeChild(n)},e.toBuffer=function(e,n){var a=e.width,r=e.mipmapCount,o=new Float32Array(27);n.toArray(o);for(var i=[],s=0,l=0;l<r;l++)for(var c=a>>l,u=0;u<6;u++){var d=c*c*4,h=new Uint8Array(d);e.getPixelBuffer(t.TextureCubeFace.PositiveX+u,0,0,c,c,l,h),i.push(h),s+=d}for(var f=new ArrayBuffer(110+s),m=new DataView(f,0,108),p=new DataView(f,108),g=0;g<27;g++)m.setFloat32(4*g,o[g],!0);p.setUint16(0,a,!0);for(var v=2,b=0;b<i.length;b++)for(var C=i[b],x=0,y=C.length;x<y;x++)p.setUint8(v++,C[x]);return f},Object.defineProperty(e,"__esModule",{value:!0})}(t,n("iJzs"))}}]);