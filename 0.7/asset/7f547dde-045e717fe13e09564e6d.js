(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{iJzs:function(e,t,r){r("j+VE"),r("PF2M"),r("IZzc"),r("E9XD"),r("ToJy"),r("p532"),function(e){"use strict";var t,r;function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function i(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}e.ContainmentType=void 0,(t=e.ContainmentType||(e.ContainmentType={}))[t.Disjoint=0]="Disjoint",t[t.Contains=1]="Contains",t[t.Intersects=2]="Intersects",e.PlaneIntersectionType=void 0,(r=e.PlaneIntersectionType||(e.PlaneIntersectionType={}))[r.Back=0]="Back",r[r.Front=1]="Front",r[r.Intersecting=2]="Intersecting";var a=function(){function e(){}return e.clamp=function(e,t,r){return Math.max(t,Math.min(r,e))},e.equals=function(t,r){return Math.abs(t-r)<=e.zeroTolerance},e.isPowerOf2=function(e){return 0==(e&e-1)},e.radianToDegree=function(t){return t*e.radToDegreeFactor},e.degreeToRadian=function(t){return t*e.degreeToRadFactor},e}();a.zeroTolerance=1e-6,a.radToDegreeFactor=180/Math.PI,a.degreeToRadFactor=Math.PI/180;var o=function(){function e(e,t,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),this._x=void 0,this._y=void 0,this._z=void 0,this._onValueChanged=null,this._x=e,this._y=t,this._z=r}e.add=function(e,t,r){r._x=e._x+t._x,r._y=e._y+t._y,r._z=e._z+t._z,r._onValueChanged&&r._onValueChanged()},e.subtract=function(e,t,r){r._x=e._x-t._x,r._y=e._y-t._y,r._z=e._z-t._z,r._onValueChanged&&r._onValueChanged()},e.multiply=function(e,t,r){r._x=e._x*t._x,r._y=e._y*t._y,r._z=e._z*t._z,r._onValueChanged&&r._onValueChanged()},e.divide=function(e,t,r){r._x=e._x/t._x,r._y=e._y/t._y,r._z=e._z/t._z,r._onValueChanged&&r._onValueChanged()},e.dot=function(e,t){return e._x*t._x+e._y*t._y+e._z*t._z},e.cross=function(e,t,r){var n=e._x,i=e._y,a=e._z,o=t._x,s=t._y,l=t._z;r.setValue(i*l-a*s,a*o-n*l,n*s-i*o)},e.distance=function(e,t){var r=t._x-e._x,n=t._y-e._y,i=t._z-e._z;return Math.sqrt(r*r+n*n+i*i)},e.distanceSquared=function(e,t){var r=t._x-e._x,n=t._y-e._y,i=t._z-e._z;return r*r+n*n+i*i},e.equals=function(e,t){return a.equals(e._x,t._x)&&a.equals(e._y,t._y)&&a.equals(e._z,t._z)},e.lerp=function(e,t,r,n){var i=e._x,a=e._y,o=e._z;n._x=i+(t._x-i)*r,n._y=a+(t._y-a)*r,n._z=o+(t._z-o)*r,n._onValueChanged&&n._onValueChanged()},e.max=function(e,t,r){r._x=Math.max(e._x,t._x),r._y=Math.max(e._y,t._y),r._z=Math.max(e._z,t._z),r._onValueChanged&&r._onValueChanged()},e.min=function(e,t,r){r._x=Math.min(e._x,t._x),r._y=Math.min(e._y,t._y),r._z=Math.min(e._z,t._z),r._onValueChanged&&r._onValueChanged()},e.negate=function(e,t){t._x=-e._x,t._y=-e._y,t._z=-e._z,t._onValueChanged&&t._onValueChanged()},e.normalize=function(e,t){var r=e._x,n=e._y,i=e._z,o=Math.sqrt(r*r+n*n+i*i);o>a.zeroTolerance&&(o=1/o,t.setValue(r*o,n*o,i*o))},e.scale=function(e,t,r){r._x=e._x*t,r._y=e._y*t,r._z=e._z*t,r._onValueChanged&&r._onValueChanged()},e.transformNormal=function(e,t,r){var n=e._x,i=e._y,a=e._z,o=t.elements;r._x=n*o[0]+i*o[4]+a*o[8],r._y=n*o[1]+i*o[5]+a*o[9],r._z=n*o[2]+i*o[6]+a*o[10],r._onValueChanged&&r._onValueChanged()},e.transformToVec3=function(e,t,r){var n=e._x,i=e._y,a=e._z,o=t.elements;r._x=n*o[0]+i*o[4]+a*o[8]+o[12],r._y=n*o[1]+i*o[5]+a*o[9]+o[13],r._z=n*o[2]+i*o[6]+a*o[10]+o[14],r._onValueChanged&&r._onValueChanged()},e.transformToVec4=function(e,t,r){var n=e._x,i=e._y,a=e._z,o=t.elements;r._x=n*o[0]+i*o[4]+a*o[8]+o[12],r._y=n*o[1]+i*o[5]+a*o[9]+o[13],r._z=n*o[2]+i*o[6]+a*o[10]+o[14],r._w=n*o[3]+i*o[7]+a*o[11]+o[15],r._onValueChanged&&r._onValueChanged()},e.transformCoordinate=function(e,t,r){var n=e._x,i=e._y,a=e._z,o=t.elements,s=n*o[3]+i*o[7]+a*o[11]+o[15];s=1/s,r._x=(n*o[0]+i*o[4]+a*o[8]+o[12])*s,r._y=(n*o[1]+i*o[5]+a*o[9]+o[13])*s,r._z=(n*o[2]+i*o[6]+a*o[10]+o[14])*s,r._onValueChanged&&r._onValueChanged()},e.transformByQuat=function(e,t,r){var n=e._x,i=e._y,a=e._z,o=t._x,s=t._y,l=t._z,u=t._w,c=u*n+s*a-l*i,h=u*i+l*n-o*a,d=u*a+o*i-s*n,_=-o*n-s*i-l*a;r._x=c*u-_*o-h*l+d*s,r._y=h*u-_*s-d*o+c*l,r._z=d*u-_*l-c*s+h*o,r._onValueChanged&&r._onValueChanged()};var t=e.prototype;return t.setValue=function(e,t,r){return this._x=e,this._y=t,this._z=r,this._onValueChanged&&this._onValueChanged(),this},t.setValueByArray=function(e,t){return void 0===t&&(t=0),this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._onValueChanged&&this._onValueChanged(),this},t.add=function(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._onValueChanged&&this._onValueChanged(),this},t.subtract=function(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._onValueChanged&&this._onValueChanged(),this},t.multiply=function(e){return this._x*=e._x,this._y*=e._y,this._z*=e._z,this._onValueChanged&&this._onValueChanged(),this},t.divide=function(e){return this._x/=e._x,this._y/=e._y,this._z/=e._z,this._onValueChanged&&this._onValueChanged(),this},t.length=function(){var e=this._x,t=this._y,r=this._z;return Math.sqrt(e*e+t*t+r*r)},t.lengthSquared=function(){var e=this._x,t=this._y,r=this._z;return e*e+t*t+r*r},t.negate=function(){return this._x=-this._x,this._y=-this._y,this._z=-this._z,this._onValueChanged&&this._onValueChanged(),this},t.normalize=function(){return e.normalize(this,this),this},t.scale=function(e){return this._x*=e,this._y*=e,this._z*=e,this._onValueChanged&&this._onValueChanged(),this},t.toArray=function(e,t){void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z},t.clone=function(){return new e(this._x,this._y,this._z)},t.cloneTo=function(e){return e._x=this._x,e._y=this._y,e._z=this._z,e._onValueChanged&&e._onValueChanged(),e},t.transformNormal=function(t){return e.transformNormal(this,t,this),this},t.transformToVec3=function(t){return e.transformToVec3(this,t,this),this},t.transformCoordinate=function(t){return e.transformCoordinate(this,t,this),this},t.transformByQuat=function(t){return e.transformByQuat(this,t,this),this},i(e,[{key:"x",get:function(){return this._x},set:function(e){this._x=e,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(e){this._y=e,this._onValueChanged&&this._onValueChanged()}},{key:"z",get:function(){return this._z},set:function(e){this._z=e,this._onValueChanged&&this._onValueChanged()}}]),e}();o._zero=new o(0,0,0),o._one=new o(1,1,1);var s=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=0),this.center=new o,this.radius=0,e&&e.cloneTo(this.center),this.radius=t}e.fromPoints=function(t,r){if(!t||0===t.length)throw new Error("points must be array and length must > 0");var n=t.length,i=e._tempVec30;i.x=i.y=i.z=0;for(var a=0;a<n;++a)o.add(t[a],i,i);o.scale(i,1/n,r.center);for(var s=0,l=0;l<n;++l){var u=o.distanceSquared(i,t[l]);u>s&&(s=u)}r.radius=Math.sqrt(s)},e.fromBox=function(e,t){var r=t.center,n=e.min,i=e.max;r.x=.5*(n.x+i.x),r.y=.5*(n.y+i.y),r.z=.5*(n.z+i.z),t.radius=o.distance(r,i)};var t=e.prototype;return t.clone=function(){return new e(this.center,this.radius)},t.cloneTo=function(e){return this.center.cloneTo(e.center),e.radius=this.radius,e},e}();s._tempVec30=new o;var l=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=null),this.min=new o,this.max=new o,e&&e.cloneTo(this.min),t&&t.cloneTo(this.max)}e.fromCenterAndExtent=function(e,t,r){o.subtract(e,t,r.min),o.add(e,t,r.max)},e.fromPoints=function(e,t){if(!e||0===e.length)throw new Error("points must be array and length must > 0");var r=t.min,n=t.max;r.x=r.y=r.z=Number.MAX_VALUE,n.x=n.y=n.z=-Number.MAX_VALUE;for(var i=0,a=e.length;i<a;++i){var s=e[i];o.min(r,s,r),o.max(n,s,n)}},e.fromSphere=function(e,t){var r=e.center,n=e.radius,i=t.min,a=t.max;i.x=r.x-n,i.y=r.y-n,i.z=r.z-n,a.x=r.x+n,a.y=r.y+n,a.z=r.z+n},e.transform=function(t,r,n){var i=e._tempVec30,a=e._tempVec31;t.getCenter(i),t.getExtent(a),o.transformCoordinate(i,r,i);var s=a.x,l=a.y,u=a.z,c=r.elements;a.x=Math.abs(s*c[0])+Math.abs(l*c[4])+Math.abs(u*c[8]),a.y=Math.abs(s*c[1])+Math.abs(l*c[5])+Math.abs(u*c[9]),a.z=Math.abs(s*c[2])+Math.abs(l*c[6])+Math.abs(u*c[10]),o.subtract(i,a,n.min),o.add(i,a,n.max)},e.merge=function(e,t,r){return o.min(e.min,t.min,r.min),o.max(e.max,t.max,r.max),r};var t=e.prototype;return t.clone=function(){return new e(this.min,this.max)},t.cloneTo=function(e){return this.min.cloneTo(e.min),this.max.cloneTo(e.max),e},t.getCenter=function(e){return o.add(this.min,this.max,e),o.scale(e,.5,e),e},t.getExtent=function(e){return o.subtract(this.max,this.min,e),o.scale(e,.5,e),e},t.getCorners=function(e){void 0===e&&(e=[]);var t=this.min,r=this.max,n=t.x,i=t.y,a=t.z,s=r.x,l=r.y,u=r.z,c=e.length;if(c<8)for(var h=0,d=8-c;h<d;++h)e[c+h]=new o;return e[0].setValue(n,l,u),e[1].setValue(s,l,u),e[2].setValue(s,i,u),e[3].setValue(n,i,u),e[4].setValue(n,l,a),e[5].setValue(s,l,a),e[6].setValue(s,i,a),e[7].setValue(n,i,a),e},t.transform=function(t){return e.transform(this,t,this),this},e}();l._tempVec30=new o,l._tempVec31=new o;var u=function(){function t(){}return t.distancePlaneAndPoint=function(e,t){return o.dot(e.normal,t)+e.distance},t.intersectsPlaneAndPoint=function(r,n){var i=t.distancePlaneAndPoint(r,n);return i>0?e.PlaneIntersectionType.Front:i<0?e.PlaneIntersectionType.Back:e.PlaneIntersectionType.Intersecting},t.intersectsPlaneAndBox=function(r,n){var i=n.min,a=n.max,o=r.normal,s=t._tempVec30,l=t._tempVec31;return o.x>=0?(s.x=a.x,l.x=i.x):(s.x=i.x,l.x=a.x),o.y>=0?(s.y=a.y,l.y=i.y):(s.y=i.y,l.y=a.y),o.z>=0?(s.z=a.z,l.z=i.z):(s.z=i.z,l.z=a.z),t.distancePlaneAndPoint(r,s)<0?e.PlaneIntersectionType.Back:t.distancePlaneAndPoint(r,l)>0?e.PlaneIntersectionType.Front:e.PlaneIntersectionType.Intersecting},t.intersectsPlaneAndSphere=function(r,n){var i=n.center,a=n.radius,o=t.distancePlaneAndPoint(r,i);return o>a?e.PlaneIntersectionType.Front:o<-a?e.PlaneIntersectionType.Back:e.PlaneIntersectionType.Intersecting},t.intersectsRayAndPlane=function(e,t){var r=t.normal,n=a.zeroTolerance,i=o.dot(r,e.direction);if(Math.abs(i)<n)return-1;var s=o.dot(r,e.origin),l=(-t.distance-s)/i;if(l<0){if(l<-n)return-1;l=0}return l},t.intersectsRayAndBox=function(e,t){var r=a.zeroTolerance,n=e.origin,i=e.direction,o=t.min,s=t.max,l=i.x,u=i.y,c=i.z,h=n.x,d=n.y,_=n.z,f=0,p=Number.MAX_VALUE;if(Math.abs(l)<r){if(h<o.x||h>s.x)return-1}else{var g=1/l,v=(o.x-h)*g,m=(s.x-h)*g;if(v>m){var y=v;v=m,m=y}if((f=Math.max(v,f))>(p=Math.min(m,p)))return-1}if(Math.abs(u)<r){if(d<o.y||d>s.y)return-1}else{var x=1/u,T=(o.y-d)*x,w=(s.y-d)*x;if(T>w){var b=T;T=w,w=b}if((f=Math.max(T,f))>(p=Math.min(w,p)))return-1}if(Math.abs(c)<r){if(_<o.z||_>s.z)return-1}else{var C=1/c,S=(o.z-_)*C,M=(s.z-_)*C;if(S>M){var A=S;S=M,M=A}if((f=Math.max(S,f))>(p=Math.min(M,p)))return-1}return f},t.intersectsRayAndSphere=function(e,r){var n=e.origin,i=e.direction,a=r.center,s=r.radius,l=t._tempVec30;o.subtract(n,a,l);var u=o.dot(l,i),c=o.dot(l,l)-s*s;if(u>0&&c>0)return-1;var h=u*u-c;if(h<0)return-1;var d=-u-Math.sqrt(h);return d<0&&(d=0),d},t.intersectsBoxAndBox=function(e,t){return!(e.min.x>t.max.x||t.min.x>e.max.x||e.min.y>t.max.y||t.min.y>e.max.y||e.min.z>t.max.z||t.min.z>e.max.z)},t.intersectsSphereAndSphere=function(e,t){var r=e.radius+t.radius;return o.distanceSquared(e.center,t.center)<r*r},t.intersectsSphereAndBox=function(e,r){var n=e.center,i=r.max,a=r.min,s=t._tempVec30;return s.setValue(Math.max(a.x,Math.min(n.x,i.x)),Math.max(a.y,Math.min(n.y,i.y)),Math.max(a.z,Math.min(n.z,i.z))),o.distanceSquared(n,s)<=e.radius*e.radius},t.intersectsFrustumAndBox=function(e,r){for(var n=r.min,i=r.max,a=t._tempVec30,s=0;s<6;++s){var l=e.getPlane(s),u=l.normal;if(a.setValue(u.x>=0?n.x:i.x,u.y>=0?n.y:i.y,u.z>=0?n.z:i.z),o.dot(l.normal,a)>-l.distance)return!1}return!0},t.frustumContainsBox=function(r,n){for(var i=n.min,a=n.max,o=t._tempVec30,s=t._tempVec31,l=e.ContainmentType.Contains,u=0;u<6;++u){var c=r.getPlane(u),h=c.normal;if(h.x>=0?(o.x=a.x,s.x=i.x):(o.x=i.x,s.x=a.x),h.y>=0?(o.y=a.y,s.y=i.y):(o.y=i.y,s.y=a.y),h.z>=0?(o.z=a.z,s.z=i.z):(o.z=i.z,s.z=a.z),t.intersectsPlaneAndPoint(c,s)===e.PlaneIntersectionType.Front)return e.ContainmentType.Disjoint;t.intersectsPlaneAndPoint(c,o)===e.PlaneIntersectionType.Front&&(l=e.ContainmentType.Intersects)}return l},t.frustumContainsSphere=function(r,n){for(var i=e.ContainmentType.Contains,a=0;a<6;++a){var o=r.getPlane(a),s=t.intersectsPlaneAndSphere(o,n);if(s===e.PlaneIntersectionType.Front)return e.ContainmentType.Disjoint;if(s===e.PlaneIntersectionType.Intersecting){i=e.ContainmentType.Intersects;break}}return i},t}();u._tempVec30=new o,u._tempVec31=new o;var c=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=0),this.normal=new o,this.distance=0,e&&e.cloneTo(this.normal),this.distance=t}e.normalize=function(e,t){var r=e.normal,n=1/r.length();o.scale(r,n,t.normal),t.distance=e.distance*n},e.fromPoints=function(e,t,r,n){var i=e.x,a=e.y,o=e.z,s=t.x-i,l=t.y-a,u=t.z-o,c=r.x-i,h=r.y-a,d=r.z-o,_=l*d-u*h,f=u*c-s*d,p=s*h-l*c,g=1/Math.sqrt(_*_+f*f+p*p),v=_*g,m=f*g,y=p*g,x=n.normal;x.x=v,x.y=m,x.z=y,n.distance=-(v*i+m*a+y*o)};var t=e.prototype;return t.normalize=function(){return e.normalize(this,this),this},t.clone=function(){var t=new e;return this.cloneTo(t),t},t.cloneTo=function(e){return this.normal.cloneTo(e.normal),e.distance=this.distance,e},e}(),h=function(){function t(e){void 0===e&&(e=null),this.near=void 0,this.far=void 0,this.left=void 0,this.right=void 0,this.top=void 0,this.bottom=void 0,this.near=new c,this.far=new c,this.left=new c,this.right=new c,this.top=new c,this.bottom=new c,e&&this.calculateFromMatrix(e)}var r=t.prototype;return r.clone=function(){var e=new t;return this.cloneTo(e),e},r.cloneTo=function(e){return this.near.cloneTo(e.near),this.far.cloneTo(e.far),this.left.cloneTo(e.left),this.right.cloneTo(e.right),this.top.cloneTo(e.top),this.bottom.cloneTo(e.bottom),e},r.getPlane=function(e){switch(e){case 0:return this.near;case 1:return this.far;case 2:return this.left;case 3:return this.right;case 4:return this.top;case 5:return this.bottom;default:return null}},r.calculateFromMatrix=function(e){var t=e.elements,r=t[0],n=t[1],i=t[2],a=t[3],o=t[4],s=t[5],l=t[6],u=t[7],c=t[8],h=t[9],d=t[10],_=t[11],f=t[12],p=t[13],g=t[14],v=t[15];this.near.normal.setValue(-a-i,-u-l,-_-d),this.near.distance=-v-g,this.near.normalize(),this.far.normal.setValue(i-a,l-u,d-_),this.far.distance=g-v,this.far.normalize(),this.left.normal.setValue(-a-r,-u-o,-_-c),this.left.distance=-v-f,this.left.normalize(),this.right.normal.setValue(r-a,o-u,c-_),this.right.distance=f-v,this.right.normalize(),this.top.normal.setValue(n-a,s-u,h-_),this.top.distance=p-v,this.top.normalize(),this.bottom.normal.setValue(-a-n,-u-s,-_-h),this.bottom.distance=-v-p,this.bottom.normalize()},r.intersectsBox=function(e){return u.intersectsFrustumAndBox(this,e)},r.intersectsSphere=function(t){return u.frustumContainsSphere(this,t)!==e.ContainmentType.Disjoint},t}(),d=function(){function e(e,t,r,n,i,a,o,s,l){void 0===e&&(e=1),void 0===t&&(t=0),void 0===r&&(r=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===a&&(a=0),void 0===o&&(o=0),void 0===s&&(s=0),void 0===l&&(l=1),this.elements=new Float32Array(9);var u=this.elements;u[0]=e,u[1]=t,u[2]=r,u[3]=n,u[4]=i,u[5]=a,u[6]=o,u[7]=s,u[8]=l}e.add=function(e,t,r){var n=e.elements,i=t.elements,a=r.elements;a[0]=n[0]+i[0],a[1]=n[1]+i[1],a[2]=n[2]+i[2],a[3]=n[3]+i[3],a[4]=n[4]+i[4],a[5]=n[5]+i[5],a[6]=n[6]+i[6],a[7]=n[7]+i[7],a[8]=n[8]+i[8]},e.subtract=function(e,t,r){var n=e.elements,i=t.elements,a=r.elements;a[0]=n[0]-i[0],a[1]=n[1]-i[1],a[2]=n[2]-i[2],a[3]=n[3]-i[3],a[4]=n[4]-i[4],a[5]=n[5]-i[5],a[6]=n[6]-i[6],a[7]=n[7]-i[7],a[8]=n[8]-i[8]},e.multiply=function(e,t,r){var n=e.elements,i=t.elements,a=r.elements,o=n[0],s=n[1],l=n[2],u=n[3],c=n[4],h=n[5],d=n[6],_=n[7],f=n[8],p=i[0],g=i[1],v=i[2],m=i[3],y=i[4],x=i[5],T=i[6],w=i[7],b=i[8];a[0]=o*p+u*g+d*v,a[1]=s*p+c*g+_*v,a[2]=l*p+h*g+f*v,a[3]=o*m+u*y+d*x,a[4]=s*m+c*y+_*x,a[5]=l*m+h*y+f*x,a[6]=o*T+u*w+d*b,a[7]=s*T+c*w+_*b,a[8]=l*T+h*w+f*b},e.equals=function(e,t){var r=e.elements,n=t.elements;return a.equals(r[0],n[0])&&a.equals(r[1],n[1])&&a.equals(r[2],n[2])&&a.equals(r[3],n[3])&&a.equals(r[4],n[4])&&a.equals(r[5],n[5])&&a.equals(r[6],n[6])&&a.equals(r[7],n[7])&&a.equals(r[8],n[8])},e.lerp=function(e,t,r,n){var i=e.elements,a=t.elements,o=n.elements,s=1-r;o[0]=i[0]*s+a[0]*r,o[1]=i[1]*s+a[1]*r,o[2]=i[2]*s+a[2]*r,o[3]=i[3]*s+a[3]*r,o[4]=i[4]*s+a[4]*r,o[5]=i[5]*s+a[5]*r,o[6]=i[6]*s+a[6]*r,o[7]=i[7]*s+a[7]*r,o[8]=i[8]*s+a[8]*r},e.rotationQuaternion=function(e,t){var r=t.elements,n=e._x,i=e._y,a=e._z,o=e._w,s=n+n,l=i+i,u=a+a,c=n*s,h=i*s,d=i*l,_=a*s,f=a*l,p=a*u,g=o*s,v=o*l,m=o*u;r[0]=1-d-p,r[3]=h-m,r[6]=_+v,r[1]=h+m,r[4]=1-c-p,r[7]=f-g,r[2]=_-v,r[5]=f+g,r[8]=1-c-d},e.scaling=function(e,t){var r=t.elements;r[0]=e._x,r[1]=0,r[2]=0,r[3]=0,r[4]=e._y,r[5]=0,r[6]=0,r[7]=0,r[8]=1},e.translation=function(e,t){var r=t.elements;r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=e._x,r[7]=e._y,r[8]=1},e.invert=function(e,t){var r=e.elements,n=t.elements,i=r[0],a=r[1],o=r[2],s=r[3],l=r[4],u=r[5],c=r[6],h=r[7],d=r[8],_=d*l-u*h,f=-d*s+u*c,p=h*s-l*c,g=i*_+a*f+o*p;g&&(g=1/g,n[0]=_*g,n[1]=(-d*a+o*h)*g,n[2]=(u*a-o*l)*g,n[3]=f*g,n[4]=(d*i-o*c)*g,n[5]=(-u*i+o*s)*g,n[6]=p*g,n[7]=(-h*i+a*c)*g,n[8]=(l*i-a*s)*g)},e.normalMatrix=function(e,t){var r=e.elements,n=t.elements,i=r[0],a=r[1],o=r[2],s=r[3],l=r[4],u=r[5],c=r[6],h=r[7],d=r[8],_=r[9],f=r[10],p=r[11],g=r[12],v=r[13],m=r[14],y=r[15],x=i*u-a*l,T=i*c-o*l,w=i*h-s*l,b=a*c-o*u,C=a*h-s*u,S=o*h-s*c,M=d*v-_*g,A=d*m-f*g,P=d*y-p*g,F=_*m-f*v,E=_*y-p*v,R=f*y-p*m,L=x*R-T*E+w*F+b*P-C*A+S*M;if(!L)return null;L=1/L,n[0]=(u*R-c*E+h*F)*L,n[1]=(c*P-l*R-h*A)*L,n[2]=(l*E-u*P+h*M)*L,n[3]=(o*E-a*R-s*F)*L,n[4]=(i*R-o*P+s*A)*L,n[5]=(a*P-i*E-s*M)*L,n[6]=(v*S-m*C+y*b)*L,n[7]=(m*w-g*S-y*T)*L,n[8]=(g*C-v*w+y*x)*L},e.rotate=function(e,t,r){var n=e.elements,i=r.elements,a=Math.sin(t),o=Math.cos(t),s=n[0],l=n[1],u=n[2],c=n[3],h=n[4],d=n[5],_=n[6],f=n[7],p=n[8];i[0]=o*s+a*c,i[1]=o*l+a*h,i[2]=o*u+a*d,i[3]=o*c-a*s,i[4]=o*h-a*l,i[5]=o*d-a*u,i[6]=_,i[7]=f,i[8]=p},e.scale=function(e,t,r){var n=t._x,i=t._y,a=e.elements,o=r.elements;o[0]=n*a[0],o[1]=n*a[1],o[2]=n*a[2],o[3]=i*a[3],o[4]=i*a[4],o[5]=i*a[5],o[6]=a[6],o[7]=a[7],o[8]=a[8]},e.translate=function(e,t,r){var n=t._x,i=t._y,a=e.elements,o=r.elements,s=a[0],l=a[1],u=a[2],c=a[3],h=a[4],d=a[5],_=a[6],f=a[7],p=a[8];o[0]=s,o[1]=l,o[2]=u,o[3]=c,o[4]=h,o[5]=d,o[6]=n*s+i*c+_,o[7]=n*l+i*h+f,o[8]=n*u+i*d+p},e.transpose=function(e,t){var r=e.elements,n=t.elements;if(t===e){var i=r[1],a=r[2],o=r[5];n[1]=r[3],n[2]=r[6],n[3]=i,n[5]=r[7],n[6]=a,n[7]=o}else n[0]=r[0],n[1]=r[3],n[2]=r[6],n[3]=r[1],n[4]=r[4],n[5]=r[7],n[6]=r[2],n[7]=r[5],n[8]=r[8]};var t=e.prototype;return t.setValue=function(e,t,r,n,i,a,o,s,l){var u=this.elements;return u[0]=e,u[1]=t,u[2]=r,u[3]=n,u[4]=i,u[5]=a,u[6]=o,u[7]=s,u[8]=l,this},t.setValueByArray=function(e,t){void 0===t&&(t=0);for(var r=this.elements,n=0;n<12;n++)r[n]=e[n+t];return this},t.setValueByMatrix=function(e){var t=e.elements,r=this.elements;return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[4],r[4]=t[5],r[5]=t[6],r[6]=t[8],r[7]=t[9],r[8]=t[10],this},t.toArray=function(e,t){void 0===t&&(t=0);var r=this.elements;e[t]=r[0],e[t+1]=r[1],e[t+2]=r[2],e[t+3]=r[3],e[t+4]=r[4],e[t+5]=r[5],e[t+6]=r[6],e[t+7]=r[7],e[t+8]=r[8]},t.clone=function(){var t=this.elements;return new e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])},t.cloneTo=function(e){var t=this.elements,r=e.elements;return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=t[7],r[8]=t[8],e},t.add=function(t){return e.add(this,t,this),this},t.subtract=function(t){return e.subtract(this,t,this),this},t.multiply=function(t){return e.multiply(this,t,this),this},t.determinant=function(){var e=this.elements,t=e[0],r=e[1],n=e[2],i=e[3],a=e[4],o=e[5],s=e[6],l=e[7],u=e[8];return t*(u*a-o*l)+r*(-u*i+o*s)+n*(l*i-a*s)},t.identity=function(){var e=this.elements;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,this},t.invert=function(){return e.invert(this,this),this},t.rotate=function(t){return e.rotate(this,t,this),this},t.scale=function(t){return e.scale(this,t,this),this},t.translate=function(t){return e.translate(this,t,this),this},t.transpose=function(){return e.transpose(this,this),this},e}(),_=function(){function e(e,t,r,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),void 0===n&&(n=1),this._x=void 0,this._y=void 0,this._z=void 0,this._w=void 0,this._onValueChanged=null,this._x=e,this._y=t,this._z=r,this._w=n}e.add=function(e,t,r){r._x=e._x+t._x,r._y=e._y+t._y,r._z=e._z+t._z,r._w=e._w+t._w,r._onValueChanged&&r._onValueChanged()},e.multiply=function(e,t,r){var n=e._x,i=e._y,a=e._z,o=e._w,s=t._x,l=t._y,u=t._z,c=t._w;r._x=n*c+o*s+i*u-a*l,r._y=i*c+o*l+a*s-n*u,r._z=a*c+o*u+n*l-i*s,r._w=o*c-n*s-i*l-a*u,r._onValueChanged&&r._onValueChanged()},e.conjugate=function(e,t){t._x=-e._x,t._y=-e._y,t._z=-e._z,t._w=e._w,t._onValueChanged&&t._onValueChanged()},e.dot=function(e,t){return e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w},e.equals=function(e,t){return a.equals(e._x,t._x)&&a.equals(e._y,t._y)&&a.equals(e._z,t._z)&&a.equals(e._w,t._w)},e.rotationAxisAngle=function(t,r,n){var i=e._tempVector3;o.normalize(t,i),r*=.5;var a=Math.sin(r);n._x=i._x*a,n._y=i._y*a,n._z=i._z*a,n._w=Math.cos(r),n._onValueChanged&&n._onValueChanged()},e.rotationEuler=function(t,r,n,i){e.rotationYawPitchRoll(r,t,n,i)},e.rotationYawPitchRoll=function(e,t,r,n){var i=.5*r,a=.5*t,o=.5*e,s=Math.sin(i),l=Math.cos(i),u=Math.sin(a),c=Math.cos(a),h=Math.sin(o),d=Math.cos(o),_=d*c,f=h*u;n._x=d*u*l+h*c*s,n._y=h*c*l-d*u*s,n._z=_*s-f*l,n._w=_*l+f*s,n._onValueChanged&&n._onValueChanged()},e.rotationMatrix3x3=function(e,t){var r,n,i=e.elements,a=i[0],o=i[1],s=i[2],l=i[3],u=i[4],c=i[5],h=i[6],d=i[7],_=i[8],f=a+u+_;f>0?(r=Math.sqrt(f+1),t._w=.5*r,r=.5/r,t._x=(c-d)*r,t._y=(h-s)*r,t._z=(o-l)*r):a>=u&&a>=_?(n=.5/(r=Math.sqrt(1+a-u-_)),t._x=.5*r,t._y=(o+l)*n,t._z=(s+h)*n,t._w=(c-d)*n):u>_?(n=.5/(r=Math.sqrt(1+u-a-_)),t._x=(l+o)*n,t._y=.5*r,t._z=(d+c)*n,t._w=(h-s)*n):(n=.5/(r=Math.sqrt(1+_-a-u)),t._x=(s+h)*n,t._y=(c+d)*n,t._z=.5*r,t._w=(o-l)*n),t._onValueChanged&&t._onValueChanged()},e.invert=function(e,t){var r=e._x,n=e._y,i=e._z,o=e._w,s=r*r+n*n+i*i+o*o;if(s>a.zeroTolerance){var l=1/s;t._x=-r*l,t._y=-n*l,t._z=-i*l,t._w=o*l,t._onValueChanged&&t._onValueChanged()}},e.lerp=function(t,r,n,i){var a=1-n;e.dot(t,r)>=0?(i._x=t._x*a+r._x*n,i._y=t._y*a+r._y*n,i._z=t._z*a+r._z*n,i._w=t._w*a+r._w*n):(i._x=t._x*a-r._x*n,i._y=t._y*a-r._y*n,i._z=t._z*a-r._z*n,i._w=t._w*a-r._w*n),i.normalize()},e.slerp=function(e,t,r,n){var i,o,s=e._x,l=e._y,u=e._z,c=e._w,h=t._x,d=t._y,_=t._z,f=t._w,p=s*h+l*d+u*_+c*f;if(p<0&&(p=-p,h=-h,d=-d,_=-_,f=-f),1-p>a.zeroTolerance){var g=Math.acos(p),v=Math.sin(g);i=Math.sin((1-r)*g)/v,o=Math.sin(r*g)/v}else i=1-r,o=r;n._x=i*s+o*h,n._y=i*l+o*d,n._z=i*u+o*_,n._w=i*c+o*f,n._onValueChanged&&n._onValueChanged()},e.normalize=function(e,t){var r=e._x,n=e._y,i=e._z,o=e._w,s=Math.sqrt(r*r+n*n+i*i+o*o);s>a.zeroTolerance&&(s=1/s,t._x=r*s,t._y=n*s,t._z=i*s,t._w=o*s,t._onValueChanged&&t._onValueChanged())},e.rotationX=function(e,t){e*=.5;var r=Math.sin(e),n=Math.cos(e);t._x=r,t._y=0,t._z=0,t._w=n,t._onValueChanged&&t._onValueChanged()},e.rotationY=function(e,t){e*=.5;var r=Math.sin(e),n=Math.cos(e);t._x=0,t._y=r,t._z=0,t._w=n,t._onValueChanged&&t._onValueChanged()},e.rotationZ=function(e,t){e*=.5;var r=Math.sin(e),n=Math.cos(e);t._x=0,t._y=0,t._z=r,t._w=n,t._onValueChanged&&t._onValueChanged()},e.rotateX=function(e,t,r){var n=e._x,i=e._y,a=e._z,o=e._w;t*=.5;var s=Math.sin(t),l=Math.cos(t);r._x=n*l+o*s,r._y=i*l+a*s,r._z=a*l-i*s,r._w=o*l-n*s,r._onValueChanged&&r._onValueChanged()},e.rotateY=function(e,t,r){var n=e._x,i=e._y,a=e._z,o=e._w;t*=.5;var s=Math.sin(t),l=Math.cos(t);r._x=n*l-a*s,r._y=i*l+o*s,r._z=a*l+n*s,r._w=o*l-i*s,r._onValueChanged&&r._onValueChanged()},e.rotateZ=function(e,t,r){var n=e._x,i=e._y,a=e._z,o=e._w;t*=.5;var s=Math.sin(t),l=Math.cos(t);r._x=n*l+i*s,r._y=i*l-n*s,r._z=a*l+o*s,r._w=o*l-a*s,r._onValueChanged&&r._onValueChanged()},e.scale=function(e,t,r){r._x=e._x*t,r._y=e._y*t,r._z=e._z*t,r._w=e._w*t,r._onValueChanged&&r._onValueChanged()};var t=e.prototype;return t.setValue=function(e,t,r,n){return this._x=e,this._y=t,this._z=r,this._w=n,this._onValueChanged&&this._onValueChanged(),this},t.setValueByArray=function(e,t){return void 0===t&&(t=0),this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onValueChanged&&this._onValueChanged(),this},t.conjugate=function(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onValueChanged&&this._onValueChanged(),this},t.getAxisAngle=function(e){var t=this._x,r=this._y,n=this._z,i=t*t+r*r+n*n;if(i<a.zeroTolerance)return e._x=1,e._y=0,e._z=0,0;var o=1/i;return e._x=this._x*o,e._y=this._y*o,e._z=this._z*o,2*Math.acos(this._w)},t.identity=function(){return this._x=0,this._y=0,this._z=0,this._w=1,this._onValueChanged&&this._onValueChanged(),this},t.length=function(){var e=this._x,t=this._y,r=this._z,n=this._w;return Math.sqrt(e*e+t*t+r*r+n*n)},t.lengthSquared=function(){var e=this._x,t=this._y,r=this._z,n=this._w;return e*e+t*t+r*r+n*n},t.normalize=function(){return e.normalize(this,this),this},t.toEuler=function(e){this._toYawPitchRoll(e);var t=e._x;return e._x=e._y,e._y=t,e._onValueChanged&&e._onValueChanged(),e},t.toYawPitchRoll=function(e){return this._toYawPitchRoll(e),e._onValueChanged&&e._onValueChanged(),e},t.toArray=function(e,t){void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w},t.clone=function(){return new e(this._x,this._y,this._z,this._w)},t.cloneTo=function(e){return e._x=this._x,e._y=this._y,e._z=this._z,e._w=this._w,e._onValueChanged&&e._onValueChanged(),e},t.rotateX=function(t){return e.rotateX(this,t,this),this},t.rotateY=function(t){return e.rotateY(this,t,this),this},t.rotateZ=function(t){return e.rotateZ(this,t,this),this},t.rotationAxisAngle=function(t,r){return e.rotationAxisAngle(t,r,this),this},t.multiply=function(t){return e.multiply(this,t,this),this},t.invert=function(){return e.invert(this,this),this},t.dot=function(t){return e.dot(this,t)},t.lerp=function(t,r){return e.lerp(this,t,r,this),this},t.rotateAxisAngle=function(t,r){return e._tempQuat1.rotationAxisAngle(t,r),this.multiply(e._tempQuat1),this},t._toYawPitchRoll=function(e){var t=this._x,r=this._y,n=this._z,i=this._w,o=t*t,s=r*r,l=n*n,u=t*r,c=n*i,h=n*t,d=r*i,_=r*n,f=t*i;return e._y=Math.asin(2*(f-_)),Math.cos(e.y)>a.zeroTolerance?(e._z=Math.atan2(2*(u+c),1-2*(l+o)),e._x=Math.atan2(2*(h+d),1-2*(s+o))):(e._z=Math.atan2(-2*(u-c),1-2*(s+l)),e._x=0),e},i(e,[{key:"x",get:function(){return this._x},set:function(e){this._x=e,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(e){this._y=e,this._onValueChanged&&this._onValueChanged()}},{key:"z",get:function(){return this._z},set:function(e){this._z=e,this._onValueChanged&&this._onValueChanged()}},{key:"normalized",get:function(){return Math.abs(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w-1)<a.zeroTolerance}},{key:"w",get:function(){return this._w},set:function(e){this._w=e,this._onValueChanged&&this._onValueChanged()}}]),e}();_._tempVector3=new o,_._tempQuat1=new _;var f=function(){function e(e,t,r,n,i,a,o,s,l,u,c,h,d,_,f,p){void 0===e&&(e=1),void 0===t&&(t=0),void 0===r&&(r=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===a&&(a=1),void 0===o&&(o=0),void 0===s&&(s=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===c&&(c=1),void 0===h&&(h=0),void 0===d&&(d=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===p&&(p=1),this.elements=new Float32Array(16);var g=this.elements;g[0]=e,g[1]=t,g[2]=r,g[3]=n,g[4]=i,g[5]=a,g[6]=o,g[7]=s,g[8]=l,g[9]=u,g[10]=c,g[11]=h,g[12]=d,g[13]=_,g[14]=f,g[15]=p}e.multiply=function(e,t,r){var n=e.elements,i=t.elements,a=r.elements,o=n[0],s=n[1],l=n[2],u=n[3],c=n[4],h=n[5],d=n[6],_=n[7],f=n[8],p=n[9],g=n[10],v=n[11],m=n[12],y=n[13],x=n[14],T=n[15],w=i[0],b=i[1],C=i[2],S=i[3],M=i[4],A=i[5],P=i[6],F=i[7],E=i[8],R=i[9],L=i[10],B=i[11],D=i[12],I=i[13],O=i[14],z=i[15];a[0]=o*w+c*b+f*C+m*S,a[1]=s*w+h*b+p*C+y*S,a[2]=l*w+d*b+g*C+x*S,a[3]=u*w+_*b+v*C+T*S,a[4]=o*M+c*A+f*P+m*F,a[5]=s*M+h*A+p*P+y*F,a[6]=l*M+d*A+g*P+x*F,a[7]=u*M+_*A+v*P+T*F,a[8]=o*E+c*R+f*L+m*B,a[9]=s*E+h*R+p*L+y*B,a[10]=l*E+d*R+g*L+x*B,a[11]=u*E+_*R+v*L+T*B,a[12]=o*D+c*I+f*O+m*z,a[13]=s*D+h*I+p*O+y*z,a[14]=l*D+d*I+g*O+x*z,a[15]=u*D+_*I+v*O+T*z},e.equals=function(e,t){var r=e.elements,n=t.elements;return a.equals(r[0],n[0])&&a.equals(r[1],n[1])&&a.equals(r[2],n[2])&&a.equals(r[3],n[3])&&a.equals(r[4],n[4])&&a.equals(r[5],n[5])&&a.equals(r[6],n[6])&&a.equals(r[7],n[7])&&a.equals(r[8],n[8])&&a.equals(r[9],n[9])&&a.equals(r[10],n[10])&&a.equals(r[11],n[11])&&a.equals(r[12],n[12])&&a.equals(r[13],n[13])&&a.equals(r[14],n[14])&&a.equals(r[15],n[15])},e.lerp=function(e,t,r,n){var i=e.elements,a=t.elements,o=n.elements,s=1-r;o[0]=i[0]*s+a[0]*r,o[1]=i[1]*s+a[1]*r,o[2]=i[2]*s+a[2]*r,o[3]=i[3]*s+a[3]*r,o[4]=i[4]*s+a[4]*r,o[5]=i[5]*s+a[5]*r,o[6]=i[6]*s+a[6]*r,o[7]=i[7]*s+a[7]*r,o[8]=i[8]*s+a[8]*r,o[9]=i[9]*s+a[9]*r,o[10]=i[10]*s+a[10]*r,o[11]=i[11]*s+a[11]*r,o[12]=i[12]*s+a[12]*r,o[13]=i[13]*s+a[13]*r,o[14]=i[14]*s+a[14]*r,o[15]=i[15]*s+a[15]*r},e.rotationQuaternion=function(e,t){var r=t.elements,n=e._x,i=e._y,a=e._z,o=e._w,s=n+n,l=i+i,u=a+a,c=n*s,h=i*s,d=i*l,_=a*s,f=a*l,p=a*u,g=o*s,v=o*l,m=o*u;r[0]=1-d-p,r[1]=h+m,r[2]=_-v,r[3]=0,r[4]=h-m,r[5]=1-c-p,r[6]=f+g,r[7]=0,r[8]=_+v,r[9]=f-g,r[10]=1-c-d,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1},e.rotationAxisAngle=function(e,t,r){var n,i,o,s=r.elements,l=e._x,u=e._y,c=e._z,h=Math.sqrt(l*l+u*u+c*c);Math.abs(h)<a.zeroTolerance||(l*=h=1/h,u*=h,c*=h,n=Math.sin(t),o=1-(i=Math.cos(t)),s[0]=l*l*o+i,s[1]=u*l*o+c*n,s[2]=c*l*o-u*n,s[3]=0,s[4]=l*u*o-c*n,s[5]=u*u*o+i,s[6]=c*u*o+l*n,s[7]=0,s[8]=l*c*o+u*n,s[9]=u*c*o-l*n,s[10]=c*c*o+i,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1)},e.rotationTranslation=function(t,r,n){e.rotationQuaternion(t,n);var i=n.elements;i[12]=r._x,i[13]=r._y,i[14]=r._z},e.affineTransformation=function(e,t,r,n){var i=n.elements,a=t._x,o=t._y,s=t._z,l=t._w,u=a+a,c=o+o,h=s+s,d=a*u,_=a*c,f=a*h,p=o*c,g=o*h,v=s*h,m=l*u,y=l*c,x=l*h,T=e._x,w=e._y,b=e._z;i[0]=(1-(p+v))*T,i[1]=(_+x)*T,i[2]=(f-y)*T,i[3]=0,i[4]=(_-x)*w,i[5]=(1-(d+v))*w,i[6]=(g+m)*w,i[7]=0,i[8]=(f+y)*b,i[9]=(g-m)*b,i[10]=(1-(d+p))*b,i[11]=0,i[12]=r._x,i[13]=r._y,i[14]=r._z,i[15]=1},e.scaling=function(e,t){var r=t.elements;r[0]=e._x,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=e._y,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=e._z,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1},e.translation=function(e,t){var r=t.elements;r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=e._x,r[13]=e._y,r[14]=e._z,r[15]=1},e.invert=function(e,t){var r=e.elements,n=t.elements,i=r[0],a=r[1],o=r[2],s=r[3],l=r[4],u=r[5],c=r[6],h=r[7],d=r[8],_=r[9],f=r[10],p=r[11],g=r[12],v=r[13],m=r[14],y=r[15],x=i*u-a*l,T=i*c-o*l,w=i*h-s*l,b=a*c-o*u,C=a*h-s*u,S=o*h-s*c,M=d*v-_*g,A=d*m-f*g,P=d*y-p*g,F=_*m-f*v,E=_*y-p*v,R=f*y-p*m,L=x*R-T*E+w*F+b*P-C*A+S*M;if(!L)return null;L=1/L,n[0]=(u*R-c*E+h*F)*L,n[1]=(o*E-a*R-s*F)*L,n[2]=(v*S-m*C+y*b)*L,n[3]=(f*C-_*S-p*b)*L,n[4]=(c*P-l*R-h*A)*L,n[5]=(i*R-o*P+s*A)*L,n[6]=(m*w-g*S-y*T)*L,n[7]=(d*S-f*w+p*T)*L,n[8]=(l*E-u*P+h*M)*L,n[9]=(a*P-i*E-s*M)*L,n[10]=(g*C-v*w+y*x)*L,n[11]=(_*w-d*C-p*x)*L,n[12]=(u*A-l*F-c*M)*L,n[13]=(i*F-a*A+o*M)*L,n[14]=(v*T-g*b-m*x)*L,n[15]=(d*b-_*T+f*x)*L},e.lookAt=function(t,r,n,i){var a=i.elements,s=e._tempVec30,l=e._tempVec31,u=e._tempVec32;o.subtract(t,r,u),u.normalize(),o.cross(n,u,s),s.normalize(),o.cross(u,s,l),a[0]=s._x,a[1]=l._x,a[2]=u._x,a[3]=0,a[4]=s._y,a[5]=l._y,a[6]=u._y,a[7]=0,a[8]=s._z,a[9]=l._z,a[10]=u._z,a[11]=0,a[12]=-o.dot(s,t),a[13]=-o.dot(l,t),a[14]=-o.dot(u,t),a[15]=1},e.ortho=function(e,t,r,n,i,a,o){var s=o.elements,l=1/(e-t),u=1/(r-n),c=1/(i-a);s[0]=-2*l,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=-2*u,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=2*c,s[11]=0,s[12]=(e+t)*l,s[13]=(n+r)*u,s[14]=(a+i)*c,s[15]=1},e.perspective=function(e,t,r,n,i){var a=i.elements,o=1/Math.tan(e/2),s=1/(r-n);a[0]=o/t,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=o,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=(n+r)*s,a[11]=-1,a[12]=0,a[13]=0,a[14]=2*n*r*s,a[15]=0},e.rotateAxisAngle=function(e,t,r,n){var i=t._x,o=t._y,s=t._z,l=Math.sqrt(i*i+o*o+s*s);if(!(Math.abs(l)<a.zeroTolerance)){var u,c,h,d=e.elements,_=n.elements;i*=l=1/l,o*=l,s*=l,u=Math.sin(r),h=1-(c=Math.cos(r));var f=d[0],p=d[1],g=d[2],v=d[3],m=d[4],y=d[5],x=d[6],T=d[7],w=d[8],b=d[9],C=d[10],S=d[11],M=i*i*h+c,A=o*i*h+s*u,P=s*i*h-o*u,F=i*o*h-s*u,E=o*o*h+c,R=s*o*h+i*u,L=i*s*h+o*u,B=o*s*h-i*u,D=s*s*h+c;_[0]=f*M+m*A+w*P,_[1]=p*M+y*A+b*P,_[2]=g*M+x*A+C*P,_[3]=v*M+T*A+S*P,_[4]=f*F+m*E+w*R,_[5]=p*F+y*E+b*R,_[6]=g*F+x*E+C*R,_[7]=v*F+T*E+S*R,_[8]=f*L+m*B+w*D,_[9]=p*L+y*B+b*D,_[10]=g*L+x*B+C*D,_[11]=v*L+T*B+S*D,e!==n&&(_[12]=d[12],_[13]=d[13],_[14]=d[14],_[15]=d[15])}},e.scale=function(e,t,r){var n=e.elements,i=r.elements,a=t._x,o=t._y,s=t._z;i[0]=n[0]*a,i[1]=n[1]*a,i[2]=n[2]*a,i[3]=n[3]*a,i[4]=n[4]*o,i[5]=n[5]*o,i[6]=n[6]*o,i[7]=n[7]*o,i[8]=n[8]*s,i[9]=n[9]*s,i[10]=n[10]*s,i[11]=n[11]*s,i[12]=n[12],i[13]=n[13],i[14]=n[14],i[15]=n[15]},e.translate=function(e,t,r){var n=e.elements,i=r.elements,a=t._x,o=t._y,s=t._z;if(e===r)i[12]=n[0]*a+n[4]*o+n[8]*s+n[12],i[13]=n[1]*a+n[5]*o+n[9]*s+n[13],i[14]=n[2]*a+n[6]*o+n[10]*s+n[14],i[15]=n[3]*a+n[7]*o+n[11]*s+n[15];else{var l=n[0],u=n[1],c=n[2],h=n[3],d=n[4],_=n[5],f=n[6],p=n[7],g=n[8],v=n[9],m=n[10],y=n[11];i[0]=l,i[1]=u,i[2]=c,i[3]=h,i[4]=d,i[5]=_,i[6]=f,i[7]=p,i[8]=g,i[9]=v,i[10]=m,i[11]=y,i[12]=l*a+d*o+g*s+n[12],i[13]=u*a+_*o+v*s+n[13],i[14]=c*a+f*o+m*s+n[14],i[15]=h*a+p*o+y*s+n[15]}},e.transpose=function(e,t){var r=e.elements,n=t.elements;if(t===e){var i=r[1],a=r[2],o=r[3],s=r[6],l=r[7],u=r[11];n[1]=r[4],n[2]=r[8],n[3]=r[12],n[4]=i,n[6]=r[9],n[7]=r[13],n[8]=a,n[9]=s,n[11]=r[14],n[12]=o,n[13]=l,n[14]=u}else n[0]=r[0],n[1]=r[4],n[2]=r[8],n[3]=r[12],n[4]=r[1],n[5]=r[5],n[6]=r[9],n[7]=r[13],n[8]=r[2],n[9]=r[6],n[10]=r[10],n[11]=r[14],n[12]=r[3],n[13]=r[7],n[14]=r[11],n[15]=r[15]};var t=e.prototype;return t.setValue=function(e,t,r,n,i,a,o,s,l,u,c,h,d,_,f,p){var g=this.elements;return g[0]=e,g[1]=t,g[2]=r,g[3]=n,g[4]=i,g[5]=a,g[6]=o,g[7]=s,g[8]=l,g[9]=u,g[10]=c,g[11]=h,g[12]=d,g[13]=_,g[14]=f,g[15]=p,this},t.setValueByArray=function(e,t){void 0===t&&(t=0);for(var r=this.elements,n=0;n<16;n++)r[n]=e[n+t];return this},t.toArray=function(e,t){void 0===t&&(t=0);var r=this.elements;e[t]=r[0],e[t+1]=r[1],e[t+2]=r[2],e[t+3]=r[3],e[t+4]=r[4],e[t+5]=r[5],e[t+6]=r[6],e[t+7]=r[7],e[t+8]=r[8],e[t+9]=r[9],e[t+10]=r[10],e[t+11]=r[11],e[t+12]=r[12],e[t+13]=r[13],e[t+14]=r[14],e[t+15]=r[15]},t.clone=function(){var t=this.elements;return new e(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])},t.cloneTo=function(e){var t=this.elements,r=e.elements;return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=t[7],r[8]=t[8],r[9]=t[9],r[10]=t[10],r[11]=t[11],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15],e},t.multiply=function(t){return e.multiply(this,t,this),this},t.determinant=function(){var e=this.elements,t=e[0],r=e[1],n=e[2],i=e[3],a=e[4],o=e[5],s=e[6],l=e[7],u=e[8],c=e[9],h=e[10],d=e[11],_=e[12],f=e[13],p=e[14],g=e[15];return(t*o-r*a)*(h*g-d*p)-(t*s-n*a)*(c*g-d*f)+(t*l-i*a)*(c*p-h*f)+(r*s-n*o)*(u*g-d*_)-(r*l-i*o)*(u*p-h*_)+(n*l-i*s)*(u*f-c*_)},t.decompose=function(t,r,n){var i=e._tempMat30,o=this.elements,s=i.elements,l=o[0],u=o[1],c=o[2],h=o[3],d=o[4],f=o[5],p=o[6],g=o[7],v=o[8],m=o[9],y=o[10],x=o[11];t.setValue(o[12],o[13],o[14]);var T=Math.sign(l*u*c*h)<0?-1:1,w=Math.sign(d*f*p*g)<0?-1:1,b=Math.sign(v*m*y*x)<0?-1:1,C=T*Math.sqrt(l*l+u*u+c*c),S=w*Math.sqrt(d*d+f*f+p*p),M=b*Math.sqrt(v*v+m*m+y*y);if(n.setValue(C,S,M),Math.abs(C)<a.zeroTolerance||Math.abs(S)<a.zeroTolerance||Math.abs(M)<a.zeroTolerance)return r.identity(),!1;var A=1/C,P=1/S,F=1/M;return s[0]=l*A,s[1]=u*A,s[2]=c*A,s[3]=d*P,s[4]=f*P,s[5]=p*P,s[6]=v*F,s[7]=m*F,s[8]=y*F,_.rotationMatrix3x3(i,r),!0},t.getRotation=function(e){var t=this.elements,r=t[0]+t[5]+t[10];if(r>a.zeroTolerance){var n=2*Math.sqrt(r+1);e._w=.25*n,e._x=(t[6]-t[9])/n,e._y=(t[8]-t[2])/n,e._z=(t[1]-t[4])/n}else if(t[0]>t[5]&&t[0]>t[10]){var i=2*Math.sqrt(1+t[0]-t[5]-t[10]);e._w=(t[6]-t[9])/i,e._x=.25*i,e._y=(t[1]+t[4])/i,e._z=(t[8]+t[2])/i}else if(t[5]>t[10]){var o=2*Math.sqrt(1+t[5]-t[0]-t[10]);e._w=(t[8]-t[2])/o,e._x=(t[1]+t[4])/o,e._y=.25*o,e._z=(t[6]+t[9])/o}else{var s=2*Math.sqrt(1+t[10]-t[0]-t[5]);e._w=(t[1]-t[4])/s,e._x=(t[8]+t[2])/s,e._y=(t[6]+t[9])/s,e._z=.25*s}return e._onValueChanged&&e._onValueChanged(),e},t.getScaling=function(e){var t=this.elements,r=t[0],n=t[1],i=t[2],a=t[4],o=t[5],s=t[6],l=t[8],u=t[9],c=t[10];return e.setValue(Math.sqrt(r*r+n*n+i*i),Math.sqrt(a*a+o*o+s*s),Math.sqrt(l*l+u*u+c*c)),e},t.getTranslation=function(e){var t=this.elements;return e.setValue(t[12],t[13],t[14]),e},t.identity=function(){var e=this.elements;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this},t.invert=function(){return e.invert(this,this),this},t.rotateAxisAngle=function(t,r){return e.rotateAxisAngle(this,t,r,this),this},t.scale=function(t){return e.scale(this,t,this),this},t.translate=function(t){return e.translate(this,t,this),this},t.transpose=function(){return e.transpose(this,this),this},e}();f._tempVec30=new o,f._tempVec31=new o,f._tempVec32=new o,f._tempMat30=new d,f._identity=new f(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);var p=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=null),this.origin=new o,this.direction=new o,e&&e.cloneTo(this.origin),t&&t.cloneTo(this.direction)}var t=e.prototype;return t.intersectPlane=function(e){return u.intersectsRayAndPlane(this,e)},t.intersectSphere=function(e){return u.intersectsRayAndSphere(this,e)},t.intersectBox=function(e){return u.intersectsRayAndBox(this,e)},t.getPoint=function(e,t){return o.scale(this.direction,e,t),t.add(this.origin)},e}(),g=function(){function e(e,t){void 0===e&&(e=0),void 0===t&&(t=0),this._x=void 0,this._y=void 0,this._onValueChanged=null,this._x=e,this._y=t}e.add=function(e,t,r){r._x=e._x+t._x,r._y=e._y+t._y,r._onValueChanged&&r._onValueChanged()},e.subtract=function(e,t,r){r._x=e._x-t._x,r._y=e._y-t._y,r._onValueChanged&&r._onValueChanged()},e.multiply=function(e,t,r){r._x=e._x*t._x,r._y=e._y*t._y,r._onValueChanged&&r._onValueChanged()},e.divide=function(e,t,r){r._x=e._x/t._x,r._y=e._y/t._y,r._onValueChanged&&r._onValueChanged()},e.dot=function(e,t){return e._x*t._x+e._y*t._y},e.distance=function(e,t){var r=t._x-e._x,n=t._y-e._y;return Math.sqrt(r*r+n*n)},e.distanceSquared=function(e,t){var r=t._x-e._x,n=t._y-e._y;return r*r+n*n},e.equals=function(e,t){return a.equals(e._x,t._x)&&a.equals(e._y,t._y)},e.lerp=function(e,t,r,n){var i=e._x,a=e._y;n._x=i+(t._x-i)*r,n._y=a+(t._y-a)*r,n._onValueChanged&&n._onValueChanged()},e.max=function(e,t,r){r._x=Math.max(e._x,t._x),r._y=Math.max(e._y,t._y),r._onValueChanged&&r._onValueChanged()},e.min=function(e,t,r){r._x=Math.min(e._x,t._x),r._y=Math.min(e._y,t._y),r._onValueChanged&&r._onValueChanged()},e.negate=function(e,t){t._x=-e._x,t._y=-e._y,t._onValueChanged&&t._onValueChanged()},e.normalize=function(e,t){var r=e._x,n=e._y,i=Math.sqrt(r*r+n*n);i>a.zeroTolerance&&(i=1/i,t._x=r*i,t._y=n*i,t._onValueChanged&&t._onValueChanged())},e.scale=function(e,t,r){r._x=e._x*t,r._y=e._y*t,r._onValueChanged&&r._onValueChanged()};var t=e.prototype;return t.setValue=function(e,t){return this._x=e,this._y=t,this._onValueChanged&&this._onValueChanged(),this},t.setValueByArray=function(e,t){return void 0===t&&(t=0),this._x=e[t],this._y=e[t+1],this._onValueChanged&&this._onValueChanged(),this},t.add=function(e){return this._x+=e._x,this._y+=e._y,this._onValueChanged&&this._onValueChanged(),this},t.subtract=function(e){return this._x-=e._x,this._y-=e._y,this._onValueChanged&&this._onValueChanged(),this},t.multiply=function(e){return this._x*=e._x,this._y*=e._y,this._onValueChanged&&this._onValueChanged(),this},t.divide=function(e){return this._x/=e._x,this._y/=e._y,this._onValueChanged&&this._onValueChanged(),this},t.length=function(){var e=this._x,t=this._y;return Math.sqrt(e*e+t*t)},t.lengthSquared=function(){var e=this._x,t=this._y;return e*e+t*t},t.negate=function(){return this._x=-this._x,this._y=-this._y,this._onValueChanged&&this._onValueChanged(),this},t.normalize=function(){return e.normalize(this,this),this},t.scale=function(e){return this._x*=e,this._y*=e,this._onValueChanged&&this._onValueChanged(),this},t.toArray=function(e,t){void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y},t.clone=function(){return new e(this._x,this._y)},t.cloneTo=function(e){return e._x=this._x,e._y=this._y,e._onValueChanged&&e._onValueChanged(),e},i(e,[{key:"x",get:function(){return this._x},set:function(e){this._x=e,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(e){this._y=e,this._onValueChanged&&this._onValueChanged()}}]),e}();g._zero=new g(0,0),g._one=new g(1,1);var v=function(){function e(e,t,r,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),void 0===n&&(n=0),this._x=void 0,this._y=void 0,this._z=void 0,this._w=void 0,this._onValueChanged=null,this._x=e,this._y=t,this._z=r,this._w=n}e.add=function(e,t,r){r._x=e._x+t._x,r._y=e._y+t._y,r._z=e._z+t._z,r._w=e._w+t._w,r._onValueChanged&&r._onValueChanged()},e.subtract=function(e,t,r){r._x=e._x-t._x,r._y=e._y-t._y,r._z=e._z-t._z,r._w=e._w-t._w,r._onValueChanged&&r._onValueChanged()},e.multiply=function(e,t,r){r._x=e._x*t._x,r._y=e._y*t._y,r._z=e._z*t._z,r._w=e._w*t._w,r._onValueChanged&&r._onValueChanged()},e.divide=function(e,t,r){r._x=e._x/t._x,r._y=e._y/t._y,r._z=e._z/t._z,r._w=e._w/t._w,r._onValueChanged&&r._onValueChanged()},e.dot=function(e,t){return e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w},e.distance=function(e,t){var r=t._x-e._x,n=t._y-e._y,i=t._z-e._z,a=t._w-e._w;return Math.sqrt(r*r+n*n+i*i+a*a)},e.distanceSquared=function(e,t){var r=t._x-e._x,n=t._y-e._y,i=t._z-e._z,a=t._w-e._w;return r*r+n*n+i*i+a*a},e.equals=function(e,t){return a.equals(e._x,t._x)&&a.equals(e._y,t._y)&&a.equals(e._z,t._z)&&a.equals(e._w,t._w)},e.lerp=function(e,t,r,n){var i=e._x,a=e._y,o=e._z,s=e._w;n._x=i+(t._x-i)*r,n._y=a+(t._y-a)*r,n._z=o+(t._z-o)*r,n._w=s+(t._w-s)*r,n._onValueChanged&&n._onValueChanged()},e.max=function(e,t,r){r._x=Math.max(e._x,t._x),r._y=Math.max(e._y,t._y),r._z=Math.max(e._z,t._z),r._w=Math.max(e._w,t._w),r._onValueChanged&&r._onValueChanged()},e.min=function(e,t,r){r._x=Math.min(e._x,t._x),r._y=Math.min(e._y,t._y),r._z=Math.min(e._z,t._z),r._w=Math.min(e._w,t._w),r._onValueChanged&&r._onValueChanged()},e.negate=function(e,t){t._x=-e._x,t._y=-e._y,t._z=-e._z,t._w=-e._w,t._onValueChanged&&t._onValueChanged()},e.normalize=function(e,t){var r=e._x,n=e._y,i=e._z,o=e._w,s=Math.sqrt(r*r+n*n+i*i+o*o);s>a.zeroTolerance&&(s=1/s,t._x=r*s,t._y=n*s,t._z=i*s,t._w=o*s,t._onValueChanged&&t._onValueChanged())},e.scale=function(e,t,r){r._x=e._x*t,r._y=e._y*t,r._z=e._z*t,r._w=e._w*t,r._onValueChanged&&r._onValueChanged()},e.transform=function(e,t,r){var n=e._x,i=e._y,a=e._z,o=e._w,s=t.elements;r._x=n*s[0]+i*s[4]+a*s[8]+o*s[12],r._y=n*s[1]+i*s[5]+a*s[9]+o*s[13],r._z=n*s[2]+i*s[6]+a*s[10]+o*s[14],r._w=n*s[3]+i*s[7]+a*s[11]+o*s[15],r._onValueChanged&&r._onValueChanged()},e.transformByQuat=function(e,t,r){var n=e._x,i=e._y,a=e._z,o=e._w,s=t._x,l=t._y,u=t._z,c=t._w,h=c*n+l*a-u*i,d=c*i+u*n-s*a,_=c*a+s*i-l*n,f=-s*n-l*i-u*a;r._x=h*c-f*s-d*u+_*l,r._y=d*c-f*l-_*s+h*u,r._z=_*c-f*u-h*l+d*s,r._w=o,r._onValueChanged&&r._onValueChanged()};var t=e.prototype;return t.setValue=function(e,t,r,n){return this._x=e,this._y=t,this._z=r,this._w=n,this._onValueChanged&&this._onValueChanged(),this},t.setValueByArray=function(e,t){return void 0===t&&(t=0),this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onValueChanged&&this._onValueChanged(),this},t.add=function(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._w+=e._w,this._onValueChanged&&this._onValueChanged(),this},t.subtract=function(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._w-=e._w,this._onValueChanged&&this._onValueChanged(),this},t.multiply=function(e){return this._x*=e._x,this._y*=e._y,this._z*=e._z,this._w*=e._w,this._onValueChanged&&this._onValueChanged(),this},t.divide=function(e){return this._x/=e._x,this._y/=e._y,this._z/=e._z,this._w/=e._w,this._onValueChanged&&this._onValueChanged(),this},t.length=function(){var e=this._x,t=this._y,r=this._z,n=this._w;return Math.sqrt(e*e+t*t+r*r+n*n)},t.lengthSquared=function(){var e=this._x,t=this._y,r=this._z,n=this._w;return e*e+t*t+r*r+n*n},t.negate=function(){return this._x=-this._x,this._y=-this._y,this._z=-this._z,this._w=-this._w,this._onValueChanged&&this._onValueChanged(),this},t.normalize=function(){return e.normalize(this,this),this},t.scale=function(e){return this._x*=e,this._y*=e,this._z*=e,this._w*=e,this._onValueChanged&&this._onValueChanged(),this},t.toArray=function(e,t){void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w},t.clone=function(){return new e(this._x,this._y,this._z,this._w)},t.cloneTo=function(e){return e._x=this._x,e._y=this._y,e._z=this._z,e._w=this._w,e._onValueChanged&&e._onValueChanged(),e},i(e,[{key:"x",get:function(){return this._x},set:function(e){this._x=e,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(e){this._y=e,this._onValueChanged&&this._onValueChanged()}},{key:"z",get:function(){return this._z},set:function(e){this._z=e,this._onValueChanged&&this._onValueChanged()}},{key:"w",get:function(){return this._w},set:function(e){this._w=e,this._onValueChanged&&this._onValueChanged()}}]),e}();v._zero=new v(0,0,0,0),v._one=new v(1,1,1,1);var m,y,x,T=function(){function e(e,t,r,n){void 0===e&&(e=1),void 0===t&&(t=1),void 0===r&&(r=1),void 0===n&&(n=1),this.r=void 0,this.g=void 0,this.b=void 0,this.a=void 0,this.r=e,this.g=t,this.b=r,this.a=n}e.gammaToLinearSpace=function(e){return e<=0?0:e<=.04045?e/12.92:e<1?Math.pow((e+.055)/1.055,2.4):Math.pow(e,2.4)},e.linearToGammaSpace=function(e){return e<=0?0:e<.0031308?12.92*e:e<1?1.055*Math.pow(e,.41666)-.055:Math.pow(e,.41666)},e.equals=function(e,t){return a.equals(e.r,t.r)&&a.equals(e.g,t.g)&&a.equals(e.b,t.b)&&a.equals(e.a,t.a)},e.add=function(e,t,r){return r.r=e.r+t.r,r.g=e.g+t.g,r.b=e.b+t.b,r.a=e.a+t.a,r},e.scale=function(e,t,r){return r.r=e.r*t,r.g=e.g*t,r.b=e.b*t,r.a=e.a*t,r};var t=e.prototype;return t.setValue=function(e,t,r,n){return this.r=e,this.g=t,this.b=r,this.a=n,this},t.add=function(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this},t.scale=function(e){return this.r*=e,this.g*=e,this.b*=e,this.a*=e,this},t.clone=function(){return new e(this.r,this.g,this.b,this.a)},t.cloneTo=function(e){return e.r=this.r,e.g=this.g,e.b=this.b,e.a=this.a,e},t.toLinear=function(t){return t.r=e.gammaToLinearSpace(this.r),t.g=e.gammaToLinearSpace(this.g),t.b=e.gammaToLinearSpace(this.b),t},t.toGamma=function(t){return t.r=e.linearToGammaSpace(this.r),t.g=e.linearToGammaSpace(this.g),t.b=e.linearToGammaSpace(this.b),t},e}(),w=function(){function e(e,t,r,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===r&&(r=0),void 0===n&&(n=0),this.x=void 0,this.y=void 0,this.width=void 0,this.height=void 0,this.x=e,this.y=t,this.width=r,this.height=n}var t=e.prototype;return t.setValue=function(e,t,r,n){return this.x=e,this.y=t,this.width=r,this.height=n,this},t.clone=function(){return new e(this.x,this.y,this.width,this.height)},t.cloneTo=function(e){return e.x=this.x,e.y=this.y,e.width=this.width,e.height=this.height,e},e}(),b=function(){function e(){this.coefficients=new Float32Array(27)}var t=e.prototype;return t.addLight=function(e,t,r){t.scale(r);var n=this.coefficients,i=e._x,a=e._y,o=e._z,s=t.r,l=t.g,u=t.b,c=.282095,h=-.488603*a,d=.488603*o,_=-.488603*i,f=i*a*1.092548,p=a*o*-1.092548,g=.315392*(3*o*o-1),v=i*o*-1.092548,m=.546274*(i*i-a*a);n[0]+=s*c,n[1]+=l*c,n[2]+=u*c,n[3]+=s*h,n[4]+=l*h,n[5]+=u*h,n[6]+=s*d,n[7]+=l*d,n[8]+=u*d,n[9]+=s*_,n[10]+=l*_,n[11]+=u*_,n[12]+=s*f,n[13]+=l*f,n[14]+=u*f,n[15]+=s*p,n[16]+=l*p,n[17]+=u*p,n[18]+=s*g,n[19]+=l*g,n[20]+=u*g,n[21]+=s*v,n[22]+=l*v,n[23]+=u*v,n[24]+=s*m,n[25]+=l*m,n[26]+=u*m},t.evaluate=function(e,t){var r=this.coefficients,n=e._x,i=e._y,a=e._z,o=.886227,s=-1.023327*i,l=1.023327*a,u=-1.023327*n,c=.858086*i*n,h=-.858086*i*a,d=.247708*(3*a*a-1),_=-.858086*a*n,f=.429042*(n*n-i*i),p=r[0]*o,g=r[1]*o,v=r[2]*o;return p+=r[3]*s+r[6]*l+r[9]*u,g+=r[4]*s+r[7]*l+r[10]*u,v+=r[5]*s+r[8]*l+r[11]*u,p+=r[12]*c+r[15]*h+r[18]*d+r[21]*_+r[24]*f,g+=r[13]*c+r[16]*h+r[19]*d+r[22]*_+r[25]*f,v+=r[14]*c+r[17]*h+r[20]*d+r[23]*_+r[26]*f,t.setValue(p,g,v,1),t},t.scale=function(e){var t=this.coefficients;t[0]*=e,t[1]*=e,t[2]*=e,t[3]*=e,t[4]*=e,t[5]*=e,t[6]*=e,t[7]*=e,t[8]*=e,t[9]*=e,t[10]*=e,t[11]*=e,t[12]*=e,t[13]*=e,t[14]*=e,t[15]*=e,t[16]*=e,t[17]*=e,t[18]*=e,t[19]*=e,t[20]*=e,t[21]*=e,t[22]*=e,t[23]*=e,t[24]*=e,t[25]*=e,t[26]*=e},t.setValueByArray=function(e,t){void 0===t&&(t=0);var r=this.coefficients;r[0]=e[t],r[1]=e[1+t],r[2]=e[2+t],r[3]=e[3+t],r[4]=e[4+t],r[5]=e[5+t],r[6]=e[6+t],r[7]=e[7+t],r[8]=e[8+t],r[9]=e[9+t],r[10]=e[10+t],r[11]=e[11+t],r[12]=e[12+t],r[13]=e[13+t],r[14]=e[14+t],r[15]=e[15+t],r[16]=e[16+t],r[17]=e[17+t],r[18]=e[18+t],r[19]=e[19+t],r[20]=e[20+t],r[21]=e[21+t],r[22]=e[22+t],r[23]=e[23+t],r[24]=e[24+t],r[25]=e[25+t],r[26]=e[26+t]},t.toArray=function(e,t){void 0===t&&(t=0);var r=this.coefficients;e[0+t]=r[0],e[1+t]=r[1],e[2+t]=r[2],e[3+t]=r[3],e[4+t]=r[4],e[5+t]=r[5],e[6+t]=r[6],e[7+t]=r[7],e[8+t]=r[8],e[9+t]=r[9],e[10+t]=r[10],e[11+t]=r[11],e[12+t]=r[12],e[13+t]=r[13],e[14+t]=r[14],e[15+t]=r[15],e[16+t]=r[16],e[17+t]=r[17],e[18+t]=r[18],e[19+t]=r[19],e[20+t]=r[20],e[21+t]=r[21],e[22+t]=r[22],e[23+t]=r[23],e[24+t]=r[24],e[25+t]=r[25],e[26+t]=r[26]},t.clone=function(){var t=new e;return this.cloneTo(t),t},t.cloneTo=function(e){return this.toArray(e.coefficients),e},e}();function C(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function S(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?C(Object(r),!0).forEach((function(t){P(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):C(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function M(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function A(e,t,r){return t&&M(e.prototype,t),r&&M(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function P(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function F(){return(F=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function E(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,L(e,t)}function R(e){return(R=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function L(e,t){return(L=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function B(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function D(e,t,r){return(D=B()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var i=new(Function.bind.apply(e,n));return r&&L(i,r.prototype),i}).apply(null,arguments)}function I(e){var t="function"==typeof Map?new Map:void 0;return(I=function(e){if(null===e||(r=e,-1===Function.toString.call(r).indexOf("[native code]")))return e;var r;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return D(e,arguments,R(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),L(n,e)})(e)}function O(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function z(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function V(e,t,r,n){r&&Object.defineProperty(e,t,{enumerable:r.enumerable,configurable:r.configurable,writable:r.writable,value:r.initializer?r.initializer.call(n):void 0})}function N(e,t,r,n,i){var a={};return Object.keys(n).forEach((function(e){a[e]=n[e]})),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=r.slice().reverse().reduce((function(r,n){return n(e,t,r)||r}),a),i&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(i):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(e,t,a),a=null),a}function U(e,t){q.registerCloneMode(e,t,x.Ignore)}function k(e,t){q.registerCloneMode(e,t,x.Assignment)}function G(e,t){q.registerCloneMode(e,t,x.Shallow)}function H(e,t){q.registerCloneMode(e,t,x.Deep)}e.TextureFilterMode=void 0,(m=e.TextureFilterMode||(e.TextureFilterMode={}))[m.Point=0]="Point",m[m.Bilinear=1]="Bilinear",m[m.Trilinear=2]="Trilinear",e.TextureFormat=void 0,(y=e.TextureFormat||(e.TextureFormat={}))[y.R8G8B8=0]="R8G8B8",y[y.R8G8B8A8=1]="R8G8B8A8",y[y.R4G4B4A4=2]="R4G4B4A4",y[y.R5G5B5A1=3]="R5G5B5A1",y[y.R5G6B5=4]="R5G6B5",y[y.Alpha8=5]="Alpha8",y[y.LuminanceAlpha=6]="LuminanceAlpha",y[y.R16G16B16A16=7]="R16G16B16A16",y[y.R32G32B32A32=8]="R32G32B32A32",y[y.DXT1=9]="DXT1",y[y.DXT5=10]="DXT5",y[y.ETC1_RGB=11]="ETC1_RGB",y[y.ETC2_RGB=12]="ETC2_RGB",y[y.ETC2_RGBA5=13]="ETC2_RGBA5",y[y.ETC2_RGBA8=14]="ETC2_RGBA8",y[y.PVRTC_RGB2=15]="PVRTC_RGB2",y[y.PVRTC_RGBA2=16]="PVRTC_RGBA2",y[y.PVRTC_RGB4=17]="PVRTC_RGB4",y[y.PVRTC_RGBA4=18]="PVRTC_RGBA4",y[y.ASTC_4x4=19]="ASTC_4x4",y[y.ASTC_5x5=20]="ASTC_5x5",y[y.ASTC_6x6=21]="ASTC_6x6",y[y.ASTC_8x8=22]="ASTC_8x8",y[y.ASTC_10x10=23]="ASTC_10x10",y[y.ASTC_12x12=24]="ASTC_12x12",y[y.Depth=25]="Depth",y[y.DepthStencil=26]="DepthStencil",y[y.Stencil=27]="Stencil",y[y.Depth16=28]="Depth16",y[y.Depth24=29]="Depth24",y[y.Depth32=30]="Depth32",y[y.Depth24Stencil8=31]="Depth24Stencil8",y[y.Depth32Stencil8=32]="Depth32Stencil8",e.TextureWrapMode=void 0,function(e){e[e.Clamp=0]="Clamp",e[e.Repeat=1]="Repeat",e[e.Mirror=2]="Mirror"}(e.TextureWrapMode||(e.TextureWrapMode={})),function(e){e[e.Ignore=0]="Ignore",e[e.Assignment=1]="Assignment",e[e.Shallow=2]="Shallow",e[e.Deep=3]="Deep"}(x||(x={}));var W,j,X,K,q=function(){function e(){}return e.registerCloneMode=function(t,r,n){var i=e._subCloneModeMap.get(t.constructor);i||(i=Object.create(null),e._subCloneModeMap.set(t.constructor,i)),i[r]=n},e.getCloneMode=function(t){var r=e._cloneModeMap.get(t);if(!r){r=Object.create(null),e._cloneModeMap.set(t,r);for(var n=e._objectType,i=e._subCloneModeMap;t!==n;){var a=i.get(t);a&&F(r,a),t=Object.getPrototypeOf(t)}}return r},e.deepCloneObject=function(t,r){switch(t.constructor){case Uint8Array:case Uint16Array:case Uint32Array:case Int8Array:case Int16Array:case Int32Array:case Float32Array:case Float64Array:r.set(t);break;case Array:for(var n=0,i=t.length;n<i;n++)e._deepCloneObjectItem(t,r,n);break;default:var a=t;if(a.clone&&a.cloneTo)a.cloneTo(r);else for(var o=Object.keys(t),s=0,l=o.length;s<l;s++)e._deepCloneObjectItem(t,r,o[s])}},e._deepCloneObjectItem=function(t,r,n){var i=t[n];if(i instanceof Object)switch(i.constructor){case Uint8Array:case Uint16Array:case Uint32Array:case Int8Array:case Int16Array:case Int32Array:case Float32Array:case Float64Array:var a=i,o=r[n];null==o?r[n]=a.slice():o.set(a);break;case Array:var s=i,l=r[n];null==l?r[n]=new Array(s.length):l.length=s.length,e.deepCloneObject(s,l);break;default:if(!i.clone||!i.cloneTo){var u=r[n];null==u&&(r[n]=u=new i.constructor),e.deepCloneObject(i,u);break}var c=i,h=r[n];h?c.cloneTo(h):r[n]=c.clone()}else r[n]=i},e}();q._subCloneModeMap=new Map,q._cloneModeMap=new Map,q._objectType=Object.getPrototypeOf(Object);var Y=((K=function(){function e(e){V(this,"instanceId",j,this),V(this,"_engine",X,this),this._destroyed=!1,this._engine=e}return e.prototype.destroy=function(){var e;this._destroyed||(null===(e=this._engine.resourceManager)||void 0===e||e._deleteAsset(this),this._destroyed=!0)},A(e,[{key:"engine",get:function(){return this._engine}},{key:"destroyed",get:function(){return this._destroyed}}]),e}())._instanceIdCounter=0,j=N((W=K).prototype,"instanceId",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return++Y._instanceIdCounter}}),X=N(W.prototype,"_engine",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),W),Q=function(e){function t(t){var r;return(r=e.call(this,t)||this).isGCIgnored=!1,r._refCount=0,t.resourceManager._addRefObject(r.instanceId,O(r)),r}E(t,e);var r=t.prototype;return r.destroy=function(t){if(void 0===t&&(t=!1),this._destroyed)return!0;if(!t&&0!==this._refCount)return!1;var r=this._engine.resourceManager;r&&(e.prototype.destroy.call(this),r._deleteRefObject(this.instanceId));var n=this._getRefCount();return n>0&&this._addRefCount(-n),this._engine=null,this._onDestroy(),!0},r._getRefCount=function(){return this._refCount},r._addRefCount=function(e){this._refCount+=e},r._addToResourceManager=function(e){this._engine.resourceManager._addAsset(e,this)},A(t,[{key:"refCount",get:function(){return this._refCount}}]),t}(Y),J=function(e){},Z=console.log.bind(console),$=console.info.bind(console),ee=console.warn.bind(console),te=console.error.bind(console),re={debug:J,info:J,warn:J,error:J,isEnabled:!1,enable:function(){this.debug=Z,this.info=$,this.warn=ee,this.error=te,this.isEnabled=!0},disable:function(){this.debug=J,this.info=J,this.warn=J,this.error=J,this.isEnabled=!1}},ne=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).name=void 0,t._platformTexture=void 0,t._mipmap=void 0,t._format=void 0,t._width=void 0,t._height=void 0,t._mipmapCount=void 0,t._wrapModeU=void 0,t._wrapModeV=void 0,t._filterMode=void 0,t._anisoLevel=1,t}E(t,e);var r=t.prototype;return r.generateMipmaps=function(){this._mipmap&&this._platformTexture.generateMipmaps()},r._onDestroy=function(){this._platformTexture.destroy(),this._platformTexture=null},r._getMaxMiplevel=function(e){return Math.floor(Math.log2(e))},r._getMipmapCount=function(){return this._mipmap?Math.floor(Math.log2(Math.max(this._width,this._height)))+1:1},A(t,[{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"wrapModeU",get:function(){return this._wrapModeU},set:function(e){e!==this._wrapModeU&&(this._wrapModeU=e,this._platformTexture.wrapModeU=e)}},{key:"wrapModeV",get:function(){return this._wrapModeV},set:function(e){e!==this._wrapModeV&&(this._wrapModeV=e,this._platformTexture.wrapModeV=e)}},{key:"mipmapCount",get:function(){return this._mipmapCount}},{key:"filterMode",get:function(){return this._filterMode},set:function(e){e!==this._filterMode&&(this._filterMode=e,this._platformTexture.filterMode=e)}},{key:"anisoLevel",get:function(){return this._anisoLevel},set:function(e){var t=this._engine._hardwareRenderer.capability.maxAnisoLevel;e>t&&(re.warn("anisoLevel:"+e+", exceeds the limit and is automatically downgraded to:"+t),e=t),e<1&&(re.warn("anisoLevel:"+e+", must be greater than 0, and is automatically downgraded to 1"),e=1),e!==this._anisoLevel&&(this._anisoLevel=e,this._platformTexture.anisoLevel=e)}}]),t}(Q),ie=function(t){function r(r,n,i,a,o){var s;return void 0===a&&(a=e.TextureFormat.R8G8B8A8),void 0===o&&(o=!0),(s=t.call(this,r)||this)._mipmap=o,s._width=n,s._height=i,s._format=a,s._mipmapCount=s._getMipmapCount(),s._platformTexture=r._hardwareRenderer.createPlatformTexture2D(O(s)),s.filterMode=e.TextureFilterMode.Bilinear,s.wrapModeU=s.wrapModeV=e.TextureWrapMode.Repeat,s}E(r,t);var n=r.prototype;return n.setPixelBuffer=function(e,t,r,n,i,a){void 0===t&&(t=0),void 0===r&&(r=0),void 0===n&&(n=0),this._platformTexture.setPixelBuffer(e,t,r,n,i,a)},n.setImageSource=function(e,t,r,n,i,a){void 0===t&&(t=0),void 0===r&&(r=!1),void 0===n&&(n=!1),void 0===i&&(i=0),void 0===a&&(a=0),this._platformTexture.setImageSource(e,t,r,n,i,a)},n.getPixelBuffer=function(e,t,r,n,i,a){var o=arguments.length;1===o?this._platformTexture.getPixelBuffer(0,0,this._width,this._height,0,e):2===o?this._platformTexture.getPixelBuffer(0,0,this._width>>e,this._height>>e,e,t):5===o?this._platformTexture.getPixelBuffer(e,t,r,n,0,i):6===o&&this._platformTexture.getPixelBuffer(e,t,r,n,i,a)},r}(ne),ae=function(){function e(e,t,r){this._texture=void 0,this._width=void 0,this._height=void 0,this._space=1,this._curX=1,this._curY=1,this._nextY=1,this._sprites={},this._width=t,this._height=r,this._texture=new ie(e,t,r),this._texture._addRefCount(1)}var t=e.prototype;return t.destroy=function(){this._sprites={},this._texture.destroy(!0)},t.addSprite=function(t,r){var n=this._space,i=this._texture,a=r.width,o=r.height,s=this._curX+a+n;s>=this._width&&(this._curX=n,this._curY=this._nextY+n);var l=this._curY+o+n;if(l>this._nextY&&(this._nextY=l),this._nextY>=this._height)return!1;i.setImageSource(r,0,!1,!1,this._curX,this._curY),i.generateMipmaps();var u=this._width,c=this._height,h=e._region;return h.setValue(this._curX/u,this._curY/c,a/u,o/c),t.texture&&t.texture.destroy(),t.atlasRegion=h,t.texture=i,this._curX=s+n,!0},t.removeSprite=function(e){var t=e.instanceId,r=this._sprites;return!!r[t]&&(delete r[t],!0)},e}();ae._region=new w;var oe,se=function(){function e(e){this.engine=e,this._maxAtlasCount=2,this._textureSize=1024,this._atlases=[],this._atlasIndex=-1,this._spritesInAtlasIndex={}}var t=e.prototype;return t.addSprite=function(e,t){var r=this._spritesInAtlasIndex,n=this._atlases,i=e.instanceId,a=r[i];if(a&&(n[a].removeSprite(e),delete r[i]),this._atlasIndex>=this._maxAtlasCount)return!1;var o=n[this._atlasIndex];return o||(o=this._createAtlas()),o.addSprite(e,t)?(r[i]=this._atlasIndex,!0):this._atlasIndex+1>=this._maxAtlasCount?(this._atlasIndex=this._maxAtlasCount,!1):!!(o=this._createAtlas()).addSprite(e,t)&&(r[i]=this._atlasIndex,!0)},t.removeSprite=function(e){if(!e)return!1;for(var t=this._atlases,r=t.length-1;r>=0;--r)if(t[r].removeSprite(e))return delete this._spritesInAtlasIndex[r],!0;return!1},t.reset=function(){for(var e=this._atlases,t=0,r=e.length;t<r;++t)e[t].destroy();e.length=0,this._atlasIndex=-1,this._spritesInAtlasIndex={}},t._createAtlas=function(){this._atlasIndex++;var e=this._textureSize,t=new ae(this.engine,e,e);return this._atlases.push(t),t},A(e,[{key:"maxAtlasCount",get:function(){return this._maxAtlasCount},set:function(e){this._maxAtlasCount=e}},{key:"textureSize",get:function(){return this._textureSize},set:function(e){this._textureSize=Math.min(e,2048)}}]),e}(),le={isArray:"isArray"in Array?Array.isArray:function(e){return"[object Array]"===toString.call(e)},isArrayLike:function(e){return!!e&&"number"==typeof e.length&&"function"!=typeof e},clone:function(e){if("object"!=typeof e||null===e)return e;var t;if(le.isArrayLike(e)){t=e.slice();for(var r=0,n=e.length;r<n;r++)t[r]=le.clone(e[r])}else for(var i in t={},e)e.hasOwnProperty(i)&&(t[i]=le.clone(e[i]));return t},downloadBlob:function(e,t){void 0===t&&(t="");var r=window.URL.createObjectURL(e),n=document.createElement("a");document.body.appendChild(n),n.style.display="none",n.href=r,n.download=t,n.addEventListener("click",(function(){n.parentElement&&n.parentElement.removeChild(n)})),n.click(),window.URL.revokeObjectURL(r)}};function ue(e,t){var r=e.indexOf(t);if(r<0)return!1;var n=e.length-1;if(r!==n){var i=e[n];e[r]=i}return e.length--,!0}function ce(e){return Object.keys(e).map((function(t){return e[t]}))}e.AssetPromiseStatus=void 0,(oe=e.AssetPromiseStatus||(e.AssetPromiseStatus={}))[oe.Success=0]="Success",oe[oe.Pending=1]="Pending",oe[oe.Failed=2]="Failed";var he=function(t){E(n,t),n.all=function(e){return new n((function(t,r,n){if(!Array.isArray(e))return t([e]);var i=0,a=e.length,o=new Array(a);e.forEach((function(e,s){Promise.resolve(e).then((function(e){o[s]=e,n((i+=1)/a),i==a&&t(o)})).catch((function(e){return r(e)}))}))}))};var r=n.prototype;function n(r){var n,i,a=function(e){if(!(e<=n._progress)){n._progress=e;for(var t,r=function(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(r)return(r=r.call(e)).next.bind(r);if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return z(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?z(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(n._listeners);!(t=r()).done;)(0,t.value)(e)}};return(n=t.call(this,(function(t,o){r((function(r){Promise.resolve().then((function(){a(1),n._status=e.AssetPromiseStatus.Success,t(r)}))}),i=function(t){Promise.resolve().then((function(){n._status=e.AssetPromiseStatus.Failed,o(t)}))},(function(e){Promise.resolve().then((function(){a(e)}))}))}))||this)._status=void 0,n._progress=void 0,n._reject=void 0,n._listeners=void 0,n._reject=i,n._listeners=new Set,n._progress=0,n._status=e.AssetPromiseStatus.Pending,n}return r.onProgress=function(e){return this._listeners.add(e),this},r.cancel=function(){return this._status!==e.AssetPromiseStatus.Pending||this._reject("Promise Canceled"),this},A(n,[{key:"status",get:function(){return this._status}},{key:"progress",get:function(){return this._progress}}]),n}(I(Promise)),de=function(){function e(e){this.engine=e,this.retryCount=1,this.retryInterval=0,this.timeout=2e4,this._assetPool=Object.create(null),this._assetUrlPool=Object.create(null),this._refObjectPool=Object.create(null),this._loadingPromises={}}e._addLoader=function(e,t,r){this._loaders[e]=t;for(var n=0,i=r.length;n<i;n++)this._extTypeMapping[r[n]]=e},e._getTypeByUrl=function(e){var t=e.split("?")[0];return this._extTypeMapping[t.substring(t.lastIndexOf(".")+1)]};var t=e.prototype;return t.load=function(e){var t=this;if(!Array.isArray(e))return this._loadSingleItem(e);var r=e.map((function(e){return t._loadSingleItem(e)}));return he.all(r)},t.cancelNotLoaded=function(e){var t,r=this;e?"string"==typeof e?null===(t=this._loadingPromises[e])||void 0===t||t.cancel():e.forEach((function(e){var t;null===(t=r._loadingPromises[e])||void 0===t||t.cancel()})):ce(this._loadingPromises).forEach((function(e){e.cancel()}))},t.gc=function(){this._gc(!1)},t.getAssetPath=function(e){return this._assetPool[e]},t._addAsset=function(e,t){this._assetPool[t.instanceId]=e,this._assetUrlPool[e]=t},t._deleteAsset=function(e){var t=e.instanceId,r=this._assetPool[t];r&&(delete this._assetPool[t],delete this._assetUrlPool[r])},t._addRefObject=function(e,t){this._refObjectPool[e]=t},t._deleteRefObject=function(e){delete this._refObjectPool[e]},t._destroy=function(){this.cancelNotLoaded(),this._gc(!0),this._assetPool=null,this._assetUrlPool=null,this._refObjectPool=null,this._loadingPromises=null},t._assignDefaultOptions=function(t){var r,n,i,a,o;if(t.type=null!=(r=t.type)?r:e._getTypeByUrl(t.url),void 0===t.type)throw"asset type should be specified: "+t.url;return t.retryCount=null!=(n=t.retryCount)?n:this.retryCount,t.timeout=null!=(i=t.timeout)?i:this.timeout,t.retryInterval=null!=(a=t.retryInterval)?a:this.retryInterval,t.url=null!=(o=t.url)?o:t.urls.join(","),t},t._loadSingleItem=function(t){var r=this,n=this._assignDefaultOptions("string"==typeof t?{url:t}:t),i=n.url;if(this._assetUrlPool[i])return new he((function(e){e(r._assetUrlPool[i])}));if(this._loadingPromises[i])return this._loadingPromises[n.url];var a=e._loaders[n.type],o=a.load(n,this);return this._loadingPromises[i]=o,o.then((function(e){a.useCache&&r._addAsset(i,e),delete r._loadingPromises[i]})).catch((function(e){Promise.reject(e),delete r._loadingPromises[i]})),o},t._gc=function(e){for(var t=ce(this._refObjectPool),r=0,n=t.length;r<n;r++)t[r].isGCIgnored&&!e||t[r].destroy()},e}();function _e(e,t,r){return void 0===r&&(r=!0),function(n){var i=new n(r);de._addLoader(e,i,t)}}de._loaders={},de._extTypeMapping={};var fe,pe,ge,ve,me=function(){function e(e,t,r,n){void 0===t&&(t=null),void 0===r&&(r={}),void 0===n&&(n=!0),this.data=void 0,this._timeStamp=void 0,this._target=void 0,this._currentTarget=void 0,this._bubbles=void 0,this._propagationStopped=void 0,this._type=void 0,this._timeStamp=(new Date).getTime(),this._target=t,this.data=r,this._currentTarget=null,this._bubbles=n,this._propagationStopped=!1,this._type=e}return e.prototype.stopPropagation=function(){this._propagationStopped=!0},A(e,[{key:"propagationStopped",get:function(){return this._propagationStopped}},{key:"target",get:function(){return this._target},set:function(e){this._target=e}},{key:"timeStamp",get:function(){return this._timeStamp}},{key:"currentTarget",get:function(){return this._currentTarget},set:function(e){this._currentTarget=e}},{key:"bubbles",get:function(){return this._bubbles}},{key:"type",get:function(){return this._type}}]),e}(),ye=(fe=function(){function e(){V(this,"_evts",pe,this),this._evtCount=0}var t=e.prototype;return t.hasEvent=function(e){return null!=this._evts[e]},t.eventNames=function(){return 0===this._evtCount?[]:Object.keys(this._evts)},t.listenerCount=function(e){var t=this._evts[e];return t?t.fn?1:t.length:0},t.dispatch=function(e,t){if(!this._evts[e])return!1;var r=this._evts[e];if(r.fn)r.once&&this.removeEventListener(e,r.fn),r.fn(t);else for(var n=r.length,i=0;i<n;i++)r[i].once&&this.removeEventListener(e,r[i].fn),r[i].fn(t);return!0},t.on=function(e,t){return this.addEventListener(e,t)},t.once=function(e,t){return this.addEventListener(e,t,!0)},t.addEventListener=function(e,t,r){var n={fn:t,once:r},i=this._evts;return i[e]?i[e].fn?i[e]=[i[e],n]:i[e].push(n):(i[e]=n,this._evtCount++),this},t.off=function(e,t){if(!this._evts[e])return this;if(!t)return this._clearEvent(e),this;var r=this._evts[e];if(r.fn&&r.fn===t)this._clearEvent(e);else{var n=r.indexOf(t);if(n>-1){var i=r[r.length-1];r[n]=i,r.length--,1===r.length&&(this._evts[e]=r[0])}}return this},t.removeEventListener=function(e,t){return this.off(e,t)},t.removeAllEventListeners=function(e){e?this._evts[e]&&this._clearEvent(e):(this._evts=Object.create(null),this._evtCount=0)},t.trigger=function(e){this.dispatch(e.type,e.data)},t._clearEvent=function(e){0==--this._evtCount?this._evts=Object.create(null):delete this._evts[e]},e}(),pe=N(fe.prototype,"_evts",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Object.create(null)}}),fe),xe=function(){function e(){this._clock=void 0,this._timeScale=void 0,this._deltaTime=void 0,this._startTime=void 0,this._lastTickTime=void 0,this._clock=performance||Date,this._timeScale=1,this._deltaTime=1e-4;var e=this._clock.now();this._startTime=e,this._lastTickTime=e}var t=e.prototype;return t.reset=function(){this._lastTickTime=this._clock.now()},t.tick=function(){var e=this.nowTime;this._deltaTime=(e-this._lastTickTime)*this._timeScale,this._lastTickTime=e},A(e,[{key:"nowTime",get:function(){return this._clock.now()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"timeScale",get:function(){return this._timeScale},set:function(e){this._timeScale=e}},{key:"unscaledDeltaTime",get:function(){return this._deltaTime/this._timeScale}},{key:"timeSinceStartup",get:function(){return this.nowTime-this._startTime}}]),e}();e.DataType=void 0,(ge=e.DataType||(e.DataType={}))[ge.FLOAT=5126]="FLOAT",ge[ge.FLOAT_VEC2=35664]="FLOAT_VEC2",ge[ge.FLOAT_VEC3=35665]="FLOAT_VEC3",ge[ge.FLOAT_VEC4=35666]="FLOAT_VEC4",ge[ge.INT=5124]="INT",ge[ge.INT_VEC2=35667]="INT_VEC2",ge[ge.INT_VEC3=35668]="INT_VEC3",ge[ge.INT_VEC4=35669]="INT_VEC4",ge[ge.BOOL=35670]="BOOL",ge[ge.BOOL_VEC2=35671]="BOOL_VEC2",ge[ge.BOOL_VEC3=35672]="BOOL_VEC3",ge[ge.BOOL_VEC4=35673]="BOOL_VEC4",ge[ge.FLOAT_MAT2=35674]="FLOAT_MAT2",ge[ge.FLOAT_MAT3=35675]="FLOAT_MAT3",ge[ge.FLOAT_MAT4=35676]="FLOAT_MAT4",ge[ge.FLOAT_ARRAY=35677]="FLOAT_ARRAY",ge[ge.FLOAT_VEC2_ARRAY=1e5]="FLOAT_VEC2_ARRAY",ge[ge.FLOAT_VEC3_ARRAY=100001]="FLOAT_VEC3_ARRAY",ge[ge.FLOAT_VEC4_ARRAY=100002]="FLOAT_VEC4_ARRAY",ge[ge.INT_ARRAY=100003]="INT_ARRAY",ge[ge.INT_VEC2_ARRAY=100004]="INT_VEC2_ARRAY",ge[ge.INT_VEC3_ARRAY=100005]="INT_VEC3_ARRAY",ge[ge.INT_VEC4_ARRAY=100006]="INT_VEC4_ARRAY",ge[ge.FLOAT_MAT2_ARRAY=100007]="FLOAT_MAT2_ARRAY",ge[ge.FLOAT_MAT3_ARRAY=100008]="FLOAT_MAT3_ARRAY",ge[ge.FLOAT_MAT4_ARRAY=100009]="FLOAT_MAT4_ARRAY",ge[ge.SAMPLER_2D_ARRAY=100010]="SAMPLER_2D_ARRAY",ge[ge.SAMPLER_CUBE_ARRAY=100011]="SAMPLER_CUBE_ARRAY",ge[ge.SAMPLER_2D=35678]="SAMPLER_2D",ge[ge.SAMPLER_CUBE=35680]="SAMPLER_CUBE",ge[ge.BYTE=5120]="BYTE",ge[ge.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",ge[ge.SHORT=5122]="SHORT",ge[ge.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",ge[ge.UNSIGNED_INT=5125]="UNSIGNED_INT",e.GLCapabilityType=void 0,(ve=e.GLCapabilityType||(e.GLCapabilityType={})).shaderVertexID="shaderVertexID",ve.standardDerivatives="OES_standard_derivatives",ve.shaderTextureLod="EXT_shader_texture_lod",ve.elementIndexUint="OES_element_index_uint",ve.depthTexture="WEBGL_depth_texture",ve.drawBuffers="WEBGL_draw_buffers",ve.vertexArrayObject="OES_vertex_array_object",ve.instancedArrays="ANGLE_instanced_arrays",ve.multipleSample="multipleSampleOnlySupportedInWebGL2",ve.textureFloat="OES_texture_float",ve.textureFloatLinear="OES_texture_float_linear",ve.textureHalfFloat="OES_texture_half_float",ve.textureHalfFloatLinear="OES_texture_half_float_linear",ve.WEBGL_colorBufferFloat="WEBGL_color_buffer_float",ve.colorBufferFloat="EXT_color_buffer_float",ve.colorBufferHalfFloat="EXT_color_buffer_half_float",ve.textureFilterAnisotropic="EXT_texture_filter_anisotropic",ve.blendMinMax="EXT_blend_minmax",ve.astc="WEBGL_compressed_texture_astc",ve.astc_webkit="WEBKIT_WEBGL_compressed_texture_astc",ve.etc="WEBGL_compressed_texture_etc",ve.etc_webkit="WEBKIT_WEBGL_compressed_texture_etc",ve.etc1="WEBGL_compressed_texture_etc1",ve.etc1_webkit="WEBKIT_WEBGL_compressed_texture_etc1",ve.pvrtc="WEBGL_compressed_texture_pvrtc",ve.pvrtc_webkit="WEBKIT_WEBGL_compressed_texture_pvrtc",ve.s3tc="WEBGL_compressed_texture_s3tc",ve.s3tc_webkit="WEBKIT_WEBGL_compressed_texture_s3tc";var Te=function(){function e(e){void 0===e&&(e=0),this._elements=void 0,this.length=0,this._elements=new Array(e)}var t=e.prototype;return t.add=function(e){this.length===this._elements.length?this._elements.push(e):this._elements[this.length]=e,this.length++},t.delete=function(e){var t=this._elements.indexOf(e);this.deleteByIndex(t)},t.get=function(e){if(e>=this.length)throw"Index is out of range.";return this._elements[e]},t.deleteByIndex=function(e){var t=this._elements,r=null,n=this.length-1;return e!==n&&(r=t[n],t[e]=r),this.length--,r},t.garbageCollection=function(){this._elements.length=this.length},e}(),we=function(){function e(){this._mask=[],this._length=0}e.unionCollection=function(e,t,r){var n,i,a,o,s=r._mask;e._length<t._length?(n=e._length,i=t._length,a=e._mask,o=t._mask):(n=t._length,i=e._length,a=t._mask,o=e._mask);var l=0;for(s.length<i&&(s.length=i);l<n;l++)s[l]=a[l]|o[l];for(;l<i;l++)s[l]=o[l];r._length=i};var t=e.prototype;return t.enable=function(e){var t=e._index,r=t+1,n=this._mask,i=this._length;if(i<r){for(n.length<r&&(n.length=r);i<t;i++)n[i]=0;n[t]=e._value,this._length=r}else n[t]|=e._value},t.disable=function(e){var t=e._index,r=this._mask,n=this._length-1;if(!(t>n)){var i=r[t]&~e._value;t==n&&0===i?this._length--:r[t]=i}},t.unionCollection=function(e){var t=e._mask,r=e._length,n=this._mask,i=this._length;if(i<r){n.length<r&&(n.length=r);for(var a=0;a<i;a++)n[a]|=t[a];for(;a<r;a++)n[a]=t[a];this._length=r}else for(var o=0;o<r;o++)n[o]|=t[o]},t.complementaryCollection=function(e){for(var t=e._mask,r=this._mask,n=this._length-1,i=Math.min(e._length-1,n);i>=0;i--){var a=r[i]&~t[i];i==n&&0===a?(n--,this._length--):r[i]=a}},t.intersectionCollection=function(e){for(var t=e._mask,r=this._mask,n=this._length-1;n>=0;n--){var i=r[n]&t[n];0==i&&n==this._length-1?this._length--:r[n]=i}},t.isEnable=function(e){var t=e._index;return!(t>=this._length)&&0!=(this._mask[t]&e._value)},t.clear=function(){this._length=0},e}(),be=function(){function e(){this._onStartScripts=new Te,this._onUpdateScripts=new Te,this._onLateUpdateScripts=new Te,this._onPhysicsUpdateScripts=new Te,this._disableScripts=[],this._destroyScripts=[],this._onUpdateAnimations=new Te,this._renderers=new Te,this._onUpdateRenderers=new Te,this._componentsContainerPool=[],this._colliders=new Te}var t=e.prototype;return t.addRenderer=function(e){e._rendererIndex=this._renderers.length,this._renderers.add(e)},t.removeRenderer=function(e){var t=this._renderers.deleteByIndex(e._rendererIndex);t&&(t._rendererIndex=e._rendererIndex),e._rendererIndex=-1},t.addOnStartScript=function(e){e._onStartIndex=this._onStartScripts.length,this._onStartScripts.add(e)},t.removeOnStartScript=function(e){var t=this._onStartScripts.deleteByIndex(e._onStartIndex);t&&(t._onStartIndex=e._onStartIndex),e._onStartIndex=-1},t.addCollider=function(e){e._index=this._colliders.length,this._colliders.add(e)},t.removeCollider=function(e){var t=this._colliders.deleteByIndex(e._index);t&&(t._index=e._index),e._index=-1},t.addOnUpdateScript=function(e){e._onUpdateIndex=this._onUpdateScripts.length,this._onUpdateScripts.add(e)},t.removeOnUpdateScript=function(e){var t=this._onUpdateScripts.deleteByIndex(e._onUpdateIndex);t&&(t._onUpdateIndex=e._onUpdateIndex),e._onUpdateIndex=-1},t.addOnLateUpdateScript=function(e){e._onLateUpdateIndex=this._onLateUpdateScripts.length,this._onLateUpdateScripts.add(e)},t.removeOnLateUpdateScript=function(e){var t=this._onLateUpdateScripts.deleteByIndex(e._onLateUpdateIndex);t&&(t._onLateUpdateIndex=e._onLateUpdateIndex),e._onLateUpdateIndex=-1},t.addOnPhysicsUpdateScript=function(e){e._onPhysicsUpdateIndex=this._onPhysicsUpdateScripts.length,this._onPhysicsUpdateScripts.add(e)},t.removeOnPhysicsUpdateScript=function(e){var t=this._onPhysicsUpdateScripts.deleteByIndex(e._onPhysicsUpdateIndex);t&&(t._onPhysicsUpdateIndex=e._onPhysicsUpdateIndex),e._onPhysicsUpdateIndex=-1},t.addOnUpdateAnimations=function(e){e._onUpdateIndex=this._onUpdateAnimations.length,this._onUpdateAnimations.add(e)},t.removeOnUpdateAnimations=function(e){var t=this._onUpdateAnimations.deleteByIndex(e._onUpdateIndex);t&&(t._onUpdateIndex=e._onUpdateIndex),e._onUpdateIndex=-1},t.addOnUpdateRenderers=function(e){e._onUpdateIndex=this._onUpdateRenderers.length,this._onUpdateRenderers.add(e)},t.removeOnUpdateRenderers=function(e){var t=this._onUpdateRenderers.deleteByIndex(e._onUpdateIndex);t&&(t._onUpdateIndex=e._onUpdateIndex),e._onUpdateIndex=-1},t.addDisableScript=function(e){this._disableScripts.push(e)},t.addDestroyScript=function(e){this._destroyScripts.push(e)},t.callScriptOnStart=function(){var e=this._onStartScripts;if(e.length>0){for(var t=e._elements,r=0;r<e.length;r++){var n=t[r];n._waitHandlingInValid||(n._started=!0,n._onStartIndex=-1,n.onStart())}e.length=0}},t.callScriptOnUpdate=function(e){for(var t=this._onUpdateScripts._elements,r=this._onUpdateScripts.length-1;r>=0;--r){var n=t[r];!n._waitHandlingInValid&&n._started&&n.onUpdate(e)}},t.callScriptOnLateUpdate=function(e){for(var t=this._onLateUpdateScripts._elements,r=this._onLateUpdateScripts.length-1;r>=0;--r){var n=t[r];!n._waitHandlingInValid&&n._started&&n.onLateUpdate(e)}},t.callScriptOnPhysicsUpdate=function(){for(var e=this._onPhysicsUpdateScripts._elements,t=this._onPhysicsUpdateScripts.length-1;t>=0;--t){var r=e[t];!r._waitHandlingInValid&&r._started&&r.onPhysicsUpdate()}},t.callAnimationUpdate=function(e){for(var t=this._onUpdateAnimations._elements,r=this._onUpdateAnimations.length-1;r>=0;--r)t[r].update(e)},t.callRendererOnUpdate=function(e){for(var t=this._onUpdateRenderers._elements,r=this._onUpdateRenderers.length-1;r>=0;--r)t[r].update(e)},t.callRender=function(t){for(var r=t._camera,n=this._renderers._elements,i=this._renderers.length-1;i>=0;--i){var a=n[i];if(r.cullingMask&a._entity.layer&&(!r.enableFrustumCulling||(a.isCulled=!r._frustum.intersectsBox(a.bounds),!a.isCulled))){var s=r.entity.transform,l=s.worldPosition,u=a.bounds.getCenter(e._tempVector0);if(r.isOrthographic){var c=s.getWorldForward(e._tempVector1);o.subtract(u,l,u),a._distanceForSort=o.dot(u,c)}else a._distanceForSort=o.distanceSquared(u,l);a._updateShaderData(t),a._render(r),we.unionCollection(r._globalShaderMacro,a.shaderData._macroCollection,a._globalShaderMacro)}}},t.handlingInvalidScripts=function(){var e=this._disableScripts,t=this._destroyScripts,r=e.length;if(r>0){for(var n=r-1;n>=0;n--){var i=e[n];i._waitHandlingInValid&&i._handlingInValid()}e.length=0}if((r=t.length)>0){for(var a=r-1;a>=0;a--)t[a].onDestroy();t.length=0}},t.callCameraOnBeginRender=function(e){for(var t=e.entity._scripts,r=t.length-1;r>=0;--r){var n=t.get(r);n._waitHandlingInValid||n.onBeginRender(e)}},t.callCameraOnEndRender=function(e){for(var t=e.entity._scripts,r=t.length-1;r>=0;--r){var n=t.get(r);n._waitHandlingInValid||n.onEndRender(e)}},t.callColliderOnUpdate=function(){for(var e=this._colliders._elements,t=this._colliders.length-1;t>=0;--t)e[t]._onUpdate()},t.callColliderOnLateUpdate=function(){for(var e=this._colliders._elements,t=this._colliders.length-1;t>=0;--t)e[t]._onLateUpdate()},t.getActiveChangedTempList=function(){return this._componentsContainerPool.length?this._componentsContainerPool.pop():[]},t.putActiveChangedTempList=function(e){e.length=0,this._componentsContainerPool.push(e)},e}();be._tempVector0=new o,be._tempVector1=new o;var Ce,Se=function(){function e(){}return e.cloneComponent=function(e,t){for(var r=q.getCloneMode(e.constructor),n=Object.keys(e),i=0,a=n.length;i<a;i++){var o=n[i];switch(r[o]){case void 0:case x.Assignment:t[o]=e[o];break;case x.Shallow:var s=e[o];if(s instanceof Object){var l=t[o];null==l&&(l=t[o]=s.constructor()),F(l,s)}else t[o]=s;break;case x.Deep:var u=e[o];if(u instanceof Object){var c=t[o];null==c&&(c=t[o]=u.constructor()),q.deepCloneObject(u,c)}else t[o]=u}}e._cloneTo&&e._cloneTo(t)},e}(),Me=function(){function e(){}return e.register=function(e,t){this._addDependency(e,t,this._dependenciesMap),this._addDependency(t,e,this._invDependenciesMap)},e._addCheck=function(t,r){var n=e._dependenciesMap.get(r);if(n)for(var i=0,a=n.length;i<a;i++)if(!t.getComponent(n[i]))throw"you should add "+n[i]+" before adding "+r},e._removeCheck=function(t,r){var n=e._invDependenciesMap.get(r);if(n)for(var i=0,a=n.length;i<a;i++)if(t.getComponent(n[i]))throw"you should remove "+n[i]+" before adding "+r},e._addDependency=function(e,t,r){var n=r.get(e);n||(n=[],r.set(e,n)),-1===n.indexOf(t)&&n.push(t)},e}();function Ae(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return function(e){t.forEach((function(t){return Me.register(e,t)}))}}Me._dependenciesMap=new Map,Me._invDependenciesMap=new Map,e.Layer=void 0,(Ce=e.Layer||(e.Layer={}))[Ce.Layer0=1]="Layer0",Ce[Ce.Layer1=2]="Layer1",Ce[Ce.Layer2=4]="Layer2",Ce[Ce.Layer3=8]="Layer3",Ce[Ce.Layer4=16]="Layer4",Ce[Ce.Layer5=32]="Layer5",Ce[Ce.Layer6=64]="Layer6",Ce[Ce.Layer7=128]="Layer7",Ce[Ce.Layer8=256]="Layer8",Ce[Ce.Layer9=512]="Layer9",Ce[Ce.Layer10=1024]="Layer10",Ce[Ce.Layer11=2048]="Layer11",Ce[Ce.Layer12=4096]="Layer12",Ce[Ce.Layer13=8192]="Layer13",Ce[Ce.Layer14=16384]="Layer14",Ce[Ce.Layer15=32768]="Layer15",Ce[Ce.Layer16=65536]="Layer16",Ce[Ce.Layer17=131072]="Layer17",Ce[Ce.Layer18=262144]="Layer18",Ce[Ce.Layer19=524288]="Layer19",Ce[Ce.Layer20=1048576]="Layer20",Ce[Ce.Layer21=2097152]="Layer21",Ce[Ce.Layer22=4194304]="Layer22",Ce[Ce.Layer23=8388608]="Layer23",Ce[Ce.Layer24=16777216]="Layer24",Ce[Ce.Layer25=33554432]="Layer25",Ce[Ce.Layer26=67108864]="Layer26",Ce[Ce.Layer27=134217728]="Layer27",Ce[Ce.Layer28=268435456]="Layer28",Ce[Ce.Layer29=536870912]="Layer29",Ce[Ce.Layer30=1073741824]="Layer30",Ce[Ce.Layer31=2147483648]="Layer31",Ce[Ce.Everything=4294967295]="Everything",Ce[Ce.Nothing=0]="Nothing";var Pe,Fe,Ee,Re,Le,Be,De,Ie,Oe,ze,Ve,Ne,Ue,ke,Ge,He,We,je,Xe,Ke,qe,Ye=function(){function e(){this._flagManagers=[]}var t=e.prototype;return t.clearFromManagers=function(){this._removeFromManagers(),this._flagManagers.length=0},t.destroy=function(){this._removeFromManagers(),this._flagManagers=null},t._removeFromManagers=function(){for(var e=this._flagManagers,t=0,r=e.length;t<r;t++)ue(e[t]._updateFlags,this)},e}(),Qe=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).flag=!0,t}return E(t,e),t.prototype.dispatch=function(){this.flag=!0},t}(Ye),Je=(Pe=function(e){function t(t){var r;return V(r=e.call(this,t.engine)||this,"_entity",Fe,O(r)),V(r,"_destroyed",Ee,O(r)),V(r,"_enabled",Re,O(r)),V(r,"_awoken",Le,O(r)),r._entity=t,r}E(t,e);var r=t.prototype;return r.destroy=function(){this._destroyed||(this._entity._removeComponent(this),this._entity.isActiveInHierarchy&&this._enabled&&this._onDisable(),this._destroyed=!0,this._onDestroy())},r._onAwake=function(){},r._onEnable=function(){},r._onDisable=function(){},r._onDestroy=function(){},r._setActive=function(e){e?(this._awoken||(this._awoken=!0,this._onAwake()),this._entity._isActiveInHierarchy&&this._enabled&&this._onEnable()):this._enabled&&this._onDisable()},A(t,[{key:"enabled",get:function(){return this._enabled},set:function(e){e!==this._enabled&&(this._enabled=e,e?this._entity.isActiveInHierarchy&&this._onEnable():this._entity.isActiveInHierarchy&&this._onDisable())}},{key:"destroyed",get:function(){return this._destroyed}},{key:"entity",get:function(){return this._entity}},{key:"scene",get:function(){return this._entity.scene}}]),t}(Y),Fe=N(Pe.prototype,"_entity",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ee=N(Pe.prototype,"_destroyed",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Re=N(Pe.prototype,"_enabled",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Le=N(Pe.prototype,"_awoken",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Pe),Ze=function(){function e(){this._updateFlags=[]}var t=e.prototype;return t.createFlag=function(e){var t=new e;return this.addFlag(t),t},t.addFlag=function(e){this._updateFlags.push(e),e._flagManagers.push(this)},t.dispatch=function(e){for(var t=this._updateFlags,r=t.length-1;r>=0;r--)t[r].dispatch(e)},e}(),$e=((Ke=function(e){function t(t){var r;return V(r=e.call(this,t)||this,"_position",De,O(r)),V(r,"_rotation",Ie,O(r)),V(r,"_rotationQuaternion",Oe,O(r)),V(r,"_scale",ze,O(r)),V(r,"_worldPosition",Ve,O(r)),V(r,"_worldRotation",Ne,O(r)),V(r,"_worldRotationQuaternion",Ue,O(r)),V(r,"_lossyWorldScale",ke,O(r)),V(r,"_localMatrix",Ge,O(r)),V(r,"_worldMatrix",He,O(r)),V(r,"_updateFlagManager",We,O(r)),V(r,"_isParentDirty",je,O(r)),V(r,"_parentTransformCache",Xe,O(r)),r._dirtyFlag=qe.WmWpWeWqWs,r._onPositionChanged=r._onPositionChanged.bind(O(r)),r._onWorldPositionChanged=r._onWorldPositionChanged.bind(O(r)),r._onRotationChanged=r._onRotationChanged.bind(O(r)),r._onWorldRotationChanged=r._onWorldRotationChanged.bind(O(r)),r._onRotationQuaternionChanged=r._onRotationQuaternionChanged.bind(O(r)),r._onWorldRotationQuaternionChanged=r._onWorldRotationQuaternionChanged.bind(O(r)),r._onScaleChanged=r._onScaleChanged.bind(O(r)),r._position._onValueChanged=r._onPositionChanged,r._worldPosition._onValueChanged=r._onWorldPositionChanged,r._rotation._onValueChanged=r._onRotationChanged,r._worldRotation._onValueChanged=r._onWorldRotationChanged,r._rotationQuaternion._onValueChanged=r._onRotationQuaternionChanged,r._worldRotationQuaternion._onValueChanged=r._onWorldRotationQuaternionChanged,r._scale._onValueChanged=r._onScaleChanged,r}E(t,e);var r=t.prototype;return r.setPosition=function(e,t,r){this._position.setValue(e,t,r)},r.setRotation=function(e,t,r){this._rotation.setValue(e,t,r)},r.setRotationQuaternion=function(e,t,r,n){this._rotationQuaternion.setValue(e,t,r,n)},r.setScale=function(e,t,r){this._scale.setValue(e,t,r)},r.setWorldPosition=function(e,t,r){this._worldPosition.setValue(e,t,r)},r.setWorldRotation=function(e,t,r){this._worldRotation.setValue(e,t,r)},r.setWorldRotationQuaternion=function(e,t,r,n){this._worldRotationQuaternion.setValue(e,t,r,n)},r.getWorldForward=function(e){var t=this.worldMatrix.elements;return e.setValue(-t[8],-t[9],-t[10]),e.normalize()},r.getWorldRight=function(e){var t=this.worldMatrix.elements;return e.setValue(t[0],t[1],t[2]),e.normalize()},r.getWorldUp=function(e){var t=this.worldMatrix.elements;return e.setValue(t[4],t[5],t[6]),e.normalize()},r.translate=function(e,r,n,i){if("number"==typeof e){var a=t._tempVec30;a.setValue(e,r,n),this._translate(a,i)}else this._translate(e,r)},r.rotate=function(e,t,r,n){"number"==typeof e?this._rotateXYZ(e,t,r,n):this._rotateXYZ(e.x,e.y,e.z,t)},r.rotateByAxis=function(e,r,n){void 0===n&&(n=!0);var i=r*a.degreeToRadFactor;_.rotationAxisAngle(e,i,t._tempQuat0),this._rotateByQuat(t._tempQuat0,n)},r.lookAt=function(e,r){var n=t._tempVec30;o.subtract(this.worldPosition,e,n);var i=n.length();if(!(i<=a.zeroTolerance)){n.scale(1/i);var s=t._tempVec31;if(r?o.cross(r,n,s):s.setValue(n.z,0,-n.x),!((i=s.length())<=a.zeroTolerance)){s.scale(1/i);var l=t._tempVec32;o.cross(n,s,l);var u=t._tempMat41,c=u.elements;c[0]=s.x,c[1]=s.y,c[2]=s.z,c[4]=l.x,c[5]=l.y,c[6]=l.z,c[8]=n.x,c[9]=n.y,c[10]=n.z,u.getRotation(this._worldRotationQuaternion)}}},r.registerWorldChangeFlag=function(){return this._updateFlagManager.createFlag(Qe)},r._parentChange=function(){this._isParentDirty=!0,this._updateAllWorldFlag()},r._isFrontFaceInvert=function(){var e=this.lossyWorldScale,t=e.x<0;return e.y<0&&(t=!t),e.z<0&&(t=!t),t},r._updateWorldPositionFlag=function(){if(!this._isContainDirtyFlags(qe.WmWp)){this._worldAssociatedChange(qe.WmWp);for(var e=this._entity._children,t=0,r=e.length;t<r;t++){var n;null===(n=e[t].transform)||void 0===n||n._updateWorldPositionFlag()}}},r._updateWorldRotationFlag=function(){if(!this._isContainDirtyFlags(qe.WmWeWq)){this._worldAssociatedChange(qe.WmWeWq);for(var e=this._entity._children,t=0,r=e.length;t<r;t++){var n;null===(n=e[t].transform)||void 0===n||n._updateWorldPositionAndRotationFlag()}}},r._updateWorldPositionAndRotationFlag=function(){if(!this._isContainDirtyFlags(qe.WmWpWeWq)){this._worldAssociatedChange(qe.WmWpWeWq);for(var e=this._entity._children,t=0,r=e.length;t<r;t++){var n;null===(n=e[t].transform)||void 0===n||n._updateWorldPositionAndRotationFlag()}}},r._updateWorldScaleFlag=function(){if(!this._isContainDirtyFlags(qe.WmWs)){this._worldAssociatedChange(qe.WmWs);for(var e=this._entity._children,t=0,r=e.length;t<r;t++){var n;null===(n=e[t].transform)||void 0===n||n._updateWorldPositionAndScaleFlag()}}},r._updateWorldPositionAndScaleFlag=function(){if(!this._isContainDirtyFlags(qe.WmWpWs)){this._worldAssociatedChange(qe.WmWpWs);for(var e=this._entity._children,t=0,r=e.length;t<r;t++){var n;null===(n=e[t].transform)||void 0===n||n._updateWorldPositionAndScaleFlag()}}},r._updateAllWorldFlag=function(){if(!this._isContainDirtyFlags(qe.WmWpWeWqWs)){this._worldAssociatedChange(qe.WmWpWeWqWs);for(var e=this._entity._children,t=0,r=e.length;t<r;t++){var n;null===(n=e[t].transform)||void 0===n||n._updateAllWorldFlag()}}},r._getParentTransform=function(){if(!this._isParentDirty)return this._parentTransformCache;for(var e=null,t=this._entity.parent;t;){var r=t.transform;if(r){e=r;break}t=t.parent}return this._parentTransformCache=e,this._isParentDirty=!1,e},r._getScaleMatrix=function(){var e=t._tempQuat0,r=t._tempMat30,n=t._tempMat31,i=t._tempMat32;return n.setValueByMatrix(this.worldMatrix),_.invert(this.worldRotationQuaternion,e),d.rotationQuaternion(e,r),d.multiply(r,n,i),i},r._isContainDirtyFlags=function(e){return(this._dirtyFlag&e)===e},r._isContainDirtyFlag=function(e){return 0!=(this._dirtyFlag&e)},r._setDirtyFlagTrue=function(e){this._dirtyFlag|=e},r._setDirtyFlagFalse=function(e){this._dirtyFlag&=~e},r._worldAssociatedChange=function(e){this._dirtyFlag|=e,this._updateFlagManager.dispatch()},r._rotateByQuat=function(e,t){t?_.multiply(this.rotationQuaternion,e,this._rotationQuaternion):_.multiply(e,this.worldRotationQuaternion,this._worldRotationQuaternion)},r._translate=function(e,t){void 0===t&&(t=!0),t?this._position.add(e):this._worldPosition.add(e)},r._rotateXYZ=function(e,r,n,i){void 0===i&&(i=!0);var o=a.degreeToRadFactor,s=t._tempQuat0;_.rotationEuler(e*o,r*o,n*o,s),this._rotateByQuat(s,i)},r._onPositionChanged=function(){this._setDirtyFlagTrue(qe.LocalMatrix),this._updateWorldPositionFlag()},r._onWorldPositionChanged=function(){var e=this._worldPosition,r=this._getParentTransform();r?(f.invert(r.worldMatrix,t._tempMat41),o.transformCoordinate(e,t._tempMat41,this._position)):e.cloneTo(this._position),this._setDirtyFlagFalse(qe.WorldPosition)},r._onRotationChanged=function(){this._setDirtyFlagTrue(qe.LocalMatrix|qe.LocalQuat),this._setDirtyFlagFalse(qe.LocalEuler),this._updateWorldRotationFlag()},r._onWorldRotationChanged=function(){var e=this._worldRotation;_.rotationEuler(a.degreeToRadian(e.x),a.degreeToRadian(e.y),a.degreeToRadian(e.z),this._worldRotationQuaternion),this._setDirtyFlagFalse(qe.WorldEuler)},r._onRotationQuaternionChanged=function(){this._setDirtyFlagTrue(qe.LocalMatrix|qe.LocalEuler),this._setDirtyFlagFalse(qe.LocalQuat),this._updateWorldRotationFlag()},r._onWorldRotationQuaternionChanged=function(){var e=this._worldRotationQuaternion,r=this._getParentTransform();if(r){var n=t._tempQuat0;_.invert(r.worldRotationQuaternion,n),_.multiply(n,e,this._rotationQuaternion)}else e.cloneTo(this._rotationQuaternion);this._setDirtyFlagFalse(qe.WorldQuat)},r._onScaleChanged=function(){this._setDirtyFlagTrue(qe.LocalMatrix),this._updateWorldScaleFlag()},A(t,[{key:"position",get:function(){return this._position},set:function(e){this._position!==e&&e.cloneTo(this._position)}},{key:"worldPosition",get:function(){var e=this._worldPosition;return this._isContainDirtyFlag(qe.WorldPosition)&&(e._onValueChanged=null,this._getParentTransform()?this.worldMatrix.getTranslation(e):this._position.cloneTo(e),e._onValueChanged=this._onWorldPositionChanged,this._setDirtyFlagFalse(qe.WorldPosition)),e},set:function(e){this._worldPosition!==e&&e.cloneTo(this._worldPosition)}},{key:"rotation",get:function(){var e=this._rotation;return this._isContainDirtyFlag(qe.LocalEuler)&&(e._onValueChanged=null,this._rotationQuaternion.toEuler(e),e._onValueChanged=this._onRotationChanged,e.scale(a.radToDegreeFactor),this._setDirtyFlagFalse(qe.LocalEuler)),e},set:function(e){this._rotation!==e&&e.cloneTo(this._rotation)}},{key:"worldRotation",get:function(){var e=this._worldRotation;return this._isContainDirtyFlag(qe.WorldEuler)&&(e._onValueChanged=null,this.worldRotationQuaternion.toEuler(e),e.scale(a.radToDegreeFactor),e._onValueChanged=this._onWorldRotationChanged,this._setDirtyFlagFalse(qe.WorldEuler)),e},set:function(e){this._worldRotation!==e&&e.cloneTo(this._worldRotation)}},{key:"rotationQuaternion",get:function(){var e=this._rotationQuaternion;return this._isContainDirtyFlag(qe.LocalQuat)&&(e._onValueChanged=null,_.rotationEuler(a.degreeToRadian(this._rotation.x),a.degreeToRadian(this._rotation.y),a.degreeToRadian(this._rotation.z),e),e._onValueChanged=this._onRotationQuaternionChanged,this._setDirtyFlagFalse(qe.LocalQuat)),e},set:function(e){this._rotationQuaternion!==e?e.normalized?e.cloneTo(this._rotationQuaternion):_.normalize(e,this._rotationQuaternion):e.normalized||e.normalize()}},{key:"worldRotationQuaternion",get:function(){var e=this._worldRotationQuaternion;if(this._isContainDirtyFlag(qe.WorldQuat)){e._onValueChanged=null;var t=this._getParentTransform();null!=t?_.multiply(t.worldRotationQuaternion,this.rotationQuaternion,e):this.rotationQuaternion.cloneTo(e),e._onValueChanged=this._onWorldRotationQuaternionChanged,this._setDirtyFlagFalse(qe.WorldQuat)}return e},set:function(e){this._worldRotationQuaternion!==e&&(e.normalized?e.cloneTo(this._worldRotationQuaternion):_.normalize(e,this._worldRotationQuaternion)),e.normalized||e.normalize()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale!==e&&e.cloneTo(this._scale)}},{key:"lossyWorldScale",get:function(){if(this._isContainDirtyFlag(qe.WorldScale)){if(this._getParentTransform()){var e=this._getScaleMatrix().elements;this._lossyWorldScale.setValue(e[0],e[4],e[8])}else this._scale.cloneTo(this._lossyWorldScale);this._setDirtyFlagFalse(qe.WorldScale)}return this._lossyWorldScale}},{key:"localMatrix",get:function(){return this._isContainDirtyFlag(qe.LocalMatrix)&&(f.affineTransformation(this._scale,this.rotationQuaternion,this._position,this._localMatrix),this._setDirtyFlagFalse(qe.LocalMatrix)),this._localMatrix},set:function(e){this._localMatrix!==e&&e.cloneTo(this._localMatrix),this._localMatrix.decompose(this._position,this._rotationQuaternion,this._scale),this._setDirtyFlagTrue(qe.LocalEuler),this._setDirtyFlagFalse(qe.LocalMatrix),this._updateAllWorldFlag()}},{key:"worldMatrix",get:function(){if(this._isContainDirtyFlag(qe.WorldMatrix)){var e=this._getParentTransform();e?f.multiply(e.worldMatrix,this.localMatrix,this._worldMatrix):this.localMatrix.cloneTo(this._worldMatrix),this._setDirtyFlagFalse(qe.WorldMatrix)}return this._worldMatrix},set:function(e){this._worldMatrix!==e&&e.cloneTo(this._worldMatrix);var r=this._getParentTransform();r?(f.invert(r.worldMatrix,t._tempMat42),f.multiply(e,t._tempMat42,this._localMatrix)):e.cloneTo(this._localMatrix),this.localMatrix=this._localMatrix,this._setDirtyFlagFalse(qe.WorldMatrix)}}]),t}(Je))._tempQuat0=new _,Ke._tempVec30=new o,Ke._tempVec31=new o,Ke._tempVec32=new o,Ke._tempMat30=new d,Ke._tempMat31=new d,Ke._tempMat32=new d,Ke._tempMat41=new f,Ke._tempMat42=new f,Ke._tempMat43=new f,De=N((Be=Ke).prototype,"_position",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new o}}),Ie=N(Be.prototype,"_rotation",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new o}}),Oe=N(Be.prototype,"_rotationQuaternion",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _}}),ze=N(Be.prototype,"_scale",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new o(1,1,1)}}),Ve=N(Be.prototype,"_worldPosition",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new o}}),Ne=N(Be.prototype,"_worldRotation",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new o}}),Ue=N(Be.prototype,"_worldRotationQuaternion",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _}}),ke=N(Be.prototype,"_lossyWorldScale",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new o(1,1,1)}}),Ge=N(Be.prototype,"_localMatrix",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new f}}),He=N(Be.prototype,"_worldMatrix",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new f}}),We=N(Be.prototype,"_updateFlagManager",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ze}}),je=N(Be.prototype,"_isParentDirty",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Xe=N(Be.prototype,"_parentTransformCache",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Be);!function(e){e[e.LocalEuler=1]="LocalEuler",e[e.LocalQuat=2]="LocalQuat",e[e.WorldPosition=4]="WorldPosition",e[e.WorldEuler=8]="WorldEuler",e[e.WorldQuat=16]="WorldQuat",e[e.WorldScale=32]="WorldScale",e[e.LocalMatrix=64]="LocalMatrix",e[e.WorldMatrix=128]="WorldMatrix",e[e.WmWp=132]="WmWp",e[e.WmWeWq=152]="WmWeWq",e[e.WmWpWeWq=156]="WmWpWeWq",e[e.WmWs=160]="WmWs",e[e.WmWpWs=164]="WmWpWs",e[e.WmWpWeWqWs=188]="WmWpWeWqWs"}(qe||(qe={}));var et,tt=function(t){function r(r,n){var i;return(i=t.call(this,r)||this).name=void 0,i.layer=e.Layer.Layer0,i.transform=void 0,i._isActiveInHierarchy=!1,i._components=[],i._scripts=new Te,i._children=[],i._scene=void 0,i._isRoot=!1,i._isActive=!0,i._parent=null,i._activeChangedComponents=void 0,i._invModelMatrix=new f,i._inverseWorldMatFlag=void 0,i.name=n,i.transform=i.addComponent($e),i._inverseWorldMatFlag=i.transform.registerWorldChangeFlag(),i}E(r,t),r._findChildByName=function(e,t){for(var r=e._children,n=r.length-1;n>=0;n--){var i=r[n];if(i.name===t)return i}return null},r._traverseSetOwnerScene=function(e,t){e._scene=t;for(var r=e._children,n=e.childCount-1;n>=0;n--)this._traverseSetOwnerScene(r[n],t)};var n=r.prototype;return n.addComponent=function(e){Me._addCheck(this,e);var t=new e(this);return this._components.push(t),this._isActiveInHierarchy&&t._setActive(!0),t},n.getComponent=function(e){for(var t=this._components.length-1;t>=0;t--){var r=this._components[t];if(r instanceof e)return r}},n.getComponents=function(e,t){t.length=0;for(var r=this._components.length-1;r>=0;r--){var n=this._components[r];n instanceof e&&t.push(n)}return t},n.getComponentsIncludeChildren=function(e,t){return t.length=0,this._getComponentsInChildren(e,t),t},n.addChild=function(e){e.parent=this},n.removeChild=function(e){e.parent=null},n.getChild=function(e){return this._children[e]},n.findByName=function(e){var t=this._children,n=r._findChildByName(this,e);if(n)return n;for(var i=t.length-1;i>=0;i--){var a=t[i].findByName(e);if(a)return a}return null},n.findByPath=function(e){for(var t=e.split("/"),n=this,i=0,a=t.length;i<a;++i){var o=t[i];if(o&&!(n=r._findChildByName(n,o)))return null}return n},n.createChild=function(e){var t=new r(this.engine,e);return t.layer=this.layer,t.parent=this,t},n.clearChildren=function(){for(var e=this._children,t=e.length-1;t>=0;t--){var n=e[t];n._parent=null,n._isActiveInHierarchy&&n._processInActive(),r._traverseSetOwnerScene(n,null)}e.length=0},n.clone=function(){var e=new r(this._engine,this.name);e._isActive=this._isActive,e.transform.localMatrix=this.transform.localMatrix;for(var t=this._children,n=0,i=this._children.length;n<i;n++){var a=t[n];e.addChild(a.clone())}for(var o=this._components,s=0,l=o.length;s<l;s++){var u=o[s];if(!(u instanceof $e)){var c=e.addComponent(u.constructor);Se.cloneComponent(u,c)}}return e},n.destroy=function(){if(!this._destroyed){t.prototype.destroy.call(this);for(var e=this._components,r=e.length-1;r>=0;r--)e[r].destroy();this._components.length=0;for(var n=this._children,i=n.length-1;i>=0;i--)n[i].destroy();if(this._children.length=0,null!=this._parent){var a=this._parent._children;a.splice(a.indexOf(this),1)}this._parent=null}},n._removeComponent=function(e){Me._removeCheck(this,e.constructor);var t=this._components;t.splice(t.indexOf(e),1)},n._addScript=function(e){e._entityScriptsIndex=this._scripts.length,this._scripts.add(e)},n._removeScript=function(e){var t=this._scripts.deleteByIndex(e._entityScriptsIndex);t&&(t._entityScriptsIndex=e._entityScriptsIndex),e._entityScriptsIndex=-1},n._removeFromParent=function(){var e=this._parent;if(null!=e){var t=e._children;t.splice(t.indexOf(this),1),this._parent=null}return e},n._processActive=function(){if(this._activeChangedComponents)throw"Note: can't set the 'main inActive entity' active in hierarchy, if the operation is in main inActive entity or it's children script's onDisable Event.";this._activeChangedComponents=this._engine._componentsManager.getActiveChangedTempList(),this._setActiveInHierarchy(this._activeChangedComponents),this._setActiveComponents(!0)},n._processInActive=function(){if(this._activeChangedComponents)throw"Note: can't set the 'main active entity' inActive in hierarchy, if the operation is in main active entity or it's children script's onEnable Event.";this._activeChangedComponents=this._engine._componentsManager.getActiveChangedTempList(),this._setInActiveInHierarchy(this._activeChangedComponents),this._setActiveComponents(!1)},n._getComponentsInChildren=function(e,t){for(var r=this._components.length-1;r>=0;r--){var n=this._components[r];n instanceof e&&t.push(n)}for(var i=this._children.length-1;i>=0;i--)this._children[i]._getComponentsInChildren(e,t)},n._setActiveComponents=function(e){for(var t=this._activeChangedComponents,r=0,n=t.length;r<n;++r)t[r]._setActive(e);this._engine._componentsManager.putActiveChangedTempList(t),this._activeChangedComponents=null},n._setActiveInHierarchy=function(e){this._isActiveInHierarchy=!0;for(var t=this._components,r=t.length-1;r>=0;r--)e.push(t[r]);for(var n=this._children,i=n.length-1;i>=0;i--){var a=n[i];a.isActive&&a._setActiveInHierarchy(e)}},n._setInActiveInHierarchy=function(e){this._isActiveInHierarchy=!1;for(var t=this._components,r=t.length-1;r>=0;r--)e.push(t[r]);for(var n=this._children,i=n.length-1;i>=0;i--){var a=n[i];a.isActive&&a._setInActiveInHierarchy(e)}},n._setTransformDirty=function(){if(this.transform)this.transform._parentChange();else for(var e=0,t=this._children.length;e<t;e++)this._children[e]._setTransformDirty()},n.getInvModelMatrix=function(){return this._inverseWorldMatFlag.flag&&(f.invert(this.transform.worldMatrix,this._invModelMatrix),this._inverseWorldMatFlag.flag=!1),this._invModelMatrix},A(r,[{key:"isActive",get:function(){return this._isActive},set:function(e){if(e!==this._isActive)if(this._isActive=e,e){var t=this._parent;(null!=t&&t._isActiveInHierarchy||this._isRoot&&this._scene._isActiveInEngine)&&this._processActive()}else this._isActiveInHierarchy&&this._processInActive()}},{key:"isActiveInHierarchy",get:function(){return this._isActiveInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){if(e!==this._parent){var t=this._removeFromParent(),n=this._parent=e;if(n){n._children.push(this);var i=n._scene;this._scene!==i&&r._traverseSetOwnerScene(this,i),n._isActiveInHierarchy?!this._isActiveInHierarchy&&this._isActive&&this._processActive():this._isActiveInHierarchy&&this._processInActive()}else this._isActiveInHierarchy&&this._processInActive(),t&&r._traverseSetOwnerScene(this,null);this._setTransformDirty()}}},{key:"children",get:function(){return this._children}},{key:"childCount",get:function(){return this._children.length}},{key:"scene",get:function(){return this._scene}}]),r}(Y),rt=function(){function e(){this._features=[],this._objects=[]}var t=e.prototype;return t.registerFeature=function(e){for(var t=this._features,r=0,n=t.length;r<n;r++)if(t[r]===e)return;t.push(e);for(var i=this._objects,a=0,o=i.length;a<o;a++)i[a].features.push(new e)},t.addObject=function(e){e.features=[];for(var t=0,r=this._features.length;t<r;t++){var n;e.features.push(new this._features[t](null!=(n=e.engine)?n:e))}this._objects.push(e)},t.callFeatureMethod=function(e,t,r){for(var n=e.features,i=n.length,a=0;a<i;a++){var o=n[a];o[t]&&o[t].apply(o,r)}},t.findFeature=function(e,t){for(var r=e.features,n=r.length,i=0;i<n;i++){var a=r[i];if(a.constructor===t)return a}},e}();e.Keys=void 0,(et=e.Keys||(e.Keys={}))[et.Backquote=0]="Backquote",et[et.Backslash=1]="Backslash",et[et.Backspace=2]="Backspace",et[et.BracketLeft=3]="BracketLeft",et[et.BracketRight=4]="BracketRight",et[et.Comma=5]="Comma",et[et.Digit0=6]="Digit0",et[et.Digit1=7]="Digit1",et[et.Digit2=8]="Digit2",et[et.Digit3=9]="Digit3",et[et.Digit4=10]="Digit4",et[et.Digit5=11]="Digit5",et[et.Digit6=12]="Digit6",et[et.Digit7=13]="Digit7",et[et.Digit8=14]="Digit8",et[et.Digit9=15]="Digit9",et[et.Equal=16]="Equal",et[et.IntlBackslash=17]="IntlBackslash",et[et.IntlRo=18]="IntlRo",et[et.IntlYen=19]="IntlYen",et[et.KeyA=20]="KeyA",et[et.KeyB=21]="KeyB",et[et.KeyC=22]="KeyC",et[et.KeyD=23]="KeyD",et[et.KeyE=24]="KeyE",et[et.KeyF=25]="KeyF",et[et.KeyG=26]="KeyG",et[et.KeyH=27]="KeyH",et[et.KeyI=28]="KeyI",et[et.KeyJ=29]="KeyJ",et[et.KeyK=30]="KeyK",et[et.KeyL=31]="KeyL",et[et.KeyM=32]="KeyM",et[et.KeyN=33]="KeyN",et[et.KeyO=34]="KeyO",et[et.KeyP=35]="KeyP",et[et.KeyQ=36]="KeyQ",et[et.KeyR=37]="KeyR",et[et.KeyS=38]="KeyS",et[et.KeyT=39]="KeyT",et[et.KeyU=40]="KeyU",et[et.KeyV=41]="KeyV",et[et.KeyW=42]="KeyW",et[et.KeyX=43]="KeyX",et[et.KeyY=44]="KeyY",et[et.KeyZ=45]="KeyZ",et[et.Minus=46]="Minus",et[et.Period=47]="Period",et[et.Quote=48]="Quote",et[et.Semicolon=49]="Semicolon",et[et.Slash=50]="Slash",et[et.AltLeft=51]="AltLeft",et[et.AltRight=52]="AltRight",et[et.CapsLock=53]="CapsLock",et[et.ContextMenu=54]="ContextMenu",et[et.ControlLeft=55]="ControlLeft",et[et.ControlRight=56]="ControlRight",et[et.Enter=57]="Enter",et[et.MetaLeft=58]="MetaLeft",et[et.MetaRight=59]="MetaRight",et[et.ShiftLeft=60]="ShiftLeft",et[et.ShiftRight=61]="ShiftRight",et[et.Space=62]="Space",et[et.Tab=63]="Tab",et[et.Convert=64]="Convert",et[et.KanaMode=65]="KanaMode",et[et.Lang1=66]="Lang1",et[et.Lang2=67]="Lang2",et[et.Lang3=68]="Lang3",et[et.Lang4=69]="Lang4",et[et.Lang5=70]="Lang5",et[et.NonConvert=71]="NonConvert",et[et.Delete=72]="Delete",et[et.End=73]="End",et[et.Help=74]="Help",et[et.Home=75]="Home",et[et.Insert=76]="Insert",et[et.PageDown=77]="PageDown",et[et.PageUp=78]="PageUp",et[et.ArrowDown=79]="ArrowDown",et[et.ArrowLeft=80]="ArrowLeft",et[et.ArrowRight=81]="ArrowRight",et[et.ArrowUp=82]="ArrowUp",et[et.NumLock=83]="NumLock",et[et.Numpad0=84]="Numpad0",et[et.Numpad1=85]="Numpad1",et[et.Numpad2=86]="Numpad2",et[et.Numpad3=87]="Numpad3",et[et.Numpad4=88]="Numpad4",et[et.Numpad5=89]="Numpad5",et[et.Numpad6=90]="Numpad6",et[et.Numpad7=91]="Numpad7",et[et.Numpad8=92]="Numpad8",et[et.Numpad9=93]="Numpad9",et[et.NumpadAdd=94]="NumpadAdd",et[et.NumpadBackspace=95]="NumpadBackspace",et[et.NumpadClear=96]="NumpadClear",et[et.NumpadClearEntry=97]="NumpadClearEntry",et[et.NumpadComma=98]="NumpadComma",et[et.NumpadDecimal=99]="NumpadDecimal",et[et.NumpadDivide=100]="NumpadDivide",et[et.NumpadEnter=101]="NumpadEnter",et[et.NumpadEqual=102]="NumpadEqual",et[et.NumpadHash=103]="NumpadHash",et[et.NumpadMemoryAdd=104]="NumpadMemoryAdd",et[et.NumpadMemoryClear=105]="NumpadMemoryClear",et[et.NumpadMemoryRecall=106]="NumpadMemoryRecall",et[et.NumpadMemoryStore=107]="NumpadMemoryStore",et[et.NumpadMemorySubtract=108]="NumpadMemorySubtract",et[et.NumpadMultiply=109]="NumpadMultiply",et[et.NumpadParenLeft=110]="NumpadParenLeft",et[et.NumpadParenRight=111]="NumpadParenRight",et[et.NumpadStar=112]="NumpadStar",et[et.NumpadSubtract=113]="NumpadSubtract",et[et.Escape=114]="Escape",et[et.F1=115]="F1",et[et.F2=116]="F2",et[et.F3=117]="F3",et[et.F4=118]="F4",et[et.F5=119]="F5",et[et.F6=120]="F6",et[et.F7=121]="F7",et[et.F8=122]="F8",et[et.F9=123]="F9",et[et.F10=124]="F10",et[et.F11=125]="F11",et[et.F12=126]="F12",et[et.F13=127]="F13",et[et.F14=128]="F14",et[et.F15=129]="F15",et[et.Fn=130]="Fn",et[et.FnLock=131]="FnLock",et[et.PrintScreen=132]="PrintScreen",et[et.ScrollLock=133]="ScrollLock",et[et.Pause=134]="Pause",et[et.BrowserBack=135]="BrowserBack",et[et.BrowserFavorites=136]="BrowserFavorites",et[et.BrowserForward=137]="BrowserForward",et[et.BrowserHome=138]="BrowserHome",et[et.BrowserRefresh=139]="BrowserRefresh",et[et.BrowserSearch=140]="BrowserSearch",et[et.BrowserStop=141]="BrowserStop",et[et.Eject=142]="Eject",et[et.LaunchApp1=143]="LaunchApp1",et[et.LaunchApp2=144]="LaunchApp2",et[et.LaunchMail=145]="LaunchMail",et[et.MediaPlayPause=146]="MediaPlayPause",et[et.MediaSelect=147]="MediaSelect",et[et.MediaStop=148]="MediaStop",et[et.MediaTrackNext=149]="MediaTrackNext",et[et.MediaTrackPrevious=150]="MediaTrackPrevious",et[et.Power=151]="Power",et[et.Sleep=152]="Sleep",et[et.AudioVolumeDown=153]="AudioVolumeDown",et[et.AudioVolumeMute=154]="AudioVolumeMute",et[et.AudioVolumeUp=155]="AudioVolumeUp",et[et.WakeUp=156]="WakeUp",et[et.Hyper=157]="Hyper",et[et.Super=158]="Super",et[et.Turbo=159]="Turbo",et[et.Abort=160]="Abort",et[et.Resume=161]="Resume",et[et.Suspend=162]="Suspend",et[et.Again=163]="Again",et[et.Copy=164]="Copy",et[et.Cut=165]="Cut",et[et.Find=166]="Find",et[et.Open=167]="Open",et[et.Paste=168]="Paste",et[et.Props=169]="Props",et[et.Select=170]="Select",et[et.Undo=171]="Undo",et[et.Hiragana=172]="Hiragana",et[et.Katakana=173]="Katakana",et[et.Unidentified=174]="Unidentified";var nt,it=function(){function t(){var e=this;this._curFrameCount=0,this._curHeldDownKeyToIndexMap=[],this._upKeyToFrameCountMap=[],this._downKeyToFrameCountMap=[],this._curFrameHeldDownList=new Te,this._curFrameDownList=new Te,this._curFrameUpList=new Te,this._nativeEvents=[],this._onKeyEvent=void 0,this._onKeyEvent=function(t){e._nativeEvents.push(t)},window.addEventListener("keydown",this._onKeyEvent),window.addEventListener("keyup",this._onKeyEvent)}var r=t.prototype;return r._update=function(){var t=++this._curFrameCount,r=this._nativeEvents,n=this._curFrameDownList,i=this._curFrameUpList;if(n.length=0,i.length=0,r.length>0){for(var a=this._curHeldDownKeyToIndexMap,o=this._curFrameHeldDownList,s=this._downKeyToFrameCountMap,l=this._upKeyToFrameCountMap,u=0,c=r.length;u<c;u++){var h=r[u],d=e.Keys[h.code];switch(h.type){case"keydown":null==a[d]&&(n.add(d),o.add(d),a[d]=o.length-1,s[d]=t);break;case"keyup":var _=a[d];if(null!=_){a[d]=null;var f=o.deleteByIndex(_);f&&(a[f]=_)}i.add(d),l[d]=t}}r.length=0}},r._onBlur=function(){this._curHeldDownKeyToIndexMap.length=0,this._nativeEvents.length=0,this._curFrameHeldDownList.length=0,this._curFrameDownList.length=0,this._curFrameUpList.length=0},r._destroy=function(){window.removeEventListener("keydown",this._onKeyEvent),window.removeEventListener("keyup",this._onKeyEvent),this._curHeldDownKeyToIndexMap=null,this._upKeyToFrameCountMap=null,this._downKeyToFrameCountMap=null,this._nativeEvents=null,this._curFrameHeldDownList=null,this._curFrameDownList=null,this._curFrameUpList=null},t}();e.CameraClearFlags=void 0,(nt=e.CameraClearFlags||(e.CameraClearFlags={}))[nt.DepthColor=0]="DepthColor",nt[nt.Depth=1]="Depth",nt[nt.None=2]="None";var at,ot,st=function(){this.entity=null,this.distance=0,this.point=new o,this.normal=new o};e.PhysicsMaterialCombineMode=void 0,(at=e.PhysicsMaterialCombineMode||(e.PhysicsMaterialCombineMode={}))[at.Average=0]="Average",at[at.Minimum=1]="Minimum",at[at.Multiply=2]="Multiply",at[at.Maximum=3]="Maximum",e.ColliderShapeUpAxis=void 0,(ot=e.ColliderShapeUpAxis||(e.ColliderShapeUpAxis={}))[ot.X=0]="X",ot[ot.Y=1]="Y",ot[ot.Z=2]="Z";var lt=function(){function t(e){var t=this;this._initialized=!1,this._engine=void 0,this._restTime=0,this._gravity=new o(0,-9.81,0),this._nativePhysicsManager=void 0,this._physicalObjectsMap={},this._onContactEnter=function(e,r){for(var n=t._physicalObjectsMap[e],i=t._physicalObjectsMap[r],a=n.collider.entity._scripts,o=0,s=a.length;o<s;o++){var l=a.get(o);l._waitHandlingInValid||l.onCollisionEnter(i)}for(var u=0,c=(a=i.collider.entity._scripts).length;u<c;u++){var h=a.get(u);h._waitHandlingInValid||h.onCollisionEnter(n)}},this._onContactExit=function(e,r){for(var n=t._physicalObjectsMap[e],i=t._physicalObjectsMap[r],a=n.collider.entity._scripts,o=0,s=a.length;o<s;o++){var l=a.get(o);l._waitHandlingInValid||l.onCollisionExit(i)}for(var u=0,c=(a=i.collider.entity._scripts).length;u<c;u++){var h=a.get(u);h._waitHandlingInValid||h.onCollisionExit(n)}},this._onContactStay=function(e,r){for(var n=t._physicalObjectsMap[e],i=t._physicalObjectsMap[r],a=n.collider.entity._scripts,o=0,s=a.length;o<s;o++){var l=a.get(o);l._waitHandlingInValid||l.onCollisionStay(i)}for(var u=0,c=(a=i.collider.entity._scripts).length;u<c;u++){var h=a.get(u);h._waitHandlingInValid||h.onCollisionStay(n)}},this._onTriggerEnter=function(e,r){for(var n=t._physicalObjectsMap[e],i=t._physicalObjectsMap[r],a=n.collider.entity._scripts,o=0,s=a.length;o<s;o++){var l=a.get(o);l._waitHandlingInValid||l.onTriggerEnter(i)}for(var u=0,c=(a=i.collider.entity._scripts).length;u<c;u++){var h=a.get(u);h._waitHandlingInValid||h.onTriggerEnter(n)}},this._onTriggerExit=function(e,r){for(var n=t._physicalObjectsMap[e],i=t._physicalObjectsMap[r],a=n.collider.entity._scripts,o=0,s=a.length;o<s;o++){var l=a.get(o);l._waitHandlingInValid||l.onTriggerExit(i)}for(var u=0,c=(a=i.collider.entity._scripts).length;u<c;u++){var h=a.get(u);h._waitHandlingInValid||h.onTriggerExit(n)}},this._onTriggerStay=function(e,r){for(var n=t._physicalObjectsMap[e],i=t._physicalObjectsMap[r],a=n.collider.entity._scripts,o=0,s=a.length;o<s;o++){var l=a.get(o);l._waitHandlingInValid||l.onTriggerStay(i)}for(var u=0,c=(a=i.collider.entity._scripts).length;u<c;u++){var h=a.get(u);h._waitHandlingInValid||h.onTriggerStay(n)}},this.fixedTimeStep=1/60,this.maxSumTimeStep=1/3,this._engine=e}var r=t.prototype;return r.initialize=function(e){this._initialized||(t._nativePhysics=e,this._nativePhysicsManager=t._nativePhysics.createPhysicsManager(this._onContactEnter,this._onContactExit,this._onContactStay,this._onTriggerEnter,this._onTriggerExit,this._onTriggerStay),this._initialized=!0)},r.raycast=function(t,r,n,i){var a,o=this,s=Number.MAX_VALUE;"number"==typeof r?s=r:null!=r&&(a=r);var l=e.Layer.Everything;return"number"==typeof n?l=n:null!=n&&(a=n),i&&(a=i),null!=a?!(!this._nativePhysicsManager.raycast(t,s,(function(e,t,r,n){a.entity=o._physicalObjectsMap[e]._collider.entity,a.distance=t,n.cloneTo(a.normal),r.cloneTo(a.point)}))||!(a.entity.layer&l)&&(a.entity=null,a.distance=0,a.point.setValue(0,0,0),a.normal.setValue(0,0,0),1)):this._nativePhysicsManager.raycast(t,s)},r._update=function(e){var t=this.fixedTimeStep,r=this._nativePhysicsManager,n=this._engine._componentsManager,i=e+this._restTime,a=Math.floor(Math.min(this.maxSumTimeStep,i)/t);this._restTime=i-a*t;for(var o=0;o<a;o++)n.callScriptOnPhysicsUpdate(),n.callColliderOnUpdate(),r.update(t),n.callColliderOnLateUpdate()},r._addColliderShape=function(e){this._physicalObjectsMap[e.id]=e,this._nativePhysicsManager.addColliderShape(e._nativeShape)},r._removeColliderShape=function(e){delete this._physicalObjectsMap[e.id],this._nativePhysicsManager.removeColliderShape(e._nativeShape)},r._addCollider=function(e){this._nativePhysicsManager.addCollider(e._nativeCollider)},r._removeCollider=function(e){this._nativePhysicsManager.removeCollider(e._nativeCollider)},A(t,[{key:"gravity",get:function(){return this._gravity},set:function(e){var t=this._gravity;t!==e&&e.cloneTo(t),this._nativePhysicsManager.setGravity(t)}}]),t}();lt._nativePhysics=void 0;var ut=function(){function t(){this._bounciness=.1,this._dynamicFriction=.1,this._staticFriction=.1,this._bounceCombine=e.PhysicsMaterialCombineMode.Average,this._frictionCombine=e.PhysicsMaterialCombineMode.Average,this._nativeMaterial=void 0,this._nativeMaterial=lt._nativePhysics.createPhysicsMaterial(this._staticFriction,this._dynamicFriction,this._bounciness,this._bounceCombine,this._frictionCombine)}return t.prototype._destroy=function(){this._nativeMaterial.destroy()},A(t,[{key:"bounciness",get:function(){return this._bounciness},set:function(e){this._bounciness=e,this._nativeMaterial.setBounciness(e)}},{key:"dynamicFriction",get:function(){return this._dynamicFriction},set:function(e){this._dynamicFriction=e,this._nativeMaterial.setDynamicFriction(e)}},{key:"staticFriction",get:function(){return this._staticFriction},set:function(e){this._staticFriction=e,this._nativeMaterial.setStaticFriction(e)}},{key:"bounceCombine",get:function(){return this._bounceCombine},set:function(e){this._bounceCombine=e,this._nativeMaterial.setBounceCombine(e)}},{key:"frictionCombine",get:function(){return this._frictionCombine},set:function(e){this._frictionCombine=e,this._nativeMaterial.setFrictionCombine(e)}}]),t}(),ct=function(){function e(){this._collider=void 0,this._nativeShape=void 0,this._id=void 0,this._position=new o,this._material=void 0,this._isTrigger=!1,this._isSceneQuery=!0,this._material=new ut,this._id=e._idGenerator++}var t=e.prototype;return t.setPosition=function(e,t,r){this._position.setValue(e,t,r),this._nativeShape.setPosition(this._position)},t._destroy=function(){this._material._destroy(),this._nativeShape.destroy()},A(e,[{key:"collider",get:function(){return this._collider}},{key:"id",get:function(){return this._id}},{key:"material",get:function(){return this._material},set:function(e){this._material=e,this._nativeShape.setMaterial(e._nativeMaterial)}},{key:"position",get:function(){return this._position},set:function(e){this._position!==e&&e.cloneTo(this._position),this._nativeShape.setPosition(e)}},{key:"isTrigger",get:function(){return this._isTrigger},set:function(e){this._isTrigger=e,this._nativeShape.setIsTrigger(e)}}]),e}();ct._idGenerator=0;var ht,dt,_t,ft,pt,gt=function(e){function t(){var t;return(t=e.call(this)||this)._size=new o(1,1,1),t._nativeShape=lt._nativePhysics.createBoxColliderShape(t._id,t._size,t._material._nativeMaterial),t}return E(t,e),t.prototype.setSize=function(e,t,r){this._size.x=e,this._size.y=t,this._size.z=r,this._nativeShape.setSize(this._size)},A(t,[{key:"size",get:function(){return this._size},set:function(e){this._size!=e&&e.cloneTo(this._size),this._nativeShape.setSize(e)}}]),t}(ct),vt=function(e){function t(){var t;return(t=e.call(this)||this)._radius=1,t._nativeShape=lt._nativePhysics.createSphereColliderShape(t._id,t._radius,t._material._nativeMaterial),t}return E(t,e),A(t,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e,this._nativeShape.setRadius(e)}}]),t}(ct),mt=function(e){function t(){var t;return(t=e.call(this)||this)._rotation=new o,t._nativeShape=lt._nativePhysics.createPlaneColliderShape(t._id,t._material._nativeMaterial),t}return E(t,e),t.prototype.setRotation=function(e,t,r){this._rotation.setValue(e,t,r),this._nativeShape.setRotation(this._rotation)},A(t,[{key:"rotation",get:function(){return this._rotation},set:function(e){this._rotation!=e&&e.cloneTo(this._rotation),this._nativeShape.setRotation(e)}}]),t}(ct),yt=function(t){function r(){var r;return(r=t.call(this)||this)._radius=1,r._height=2,r._upAxis=e.ColliderShapeUpAxis.Y,r._nativeShape=lt._nativePhysics.createCapsuleColliderShape(r._id,r._radius,r._height,r._material._nativeMaterial),r._nativeShape.setUpAxis(e.ColliderShapeUpAxis.Y),r}return E(r,t),A(r,[{key:"radius",get:function(){return this._radius},set:function(e){this._nativeShape.setRadius(e)}},{key:"height",get:function(){return this._height},set:function(e){this._nativeShape.setHeight(e)}},{key:"upAxis",get:function(){return this._upAxis},set:function(e){this._upAxis=e,this._nativeShape.setUpAxis(e)}}]),r}(ct),xt=(ht=function(e){function t(t){var r;return V(r=e.call(this,t)||this,"_index",dt,O(r)),r._nativeCollider=void 0,r._updateFlag=void 0,r._shapes=[],r._updateFlag=r.entity.transform.registerWorldChangeFlag(),r}E(t,e);var r=t.prototype;return r.addShape=function(e){var t=e._collider;t!==this&&(t&&t.removeShape(e),this._shapes.push(e),this.engine.physicsManager._addColliderShape(e),this._nativeCollider.addShape(e._nativeShape),e._collider=this)},r.removeShape=function(e){var t=this._shapes.indexOf(e);-1!==t&&(this._shapes.splice(t,1),this._nativeCollider.removeShape(e._nativeShape),this.engine.physicsManager._removeColliderShape(e),e._collider=null)},r.clearShapes=function(){for(var e=this._shapes,t=0,r=e.length;t<r;t++){var n=e[t];this._nativeCollider.removeShape(n._nativeShape),this.engine.physicsManager._removeColliderShape(n),n._destroy()}e.length=0},r._onUpdate=function(){if(this._updateFlag.flag){var e=this.entity.transform;this._nativeCollider.setWorldTransform(e.worldPosition,e.worldRotationQuaternion),this._updateFlag.flag=!1;for(var t=e.lossyWorldScale,r=0,n=this.shapes.length;r<n;r++)this.shapes[r]._nativeShape.setWorldScale(t)}},r._onLateUpdate=function(){},r._onEnable=function(){this.engine.physicsManager._addCollider(this),this.engine._componentsManager.addCollider(this)},r._onDisable=function(){this.engine.physicsManager._removeCollider(this),this.engine._componentsManager.removeCollider(this)},r._onDestroy=function(){this.clearShapes(),this._nativeCollider.destroy()},A(t,[{key:"shapes",get:function(){return this._shapes}}]),t}(Je),dt=N(ht.prototype,"_index",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),ht),Tt=function(e){function t(t){var r,n=(r=e.call(this,t)||this).entity.transform;return r._nativeCollider=lt._nativePhysics.createStaticCollider(n.worldPosition,n.worldRotationQuaternion),r}return E(t,e),t}(xt),wt=function(t){function r(r){var n;(n=t.call(this,r)||this)._linearDamping=0,n._angularDamping=0,n._linearVelocity=new o,n._angularVelocity=new o,n._mass=0,n._centerOfMass=new o,n._inertiaTensor=new o,n._maxAngularVelocity=0,n._maxDepenetrationVelocity=0,n._sleepThreshold=0,n._solverIterations=0,n._isKinematic=!1,n._constraints=0,n._collisionDetectionMode=e.CollisionDetectionMode.Discrete;var i=n.entity.transform;return n._nativeCollider=lt._nativePhysics.createDynamicCollider(i.worldPosition,i.worldRotationQuaternion),n}E(r,t);var n=r.prototype;return n.applyForce=function(e){this._nativeCollider.addForce(e)},n.applyTorque=function(e){this._nativeCollider.addTorque(e)},n.move=function(e,t){this._nativeCollider.move(e,t)},n.sleep=function(){this._nativeCollider.sleep()},n.wakeUp=function(){this._nativeCollider.wakeUp()},n._onLateUpdate=function(){var e=this.entity.transform,t=e.worldPosition,r=e.worldRotationQuaternion;this._nativeCollider.getWorldTransform(t,r),e.worldPosition=t,e.worldRotationQuaternion=r,this._updateFlag.flag=!1},A(r,[{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping=e,this._nativeCollider.setLinearDamping(e)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping=e,this._nativeCollider.setAngularDamping(e)}},{key:"linearVelocity",get:function(){return this._linearVelocity},set:function(e){this._linearVelocity!==e&&e.cloneTo(this._linearVelocity),this._nativeCollider.setLinearVelocity(this._linearVelocity)}},{key:"angularVelocity",get:function(){return this._angularVelocity},set:function(e){this._angularVelocity!==e&&e.cloneTo(this._angularVelocity),this._nativeCollider.setAngularVelocity(this._angularVelocity)}},{key:"mass",get:function(){return this._mass},set:function(e){this._mass=e,this._nativeCollider.setMass(e)}},{key:"centerOfMass",get:function(){return this._centerOfMass},set:function(e){this._centerOfMass!==e&&e.cloneTo(this._centerOfMass),this._nativeCollider.setCenterOfMass(this._centerOfMass)}},{key:"inertiaTensor",get:function(){return this._inertiaTensor},set:function(e){this._inertiaTensor!==e&&e.cloneTo(this._inertiaTensor),this._nativeCollider.setInertiaTensor(this._inertiaTensor)}},{key:"maxAngularVelocity",get:function(){return this._maxAngularVelocity},set:function(e){this._maxAngularVelocity=e,this._nativeCollider.setMaxAngularVelocity(e)}},{key:"maxDepenetrationVelocity",get:function(){return this._maxDepenetrationVelocity},set:function(e){this._maxDepenetrationVelocity=e,this._nativeCollider.setMaxDepenetrationVelocity(e)}},{key:"sleepThreshold",get:function(){return this._sleepThreshold},set:function(e){this._sleepThreshold=e,this._nativeCollider.setSleepThreshold(e)}},{key:"solverIterations",get:function(){return this._solverIterations},set:function(e){this._solverIterations=e,this._nativeCollider.setSolverIterations(e)}},{key:"isKinematic",get:function(){return this._isKinematic},set:function(e){this._isKinematic=e,this._nativeCollider.setIsKinematic(e)}},{key:"constraints",get:function(){return this._constraints},set:function(e){this._constraints=e,this._nativeCollider.setConstraints(e)}},{key:"collisionDetectionMode",get:function(){return this._collisionDetectionMode},set:function(e){this._collisionDetectionMode=e,this._nativeCollider.setCollisionDetectionMode(e)}}]),r}(xt);e.CollisionDetectionMode=void 0,(_t=e.CollisionDetectionMode||(e.CollisionDetectionMode={}))[_t.Discrete=0]="Discrete",_t[_t.Continuous=1]="Continuous",_t[_t.ContinuousDynamic=2]="ContinuousDynamic",_t[_t.ContinuousSpeculative=3]="ContinuousSpeculative",e.DynamicColliderConstraints=void 0,(ft=e.DynamicColliderConstraints||(e.DynamicColliderConstraints={}))[ft.None=0]="None",ft[ft.FreezePositionX=1]="FreezePositionX",ft[ft.FreezePositionY=2]="FreezePositionY",ft[ft.FreezePositionZ=4]="FreezePositionZ",ft[ft.FreezeRotationX=8]="FreezeRotationX",ft[ft.FreezeRotationY=16]="FreezeRotationY",ft[ft.FreezeRotationZ=32]="FreezeRotationZ",e.PointerPhase=void 0,(pt=e.PointerPhase||(e.PointerPhase={}))[pt.Down=0]="Down",pt[pt.Move=1]="Move",pt[pt.Up=2]="Up",pt[pt.Leave=3]="Leave";var bt,Ct=function(t){this.id=void 0,this.phase=e.PointerPhase.Leave,this.position=new g,this._uniqueID=void 0,this._needUpdate=!0,this.id=t},St=function(){function t(e,t){var r=this;this._pointers=[],this._multiPointerEnabled=!0,this._engine=void 0,this._canvas=void 0,this._nativeEvents=[],this._pointerPool=void 0,this._keyEventList=[],this._keyEventCount=0,this._needOverallPointers=!1,this._currentPosition=new g,this._currentPressedEntity=void 0,this._currentEnteredEntity=void 0,this._engine=e,this._canvas=e.canvas,t.style.touchAction="none",t.onpointerdown=t.onpointerup=t.onpointerout=t.onpointermove=function(e){r._nativeEvents.push(e)},this._pointerPool=new Array(11)}var r=t.prototype;return r._update=function(){if(this._needOverallPointers&&this._overallPointers(),this._nativeEvents.length>0&&this._handlePointerEvent(this._nativeEvents),this._engine.physicsManager._initialized){var e=this._pointerRayCast(),t=this._keyEventCount;if(t>0){for(var r=this._keyEventList,n=0;n<t;n++)switch(r[n]){case bt.Down:this._firePointerDown(e);break;case bt.Up:this._firePointerUpAndClick(e)}this._firePointerExitAndEnter(e),r[t-1]===bt.Leave&&(this._currentPressedEntity=null),this._keyEventCount=0}else this._firePointerDrag(),this._firePointerExitAndEnter(e)}},r._destroy=function(){var e=this._canvas._webCanvas;e.onpointerdown=e.onpointerup=e.onpointerout=e.onpointermove=null,this._nativeEvents.length=0,this._pointerPool.length=0,this._pointers.length=0,this._currentPosition=null,this._currentEnteredEntity=null,this._currentPressedEntity=null,this._engine=null,this._canvas=null},r._overallPointers=function(){for(var t=this._pointers,r=0,n=t.length,i=0;i<n;i++)t[i].phase===e.PointerPhase.Leave?r++:r>0&&(t[i-r]=t[i]);t.length=n-r,this._needOverallPointers=!1},r._getIndexByPointerID=function(e){for(var t=this._pointers,r=t.length-1;r>=0;r--)if(t[r]._uniqueID===e)return r;return-1},r._addPointer=function(e,t,r,n){var i=this._pointers,a=i.length;if(0===a||this._multiPointerEnabled){for(var o=this._pointerPool,s=0;s<a&&!(i[s].id>s);s++);var l=o[s];l||(l=o[s]=new Ct(s)),l._uniqueID=e,l._needUpdate=!0,l.position.setValue(t,r),l.phase=n,i.splice(s,0,l)}},r._removePointer=function(t){this._pointers[t].phase=e.PointerPhase.Leave},r._updatePointer=function(e,t,r,n){var i=this._pointers[e];i.position.setValue(t,r),i._needUpdate=!0,i.phase=n},r._handlePointerEvent=function(t){for(var r=this._pointers,n=this._keyEventList,i=r.length,a=t.length,o=0;o<a;o++){var s=t[o],l=this._getIndexByPointerID(s.pointerId);switch(s.type){case"pointerdown":-1===l?(this._addPointer(s.pointerId,s.offsetX,s.offsetY,e.PointerPhase.Down),i++):this._updatePointer(l,s.offsetX,s.offsetY,e.PointerPhase.Down),1===i&&(n[this._keyEventCount++]=bt.Down);break;case"pointerup":l>=0&&(this._updatePointer(l,s.offsetX,s.offsetY,e.PointerPhase.Up),1===i&&(n[this._keyEventCount++]=bt.Up));break;case"pointermove":-1===l?(this._addPointer(s.pointerId,s.offsetX,s.offsetY,e.PointerPhase.Move),i++):this._updatePointer(l,s.offsetX,s.offsetY,e.PointerPhase.Move);break;case"pointerout":l>=0&&(this._removePointer(l),0==--i&&(n[this._keyEventCount++]=bt.Leave),this._needOverallPointers=!0)}}var u=r.length;if(u>0){var c=this._canvas,h=this._currentPosition,d=c.width/c._webCanvas.clientWidth,_=c.height/c._webCanvas.clientHeight;if(0===i){var f=t[a-1];h.setValue(f.offsetX*d,f.offsetY*_)}else{h.setValue(0,0);for(var p=0;p<u;p++){var g=r[p],v=g.position;g._needUpdate&&(v.setValue(v.x*d,v.y*_),g._needUpdate=!1),h.add(v)}h.scale(1/u)}}t.length=0},r._pointerRayCast=function(){if(this._pointers.length>0)for(var r=t._tempPoint,n=t._tempRay,i=t._tempHitResult,a=this._engine.sceneManager.activeScene._activeCameras,o=this._currentPosition.x/this._canvas.width,s=this._currentPosition.y/this._canvas.height,l=a.length-1;l>=0;l--){var u=a[l];if(u.enabled&&!u.renderTarget){var c=u.viewport,h=c.x,d=c.y,_=c.z,f=c.w;if(o>=h&&s>=d&&o-h<=_&&s-d<=f){if(r.setValue((o-h)/_,(s-d)/f),this._engine.physicsManager.raycast(u.viewportPointToRay(r,n),i))return i.entity;if(u.clearFlags===e.CameraClearFlags.DepthColor)return null}}}return null},r._firePointerDrag=function(){if(this._currentPressedEntity)for(var e=this._currentPressedEntity._scripts,t=e.length-1;t>=0;t--){var r=e.get(t);r._waitHandlingInValid||r.onPointerDrag()}},r._firePointerExitAndEnter=function(e){if(this._currentEnteredEntity!==e){if(this._currentEnteredEntity)for(var t=this._currentEnteredEntity._scripts,r=t.length-1;r>=0;r--){var n=t.get(r);n._waitHandlingInValid||n.onPointerExit()}if(e)for(var i=e._scripts,a=i.length-1;a>=0;a--){var o=i.get(a);o._waitHandlingInValid||o.onPointerEnter()}this._currentEnteredEntity=e}},r._firePointerDown=function(e){if(e)for(var t=e._scripts,r=t.length-1;r>=0;r--){var n=t.get(r);n._waitHandlingInValid||n.onPointerDown()}this._currentPressedEntity=e},r._firePointerUpAndClick=function(e){var t=this._currentPressedEntity;if(t){for(var r=t===e,n=t._scripts,i=n.length-1;i>=0;i--){var a=n.get(i);a._waitHandlingInValid||(r&&a.onPointerClick(),a.onPointerUp())}this._currentPressedEntity=null}},t}();St._tempRay=new p,St._tempPoint=new g,St._tempHitResult=new st,function(e){e[e.Down=0]="Down",e[e.Up=1]="Up",e[e.Leave=2]="Leave"}(bt||(bt={}));var Mt,At,Pt=function(){var e=t.prototype;function t(e){this._enabled=!0,this._pointerManager=void 0,this._keyboardManager=void 0;var t=e._canvas._webCanvas;t instanceof HTMLCanvasElement?(this._enabled=!0,this._pointerManager=new St(e,t),this._keyboardManager=new it,this._onBlur=this._onBlur.bind(this),window.addEventListener("blur",this._onBlur)):this._enabled=!1}return e.isKeyHeldDown=function(e){return void 0===e?this._keyboardManager._curFrameHeldDownList.length>0:!!this._keyboardManager._curHeldDownKeyToIndexMap[e]},e.isKeyDown=function(e){return void 0===e?this._keyboardManager._curFrameDownList.length>0:this._keyboardManager._downKeyToFrameCountMap[e]===this._keyboardManager._curFrameCount},e.isKeyUp=function(e){return void 0===e?this._keyboardManager._curFrameUpList.length>0:this._keyboardManager._upKeyToFrameCountMap[e]===this._keyboardManager._curFrameCount},e._update=function(){this._enabled&&(this._pointerManager._update(),this._keyboardManager._update())},e._destroy=function(){this._enabled&&(window.removeEventListener("blur",this._onBlur),this._pointerManager._destroy(),this._keyboardManager._destroy())},e._onBlur=function(){this._enabled&&this._keyboardManager._onBlur()},A(t,[{key:"pointers",get:function(){return this._enabled?this._pointerManager._pointers:null}},{key:"multiPointerEnabled",get:function(){return!!this._enabled&&this._pointerManager._multiPointerEnabled},set:function(e){this._enabled&&(this._pointerManager._multiPointerEnabled=e)}}]),t}();e.RenderQueueType=void 0,(Mt=e.RenderQueueType||(e.RenderQueueType={}))[Mt.Opaque=1e3]="Opaque",Mt[Mt.AlphaTest=2e3]="AlphaTest",Mt[Mt.Transparent=3e3]="Transparent",function(e){e[e.Scene=0]="Scene",e[e.Camera=1]="Camera",e[e.Renderer=2]="Renderer",e[e.Material=3]="Material"}(At||(At={}));var Ft,Et=S(S({common:"#define GLSLIFY 1\n#define PI 3.14159265359\n#define RECIPROCAL_PI 0.31830988618\n#define EPSILON 1e-6\n#define LOG2 1.442695\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\nfloat pow2(float x){return x*x;}vec4 RGBMToLinear(vec4 value,float maxRange){return vec4(value.rgb*value.a*maxRange,1.0);}vec4 gammaToLinear(vec4 srgbIn){return vec4(pow(srgbIn.rgb,vec3(2.2)),srgbIn.a);}vec4 linearToGamma(vec4 linearIn){return vec4(pow(linearIn.rgb,vec3(1.0/2.2)),linearIn.a);}",common_vert:"#define GLSLIFY 1\nattribute vec3 POSITION;\n#ifdef O3_HAS_UV\nattribute vec2 TEXCOORD_0;\n#endif\n#ifdef O3_HAS_UV1\nattribute vec2 TEXCOORD_1;\n#endif\n#ifdef O3_HAS_SKIN\nattribute vec4 JOINTS_0;attribute vec4 WEIGHTS_0;\n#ifdef O3_USE_JOINT_TEXTURE\nuniform sampler2D u_jointSampler;uniform float u_jointCount;mat4 getJointMatrix(sampler2D smp,float index){float base=index/u_jointCount;float hf=0.5/u_jointCount;float v=base+hf;vec4 m0=texture2D(smp,vec2(0.125,v));vec4 m1=texture2D(smp,vec2(0.375,v));vec4 m2=texture2D(smp,vec2(0.625,v));vec4 m3=texture2D(smp,vec2(0.875,v));return mat4(m0,m1,m2,m3);}\n#else\nuniform mat4 u_jointMatrix[O3_JOINTS_NUM];\n#endif\n#endif\n#ifdef O3_HAS_VERTEXCOLOR\nattribute vec4 COLOR_0;\n#endif\nuniform mat4 u_localMat;uniform mat4 u_modelMat;uniform mat4 u_viewMat;uniform mat4 u_projMat;uniform mat4 u_MVMat;uniform mat4 u_MVPMat;uniform mat4 u_normalMat;uniform vec3 u_cameraPos;uniform vec4 u_tilingOffset;\n#ifndef OMIT_NORMAL\n#ifdef O3_HAS_NORMAL\nattribute vec3 NORMAL;\n#endif\n#ifdef O3_HAS_TANGENT\nattribute vec4 TANGENT;\n#endif\n#endif\n",common_frag:"#define GLSLIFY 1\nuniform mat4 u_localMat;uniform mat4 u_modelMat;uniform mat4 u_viewMat;uniform mat4 u_projMat;uniform mat4 u_MVMat;uniform mat4 u_MVPMat;uniform mat4 u_normalMat;uniform vec3 u_cameraPos;",color_share:"#define GLSLIFY 1\n#ifdef O3_HAS_VERTEXCOLOR\nvarying vec4 v_color;\n#endif\n",normal_share:"#define GLSLIFY 1\n#ifndef OMIT_NORMAL\n#ifdef O3_HAS_NORMAL\nvarying vec3 v_normal;\n#if defined(O3_HAS_TANGENT) && ( defined(O3_NORMAL_TEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE) )\nvarying mat3 v_TBN;\n#endif\n#endif\n#endif\n",uv_share:"#define GLSLIFY 1\nvarying vec2 v_uv;\n#ifdef O3_HAS_UV1\nvarying vec2 v_uv1;\n#endif\n",worldpos_share:"#define GLSLIFY 1\n#ifdef O3_NEED_WORLDPOS\nvarying vec3 v_pos;\n#endif\n",shadow_share:"#define GLSLIFY 1\n#ifdef O3_GENERATE_SHADOW_MAP\nuniform mat4 u_viewMatFromLight;uniform mat4 u_projMatFromLight;\n#endif\n#ifdef O3_SHADOW_MAP_COUNT\nuniform mat4 u_viewMatFromLight[O3_SHADOW_MAP_COUNT];uniform mat4 u_projMatFromLight[O3_SHADOW_MAP_COUNT];varying vec4 v_PositionFromLight[O3_SHADOW_MAP_COUNT];\n#endif\n",fog_share:"#define GLSLIFY 1\n#ifdef O3_HAS_FOG\nvarying vec3 v_fogDepth;uniform vec3 u_fogColor;\n#ifdef O3_FOG_EXP2\nuniform float u_fogDensity;\n#else\nuniform float u_fogNear;uniform float u_fogFar;\n#endif\n#endif\n",begin_normal_vert:"#define GLSLIFY 1\n#ifndef OMIT_NORMAL\n#ifdef O3_HAS_NORMAL\nvec3 normal=vec3(NORMAL);\n#endif\n#ifdef O3_HAS_TANGENT\nvec4 tangent=vec4(TANGENT);\n#endif\n#endif\n",begin_position_vert:"#define GLSLIFY 1\nvec4 position=vec4(POSITION,1.0);",position_vert:"#define GLSLIFY 1\n#ifndef O3_GENERATE_SHADOW_MAP\ngl_Position=u_MVPMat*position;\n#endif\n",color_vert:"#define GLSLIFY 1\n#ifdef O3_HAS_VERTEXCOLOR\nv_color=COLOR_0;\n#endif\n",normal_vert:"#define GLSLIFY 1\n#ifndef OMIT_NORMAL\n#ifdef O3_HAS_NORMAL\nv_normal=normalize(mat3(u_normalMat)*normal);\n#if defined(O3_HAS_TANGENT) && ( defined(O3_NORMAL_TEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE) )\nvec3 normalW=normalize(mat3(u_normalMat)*normal.xyz);vec3 tangentW=normalize(mat3(u_normalMat)*tangent.xyz);vec3 bitangentW=cross(normalW,tangentW)*tangent.w;v_TBN=mat3(tangentW,bitangentW,normalW);\n#endif\n#endif\n#endif\n",skinning_vert:"#define GLSLIFY 1\n#ifdef O3_HAS_SKIN\n#ifdef O3_USE_JOINT_TEXTURE\nmat4 skinMatrix=WEIGHTS_0.x*getJointMatrix(u_jointSampler,JOINTS_0.x)+WEIGHTS_0.y*getJointMatrix(u_jointSampler,JOINTS_0.y)+WEIGHTS_0.z*getJointMatrix(u_jointSampler,JOINTS_0.z)+WEIGHTS_0.w*getJointMatrix(u_jointSampler,JOINTS_0.w);\n#else\nmat4 skinMatrix=WEIGHTS_0.x*u_jointMatrix[int(JOINTS_0.x)]+WEIGHTS_0.y*u_jointMatrix[int(JOINTS_0.y)]+WEIGHTS_0.z*u_jointMatrix[int(JOINTS_0.z)]+WEIGHTS_0.w*u_jointMatrix[int(JOINTS_0.w)];\n#endif\nposition=skinMatrix*position;\n#if defined(O3_HAS_NORMAL) && !defined(OMIT_NORMAL)\nnormal=vec4(skinMatrix*vec4(normal,0.0)).xyz;\n#if defined(O3_HAS_TANGENT) && ( defined(O3_NORMAL_TEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE) )\ntangent.xyz=vec4(skinMatrix*vec4(tangent.xyz,0.0)).xyz;\n#endif\n#endif\n#endif\n",blendShape_input:"#define GLSLIFY 1\n#ifdef OASIS_BLENDSHAPE\n#ifdef OASIS_BLENDSHAPE_TEXTURE\nuniform mediump sampler2DArray u_blendShapeTexture;uniform ivec3 u_blendShapeTextureInfo;uniform float u_blendShapeWeights[OASIS_BLENDSHAPE_COUNT];\n#else\nattribute vec3 POSITION_BS0;attribute vec3 POSITION_BS1;attribute vec3 POSITION_BS2;attribute vec3 POSITION_BS3;\n#if defined( OASIS_BLENDSHAPE_NORMAL ) || defined( OASIS_BLENDSHAPE_TANGENT )\n#ifdef OASIS_BLENDSHAPE_NORMAL\nattribute vec3 NORMAL_BS0;attribute vec3 NORMAL_BS1;attribute vec3 NORMAL_BS2;attribute vec3 NORMAL_BS3;\n#endif\n#ifdef OASIS_BLENDSHAPE_TANGENT\nattribute vec3 TANGENT_BS0;attribute vec3 TANGENT_BS1;attribute vec3 TANGENT_BS2;attribute vec3 TANGENT_BS3;\n#endif\nuniform float u_blendShapeWeights[4];\n#else\nattribute vec3 POSITION_BS4;attribute vec3 POSITION_BS5;attribute vec3 POSITION_BS6;attribute vec3 POSITION_BS7;uniform float u_blendShapeWeights[8];\n#endif\n#endif\n#ifdef OASIS_BLENDSHAPE_TEXTURE\nvec3 getBlendShapeVertexElement(int blendShapeIndex,int vertexElementIndex){int y=vertexElementIndex/u_blendShapeTextureInfo.y;int x=vertexElementIndex-y*u_blendShapeTextureInfo.y;ivec3 uv=ivec3(x,y,blendShapeIndex);return texelFetch(u_blendShapeTexture,uv,0).xyz;}\n#endif\n#endif\n",blendShape_vert:"#define GLSLIFY 1\n#ifdef OASIS_BLENDSHAPE\n#ifdef OASIS_BLENDSHAPE_TEXTURE\nint vertexOffset=gl_VertexID*u_blendShapeTextureInfo.x;for(int i=0;i<OASIS_BLENDSHAPE_COUNT;i++){int vertexElementOffset=vertexOffset;float weight=u_blendShapeWeights[i];position.xyz+=getBlendShapeVertexElement(i,vertexElementOffset)*weight;\n#ifndef OMIT_NORMAL\n#if defined( O3_HAS_NORMAL ) && defined( OASIS_BLENDSHAPE_NORMAL )\nvertexElementOffset+=1;normal+=getBlendShapeVertexElement(i,vertexElementOffset)*weight;\n#endif\n#if defined( O3_HAS_TANGENT ) && defined(OASIS_BLENDSHAPE_TANGENT) && ( defined(O3_NORMAL_TEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE) )\nvertexElementOffset+=1;tangent.xyz+=getBlendShapeVertexElement(i,vertexElementOffset)*weight;\n#endif\n#endif\n}\n#else\nposition.xyz+=POSITION_BS0*u_blendShapeWeights[0];position.xyz+=POSITION_BS1*u_blendShapeWeights[1];position.xyz+=POSITION_BS2*u_blendShapeWeights[2];position.xyz+=POSITION_BS3*u_blendShapeWeights[3];\n#if defined( OASIS_BLENDSHAPE_NORMAL ) || defined( OASIS_BLENDSHAPE_TANGENT )\n#ifndef OMIT_NORMAL\n#if defined( O3_HAS_NORMAL ) && defined( OASIS_BLENDSHAPE_NORMAL )\nnormal+=NORMAL_BS0*u_blendShapeWeights[0];normal+=NORMAL_BS1*u_blendShapeWeights[1];normal+=NORMAL_BS2*u_blendShapeWeights[2];normal+=NORMAL_BS3*u_blendShapeWeights[3];\n#endif\n#if defined( O3_HAS_TANGENT ) && defined(OASIS_BLENDSHAPE_TANGENT) && ( defined(O3_NORMAL_TEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE) )\ntangent.xyz+=TANGENT_BS0*u_blendShapeWeights[0];tangent.xyz+=TANGENT_BS1*u_blendShapeWeights[1];tangent.xyz+=TANGENT_BS2*u_blendShapeWeights[2];tangent.xyz+=TANGENT_BS3*u_blendShapeWeights[3];\n#endif\n#endif\n#else\nposition.xyz+=POSITION_BS4*u_blendShapeWeights[4];position.xyz+=POSITION_BS5*u_blendShapeWeights[5];position.xyz+=POSITION_BS6*u_blendShapeWeights[6];position.xyz+=POSITION_BS7*u_blendShapeWeights[7];\n#endif\n#endif\n#endif\n",uv_vert:"#define GLSLIFY 1\n#ifdef O3_HAS_UV\nv_uv=TEXCOORD_0;\n#else\nv_uv=vec2(0.,0.);\n#endif\n#ifdef O3_HAS_UV1\nv_uv1=TEXCOORD_1;\n#endif\n#ifdef O3_NEED_TILINGOFFSET\nv_uv=v_uv*u_tilingOffset.xy+u_tilingOffset.zw;\n#endif\n",worldpos_vert:"#define GLSLIFY 1\n#ifdef O3_NEED_WORLDPOS\nvec4 temp_pos=u_modelMat*position;v_pos=temp_pos.xyz/temp_pos.w;\n#endif\n",shadow_vert:"#define GLSLIFY 1\n#ifdef O3_GENERATE_SHADOW_MAP\ngl_Position=u_projMatFromLight*u_viewMatFromLight*u_modelMat*position;\n#endif\n#ifdef O3_SHADOW_MAP_COUNT\nfor(int i=0;i<O3_SHADOW_MAP_COUNT;i++){v_PositionFromLight[i]=u_projMatFromLight[i]*u_viewMatFromLight[i]*u_modelMat*vec4(POSITION,1.0);}\n#endif\n",fog_vert:"#define GLSLIFY 1\n#ifdef O3_HAS_FOG\nv_fogDepth=(u_MVMat*position).xyz;\n#endif\n",light_frag_define:"#define GLSLIFY 1\n#ifdef O3_DIRECT_LIGHT_COUNT\nstruct DirectLight{vec3 color;vec3 direction;};uniform vec3 u_directLightColor[O3_DIRECT_LIGHT_COUNT];uniform vec3 u_directLightDirection[O3_DIRECT_LIGHT_COUNT];\n#endif\n#ifdef O3_POINT_LIGHT_COUNT\nstruct PointLight{vec3 color;vec3 position;float distance;};uniform vec3 u_pointLightColor[O3_POINT_LIGHT_COUNT];uniform vec3 u_pointLightPosition[O3_POINT_LIGHT_COUNT];uniform float u_pointLightDistance[O3_POINT_LIGHT_COUNT];\n#endif\n#ifdef O3_SPOT_LIGHT_COUNT\nstruct SpotLight{vec3 color;vec3 position;vec3 direction;float distance;float angleCos;float penumbraCos;};uniform vec3 u_spotLightColor[O3_SPOT_LIGHT_COUNT];uniform vec3 u_spotLightPosition[O3_SPOT_LIGHT_COUNT];uniform vec3 u_spotLightDirection[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightDistance[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightAngleCos[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightPenumbraCos[O3_SPOT_LIGHT_COUNT];\n#endif\nstruct EnvMapLight{vec3 diffuse;float mipMapLevel;float diffuseIntensity;float specularIntensity;};uniform EnvMapLight u_envMapLight;\n#ifdef O3_USE_SH\nuniform vec3 u_env_sh[9];\n#endif\n#ifdef O3_USE_SPECULAR_ENV\nuniform samplerCube u_env_specularSampler;\n#endif\n",mobile_material_frag:"#define GLSLIFY 1\nuniform vec4 u_emissiveColor;uniform vec4 u_diffuseColor;uniform vec4 u_specularColor;uniform float u_shininess;uniform float u_normalIntensity;uniform float u_alphaCutoff;\n#ifdef O3_EMISSIVE_TEXTURE\nuniform sampler2D u_emissiveTexture;\n#endif\n#ifdef O3_DIFFUSE_TEXTURE\nuniform sampler2D u_diffuseTexture;\n#endif\n#ifdef O3_SPECULAR_TEXTURE\nuniform sampler2D u_specularTexture;\n#endif\n#ifdef O3_NORMAL_TEXTURE\nuniform sampler2D u_normalTexture;\n#endif\n",fog_frag:"#define GLSLIFY 1\n#ifdef O3_HAS_FOG\nfloat fogDepth=length(v_fogDepth);\n#ifdef O3_FOG_EXP2\nfloat fogFactor=whiteCompliment(exp2(-u_fogDensity*u_fogDensity*fogDepth*fogDepth*LOG2));\n#else\nfloat fogFactor=smoothstep(u_fogNear,u_fogFar,fogDepth);\n#endif\ngl_FragColor.rgb=mix(gl_FragColor.rgb,u_fogColor,fogFactor);\n#endif\n",begin_mobile_frag:"#define GLSLIFY 1\nvec4 ambient=vec4(0.0);vec4 emission=u_emissiveColor;vec4 diffuse=u_diffuseColor;vec4 specular=u_specularColor;\n#ifdef O3_EMISSIVE_TEXTURE\nvec4 emissiveTextureColor=texture2D(u_emissiveTexture,v_uv);\n#ifndef OASIS_COLORSPACE_GAMMA\nemissiveTextureColor=gammaToLinear(emissiveTextureColor);\n#endif\nemission*=emissiveTextureColor;\n#endif\n#ifdef O3_DIFFUSE_TEXTURE\nvec4 diffuseTextureColor=texture2D(u_diffuseTexture,v_uv);\n#ifndef OASIS_COLORSPACE_GAMMA\ndiffuseTextureColor=gammaToLinear(diffuseTextureColor);\n#endif\ndiffuse*=diffuseTextureColor;\n#endif\n#ifdef O3_HAS_VERTEXCOLOR\ndiffuse*=v_color;\n#endif\n#ifdef O3_SPECULAR_TEXTURE\nvec4 specularTextureColor=texture2D(u_specularTexture,v_uv);\n#ifndef OASIS_COLORSPACE_GAMMA\nspecularTextureColor=gammaToLinear(specularTextureColor);\n#endif\nspecular*=specularTextureColor;\n#endif\nambient=vec4(u_envMapLight.diffuse*u_envMapLight.diffuseIntensity,1.0)*diffuse;",begin_viewdir_frag:"#define GLSLIFY 1\n#ifdef O3_NEED_WORLDPOS\nvec3 V=normalize(u_cameraPos-v_pos);\n#endif\n",mobile_blinnphong_frag:"#define GLSLIFY 1\n#ifdef O3_NORMAL_TEXTURE\nmat3 tbn=getTBN();vec3 N=getNormalByNormalTexture(tbn,u_normalTexture,u_normalIntensity,v_uv);\n#else\nvec3 N=getNormal();\n#endif\nvec3 lightDiffuse=vec3(0.0,0.0,0.0);vec3 lightSpecular=vec3(0.0,0.0,0.0);\n#ifdef O3_DIRECT_LIGHT_COUNT\nDirectLight directionalLight;for(int i=0;i<O3_DIRECT_LIGHT_COUNT;i++){directionalLight.color=u_directLightColor[i];directionalLight.direction=u_directLightDirection[i];float d=max(dot(N,-directionalLight.direction),0.0);lightDiffuse+=directionalLight.color*d;vec3 halfDir=normalize(V-directionalLight.direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),u_shininess);lightSpecular+=directionalLight.color*s;}\n#endif\n#ifdef O3_POINT_LIGHT_COUNT\nPointLight pointLight;for(int i=0;i<O3_POINT_LIGHT_COUNT;i++){pointLight.color=u_pointLightColor[i];pointLight.position=u_pointLightPosition[i];pointLight.distance=u_pointLightDistance[i];vec3 direction=v_pos-pointLight.position;float dist=length(direction);direction/=dist;float decay=clamp(1.0-pow(dist/pointLight.distance,4.0),0.0,1.0);float d=max(dot(N,-direction),0.0)*decay;lightDiffuse+=pointLight.color*d;vec3 halfDir=normalize(V-direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),u_shininess)*decay;lightSpecular+=pointLight.color*s;}\n#endif\n#ifdef O3_SPOT_LIGHT_COUNT\nSpotLight spotLight;for(int i=0;i<O3_SPOT_LIGHT_COUNT;i++){spotLight.color=u_spotLightColor[i];spotLight.position=u_spotLightPosition[i];spotLight.direction=u_spotLightDirection[i];spotLight.distance=u_spotLightDistance[i];spotLight.angleCos=u_spotLightAngleCos[i];spotLight.penumbraCos=u_spotLightPenumbraCos[i];vec3 direction=spotLight.position-v_pos;float lightDistance=length(direction);direction/=lightDistance;float angleCos=dot(direction,-spotLight.direction);float decay=clamp(1.0-pow(lightDistance/spotLight.distance,4.0),0.0,1.0);float spotEffect=smoothstep(spotLight.penumbraCos,spotLight.angleCos,angleCos);float decayTotal=decay*spotEffect;float d=max(dot(N,direction),0.0)*decayTotal;lightDiffuse+=spotLight.color*d;vec3 halfDir=normalize(V+direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),u_shininess)*decayTotal;lightSpecular+=spotLight.color*s;}\n#endif\ndiffuse*=vec4(lightDiffuse,1.0);specular*=vec4(lightSpecular,1.0);\n#ifdef ALPHA_CUTOFF\nif(diffuse.a<u_alphaCutoff){discard;}\n#endif\n",noise_common:"#define GLSLIFY 1\nvec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}vec3 mod289(vec3 x){return x-floor(x*(1.0/289.0))*289.0;}vec2 mod289(vec2 x){return x-floor(x*(1.0/289.0))*289.0;}float mod289(float x){return x-floor(x*(1.0/289.0))*289.0;}vec4 mod7(vec4 x){return x-floor(x*(1.0/7.0))*7.0;}vec3 mod7(vec3 x){return x-floor(x*(1.0/7.0))*7.0;}vec4 permute(vec4 x){return mod289((34.0*x+1.0)*x);}vec3 permute(vec3 x){return mod289((34.0*x+1.0)*x);}float permute(float x){return mod289(((x*34.0)+1.0)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-0.85373472095314*r;}float taylorInvSqrt(float r){return 1.79284291400159-0.85373472095314*r;}vec4 fade(vec4 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}vec3 fade(vec3 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}vec2 fade(vec2 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}\n#define K 0.142857142857\n#define Ko 0.428571428571\n#define K2 0.020408163265306\n#define Kd2 0.0714285714285\n#define Kz 0.166666666667\n#define Kzo 0.416666666667\n#define jitter 1.0\n#define jitter1 0.8\n",noise_cellular_2D:"#define GLSLIFY 1\nvec2 cellular(vec2 P){vec2 Pi=mod289(floor(P));vec2 Pf=fract(P);vec3 oi=vec3(-1.0,0.0,1.0);vec3 of=vec3(-0.5,0.5,1.5);vec3 px=permute(Pi.x+oi);vec3 p=permute(px.x+Pi.y+oi);vec3 ox=fract(p*K)-Ko;vec3 oy=mod7(floor(p*K))*K-Ko;vec3 dx=Pf.x+0.5+jitter*ox;vec3 dy=Pf.y-of+jitter*oy;vec3 d1=dx*dx+dy*dy;p=permute(px.y+Pi.y+oi);ox=fract(p*K)-Ko;oy=mod7(floor(p*K))*K-Ko;dx=Pf.x-0.5+jitter*ox;dy=Pf.y-of+jitter*oy;vec3 d2=dx*dx+dy*dy;p=permute(px.z+Pi.y+oi);ox=fract(p*K)-Ko;oy=mod7(floor(p*K))*K-Ko;dx=Pf.x-1.5+jitter*ox;dy=Pf.y-of+jitter*oy;vec3 d3=dx*dx+dy*dy;vec3 d1a=min(d1,d2);d2=max(d1,d2);d2=min(d2,d3);d1=min(d1a,d2);d2=max(d1a,d2);d1.xy=(d1.x<d1.y)? d1.xy : d1.yx;d1.xz=(d1.x<d1.z)? d1.xz : d1.zx;d1.yz=min(d1.yz,d2.yz);d1.y=min(d1.y,d1.z);d1.y=min(d1.y,d2.x);return sqrt(d1.xy);}",noise_cellular_2x2:"#define GLSLIFY 1\nvec2 cellular2x2(vec2 P){vec2 Pi=mod289(floor(P));vec2 Pf=fract(P);vec4 Pfx=Pf.x+vec4(-0.5,-1.5,-0.5,-1.5);vec4 Pfy=Pf.y+vec4(-0.5,-0.5,-1.5,-1.5);vec4 p=permute(Pi.x+vec4(0.0,1.0,0.0,1.0));p=permute(p+Pi.y+vec4(0.0,0.0,1.0,1.0));vec4 ox=mod7(p)*K+Kd2;vec4 oy=mod7(floor(p*K))*K+Kd2;vec4 dx=Pfx+jitter1*ox;vec4 dy=Pfy+jitter1*oy;vec4 d=dx*dx+dy*dy;d.xy=(d.x<d.y)? d.xy : d.yx;d.xz=(d.x<d.z)? d.xz : d.zx;d.xw=(d.x<d.w)? d.xw : d.wx;d.y=min(d.y,d.z);d.y=min(d.y,d.w);return sqrt(d.xy);}",noise_cellular_2x2x2:"#define GLSLIFY 1\nvec2 cellular2x2x2(vec3 P){vec3 Pi=mod289(floor(P));vec3 Pf=fract(P);vec4 Pfx=Pf.x+vec4(0.0,-1.0,0.0,-1.0);vec4 Pfy=Pf.y+vec4(0.0,0.0,-1.0,-1.0);vec4 p=permute(Pi.x+vec4(0.0,1.0,0.0,1.0));p=permute(p+Pi.y+vec4(0.0,0.0,1.0,1.0));vec4 p1=permute(p+Pi.z);vec4 p2=permute(p+Pi.z+vec4(1.0));vec4 ox1=fract(p1*K)-Ko;vec4 oy1=mod7(floor(p1*K))*K-Ko;vec4 oz1=floor(p1*K2)*Kz-Kzo;vec4 ox2=fract(p2*K)-Ko;vec4 oy2=mod7(floor(p2*K))*K-Ko;vec4 oz2=floor(p2*K2)*Kz-Kzo;vec4 dx1=Pfx+jitter1*ox1;vec4 dy1=Pfy+jitter1*oy1;vec4 dz1=Pf.z+jitter1*oz1;vec4 dx2=Pfx+jitter1*ox2;vec4 dy2=Pfy+jitter1*oy2;vec4 dz2=Pf.z-1.0+jitter1*oz2;vec4 d1=dx1*dx1+dy1*dy1+dz1*dz1;vec4 d2=dx2*dx2+dy2*dy2+dz2*dz2;vec4 d=min(d1,d2);d2=max(d1,d2);d.xy=(d.x<d.y)? d.xy : d.yx;d.xz=(d.x<d.z)? d.xz : d.zx;d.xw=(d.x<d.w)? d.xw : d.wx;d.yzw=min(d.yzw,d2.yzw);d.y=min(d.y,d.z);d.y=min(d.y,d.w);d.y=min(d.y,d2.x);return sqrt(d.xy);}",noise_cellular_3D:"#define GLSLIFY 1\nvec2 cellular(vec3 P){vec3 Pi=mod289(floor(P));vec3 Pf=fract(P)-0.5;vec3 Pfx=Pf.x+vec3(1.0,0.0,-1.0);vec3 Pfy=Pf.y+vec3(1.0,0.0,-1.0);vec3 Pfz=Pf.z+vec3(1.0,0.0,-1.0);vec3 p=permute(Pi.x+vec3(-1.0,0.0,1.0));vec3 p1=permute(p+Pi.y-1.0);vec3 p2=permute(p+Pi.y);vec3 p3=permute(p+Pi.y+1.0);vec3 p11=permute(p1+Pi.z-1.0);vec3 p12=permute(p1+Pi.z);vec3 p13=permute(p1+Pi.z+1.0);vec3 p21=permute(p2+Pi.z-1.0);vec3 p22=permute(p2+Pi.z);vec3 p23=permute(p2+Pi.z+1.0);vec3 p31=permute(p3+Pi.z-1.0);vec3 p32=permute(p3+Pi.z);vec3 p33=permute(p3+Pi.z+1.0);vec3 ox11=fract(p11*K)-Ko;vec3 oy11=mod7(floor(p11*K))*K-Ko;vec3 oz11=floor(p11*K2)*Kz-Kzo;vec3 ox12=fract(p12*K)-Ko;vec3 oy12=mod7(floor(p12*K))*K-Ko;vec3 oz12=floor(p12*K2)*Kz-Kzo;vec3 ox13=fract(p13*K)-Ko;vec3 oy13=mod7(floor(p13*K))*K-Ko;vec3 oz13=floor(p13*K2)*Kz-Kzo;vec3 ox21=fract(p21*K)-Ko;vec3 oy21=mod7(floor(p21*K))*K-Ko;vec3 oz21=floor(p21*K2)*Kz-Kzo;vec3 ox22=fract(p22*K)-Ko;vec3 oy22=mod7(floor(p22*K))*K-Ko;vec3 oz22=floor(p22*K2)*Kz-Kzo;vec3 ox23=fract(p23*K)-Ko;vec3 oy23=mod7(floor(p23*K))*K-Ko;vec3 oz23=floor(p23*K2)*Kz-Kzo;vec3 ox31=fract(p31*K)-Ko;vec3 oy31=mod7(floor(p31*K))*K-Ko;vec3 oz31=floor(p31*K2)*Kz-Kzo;vec3 ox32=fract(p32*K)-Ko;vec3 oy32=mod7(floor(p32*K))*K-Ko;vec3 oz32=floor(p32*K2)*Kz-Kzo;vec3 ox33=fract(p33*K)-Ko;vec3 oy33=mod7(floor(p33*K))*K-Ko;vec3 oz33=floor(p33*K2)*Kz-Kzo;vec3 dx11=Pfx+jitter*ox11;vec3 dy11=Pfy.x+jitter*oy11;vec3 dz11=Pfz.x+jitter*oz11;vec3 dx12=Pfx+jitter*ox12;vec3 dy12=Pfy.x+jitter*oy12;vec3 dz12=Pfz.y+jitter*oz12;vec3 dx13=Pfx+jitter*ox13;vec3 dy13=Pfy.x+jitter*oy13;vec3 dz13=Pfz.z+jitter*oz13;vec3 dx21=Pfx+jitter*ox21;vec3 dy21=Pfy.y+jitter*oy21;vec3 dz21=Pfz.x+jitter*oz21;vec3 dx22=Pfx+jitter*ox22;vec3 dy22=Pfy.y+jitter*oy22;vec3 dz22=Pfz.y+jitter*oz22;vec3 dx23=Pfx+jitter*ox23;vec3 dy23=Pfy.y+jitter*oy23;vec3 dz23=Pfz.z+jitter*oz23;vec3 dx31=Pfx+jitter*ox31;vec3 dy31=Pfy.z+jitter*oy31;vec3 dz31=Pfz.x+jitter*oz31;vec3 dx32=Pfx+jitter*ox32;vec3 dy32=Pfy.z+jitter*oy32;vec3 dz32=Pfz.y+jitter*oz32;vec3 dx33=Pfx+jitter*ox33;vec3 dy33=Pfy.z+jitter*oy33;vec3 dz33=Pfz.z+jitter*oz33;vec3 d11=dx11*dx11+dy11*dy11+dz11*dz11;vec3 d12=dx12*dx12+dy12*dy12+dz12*dz12;vec3 d13=dx13*dx13+dy13*dy13+dz13*dz13;vec3 d21=dx21*dx21+dy21*dy21+dz21*dz21;vec3 d22=dx22*dx22+dy22*dy22+dz22*dz22;vec3 d23=dx23*dx23+dy23*dy23+dz23*dz23;vec3 d31=dx31*dx31+dy31*dy31+dz31*dz31;vec3 d32=dx32*dx32+dy32*dy32+dz32*dz32;vec3 d33=dx33*dx33+dy33*dy33+dz33*dz33;vec3 d1a=min(d11,d12);d12=max(d11,d12);d11=min(d1a,d13);d13=max(d1a,d13);d12=min(d12,d13);vec3 d2a=min(d21,d22);d22=max(d21,d22);d21=min(d2a,d23);d23=max(d2a,d23);d22=min(d22,d23);vec3 d3a=min(d31,d32);d32=max(d31,d32);d31=min(d3a,d33);d33=max(d3a,d33);d32=min(d32,d33);vec3 da=min(d11,d21);d21=max(d11,d21);d11=min(da,d31);d31=max(da,d31);d11.xy=(d11.x<d11.y)? d11.xy : d11.yx;d11.xz=(d11.x<d11.z)? d11.xz : d11.zx;d12=min(d12,d21);d12=min(d12,d22);d12=min(d12,d31);d12=min(d12,d32);d11.yz=min(d11.yz,d12.xy);d11.y=min(d11.y,d12.z);d11.y=min(d11.y,d11.z);return sqrt(d11.xy);}",noise_cellular:"#define GLSLIFY 1\n#include <noise_cellular_2D>\n#include <noise_cellular_3D>\n#include <noise_cellular_2x2>\n#include <noise_cellular_2x2x2>\n",noise_perlin_2D:"#define GLSLIFY 1\nfloat perlin(vec2 P){vec4 Pi=floor(P.xyxy)+vec4(0.0,0.0,1.0,1.0);vec4 Pf=fract(P.xyxy)-vec4(0.0,0.0,1.0,1.0);Pi=mod289(Pi);vec4 ix=Pi.xzxz;vec4 iy=Pi.yyww;vec4 fx=Pf.xzxz;vec4 fy=Pf.yyww;vec4 i=permute(permute(ix)+iy);vec4 gx=fract(i*(1.0/41.0))*2.0-1.0;vec4 gy=abs(gx)-0.5;vec4 tx=floor(gx+0.5);gx=gx-tx;vec2 g00=vec2(gx.x,gy.x);vec2 g10=vec2(gx.y,gy.y);vec2 g01=vec2(gx.z,gy.z);vec2 g11=vec2(gx.w,gy.w);vec4 norm=taylorInvSqrt(vec4(dot(g00,g00),dot(g01,g01),dot(g10,g10),dot(g11,g11)));g00*=norm.x;g01*=norm.y;g10*=norm.z;g11*=norm.w;float n00=dot(g00,vec2(fx.x,fy.x));float n10=dot(g10,vec2(fx.y,fy.y));float n01=dot(g01,vec2(fx.z,fy.z));float n11=dot(g11,vec2(fx.w,fy.w));vec2 fade_xy=fade(Pf.xy);vec2 n_x=mix(vec2(n00,n01),vec2(n10,n11),fade_xy.x);float n_xy=mix(n_x.x,n_x.y,fade_xy.y);return 2.3*n_xy;}float perlin(vec2 P,vec2 rep){vec4 Pi=floor(P.xyxy)+vec4(0.0,0.0,1.0,1.0);vec4 Pf=fract(P.xyxy)-vec4(0.0,0.0,1.0,1.0);Pi=mod(Pi,rep.xyxy);Pi=mod289(Pi);vec4 ix=Pi.xzxz;vec4 iy=Pi.yyww;vec4 fx=Pf.xzxz;vec4 fy=Pf.yyww;vec4 i=permute(permute(ix)+iy);vec4 gx=fract(i*(1.0/41.0))*2.0-1.0;vec4 gy=abs(gx)-0.5;vec4 tx=floor(gx+0.5);gx=gx-tx;vec2 g00=vec2(gx.x,gy.x);vec2 g10=vec2(gx.y,gy.y);vec2 g01=vec2(gx.z,gy.z);vec2 g11=vec2(gx.w,gy.w);vec4 norm=taylorInvSqrt(vec4(dot(g00,g00),dot(g01,g01),dot(g10,g10),dot(g11,g11)));g00*=norm.x;g01*=norm.y;g10*=norm.z;g11*=norm.w;float n00=dot(g00,vec2(fx.x,fy.x));float n10=dot(g10,vec2(fx.y,fy.y));float n01=dot(g01,vec2(fx.z,fy.z));float n11=dot(g11,vec2(fx.w,fy.w));vec2 fade_xy=fade(Pf.xy);vec2 n_x=mix(vec2(n00,n01),vec2(n10,n11),fade_xy.x);float n_xy=mix(n_x.x,n_x.y,fade_xy.y);return 2.3*n_xy;}",noise_perlin_3D:"#define GLSLIFY 1\nfloat perlin(vec3 P){vec3 Pi0=floor(P);vec3 Pi1=Pi0+vec3(1.0);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec3 Pf0=fract(P);vec3 Pf1=Pf0-vec3(1.0);vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=Pi0.zzzz;vec4 iz1=Pi1.zzzz;vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 gx0=ixy0*(1.0/7.0);vec4 gy0=fract(floor(gx0)*(1.0/7.0))-0.5;gx0=fract(gx0);vec4 gz0=vec4(0.5)-abs(gx0)-abs(gy0);vec4 sz0=step(gz0,vec4(0.0));gx0-=sz0*(step(0.0,gx0)-0.5);gy0-=sz0*(step(0.0,gy0)-0.5);vec4 gx1=ixy1*(1.0/7.0);vec4 gy1=fract(floor(gx1)*(1.0/7.0))-0.5;gx1=fract(gx1);vec4 gz1=vec4(0.5)-abs(gx1)-abs(gy1);vec4 sz1=step(gz1,vec4(0.0));gx1-=sz1*(step(0.0,gx1)-0.5);gy1-=sz1*(step(0.0,gy1)-0.5);vec3 g000=vec3(gx0.x,gy0.x,gz0.x);vec3 g100=vec3(gx0.y,gy0.y,gz0.y);vec3 g010=vec3(gx0.z,gy0.z,gz0.z);vec3 g110=vec3(gx0.w,gy0.w,gz0.w);vec3 g001=vec3(gx1.x,gy1.x,gz1.x);vec3 g101=vec3(gx1.y,gy1.y,gz1.y);vec3 g011=vec3(gx1.z,gy1.z,gz1.z);vec3 g111=vec3(gx1.w,gy1.w,gz1.w);vec4 norm0=taylorInvSqrt(vec4(dot(g000,g000),dot(g010,g010),dot(g100,g100),dot(g110,g110)));g000*=norm0.x;g010*=norm0.y;g100*=norm0.z;g110*=norm0.w;vec4 norm1=taylorInvSqrt(vec4(dot(g001,g001),dot(g011,g011),dot(g101,g101),dot(g111,g111)));g001*=norm1.x;g011*=norm1.y;g101*=norm1.z;g111*=norm1.w;float n000=dot(g000,Pf0);float n100=dot(g100,vec3(Pf1.x,Pf0.yz));float n010=dot(g010,vec3(Pf0.x,Pf1.y,Pf0.z));float n110=dot(g110,vec3(Pf1.xy,Pf0.z));float n001=dot(g001,vec3(Pf0.xy,Pf1.z));float n101=dot(g101,vec3(Pf1.x,Pf0.y,Pf1.z));float n011=dot(g011,vec3(Pf0.x,Pf1.yz));float n111=dot(g111,Pf1);vec3 fade_xyz=fade(Pf0);vec4 n_z=mix(vec4(n000,n100,n010,n110),vec4(n001,n101,n011,n111),fade_xyz.z);vec2 n_yz=mix(n_z.xy,n_z.zw,fade_xyz.y);float n_xyz=mix(n_yz.x,n_yz.y,fade_xyz.x);return 2.2*n_xyz;}float perlin(vec3 P,vec3 rep){vec3 Pi0=mod(floor(P),rep);vec3 Pi1=mod(Pi0+vec3(1.0),rep);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec3 Pf0=fract(P);vec3 Pf1=Pf0-vec3(1.0);vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=Pi0.zzzz;vec4 iz1=Pi1.zzzz;vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 gx0=ixy0*(1.0/7.0);vec4 gy0=fract(floor(gx0)*(1.0/7.0))-0.5;gx0=fract(gx0);vec4 gz0=vec4(0.5)-abs(gx0)-abs(gy0);vec4 sz0=step(gz0,vec4(0.0));gx0-=sz0*(step(0.0,gx0)-0.5);gy0-=sz0*(step(0.0,gy0)-0.5);vec4 gx1=ixy1*(1.0/7.0);vec4 gy1=fract(floor(gx1)*(1.0/7.0))-0.5;gx1=fract(gx1);vec4 gz1=vec4(0.5)-abs(gx1)-abs(gy1);vec4 sz1=step(gz1,vec4(0.0));gx1-=sz1*(step(0.0,gx1)-0.5);gy1-=sz1*(step(0.0,gy1)-0.5);vec3 g000=vec3(gx0.x,gy0.x,gz0.x);vec3 g100=vec3(gx0.y,gy0.y,gz0.y);vec3 g010=vec3(gx0.z,gy0.z,gz0.z);vec3 g110=vec3(gx0.w,gy0.w,gz0.w);vec3 g001=vec3(gx1.x,gy1.x,gz1.x);vec3 g101=vec3(gx1.y,gy1.y,gz1.y);vec3 g011=vec3(gx1.z,gy1.z,gz1.z);vec3 g111=vec3(gx1.w,gy1.w,gz1.w);vec4 norm0=taylorInvSqrt(vec4(dot(g000,g000),dot(g010,g010),dot(g100,g100),dot(g110,g110)));g000*=norm0.x;g010*=norm0.y;g100*=norm0.z;g110*=norm0.w;vec4 norm1=taylorInvSqrt(vec4(dot(g001,g001),dot(g011,g011),dot(g101,g101),dot(g111,g111)));g001*=norm1.x;g011*=norm1.y;g101*=norm1.z;g111*=norm1.w;float n000=dot(g000,Pf0);float n100=dot(g100,vec3(Pf1.x,Pf0.yz));float n010=dot(g010,vec3(Pf0.x,Pf1.y,Pf0.z));float n110=dot(g110,vec3(Pf1.xy,Pf0.z));float n001=dot(g001,vec3(Pf0.xy,Pf1.z));float n101=dot(g101,vec3(Pf1.x,Pf0.y,Pf1.z));float n011=dot(g011,vec3(Pf0.x,Pf1.yz));float n111=dot(g111,Pf1);vec3 fade_xyz=fade(Pf0);vec4 n_z=mix(vec4(n000,n100,n010,n110),vec4(n001,n101,n011,n111),fade_xyz.z);vec2 n_yz=mix(n_z.xy,n_z.zw,fade_xyz.y);float n_xyz=mix(n_yz.x,n_yz.y,fade_xyz.x);return 2.2*n_xyz;}",noise_perlin_4D:"#define GLSLIFY 1\nfloat perlin(vec4 P){vec4 Pi0=floor(P);vec4 Pi1=Pi0+1.0;Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec4 Pf0=fract(P);vec4 Pf1=Pf0-1.0;vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=vec4(Pi0.zzzz);vec4 iz1=vec4(Pi1.zzzz);vec4 iw0=vec4(Pi0.wwww);vec4 iw1=vec4(Pi1.wwww);vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 ixy00=permute(ixy0+iw0);vec4 ixy01=permute(ixy0+iw1);vec4 ixy10=permute(ixy1+iw0);vec4 ixy11=permute(ixy1+iw1);vec4 gx00=ixy00*(1.0/7.0);vec4 gy00=floor(gx00)*(1.0/7.0);vec4 gz00=floor(gy00)*(1.0/6.0);gx00=fract(gx00)-0.5;gy00=fract(gy00)-0.5;gz00=fract(gz00)-0.5;vec4 gw00=vec4(0.75)-abs(gx00)-abs(gy00)-abs(gz00);vec4 sw00=step(gw00,vec4(0.0));gx00-=sw00*(step(0.0,gx00)-0.5);gy00-=sw00*(step(0.0,gy00)-0.5);vec4 gx01=ixy01*(1.0/7.0);vec4 gy01=floor(gx01)*(1.0/7.0);vec4 gz01=floor(gy01)*(1.0/6.0);gx01=fract(gx01)-0.5;gy01=fract(gy01)-0.5;gz01=fract(gz01)-0.5;vec4 gw01=vec4(0.75)-abs(gx01)-abs(gy01)-abs(gz01);vec4 sw01=step(gw01,vec4(0.0));gx01-=sw01*(step(0.0,gx01)-0.5);gy01-=sw01*(step(0.0,gy01)-0.5);vec4 gx10=ixy10*(1.0/7.0);vec4 gy10=floor(gx10)*(1.0/7.0);vec4 gz10=floor(gy10)*(1.0/6.0);gx10=fract(gx10)-0.5;gy10=fract(gy10)-0.5;gz10=fract(gz10)-0.5;vec4 gw10=vec4(0.75)-abs(gx10)-abs(gy10)-abs(gz10);vec4 sw10=step(gw10,vec4(0.0));gx10-=sw10*(step(0.0,gx10)-0.5);gy10-=sw10*(step(0.0,gy10)-0.5);vec4 gx11=ixy11*(1.0/7.0);vec4 gy11=floor(gx11)*(1.0/7.0);vec4 gz11=floor(gy11)*(1.0/6.0);gx11=fract(gx11)-0.5;gy11=fract(gy11)-0.5;gz11=fract(gz11)-0.5;vec4 gw11=vec4(0.75)-abs(gx11)-abs(gy11)-abs(gz11);vec4 sw11=step(gw11,vec4(0.0));gx11-=sw11*(step(0.0,gx11)-0.5);gy11-=sw11*(step(0.0,gy11)-0.5);vec4 g0000=vec4(gx00.x,gy00.x,gz00.x,gw00.x);vec4 g1000=vec4(gx00.y,gy00.y,gz00.y,gw00.y);vec4 g0100=vec4(gx00.z,gy00.z,gz00.z,gw00.z);vec4 g1100=vec4(gx00.w,gy00.w,gz00.w,gw00.w);vec4 g0010=vec4(gx10.x,gy10.x,gz10.x,gw10.x);vec4 g1010=vec4(gx10.y,gy10.y,gz10.y,gw10.y);vec4 g0110=vec4(gx10.z,gy10.z,gz10.z,gw10.z);vec4 g1110=vec4(gx10.w,gy10.w,gz10.w,gw10.w);vec4 g0001=vec4(gx01.x,gy01.x,gz01.x,gw01.x);vec4 g1001=vec4(gx01.y,gy01.y,gz01.y,gw01.y);vec4 g0101=vec4(gx01.z,gy01.z,gz01.z,gw01.z);vec4 g1101=vec4(gx01.w,gy01.w,gz01.w,gw01.w);vec4 g0011=vec4(gx11.x,gy11.x,gz11.x,gw11.x);vec4 g1011=vec4(gx11.y,gy11.y,gz11.y,gw11.y);vec4 g0111=vec4(gx11.z,gy11.z,gz11.z,gw11.z);vec4 g1111=vec4(gx11.w,gy11.w,gz11.w,gw11.w);vec4 norm00=taylorInvSqrt(vec4(dot(g0000,g0000),dot(g0100,g0100),dot(g1000,g1000),dot(g1100,g1100)));g0000*=norm00.x;g0100*=norm00.y;g1000*=norm00.z;g1100*=norm00.w;vec4 norm01=taylorInvSqrt(vec4(dot(g0001,g0001),dot(g0101,g0101),dot(g1001,g1001),dot(g1101,g1101)));g0001*=norm01.x;g0101*=norm01.y;g1001*=norm01.z;g1101*=norm01.w;vec4 norm10=taylorInvSqrt(vec4(dot(g0010,g0010),dot(g0110,g0110),dot(g1010,g1010),dot(g1110,g1110)));g0010*=norm10.x;g0110*=norm10.y;g1010*=norm10.z;g1110*=norm10.w;vec4 norm11=taylorInvSqrt(vec4(dot(g0011,g0011),dot(g0111,g0111),dot(g1011,g1011),dot(g1111,g1111)));g0011*=norm11.x;g0111*=norm11.y;g1011*=norm11.z;g1111*=norm11.w;float n0000=dot(g0000,Pf0);float n1000=dot(g1000,vec4(Pf1.x,Pf0.yzw));float n0100=dot(g0100,vec4(Pf0.x,Pf1.y,Pf0.zw));float n1100=dot(g1100,vec4(Pf1.xy,Pf0.zw));float n0010=dot(g0010,vec4(Pf0.xy,Pf1.z,Pf0.w));float n1010=dot(g1010,vec4(Pf1.x,Pf0.y,Pf1.z,Pf0.w));float n0110=dot(g0110,vec4(Pf0.x,Pf1.yz,Pf0.w));float n1110=dot(g1110,vec4(Pf1.xyz,Pf0.w));float n0001=dot(g0001,vec4(Pf0.xyz,Pf1.w));float n1001=dot(g1001,vec4(Pf1.x,Pf0.yz,Pf1.w));float n0101=dot(g0101,vec4(Pf0.x,Pf1.y,Pf0.z,Pf1.w));float n1101=dot(g1101,vec4(Pf1.xy,Pf0.z,Pf1.w));float n0011=dot(g0011,vec4(Pf0.xy,Pf1.zw));float n1011=dot(g1011,vec4(Pf1.x,Pf0.y,Pf1.zw));float n0111=dot(g0111,vec4(Pf0.x,Pf1.yzw));float n1111=dot(g1111,Pf1);vec4 fade_xyzw=fade(Pf0);vec4 n_0w=mix(vec4(n0000,n1000,n0100,n1100),vec4(n0001,n1001,n0101,n1101),fade_xyzw.w);vec4 n_1w=mix(vec4(n0010,n1010,n0110,n1110),vec4(n0011,n1011,n0111,n1111),fade_xyzw.w);vec4 n_zw=mix(n_0w,n_1w,fade_xyzw.z);vec2 n_yzw=mix(n_zw.xy,n_zw.zw,fade_xyzw.y);float n_xyzw=mix(n_yzw.x,n_yzw.y,fade_xyzw.x);return 2.2*n_xyzw;}float perlin(vec4 P,vec4 rep){vec4 Pi0=mod(floor(P),rep);vec4 Pi1=mod(Pi0+1.0,rep);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec4 Pf0=fract(P);vec4 Pf1=Pf0-1.0;vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=vec4(Pi0.zzzz);vec4 iz1=vec4(Pi1.zzzz);vec4 iw0=vec4(Pi0.wwww);vec4 iw1=vec4(Pi1.wwww);vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 ixy00=permute(ixy0+iw0);vec4 ixy01=permute(ixy0+iw1);vec4 ixy10=permute(ixy1+iw0);vec4 ixy11=permute(ixy1+iw1);vec4 gx00=ixy00*(1.0/7.0);vec4 gy00=floor(gx00)*(1.0/7.0);vec4 gz00=floor(gy00)*(1.0/6.0);gx00=fract(gx00)-0.5;gy00=fract(gy00)-0.5;gz00=fract(gz00)-0.5;vec4 gw00=vec4(0.75)-abs(gx00)-abs(gy00)-abs(gz00);vec4 sw00=step(gw00,vec4(0.0));gx00-=sw00*(step(0.0,gx00)-0.5);gy00-=sw00*(step(0.0,gy00)-0.5);vec4 gx01=ixy01*(1.0/7.0);vec4 gy01=floor(gx01)*(1.0/7.0);vec4 gz01=floor(gy01)*(1.0/6.0);gx01=fract(gx01)-0.5;gy01=fract(gy01)-0.5;gz01=fract(gz01)-0.5;vec4 gw01=vec4(0.75)-abs(gx01)-abs(gy01)-abs(gz01);vec4 sw01=step(gw01,vec4(0.0));gx01-=sw01*(step(0.0,gx01)-0.5);gy01-=sw01*(step(0.0,gy01)-0.5);vec4 gx10=ixy10*(1.0/7.0);vec4 gy10=floor(gx10)*(1.0/7.0);vec4 gz10=floor(gy10)*(1.0/6.0);gx10=fract(gx10)-0.5;gy10=fract(gy10)-0.5;gz10=fract(gz10)-0.5;vec4 gw10=vec4(0.75)-abs(gx10)-abs(gy10)-abs(gz10);vec4 sw10=step(gw10,vec4(0.0));gx10-=sw10*(step(0.0,gx10)-0.5);gy10-=sw10*(step(0.0,gy10)-0.5);vec4 gx11=ixy11*(1.0/7.0);vec4 gy11=floor(gx11)*(1.0/7.0);vec4 gz11=floor(gy11)*(1.0/6.0);gx11=fract(gx11)-0.5;gy11=fract(gy11)-0.5;gz11=fract(gz11)-0.5;vec4 gw11=vec4(0.75)-abs(gx11)-abs(gy11)-abs(gz11);vec4 sw11=step(gw11,vec4(0.0));gx11-=sw11*(step(0.0,gx11)-0.5);gy11-=sw11*(step(0.0,gy11)-0.5);vec4 g0000=vec4(gx00.x,gy00.x,gz00.x,gw00.x);vec4 g1000=vec4(gx00.y,gy00.y,gz00.y,gw00.y);vec4 g0100=vec4(gx00.z,gy00.z,gz00.z,gw00.z);vec4 g1100=vec4(gx00.w,gy00.w,gz00.w,gw00.w);vec4 g0010=vec4(gx10.x,gy10.x,gz10.x,gw10.x);vec4 g1010=vec4(gx10.y,gy10.y,gz10.y,gw10.y);vec4 g0110=vec4(gx10.z,gy10.z,gz10.z,gw10.z);vec4 g1110=vec4(gx10.w,gy10.w,gz10.w,gw10.w);vec4 g0001=vec4(gx01.x,gy01.x,gz01.x,gw01.x);vec4 g1001=vec4(gx01.y,gy01.y,gz01.y,gw01.y);vec4 g0101=vec4(gx01.z,gy01.z,gz01.z,gw01.z);vec4 g1101=vec4(gx01.w,gy01.w,gz01.w,gw01.w);vec4 g0011=vec4(gx11.x,gy11.x,gz11.x,gw11.x);vec4 g1011=vec4(gx11.y,gy11.y,gz11.y,gw11.y);vec4 g0111=vec4(gx11.z,gy11.z,gz11.z,gw11.z);vec4 g1111=vec4(gx11.w,gy11.w,gz11.w,gw11.w);vec4 norm00=taylorInvSqrt(vec4(dot(g0000,g0000),dot(g0100,g0100),dot(g1000,g1000),dot(g1100,g1100)));g0000*=norm00.x;g0100*=norm00.y;g1000*=norm00.z;g1100*=norm00.w;vec4 norm01=taylorInvSqrt(vec4(dot(g0001,g0001),dot(g0101,g0101),dot(g1001,g1001),dot(g1101,g1101)));g0001*=norm01.x;g0101*=norm01.y;g1001*=norm01.z;g1101*=norm01.w;vec4 norm10=taylorInvSqrt(vec4(dot(g0010,g0010),dot(g0110,g0110),dot(g1010,g1010),dot(g1110,g1110)));g0010*=norm10.x;g0110*=norm10.y;g1010*=norm10.z;g1110*=norm10.w;vec4 norm11=taylorInvSqrt(vec4(dot(g0011,g0011),dot(g0111,g0111),dot(g1011,g1011),dot(g1111,g1111)));g0011*=norm11.x;g0111*=norm11.y;g1011*=norm11.z;g1111*=norm11.w;float n0000=dot(g0000,Pf0);float n1000=dot(g1000,vec4(Pf1.x,Pf0.yzw));float n0100=dot(g0100,vec4(Pf0.x,Pf1.y,Pf0.zw));float n1100=dot(g1100,vec4(Pf1.xy,Pf0.zw));float n0010=dot(g0010,vec4(Pf0.xy,Pf1.z,Pf0.w));float n1010=dot(g1010,vec4(Pf1.x,Pf0.y,Pf1.z,Pf0.w));float n0110=dot(g0110,vec4(Pf0.x,Pf1.yz,Pf0.w));float n1110=dot(g1110,vec4(Pf1.xyz,Pf0.w));float n0001=dot(g0001,vec4(Pf0.xyz,Pf1.w));float n1001=dot(g1001,vec4(Pf1.x,Pf0.yz,Pf1.w));float n0101=dot(g0101,vec4(Pf0.x,Pf1.y,Pf0.z,Pf1.w));float n1101=dot(g1101,vec4(Pf1.xy,Pf0.z,Pf1.w));float n0011=dot(g0011,vec4(Pf0.xy,Pf1.zw));float n1011=dot(g1011,vec4(Pf1.x,Pf0.y,Pf1.zw));float n0111=dot(g0111,vec4(Pf0.x,Pf1.yzw));float n1111=dot(g1111,Pf1);vec4 fade_xyzw=fade(Pf0);vec4 n_0w=mix(vec4(n0000,n1000,n0100,n1100),vec4(n0001,n1001,n0101,n1101),fade_xyzw.w);vec4 n_1w=mix(vec4(n0010,n1010,n0110,n1110),vec4(n0011,n1011,n0111,n1111),fade_xyzw.w);vec4 n_zw=mix(n_0w,n_1w,fade_xyzw.z);vec2 n_yzw=mix(n_zw.xy,n_zw.zw,fade_xyzw.y);float n_xyzw=mix(n_yzw.x,n_yzw.y,fade_xyzw.x);return 2.2*n_xyzw;}",noise_perlin:"#define GLSLIFY 1\n#include <noise_perlin_2D>\n#include <noise_perlin_3D>\n#include <noise_perlin_4D>\n",noise_psrd_2D:"#define GLSLIFY 1\nvec2 rgrad2(vec2 p,float rot){float u=permute(permute(p.x)+p.y)*0.0243902439+rot;u=fract(u)*6.28318530718;return vec2(cos(u),sin(u));}vec3 psrdnoise(vec2 pos,vec2 per,float rot){pos.y+=0.01;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 xw=mod(vec3(p0.x,p1.x,p2.x),per.x);vec3 yw=mod(vec3(p0.y,p1.y,p2.y),per.y);vec3 iuw=xw+0.5*yw;vec3 ivw=yw;vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));vec3 dtdx=-2.0*vec3(d0.x,d1.x,d2.x);vec3 dtdy=-2.0*vec3(d0.y,d1.y,d2.y);if(t.x<0.0){dtdx.x=0.0;dtdy.x=0.0;t.x=0.0;}if(t.y<0.0){dtdx.y=0.0;dtdy.y=0.0;t.y=0.0;}if(t.z<0.0){dtdx.z=0.0;dtdy.z=0.0;t.z=0.0;}vec3 t2=t*t;vec3 t4=t2*t2;vec3 t3=t2*t;float n=dot(t4,w);vec2 dt0=vec2(dtdx.x,dtdy.x)*4.0*t3.x;vec2 dn0=t4.x*g0+dt0*w.x;vec2 dt1=vec2(dtdx.y,dtdy.y)*4.0*t3.y;vec2 dn1=t4.y*g1+dt1*w.y;vec2 dt2=vec2(dtdx.z,dtdy.z)*4.0*t3.z;vec2 dn2=t4.z*g2+dt2*w.z;return 11.0*vec3(n,dn0+dn1+dn2);}vec3 psdnoise(vec2 pos,vec2 per){return psrdnoise(pos,per,0.0);}float psrnoise(vec2 pos,vec2 per,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 xw=mod(vec3(p0.x,p1.x,p2.x),per.x);vec3 yw=mod(vec3(p0.y,p1.y,p2.y),per.y);vec3 iuw=xw+0.5*yw;vec3 ivw=yw;vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));t=max(t,0.0);vec3 t2=t*t;vec3 t4=t2*t2;float n=dot(t4,w);return 11.0*n;}float psnoise(vec2 pos,vec2 per){return psrnoise(pos,per,0.0);}vec3 srdnoise(vec2 pos,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 x=vec3(p0.x,p1.x,p2.x);vec3 y=vec3(p0.y,p1.y,p2.y);vec3 iuw=x+0.5*y;vec3 ivw=y;iuw=mod289(iuw);ivw=mod289(ivw);vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));vec3 dtdx=-2.0*vec3(d0.x,d1.x,d2.x);vec3 dtdy=-2.0*vec3(d0.y,d1.y,d2.y);if(t.x<0.0){dtdx.x=0.0;dtdy.x=0.0;t.x=0.0;}if(t.y<0.0){dtdx.y=0.0;dtdy.y=0.0;t.y=0.0;}if(t.z<0.0){dtdx.z=0.0;dtdy.z=0.0;t.z=0.0;}vec3 t2=t*t;vec3 t4=t2*t2;vec3 t3=t2*t;float n=dot(t4,w);vec2 dt0=vec2(dtdx.x,dtdy.x)*4.0*t3.x;vec2 dn0=t4.x*g0+dt0*w.x;vec2 dt1=vec2(dtdx.y,dtdy.y)*4.0*t3.y;vec2 dn1=t4.y*g1+dt1*w.y;vec2 dt2=vec2(dtdx.z,dtdy.z)*4.0*t3.z;vec2 dn2=t4.z*g2+dt2*w.z;return 11.0*vec3(n,dn0+dn1+dn2);}vec3 sdnoise(vec2 pos){return srdnoise(pos,0.0);}float srnoise(vec2 pos,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 x=vec3(p0.x,p1.x,p2.x);vec3 y=vec3(p0.y,p1.y,p2.y);vec3 iuw=x+0.5*y;vec3 ivw=y;iuw=mod289(iuw);ivw=mod289(ivw);vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));t=max(t,0.0);vec3 t2=t*t;vec3 t4=t2*t2;float n=dot(t4,w);return 11.0*n;}float snoise(vec2 pos){return srnoise(pos,0.0);}",noise_simplex_2D:"#define GLSLIFY 1\nfloat simplex(vec2 v){const vec4 C=vec4(0.211324865405187,0.366025403784439,-0.577350269189626,0.024390243902439);vec2 i=floor(v+dot(v,C.yy));vec2 x0=v-i+dot(i,C.xx);vec2 i1;i1=(x0.x>x0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec4 x12=x0.xyxy+C.xxzz;x12.xy-=i1;i=mod289(i);vec3 p=permute(permute(i.y+vec3(0.0,i1.y,1.0))+i.x+vec3(0.0,i1.x,1.0));vec3 m=max(0.5-vec3(dot(x0,x0),dot(x12.xy,x12.xy),dot(x12.zw,x12.zw)),0.0);m=m*m;m=m*m;vec3 x=2.0*fract(p*C.www)-1.0;vec3 h=abs(x)-0.5;vec3 ox=floor(x+0.5);vec3 a0=x-ox;m*=1.79284291400159-0.85373472095314*(a0*a0+h*h);vec3 g;g.x=a0.x*x0.x+h.x*x0.y;g.yz=a0.yz*x12.xz+h.yz*x12.yw;return 130.0*dot(m,g);}",noise_simplex_3D_grad:"#define GLSLIFY 1\nfloat simplex(vec3 v,out vec3 gradient){const vec2 C=vec2(1.0/6.0,1.0/3.0);const vec4 D=vec4(0.0,0.5,1.0,2.0);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.0-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.0,i1.z,i2.z,1.0))+i.y+vec4(0.0,i1.y,i2.y,1.0))+i.x+vec4(0.0,i1.x,i2.x,1.0));float n_=0.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.0*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.0*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.0-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.0+1.0;vec4 s1=floor(b1)*2.0+1.0;vec4 sh=-step(h,vec4(0.0));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);vec4 m2=m*m;vec4 m4=m2*m2;vec4 pdotx=vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3));vec4 temp=m2*m*pdotx;gradient=-8.0*(temp.x*x0+temp.y*x1+temp.z*x2+temp.w*x3);gradient+=m4.x*p0+m4.y*p1+m4.z*p2+m4.w*p3;gradient*=42.0;return 42.0*dot(m4,pdotx);}",noise_simplex_3D:"#define GLSLIFY 1\nfloat simplex(vec3 v){const vec2 C=vec2(1.0/6.0,1.0/3.0);const vec4 D=vec4(0.0,0.5,1.0,2.0);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.0-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.0,i1.z,i2.z,1.0))+i.y+vec4(0.0,i1.y,i2.y,1.0))+i.x+vec4(0.0,i1.x,i2.x,1.0));float n_=0.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.0*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.0*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.0-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.0+1.0;vec4 s1=floor(b1)*2.0+1.0;vec4 sh=-step(h,vec4(0.0));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);m=m*m;return 42.0*dot(m*m,vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3)));}",noise_simplex_4D:"#define GLSLIFY 1\nvec4 grad4(float j,vec4 ip){const vec4 ones=vec4(1.0,1.0,1.0,-1.0);vec4 p,s;p.xyz=floor(fract(vec3(j)*ip.xyz)*7.0)*ip.z-1.0;p.w=1.5-dot(abs(p.xyz),ones.xyz);s=vec4(lessThan(p,vec4(0.0)));p.xyz=p.xyz+(s.xyz*2.0-1.0)*s.www;return p;}\n#define F4 0.309016994374947451\nfloat simplex(vec4 v){const vec4 C=vec4(0.138196601125011,0.276393202250021,0.414589803375032,-0.447213595499958);vec4 i=floor(v+dot(v,vec4(F4)));vec4 x0=v-i+dot(i,C.xxxx);vec4 i0;vec3 isX=step(x0.yzw,x0.xxx);vec3 isYZ=step(x0.zww,x0.yyz);i0.x=isX.x+isX.y+isX.z;i0.yzw=1.0-isX;i0.y+=isYZ.x+isYZ.y;i0.zw+=1.0-isYZ.xy;i0.z+=isYZ.z;i0.w+=1.0-isYZ.z;vec4 i3=clamp(i0,0.0,1.0);vec4 i2=clamp(i0-1.0,0.0,1.0);vec4 i1=clamp(i0-2.0,0.0,1.0);vec4 x1=x0-i1+C.xxxx;vec4 x2=x0-i2+C.yyyy;vec4 x3=x0-i3+C.zzzz;vec4 x4=x0+C.wwww;i=mod289(i);float j0=permute(permute(permute(permute(i.w)+i.z)+i.y)+i.x);vec4 j1=permute(permute(permute(permute(i.w+vec4(i1.w,i2.w,i3.w,1.0))+i.z+vec4(i1.z,i2.z,i3.z,1.0))+i.y+vec4(i1.y,i2.y,i3.y,1.0))+i.x+vec4(i1.x,i2.x,i3.x,1.0));vec4 ip=vec4(1.0/294.0,1.0/49.0,1.0/7.0,0.0);vec4 p0=grad4(j0,ip);vec4 p1=grad4(j1.x,ip);vec4 p2=grad4(j1.y,ip);vec4 p3=grad4(j1.z,ip);vec4 p4=grad4(j1.w,ip);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;p4*=taylorInvSqrt(dot(p4,p4));vec3 m0=max(0.6-vec3(dot(x0,x0),dot(x1,x1),dot(x2,x2)),0.0);vec2 m1=max(0.6-vec2(dot(x3,x3),dot(x4,x4)),0.0);m0=m0*m0;m1=m1*m1;return 49.0*(dot(m0*m0,vec3(dot(p0,x0),dot(p1,x1),dot(p2,x2)))+dot(m1*m1,vec2(dot(p3,x3),dot(p4,x4))));}",noise_simplex:"#define GLSLIFY 1\n#include <noise_simplex_2D>\n#include <noise_simplex_3D>\n#include <noise_simplex_3D_grad>\n#include <noise_simplex_4D>\n"},{pbr_frag_define:"#define GLSLIFY 1\nuniform float u_alphaCutoff;uniform vec4 u_baseColor;uniform float u_metal;uniform float u_roughness;uniform vec3 u_specularColor;uniform float u_glossiness;uniform vec3 u_emissiveColor;\n#ifdef CLEARCOAT\nuniform float u_clearCoat;uniform float u_clearCoatRoughness;\n#endif\nuniform float u_normalIntensity;uniform float u_occlusionStrength;uniform float u_occlusionTextureCoord;\n#ifdef HAS_BASECOLORMAP\nuniform sampler2D u_baseColorSampler;\n#endif\n#ifdef O3_NORMAL_TEXTURE\nuniform sampler2D u_normalTexture;\n#endif\n#ifdef HAS_EMISSIVEMAP\nuniform sampler2D u_emissiveSampler;\n#endif\n#ifdef HAS_METALROUGHNESSMAP\nuniform sampler2D u_metallicRoughnessSampler;\n#endif\n#ifdef HAS_SPECULARGLOSSINESSMAP\nuniform sampler2D u_specularGlossinessSampler;\n#endif\n#ifdef HAS_OCCLUSIONMAP\nuniform sampler2D u_occlusionSampler;\n#endif\n#ifdef HAS_CLEARCOATTEXTURE\nuniform sampler2D u_clearCoatTexture;\n#endif\n#ifdef HAS_CLEARCOATROUGHNESSTEXTURE\nuniform sampler2D u_clearCoatRoughnessTexture;\n#endif\n#ifdef HAS_CLEARCOATNORMALTEXTURE\nuniform sampler2D u_clearCoatNormalTexture;\n#endif\nstruct ReflectedLight{vec3 directDiffuse;vec3 directSpecular;vec3 indirectDiffuse;vec3 indirectSpecular;};struct Geometry{vec3 position;vec3 normal;vec3 viewDir;float dotNV;\n#ifdef CLEARCOAT\nvec3 clearCoatNormal;float clearCoatDotNV;\n#endif\n};struct Material{vec3 diffuseColor;float roughness;vec3 specularColor;float opacity;\n#ifdef CLEARCOAT\nfloat clearCoat;float clearCoatRoughness;\n#endif\n};",pbr_helper:"#define GLSLIFY 1\n#include <normal_get>\nfloat computeSpecularOcclusion(float ambientOcclusion,float roughness,float dotNV){return saturate(pow(dotNV+ambientOcclusion,exp2(-16.0*roughness-1.0))-1.0+ambientOcclusion);}float getAARoughnessFactor(vec3 normal){\n#ifdef HAS_DERIVATIVES\nvec3 dxy=max(abs(dFdx(normal)),abs(dFdy(normal)));return max(max(dxy.x,dxy.y),dxy.z);\n#else\nreturn 0.04;\n#endif\n}void initGeometry(out Geometry geometry){geometry.position=v_pos;geometry.viewDir=normalize(u_cameraPos-v_pos);\n#if defined(O3_NORMAL_TEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE)\nmat3 tbn=getTBN();\n#endif\n#ifdef O3_NORMAL_TEXTURE\ngeometry.normal=getNormalByNormalTexture(tbn,u_normalTexture,u_normalIntensity,v_uv);\n#else\ngeometry.normal=getNormal();\n#endif\ngeometry.dotNV=saturate(dot(geometry.normal,geometry.viewDir));\n#ifdef CLEARCOAT\n#ifdef HAS_CLEARCOATNORMALTEXTURE\ngeometry.clearCoatNormal=getNormalByNormalTexture(tbn,u_clearCoatNormalTexture,u_normalIntensity,v_uv);\n#else\ngeometry.clearCoatNormal=getNormal();\n#endif\ngeometry.clearCoatDotNV=saturate(dot(geometry.clearCoatNormal,geometry.viewDir));\n#endif\n}void initMaterial(out Material material,const in Geometry geometry){vec4 baseColor=u_baseColor;float metal=u_metal;float roughness=u_roughness;vec3 specularColor=u_specularColor;float glossiness=u_glossiness;float alphaCutoff=u_alphaCutoff;\n#ifdef HAS_BASECOLORMAP\nvec4 baseTextureColor=texture2D(u_baseColorSampler,v_uv);\n#ifndef OASIS_COLORSPACE_GAMMA\nbaseTextureColor=gammaToLinear(baseTextureColor);\n#endif\nbaseColor*=baseTextureColor;\n#endif\n#ifdef O3_HAS_VERTEXCOLOR\nbaseColor*=v_color;\n#endif\n#ifdef ALPHA_CUTOFF\nif(baseColor.a<alphaCutoff){discard;}\n#endif\n#ifdef HAS_METALROUGHNESSMAP\nvec4 metalRoughMapColor=texture2D(u_metallicRoughnessSampler,v_uv);roughness*=metalRoughMapColor.g;metal*=metalRoughMapColor.b;\n#endif\n#ifdef HAS_SPECULARGLOSSINESSMAP\nvec4 specularGlossinessColor=texture2D(u_specularGlossinessSampler,v_uv);\n#ifndef OASIS_COLORSPACE_GAMMA\nspecularGlossinessColor=gammaToLinear(specularGlossinessColor);\n#endif\nspecularColor*=specularGlossinessColor.rgb;glossiness*=specularGlossinessColor.a;\n#endif\n#ifdef IS_METALLIC_WORKFLOW\nmaterial.diffuseColor=baseColor.rgb*(1.0-metal);material.specularColor=mix(vec3(0.04),baseColor.rgb,metal);material.roughness=roughness;\n#else\nfloat specularStrength=max(max(specularColor.r,specularColor.g),specularColor.b);material.diffuseColor=baseColor.rgb*(1.0-specularStrength);material.specularColor=specularColor;material.roughness=1.0-glossiness;\n#endif\nmaterial.roughness=max(material.roughness,getAARoughnessFactor(geometry.normal));\n#ifdef CLEARCOAT\nmaterial.clearCoat=u_clearCoat;material.clearCoatRoughness=u_clearCoatRoughness;\n#ifdef HAS_CLEARCOATTEXTURE\nmaterial.clearCoat*=texture2D(u_clearCoatTexture,v_uv).r;\n#endif\n#ifdef HAS_CLEARCOATROUGHNESSTEXTURE\nmaterial.clearCoatRoughness*=texture2D(u_clearCoatRoughnessTexture,v_uv).g;\n#endif\nmaterial.clearCoat=saturate(material.clearCoat);material.clearCoatRoughness=max(material.clearCoatRoughness,getAARoughnessFactor(geometry.clearCoatNormal));\n#endif\nmaterial.opacity=baseColor.a;}\n#include <brdf>\n#include <direct_irradiance_frag_define>\n#include <ibl_frag_define>\n",brdf:"#define GLSLIFY 1\nfloat F_Schlick(float dotLH){return 0.04+0.96*(pow(1.0-dotLH,5.0));}vec3 F_Schlick(vec3 specularColor,float dotLH){float fresnel=exp2((-5.55473*dotLH-6.98316)*dotLH);return(1.0-specularColor)*fresnel+specularColor;}float G_GGX_SmithCorrelated(float alpha,float dotNL,float dotNV){float a2=pow2(alpha);float gv=dotNL*sqrt(a2+(1.0-a2)*pow2(dotNV));float gl=dotNV*sqrt(a2+(1.0-a2)*pow2(dotNL));return 0.5/max(gv+gl,EPSILON);}float D_GGX(float alpha,float dotNH){float a2=pow2(alpha);float denom=pow2(dotNH)*(a2-1.0)+1.0;return RECIPROCAL_PI*a2/pow2(denom);}vec3 BRDF_Specular_GGX(vec3 incidentDirection,vec3 viewDir,vec3 normal,vec3 specularColor,float roughness){float alpha=pow2(roughness);vec3 halfDir=normalize(incidentDirection+viewDir);float dotNL=saturate(dot(normal,incidentDirection));float dotNV=saturate(dot(normal,viewDir));float dotNH=saturate(dot(normal,halfDir));float dotLH=saturate(dot(incidentDirection,halfDir));vec3 F=F_Schlick(specularColor,dotLH);float G=G_GGX_SmithCorrelated(alpha,dotNL,dotNV);float D=D_GGX(alpha,dotNH);return F*(G*D);}vec3 BRDF_Diffuse_Lambert(vec3 diffuseColor){return RECIPROCAL_PI*diffuseColor;}",direct_irradiance_frag_define:"#define GLSLIFY 1\nvoid addDirectRadiance(vec3 incidentDirection,vec3 color,Geometry geometry,Material material,inout ReflectedLight reflectedLight){float attenuation=1.0;\n#ifdef CLEARCOAT\nfloat clearCoatDotNL=saturate(dot(geometry.clearCoatNormal,incidentDirection));vec3 clearCoatIrradiance=clearCoatDotNL*color;reflectedLight.directSpecular+=material.clearCoat*clearCoatIrradiance*BRDF_Specular_GGX(incidentDirection,geometry.viewDir,geometry.clearCoatNormal,vec3(0.04),material.clearCoatRoughness);attenuation-=material.clearCoat*F_Schlick(geometry.clearCoatDotNV);\n#endif\nfloat dotNL=saturate(dot(geometry.normal,incidentDirection));vec3 irradiance=dotNL*color*PI;reflectedLight.directSpecular+=attenuation*irradiance*BRDF_Specular_GGX(incidentDirection,geometry.viewDir,geometry.normal,material.specularColor,material.roughness);reflectedLight.directDiffuse+=attenuation*irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);}\n#ifdef O3_DIRECT_LIGHT_COUNT\nvoid addDirectionalDirectLightRadiance(DirectLight directionalLight,Geometry geometry,Material material,inout ReflectedLight reflectedLight){vec3 color=directionalLight.color;vec3 direction=-directionalLight.direction;addDirectRadiance(direction,color,geometry,material,reflectedLight);}\n#endif\n#ifdef O3_POINT_LIGHT_COUNT\nvoid addPointDirectLightRadiance(PointLight pointLight,Geometry geometry,Material material,inout ReflectedLight reflectedLight){vec3 lVector=pointLight.position-geometry.position;vec3 direction=normalize(lVector);float lightDistance=length(lVector);vec3 color=pointLight.color;color*=clamp(1.0-pow(lightDistance/pointLight.distance,4.0),0.0,1.0);addDirectRadiance(direction,color,geometry,material,reflectedLight);}\n#endif\n#ifdef O3_SPOT_LIGHT_COUNT\nvoid addSpotDirectLightRadiance(SpotLight spotLight,Geometry geometry,Material material,inout ReflectedLight reflectedLight){vec3 lVector=spotLight.position-geometry.position;vec3 direction=normalize(lVector);float lightDistance=length(lVector);float angleCos=dot(direction,-spotLight.direction);float spotEffect=smoothstep(spotLight.penumbraCos,spotLight.angleCos,angleCos);float decayEffect=clamp(1.0-pow(lightDistance/spotLight.distance,4.0),0.0,1.0);vec3 color=spotLight.color;color*=spotEffect*decayEffect;addDirectRadiance(direction,color,geometry,material,reflectedLight);}\n#endif\nvoid addTotalDirectRadiance(Geometry geometry,Material material,inout ReflectedLight reflectedLight){\n#ifdef O3_DIRECT_LIGHT_COUNT\nDirectLight directionalLight;for(int i=0;i<O3_DIRECT_LIGHT_COUNT;i++){directionalLight.color=u_directLightColor[i];directionalLight.direction=u_directLightDirection[i];addDirectionalDirectLightRadiance(directionalLight,geometry,material,reflectedLight);}\n#endif\n#ifdef O3_POINT_LIGHT_COUNT\nPointLight pointLight;for(int i=0;i<O3_POINT_LIGHT_COUNT;i++){pointLight.color=u_pointLightColor[i];pointLight.position=u_pointLightPosition[i];pointLight.distance=u_pointLightDistance[i];addPointDirectLightRadiance(pointLight,geometry,material,reflectedLight);}\n#endif\n#ifdef O3_SPOT_LIGHT_COUNT\nSpotLight spotLight;for(int i=0;i<O3_SPOT_LIGHT_COUNT;i++){spotLight.color=u_spotLightColor[i];spotLight.position=u_spotLightPosition[i];spotLight.direction=u_spotLightDirection[i];spotLight.distance=u_spotLightDistance[i];spotLight.angleCos=u_spotLightAngleCos[i];spotLight.penumbraCos=u_spotLightPenumbraCos[i];addSpotDirectLightRadiance(spotLight,geometry,material,reflectedLight);}\n#endif\n}",ibl_frag_define:"#define GLSLIFY 1\nvec3 getLightProbeIrradiance(vec3 sh[9],vec3 normal){vec3 result=sh[0]+sh[1]*(normal.y)+sh[2]*(normal.z)+sh[3]*(normal.x)+sh[4]*(normal.y*normal.x)+sh[5]*(normal.y*normal.z)+sh[6]*(3.0*normal.z*normal.z-1.0)+sh[7]*(normal.z*normal.x)+sh[8]*(normal.x*normal.x-normal.y*normal.y);return max(result,vec3(0.0));}vec3 envBRDFApprox(vec3 specularColor,float roughness,float dotNV){const vec4 c0=vec4(-1,-0.0275,-0.572,0.022);const vec4 c1=vec4(1,0.0425,1.04,-0.04);vec4 r=roughness*c0+c1;float a004=min(r.x*r.x,exp2(-9.28*dotNV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}float getSpecularMIPLevel(float roughness,int maxMIPLevel){return roughness*float(maxMIPLevel);}vec3 getLightProbeRadiance(vec3 viewDir,vec3 normal,float roughness,int maxMIPLevel,float specularIntensity){\n#ifndef O3_USE_SPECULAR_ENV\nreturn vec3(0);\n#else\nvec3 reflectVec=reflect(-viewDir,normal);float specularMIPLevel=getSpecularMIPLevel(roughness,maxMIPLevel);\n#ifdef HAS_TEX_LOD\nvec4 envMapColor=textureCubeLodEXT(u_env_specularSampler,reflectVec,specularMIPLevel);\n#else\nvec4 envMapColor=textureCube(u_env_specularSampler,reflectVec,specularMIPLevel);\n#endif\n#ifdef O3_DECODE_ENV_RGBM\nenvMapColor.rgb=RGBMToLinear(envMapColor,5.0).rgb;\n#ifdef OASIS_COLORSPACE_GAMMA\nenvMapColor=linearToGamma(envMapColor);\n#endif\n#else\n#ifndef OASIS_COLORSPACE_GAMMA\nenvMapColor=gammaToLinear(envMapColor);\n#endif\n#endif\nreturn envMapColor.rgb*specularIntensity;\n#endif\n}",pbr_frag:"#define GLSLIFY 1\nGeometry geometry;Material material;ReflectedLight reflectedLight;initGeometry(geometry);initMaterial(material,geometry);addTotalDirectRadiance(geometry,material,reflectedLight);\n#ifdef O3_USE_SH\nvec3 irradiance=getLightProbeIrradiance(u_env_sh,geometry.normal);\n#ifdef OASIS_COLORSPACE_GAMMA\nirradiance=linearToGamma(vec4(irradiance,1.0)).rgb;\n#endif\nirradiance*=u_envMapLight.diffuseIntensity;\n#else\nvec3 irradiance=u_envMapLight.diffuse*u_envMapLight.diffuseIntensity;irradiance*=PI;\n#endif\nreflectedLight.indirectDiffuse+=irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);vec3 radiance=getLightProbeRadiance(geometry.viewDir,geometry.normal,material.roughness,int(u_envMapLight.mipMapLevel),u_envMapLight.specularIntensity);float radianceAttenuation=1.0;\n#ifdef CLEARCOAT\nvec3 clearCoatRadiance=getLightProbeRadiance(geometry.viewDir,geometry.clearCoatNormal,material.clearCoatRoughness,int(u_envMapLight.mipMapLevel),u_envMapLight.specularIntensity);reflectedLight.indirectSpecular+=clearCoatRadiance*material.clearCoat*envBRDFApprox(vec3(0.04),material.clearCoatRoughness,geometry.clearCoatDotNV);radianceAttenuation-=material.clearCoat*F_Schlick(geometry.clearCoatDotNV);\n#endif\nreflectedLight.indirectSpecular+=radianceAttenuation*radiance*envBRDFApprox(material.specularColor,material.roughness,geometry.dotNV);\n#ifdef HAS_OCCLUSIONMAP\nvec2 aoUV=v_uv;\n#ifdef O3_HAS_UV1\nif(u_occlusionTextureCoord==1.0){aoUV=v_uv1;}\n#endif\nfloat ambientOcclusion=(texture2D(u_occlusionSampler,aoUV).r-1.0)*u_occlusionStrength+1.0;reflectedLight.indirectDiffuse*=ambientOcclusion;\n#ifdef O3_USE_SPECULAR_ENV\nreflectedLight.indirectSpecular*=computeSpecularOcclusion(ambientOcclusion,material.roughness,geometry.dotNV);\n#endif\n#endif\nvec3 emissiveRadiance=u_emissiveColor;\n#ifdef HAS_EMISSIVEMAP\nvec4 emissiveColor=texture2D(u_emissiveSampler,v_uv);\n#ifndef OASIS_COLORSPACE_GAMMA\nemissiveColor=gammaToLinear(emissiveColor);\n#endif\nemissiveRadiance*=emissiveColor.rgb;\n#endif\nvec3 totalRadiance=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse+reflectedLight.directSpecular+reflectedLight.indirectSpecular+emissiveRadiance;vec4 targetColor=vec4(totalRadiance,material.opacity);\n#ifndef OASIS_COLORSPACE_GAMMA\ntargetColor=linearToGamma(targetColor);\n#endif\ngl_FragColor=targetColor;"}),{},{normal_get:"#define GLSLIFY 1\nvec3 getNormal(){\n#ifdef O3_HAS_NORMAL\nvec3 normal=normalize(v_normal);\n#elif defined(HAS_DERIVATIVES)\nvec3 pos_dx=dFdx(v_pos);vec3 pos_dy=dFdy(v_pos);vec3 normal=normalize(cross(pos_dx,pos_dy));\n#else\nvec3 normal=vec3(0,0,1);\n#endif\nnormal*=float(gl_FrontFacing)*2.0-1.0;return normal;}vec3 getNormalByNormalTexture(mat3 tbn,sampler2D normalTexture,float normalIntensity,vec2 uv){vec3 normal=texture2D(normalTexture,uv).rgb;normal=normalize(tbn*((2.0*normal-1.0)*vec3(normalIntensity,normalIntensity,1.0)));normal*=float(gl_FrontFacing)*2.0-1.0;return normal;}mat3 getTBN(){\n#if defined(O3_HAS_NORMAL) && defined(O3_HAS_TANGENT) && ( defined(O3_NORMAL_TEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE) )\nmat3 tbn=v_TBN;\n#else\nvec3 normal=getNormal();vec3 position=v_pos;vec2 uv=gl_FrontFacing? v_uv:-v_uv;\n#ifdef HAS_DERIVATIVES\nvec3 dp1=dFdx(position);vec3 dp2=dFdy(position);vec2 duv1=dFdx(uv);vec2 duv2=dFdy(uv);vec3 dp2perp=cross(dp2,normal);vec3 dp1perp=cross(normal,dp1);vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;vec3 binormal=dp2perp*duv1.y+dp1perp*duv2.y;float invmax=inversesqrt(max(dot(tangent,tangent),dot(binormal,binormal)));mat3 tbn=mat3(tangent*invmax,binormal*invmax,normal);\n#else\nmat3 tbn=mat3(vec3(0.0),vec3(0.0),normal);\n#endif\n#endif\nreturn tbn;}"}),Rt=function(){function e(){}return e.parseCustomMacros=function(e){return e.map((function(e){return"#define "+e+"\n"})).join("")},e.parseIncludes=function(t){return t.replace(/^[ \t]*#include +<([\w\d.]+)>/gm,(function(t,r){var n=Et[r];return void 0===n?(re.error('Shader slice "'+t.trim()+'" not founded.'),""):e.parseIncludes(n)}))},e.parseExtension=function(e){return e.map((function(e){return"#extension "+e+" : enable\n"})).join("")},e.convertTo300=function(e,t){if(e=(e=(e=(e=e.replace(/\battribute\b/g,"in")).replace(/\bvarying\b/g,t?"in":"out")).replace(/\btexture(2D|Cube)\b/g,"texture")).replace(/\btexture(2D|Cube)LodEXT\b/g,"textureLod"),t)if(/\bgl_FragData\[.+?\]/g.test(e)){var r=(e=e.replace(/\bgl_FragColor\b/g,"gl_FragData[0]")).match(/\bgl_FragData\[.+?\]/g);e=this._replaceMRTShader(e,r)}else e=(e=e.replace(/void\s+?main\s*\(/g,"out vec4 glFragColor;\nvoid main(")).replace(/\bgl_FragColor\b/g,"glFragColor");return e},e._replaceMRTShader=function(e,t){for(var r="",n=new Set,i=0;i<t.length;i++){var a=t[i].match(/\bgl_FragData\[(.+?)\]/);n.add(a[1])}return n.forEach((function(e){r+="layout(location="+e+") out vec4 fragOutColor"+e+";\n"})),r+="void main(",(e=e.replace(/\bgl_FragData\[(.+?)\]/g,"fragOutColor$1")).replace(/void\s+?main\s*\(/g,r)},e}(),Lt=function(e,t,r){this.name=void 0,this._index=void 0,this._value=void 0,this.name=e,this._index=t,this._value=r};e.ColorSpace=void 0,(Ft=e.ColorSpace||(e.ColorSpace={}))[Ft.Linear=0]="Linear",Ft[Ft.Gamma=1]="Gamma";var Bt=function(){function t(e){this.name=void 0,this.propertyId=void 0,this.location=void 0,this.applyFunc=void 0,this.cacheValue=void 0,this.textureIndex=void 0,this.textureDefault=void 0,this._rhi=void 0,this._gl=void 0,this._colorSpace=void 0;var t=e._hardwareRenderer;this._rhi=t,this._gl=t.gl,this._colorSpace=e.settings.colorSpace}var r=t.prototype;return r.upload1f=function(e,t){this.cacheValue!==t&&(this._gl.uniform1f(e.location,t),this.cacheValue=t)},r.upload1fv=function(e,t){this._gl.uniform1fv(e.location,t)},r.upload2f=function(t,r){var n=this.cacheValue;void 0!==r.r?n.x===r.r&&n.y===r.g||(this._colorSpace===e.ColorSpace.Linear?this._gl.uniform2f(t.location,T.gammaToLinearSpace(r.r),T.gammaToLinearSpace(r.g)):this._gl.uniform2f(t.location,r.r,r.g),n.x=r.r,n.y=r.g):n.x===r.x&&n.y===r.y||(this._gl.uniform2f(t.location,r.x,r.y),n.x=r.x,n.y=r.y)},r.upload2fv=function(e,t){this._gl.uniform2fv(e.location,t)},r.upload3f=function(t,r){var n=this.cacheValue;void 0!==r.r?n.x===r.r&&n.y===r.g&&n.z===r.b||(this._colorSpace===e.ColorSpace.Linear?this._gl.uniform3f(t.location,T.gammaToLinearSpace(r.r),T.gammaToLinearSpace(r.g),T.gammaToLinearSpace(r.b)):this._gl.uniform3f(t.location,r.r,r.g,r.b),n.x=r.r,n.y=r.g,n.z=r.b):n.x===r.x&&n.y===r.y&&n.z===r.z||(this._gl.uniform3f(t.location,r.x,r.y,r.z),n.x=r.x,n.y=r.y,n.z=r.z)},r.upload3fv=function(e,t){this._gl.uniform3fv(e.location,t)},r.upload4f=function(t,r){var n=this.cacheValue;void 0!==r.r?n.x===r.r&&n.y===r.g&&n.z===r.b&&n.w===r.a||(this._colorSpace===e.ColorSpace.Linear?this._gl.uniform4f(t.location,T.gammaToLinearSpace(r.r),T.gammaToLinearSpace(r.g),T.gammaToLinearSpace(r.b),r.a):this._gl.uniform4f(t.location,r.r,r.g,r.b,r.a),n.x=r.r,n.y=r.g,n.z=r.b,n.w=r.a):n.x===r.x&&n.y===r.y&&n.z===r.z&&n.w===r.w||(this._gl.uniform4f(t.location,r.x,r.y,r.z,r.w),n.x=r.x,n.y=r.y,n.z=r.z,n.w=r.w)},r.upload4fv=function(e,t){this._gl.uniform4fv(e.location,t)},r.upload1i=function(e,t){this.cacheValue!==t&&(this._gl.uniform1i(e.location,t),this.cacheValue=t)},r.upload1iv=function(e,t){this._gl.uniform1iv(e.location,t)},r.upload2i=function(e,t){var r=this.cacheValue;void 0!==t.r?r.x===t.r&&r.y===t.g||(this._gl.uniform2i(e.location,t.r,t.g),r.x=t.r,r.y=t.g):r.x===t.x&&r.y===t.y||(this._gl.uniform2i(e.location,t.x,t.y),r.x=t.x,r.y=t.y)},r.upload2iv=function(e,t){this._gl.uniform2iv(e.location,t)},r.upload3i=function(e,t){var r=this.cacheValue;void 0!==t.r?r.x===t.r&&r.y===t.g&&r.z===t.b||(this._gl.uniform3i(e.location,t.r,t.g,t.b),r.x=t.r,r.y=t.g,r.z=t.b):r.x===t.x&&r.y===t.y&&r.z===t.z||(this._gl.uniform3i(e.location,t.x,t.y,t.z),r.x=t.x,r.y=t.y,r.z=t.z)},r.upload3iv=function(e,t){this._gl.uniform3iv(e.location,t)},r.upload4i=function(e,t){var r=this.cacheValue;void 0!==t.r?r.x===t.r&&r.y===t.g&&r.z===t.b&&r.w===t.a||(this._gl.uniform4i(e.location,t.r,t.g,t.b,t.a),r.x=t.r,r.y=t.g,r.z=t.b,r.w=t.a):r.x===t.x&&r.y===t.y&&r.z===t.z&&r.w===t.w||(this._gl.uniform4i(e.location,t.x,t.y,t.z,t.w),r.x=t.x,r.y=t.y,r.z=t.z,r.w=t.w)},r.upload4iv=function(e,t){this._gl.uniform4iv(e.location,t)},r.uploadMat4=function(e,t){this._gl.uniformMatrix4fv(e.location,!1,t.elements)},r.uploadMat4v=function(e,t){this._gl.uniformMatrix4fv(e.location,!1,t)},r.uploadTexture=function(e,t){var r=this._rhi;r.activeTexture(e.textureIndex),r.bindTexture(t._platformTexture)},r.uploadTextureArray=function(e,t){for(var r=this._rhi,n=e.textureIndex,i=0;i<t.length;i++){var a=t[i];r.activeTexture(n[i]),r.bindTexture(a._platformTexture)}},t}(),Dt=function(){this.constUniforms=[],this.textureUniforms=[]},It=function(){function e(t,r,n){this.id=void 0,this.sceneUniformBlock=new Dt,this.cameraUniformBlock=new Dt,this.rendererUniformBlock=new Dt,this.materialUniformBlock=new Dt,this.otherUniformBlock=new Dt,this._uploadRenderCount=-1,this._uploadCamera=void 0,this._uploadRenderer=void 0,this._uploadMaterial=void 0,this.attributeLocation=Object.create(null),this._isValid=void 0,this._engine=void 0,this._gl=void 0,this._vertexShader=void 0,this._fragmentShader=void 0,this._glProgram=void 0,this._activeTextureUint=0,this._engine=t,this._gl=t._hardwareRenderer.gl,this._glProgram=this._createProgram(r,n),this._glProgram?(this._isValid=!0,this._recordLocation()):this._isValid=!1,this.id=e._counter++}e._addLineNum=function(e){var t,r=e.split("\n"),n=(r.length+1).toString().length+6;return r.map((function(e,r){if((t="0:"+(r+1)).length>=n)return t.substring(0,n)+e;for(var i=0;i<n-t.length;i++)t+=" ";return t+e})).join("\n")};var t=e.prototype;return t.uploadAll=function(e,t){this.uploadUniforms(e,t),this.uploadTextures(e,t)},t.uploadUniforms=function(e,t){for(var r=t._properties,n=e.constUniforms,i=0,a=n.length;i<a;i++){var o=n[i],s=r[o.propertyId];null!=s&&o.applyFunc(o,s)}},t.uploadTextures=function(e,t){var r=t._properties,n=e.textureUniforms;if(n)for(var i=0,a=n.length;i<a;i++){var o=n[i],s=r[o.propertyId];s?o.applyFunc(o,s):o.applyFunc(o,o.textureDefault)}},t.uploadUnGroupTextures=function(){var e=this.otherUniformBlock.textureUniforms;if(e)for(var t=0,r=e.length;t<r;t++){var n=e[t];n.applyFunc(n,n.textureDefault)}},t.groupingOtherUniformBlock=function(){var e=this.otherUniformBlock,t=e.constUniforms,r=e.textureUniforms;t.length>0&&this._groupingSubOtherUniforms(t,!1),r.length>0&&this._groupingSubOtherUniforms(r,!0)},t.bind=function(){var e=this._engine._hardwareRenderer;return e._currentBind!==this&&(this._gl.useProgram(this._glProgram),e._currentBind=this,!0)},t.destroy=function(){var e=this._gl;this._vertexShader&&e.deleteShader(this._vertexShader),this._fragmentShader&&e.deleteShader(this._fragmentShader),this._glProgram&&e.deleteProgram(this._glProgram)},t._groupingSubOtherUniforms=function(e,t){for(var r=e.length-1;r>=0;r--){var n=e[r],i=zt._getShaderPropertyGroup(n.name);void 0!==i&&(e.splice(e.indexOf(n),1),this._groupingUniform(n,i,t))}},t._groupingUniform=function(e,t,r){switch(t){case At.Scene:r?this.sceneUniformBlock.textureUniforms.push(e):this.sceneUniformBlock.constUniforms.push(e);break;case At.Camera:r?this.cameraUniformBlock.textureUniforms.push(e):this.cameraUniformBlock.constUniforms.push(e);break;case At.Renderer:r?this.rendererUniformBlock.textureUniforms.push(e):this.rendererUniformBlock.constUniforms.push(e);break;case At.Material:r?this.materialUniformBlock.textureUniforms.push(e):this.materialUniformBlock.constUniforms.push(e);break;default:r?this.otherUniformBlock.textureUniforms.push(e):this.otherUniformBlock.constUniforms.push(e)}},t._createProgram=function(e,t){var r=this._gl,n=this._createShader(r.VERTEX_SHADER,e);if(!n)return null;var i=this._createShader(r.FRAGMENT_SHADER,t);if(!i)return null;var a=r.createProgram();return r.attachShader(a,n),r.attachShader(a,i),r.linkProgram(a),r.validateProgram(a),r.isContextLost()?(re.error("Context lost while linking program."),r.deleteShader(n),r.deleteShader(i),null):re.isEnabled&&!r.getProgramParameter(a,r.LINK_STATUS)?(re.error("Could not link WebGL program. \n"+r.getProgramInfoLog(a)),r.deleteProgram(a),null):(this._vertexShader=n,this._fragmentShader=i,a)},t._createShader=function(t,r){var n=this._gl,i=n.createShader(t);return i?(n.shaderSource(i,r),n.compileShader(i),n.isContextLost()?(re.error("Context lost while compiling shader."),n.deleteShader(i),null):re.isEnabled&&!n.getShaderParameter(i,n.COMPILE_STATUS)?(re.error("Could not compile WebGL shader.\n"+n.getShaderInfoLog(i),e._addLineNum(r)),n.deleteShader(i),null):i):(re.error("Context lost while create shader."),null)},t._recordLocation=function(){var e=this,t=this._gl,r=this._glProgram,n=this._getUniformInfos(),i=this._getAttributeInfos();n.forEach((function(n){var i=n.name,a=n.size,s=n.type,l=new Bt(e._engine),u=!1,c=!1;i.indexOf("[0]")>0&&(i=i.substr(0,i.length-3),u=!0);var h=zt._getShaderPropertyGroup(i),d=t.getUniformLocation(r,i);switch(l.name=i,l.propertyId=zt.getPropertyByName(i)._uniqueId,l.location=d,s){case t.FLOAT:u?l.applyFunc=l.upload1fv:(l.applyFunc=l.upload1f,l.cacheValue=0);break;case t.FLOAT_VEC2:u?l.applyFunc=l.upload2fv:(l.applyFunc=l.upload2f,l.cacheValue=new g(0,0));break;case t.FLOAT_VEC3:u?l.applyFunc=l.upload3fv:(l.applyFunc=l.upload3f,l.cacheValue=new o(0,0,0));break;case t.FLOAT_VEC4:u?l.applyFunc=l.upload4fv:(l.applyFunc=l.upload4f,l.cacheValue=new v(0,0,0,0));break;case t.BOOL:case t.INT:u?l.applyFunc=l.upload1iv:(l.applyFunc=l.upload1i,l.cacheValue=0);break;case t.BOOL_VEC2:case t.INT_VEC2:u?l.applyFunc=l.upload2iv:(l.applyFunc=l.upload2i,l.cacheValue=new g(0,0));break;case t.BOOL_VEC3:case t.INT_VEC3:l.applyFunc=u?l.upload3iv:l.upload3i,l.cacheValue=new o(0,0,0);break;case t.BOOL_VEC4:case t.INT_VEC4:u?l.applyFunc=l.upload4iv:(l.applyFunc=l.upload4i,l.cacheValue=new v(0,0,0));break;case t.FLOAT_MAT4:l.applyFunc=u?l.uploadMat4v:l.uploadMat4;break;case t.SAMPLER_2D:case t.SAMPLER_CUBE:case t.SAMPLER_2D_ARRAY:var _;switch(s){case t.SAMPLER_2D:_=e._engine._whiteTexture2D;break;case t.SAMPLER_CUBE:_=e._engine._whiteTextureCube;break;case t.SAMPLER_2D_ARRAY:_=e._engine._whiteTexture2DArray;break;default:throw new Error("Unsupported texture type.")}if(c=!0,u){for(var f=new Array(a),p=new Int32Array(a),m=new Array(a),y=0;y<a;y++)f[y]=_,p[y]=e._activeTextureUint,m[y]=t.TEXTURE0+e._activeTextureUint++;l.textureDefault=f,l.textureIndex=m,l.applyFunc=l.uploadTextureArray,e.bind(),t.uniform1iv(d,p),l.uploadTextureArray(l,f)}else{var x=t.TEXTURE0+e._activeTextureUint;l.textureDefault=_,l.textureIndex=x,l.applyFunc=l.uploadTexture,e.bind(),t.uniform1i(d,e._activeTextureUint++),l.uploadTexture(l,_)}}e._groupingUniform(l,h,c)})),i.forEach((function(n){var i=n.name;e.attributeLocation[i]=t.getAttribLocation(r,i)}))},t._getUniformInfos=function(){for(var e=this._gl,t=this._glProgram,r=new Array,n=e.getProgramParameter(t,e.ACTIVE_UNIFORMS),i=0;i<n;++i){var a=e.getActiveUniform(t,i);r[i]=a}return r},t._getAttributeInfos=function(){for(var e=this._gl,t=this._glProgram,r=new Array,n=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES),i=0;i<n;++i){var a=e.getActiveAttrib(t,i);r[i]=a}return r},A(e,[{key:"isValid",get:function(){return this._isValid}}]),e}();It._counter=0;var Ot=function e(t){this._uniqueId=void 0,this._group=void 0,this.name=void 0,this.name=t,this._uniqueId=e._propertyNameCounter++};Ot._propertyNameCounter=0;var zt=function(){function t(e,r,n){this.name=void 0,this._shaderId=0,this._vertexSource=void 0,this._fragmentSource=void 0,this._shaderId=t._shaderCounter++,this.name=e,this._vertexSource=r,this._fragmentSource=n}t.create=function(e,r,n){var i=t._shaderMap;if(i[e])throw'Shader named "'+e+'" already exists.';return i[e]=new t(e,r,n)},t.find=function(e){return t._shaderMap[e]},t.getMacroByName=function(e){var r=t._macroMap[e];if(!r){var n=t._macroMaskMap,i=t._macroCounter,a=Math.floor(i/32),o=i%32;r=new Lt(e,a,1<<o),t._macroMap[e]=r,a==n.length&&(n.length++,n[a]=new Array(32)),n[a][o]=e,t._macroCounter++}return r},t.getPropertyByName=function(e){var r=t._propertyNameMap;if(null!=r[e])return r[e];var n=new Ot(e);return r[e]=n,n},t._getShaderPropertyGroup=function(e){var r=t._propertyNameMap[e];return null==r?void 0:r._group},t._getNamesByMacros=function(e,r){var n=t._macroMaskMap,i=e._mask;r.length=0;for(var a=0,o=e._length;a<o;a++)for(var s=n[a],l=i[a],u=l<0?32:Math.floor(Math.log2(l))+1,c=0;c<u;c++)l&1<<c&&r.push(s[c])};var r=t.prototype;return r.compileVariant=function(e,r){var n=t._compileMacros;n.clear();for(var i=0,a=r.length;i<a;i++)n.enable(t.getMacroByName(r[i]));return this._getShaderProgram(e,n).isValid},r._getShaderProgram=function(r,n){var i=r._getShaderProgramPool(this),a=i.get(n);if(a)return a;var o=r._hardwareRenderer.isWebGL2,s=[];t._getNamesByMacros(n,s);var l=Rt.parseCustomMacros(s),u=o?"#version 300 es":"#version 100",c="\n    #ifdef GL_FRAGMENT_PRECISION_HIGH\n      precision highp float;\n      precision highp int;\n    #else\n      precision mediump float;\n      precision mediump int;\n    #endif\n    ";r._hardwareRenderer.canIUse(e.GLCapabilityType.shaderTextureLod)&&(c+="#define HAS_TEX_LOD\n"),r._hardwareRenderer.canIUse(e.GLCapabilityType.standardDerivatives)&&(c+="#define HAS_DERIVATIVES\n");var h=Rt.parseIncludes(" "+u+"\n        "+c+"\n        "+l+"\n        "+this._vertexSource),d=Rt.parseIncludes(" "+u+"\n        "+(o?"":Rt.parseExtension(t._shaderExtension))+"\n        "+c+"\n        "+l+"\n      "+this._fragmentSource);return o&&(h=Rt.convertTo300(h),d=Rt.convertTo300(d,!0)),a=new It(r,h,d),i.cache(a),a},t}();zt._compileMacros=new we,zt._shaderCounter=0,zt._shaderMap=Object.create(null),zt._propertyNameMap=Object.create(null),zt._macroMaskMap=[],zt._macroCounter=0,zt._macroMap=Object.create(null),zt._shaderExtension=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives","GL_EXT_draw_buffers"];var Vt,Nt,Ut,kt=function(){function e(e){this._group=void 0,this._properties=Object.create(null),this._macroCollection=new we,this._variableMacros=Object.create(null),this._refCount=0,this._group=e}var t=e.prototype;return t.getFloat=function(e){return this._getData(e)},t.setFloat=function(e,t){this._setData(e,t)},t.getInt=function(e){return this._getData(e)},t.setInt=function(e,t){this._setData(e,t)},t.getFloatArray=function(e){return this._getData(e)},t.setFloatArray=function(e,t){this._setData(e,t)},t.getIntArray=function(e){return this._getData(e)},t.setIntArray=function(e,t){this._setData(e,t)},t.getVector2=function(e){return this._getData(e)},t.setVector2=function(e,t){this._setData(e,t)},t.getVector3=function(e){return this._getData(e)},t.setVector3=function(e,t){this._setData(e,t)},t.getVector4=function(e){return this._getData(e)},t.setVector4=function(e,t){this._setData(e,t)},t.getMatrix=function(e){return this._getData(e)},t.setMatrix=function(e,t){this._setData(e,t)},t.getColor=function(e){return this._getData(e)},t.setColor=function(e,t){this._setData(e,t)},t.getTexture=function(e){return this._getData(e)},t.setTexture=function(e,t){if(this._getRefCount()>0){var r=this._getData(e);r&&r._addRefCount(-1),t&&t._addRefCount(1)}this._setData(e,t)},t.getTextureArray=function(e){return this._getData(e)},t.setTextureArray=function(e,t){if(this._getRefCount()>0){var r=this._getData(e);if(r)for(var n=0,i=r.length;n<i;n++)r[n]._addRefCount(-1);if(t)for(var a=0,o=t.length;a<o;a++)t[a]._addRefCount(1)}this._setData(e,t)},t.enableMacro=function(e,t){void 0===t&&(t=null),t?this._enableVariableMacro(e,t):("string"==typeof e&&(e=zt.getMacroByName(e)),this._macroCollection.enable(e))},t.disableMacro=function(e){if("string"==typeof e){var t=this._variableMacros[e];t?this._disableVariableMacro(e,t):(e=zt.getMacroByName(e),this._macroCollection.disable(e))}else this._macroCollection.disable(e)},t.clone=function(){var t=new e(this._group);return this.cloneTo(t),t},t.cloneTo=function(e){q.deepCloneObject(this._macroCollection,e._macroCollection),F(e._variableMacros,this._variableMacros);for(var t=this._properties,r=e._properties,n=Object.keys(t),i=0,a=n.length;i<a;i++){var o=n[i],s=t[o];if(null!=s)if("number"==typeof s)r[o]=s;else if(s instanceof ne)r[o]=s;else if(s instanceof Array||s instanceof Float32Array||s instanceof Int32Array)r[o]=s.slice();else{var l=r[o];l?s.cloneTo(l):r[o]=s.clone()}else r[o]=s}},t._getData=function(e){return"string"==typeof e&&(e=zt.getPropertyByName(e)),this._properties[e._uniqueId]},t._setData=function(e,t){if("string"==typeof e&&(e=zt.getPropertyByName(e)),e._group!==this._group){if(void 0!==e._group)throw"Shader property "+e.name+" has been used as "+At[e._group]+" property.";e._group=this._group}this._properties[e._uniqueId]=t},t._getRefCount=function(){return this._refCount},t._addRefCount=function(e){this._refCount+=e;var t=this._properties;for(var r in t){var n=t[r];n&&n instanceof ne&&n._addRefCount(e)}},t._enableVariableMacro=function(e,t){var r=this._variableMacros,n=r[e];if(n!==t){n&&this._disableVariableMacro(e,n);var i=zt.getMacroByName(e+" "+t);this._macroCollection.enable(i),r[e]=t}},t._disableVariableMacro=function(e,t){var r=zt.getMacroByName(e+" "+t);this._macroCollection.disable(r),delete this._variableMacros[e]},e}();e.BlendFactor=void 0,(Vt=e.BlendFactor||(e.BlendFactor={}))[Vt.Zero=0]="Zero",Vt[Vt.One=1]="One",Vt[Vt.SourceColor=2]="SourceColor",Vt[Vt.OneMinusSourceColor=3]="OneMinusSourceColor",Vt[Vt.DestinationColor=4]="DestinationColor",Vt[Vt.OneMinusDestinationColor=5]="OneMinusDestinationColor",Vt[Vt.SourceAlpha=6]="SourceAlpha",Vt[Vt.OneMinusSourceAlpha=7]="OneMinusSourceAlpha",Vt[Vt.DestinationAlpha=8]="DestinationAlpha",Vt[Vt.OneMinusDestinationAlpha=9]="OneMinusDestinationAlpha",Vt[Vt.SourceAlphaSaturate=10]="SourceAlphaSaturate",Vt[Vt.BlendColor=11]="BlendColor",Vt[Vt.OneMinusBlendColor=12]="OneMinusBlendColor",e.BlendOperation=void 0,(Nt=e.BlendOperation||(e.BlendOperation={}))[Nt.Add=0]="Add",Nt[Nt.Subtract=1]="Subtract",Nt[Nt.ReverseSubtract=2]="ReverseSubtract",Nt[Nt.Min=3]="Min",Nt[Nt.Max=4]="Max",e.ColorWriteMask=void 0,(Ut=e.ColorWriteMask||(e.ColorWriteMask={}))[Ut.None=0]="None",Ut[Ut.Red=1]="Red",Ut[Ut.Green=2]="Green",Ut[Ut.Blue=4]="Blue",Ut[Ut.Alpha=8]="Alpha",Ut[Ut.All=15]="All";var Gt,Ht=function(){this.enabled=!1,this.colorBlendOperation=e.BlendOperation.Add,this.alphaBlendOperation=e.BlendOperation.Add,this.sourceColorBlendFactor=e.BlendFactor.One,this.sourceAlphaBlendFactor=e.BlendFactor.One,this.destinationColorBlendFactor=e.BlendFactor.Zero,this.destinationAlphaBlendFactor=e.BlendFactor.Zero,this.colorWriteMask=e.ColorWriteMask.All},Wt=function(){function t(){this.targetBlendState=new Ht,this.blendColor=new T(0,0,0,0),this.alphaToCoverage=!1}t._getGLBlendFactor=function(t,r){var n=t.gl;switch(r){case e.BlendFactor.Zero:return n.ZERO;case e.BlendFactor.One:return n.ONE;case e.BlendFactor.SourceColor:return n.SRC_COLOR;case e.BlendFactor.OneMinusSourceColor:return n.ONE_MINUS_SRC_COLOR;case e.BlendFactor.DestinationColor:return n.DST_COLOR;case e.BlendFactor.OneMinusDestinationColor:return n.ONE_MINUS_DST_COLOR;case e.BlendFactor.SourceAlpha:return n.SRC_ALPHA;case e.BlendFactor.OneMinusSourceAlpha:return n.ONE_MINUS_SRC_ALPHA;case e.BlendFactor.DestinationAlpha:return n.DST_ALPHA;case e.BlendFactor.OneMinusDestinationAlpha:return n.ONE_MINUS_DST_ALPHA;case e.BlendFactor.SourceAlphaSaturate:return n.SRC_ALPHA_SATURATE;case e.BlendFactor.BlendColor:return n.CONSTANT_COLOR;case e.BlendFactor.OneMinusBlendColor:return n.ONE_MINUS_CONSTANT_COLOR}},t._getGLBlendOperation=function(t,r){var n=t.gl;switch(r){case e.BlendOperation.Add:return n.FUNC_ADD;case e.BlendOperation.Subtract:return n.FUNC_SUBTRACT;case e.BlendOperation.ReverseSubtract:return n.FUNC_REVERSE_SUBTRACT;case e.BlendOperation.Min:if(!t.canIUse(e.GLCapabilityType.blendMinMax))throw new Error("BlendOperation.Min is not supported in this context");return n.MIN;case e.BlendOperation.Max:if(!t.canIUse(e.GLCapabilityType.blendMinMax))throw new Error("BlendOperation.Max is not supported in this context");return n.MAX}};var r=t.prototype;return r._apply=function(e,t){this._platformApply(e,t.blendState)},r._platformApply=function(r,n){var i=r.gl,a=n.targetBlendState,o=this.targetBlendState,s=o.enabled,l=o.colorBlendOperation,u=o.alphaBlendOperation,c=o.sourceColorBlendFactor,h=o.destinationColorBlendFactor,d=o.sourceAlphaBlendFactor,_=o.destinationAlphaBlendFactor,f=o.colorWriteMask;if(s!==a.enabled&&(s?i.enable(i.BLEND):i.disable(i.BLEND),a.enabled=s),s){c===a.sourceColorBlendFactor&&h===a.destinationColorBlendFactor&&d===a.sourceAlphaBlendFactor&&_===a.destinationAlphaBlendFactor||(i.blendFuncSeparate(t._getGLBlendFactor(r,c),t._getGLBlendFactor(r,h),t._getGLBlendFactor(r,d),t._getGLBlendFactor(r,_)),a.sourceColorBlendFactor=c,a.destinationColorBlendFactor=h,a.sourceAlphaBlendFactor=d,a.destinationAlphaBlendFactor=_),l===a.colorBlendOperation&&u===a.alphaBlendOperation||(i.blendEquationSeparate(t._getGLBlendOperation(r,l),t._getGLBlendOperation(r,u)),a.colorBlendOperation=l,a.alphaBlendOperation=u);var p=this.blendColor;T.equals(n.blendColor,p)||(i.blendColor(p.r,p.g,p.b,p.a),p.cloneTo(n.blendColor))}f!==a.colorWriteMask&&(i.colorMask(0!=(f&e.ColorWriteMask.Red),0!=(f&e.ColorWriteMask.Green),0!=(f&e.ColorWriteMask.Blue),0!=(f&e.ColorWriteMask.Alpha)),a.colorWriteMask=f);var g=this.alphaToCoverage;g!==n.alphaToCoverage&&(g?i.enable(i.SAMPLE_ALPHA_TO_COVERAGE):i.disable(i.SAMPLE_ALPHA_TO_COVERAGE),n.alphaToCoverage=g)},t}();e.CompareFunction=void 0,(Gt=e.CompareFunction||(e.CompareFunction={}))[Gt.Never=0]="Never",Gt[Gt.Less=1]="Less",Gt[Gt.Equal=2]="Equal",Gt[Gt.LessEqual=3]="LessEqual",Gt[Gt.Greater=4]="Greater",Gt[Gt.NotEqual=5]="NotEqual",Gt[Gt.GreaterEqual=6]="GreaterEqual",Gt[Gt.Always=7]="Always";var jt,Xt=function(){function t(){this.enabled=!0,this.writeEnabled=!0,this.compareFunction=e.CompareFunction.Less}t._getGLCompareFunction=function(t,r){var n=t.gl;switch(r){case e.CompareFunction.Never:return n.NEVER;case e.CompareFunction.Less:return n.LESS;case e.CompareFunction.Equal:return n.EQUAL;case e.CompareFunction.LessEqual:return n.LEQUAL;case e.CompareFunction.Greater:return n.GREATER;case e.CompareFunction.NotEqual:return n.NOTEQUAL;case e.CompareFunction.GreaterEqual:return n.GEQUAL;case e.CompareFunction.Always:return n.ALWAYS}};var r=t.prototype;return r._apply=function(e,t){this._platformApply(e,t.depthState)},r._platformApply=function(e,r){var n=e.gl,i=this.enabled,a=this.compareFunction,o=this.writeEnabled;i!=r.enabled&&(i?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST),r.enabled=i),i&&(a!=r.compareFunction&&(n.depthFunc(t._getGLCompareFunction(e,a)),r.compareFunction=a),o!=r.writeEnabled&&(n.depthMask(o),r.writeEnabled=o))},t}();e.CullMode=void 0,(jt=e.CullMode||(e.CullMode={}))[jt.Off=0]="Off",jt[jt.Front=1]="Front",jt[jt.Back=2]="Back";var Kt,qt=function(){function t(){this.cullMode=e.CullMode.Back,this.depthBias=0,this.slopeScaledDepthBias=0,this._cullFaceEnable=!0,this._frontFaceInvert=!1}var r=t.prototype;return r._apply=function(e,t,r){this._platformApply(e,t.rasterState,r)},r._platformApply=function(t,r,n){var i=t.gl,a=this.cullMode,o=this.depthBias,s=this.slopeScaledDepthBias,l=a!==e.CullMode.Off;l!==r._cullFaceEnable&&(l?i.enable(i.CULL_FACE):i.disable(i.CULL_FACE),r._cullFaceEnable=l),l&&a!==r.cullMode&&(a==e.CullMode.Back?i.cullFace(i.BACK):i.cullFace(i.FRONT),r.cullMode=a),n!==r._frontFaceInvert&&(n?i.frontFace(i.CW):i.frontFace(i.CCW),r._frontFaceInvert=n),o===r.depthBias&&s===r.slopeScaledDepthBias||(0!==o||0!==s?(i.enable(i.POLYGON_OFFSET_FILL),i.polygonOffset(s,o)):i.disable(i.POLYGON_OFFSET_FILL),r.depthBias=o,r.slopeScaledDepthBias=s)},t}();e.StencilOperation=void 0,(Kt=e.StencilOperation||(e.StencilOperation={}))[Kt.Keep=0]="Keep",Kt[Kt.Zero=1]="Zero",Kt[Kt.Replace=2]="Replace",Kt[Kt.IncrementSaturate=3]="IncrementSaturate",Kt[Kt.DecrementSaturate=4]="DecrementSaturate",Kt[Kt.Invert=5]="Invert",Kt[Kt.IncrementWrap=6]="IncrementWrap",Kt[Kt.DecrementWrap=7]="DecrementWrap";var Yt,Qt,Jt,Zt,$t,er,tr,rr,nr,ir,ar,or,sr,lr,ur,cr,hr,dr,_r,fr=function(){function t(){this.enabled=!1,this.referenceValue=0,this.mask=255,this.writeMask=255,this.compareFunctionFront=e.CompareFunction.Always,this.compareFunctionBack=e.CompareFunction.Always,this.passOperationFront=e.StencilOperation.Keep,this.passOperationBack=e.StencilOperation.Keep,this.failOperationFront=e.StencilOperation.Keep,this.failOperationBack=e.StencilOperation.Keep,this.zFailOperationFront=e.StencilOperation.Keep,this.zFailOperationBack=e.StencilOperation.Keep}t._getGLCompareFunction=function(t,r){var n=t.gl;switch(r){case e.CompareFunction.Never:return n.NEVER;case e.CompareFunction.Less:return n.LESS;case e.CompareFunction.Equal:return n.EQUAL;case e.CompareFunction.LessEqual:return n.LEQUAL;case e.CompareFunction.Greater:return n.GREATER;case e.CompareFunction.NotEqual:return n.NOTEQUAL;case e.CompareFunction.GreaterEqual:return n.GEQUAL;case e.CompareFunction.Always:return n.ALWAYS}},t._getGLStencilOperation=function(t,r){var n=t.gl;switch(r){case e.StencilOperation.Keep:return n.KEEP;case e.StencilOperation.Zero:return n.ZERO;case e.StencilOperation.Replace:return n.REPLACE;case e.StencilOperation.IncrementSaturate:return n.INCR;case e.StencilOperation.DecrementSaturate:return n.DECR;case e.StencilOperation.Invert:return n.INVERT;case e.StencilOperation.IncrementWrap:return n.INCR_WRAP;case e.StencilOperation.DecrementWrap:return n.DECR_WRAP}};var r=t.prototype;return r._apply=function(e,t){this._platformApply(e,t.stencilState)},r._platformApply=function(e,r){var n=e.gl,i=this.enabled,a=this.referenceValue,o=this.mask,s=this.compareFunctionFront,l=this.compareFunctionBack,u=this.failOperationFront,c=this.zFailOperationFront,h=this.passOperationFront,d=this.failOperationBack,_=this.zFailOperationBack,f=this.passOperationBack,p=this.writeMask;if(i!=r.enabled&&(i?n.enable(n.STENCIL_TEST):n.disable(n.STENCIL_TEST),r.enabled=i),i){var g=a!==r.referenceValue||o!==r.mask;(g||s!==r.compareFunctionFront)&&(n.stencilFuncSeparate(n.FRONT,t._getGLCompareFunction(e,s),a,o),r.compareFunctionFront=s),(g||l!==r.compareFunctionBack)&&(n.stencilFuncSeparate(n.BACK,t._getGLCompareFunction(e,l),a,o),r.compareFunctionBack=this.compareFunctionBack),g&&(r.referenceValue=this.referenceValue,r.mask=this.mask),u===r.failOperationFront&&c===r.zFailOperationFront&&h===r.passOperationFront||(n.stencilOpSeparate(n.FRONT,t._getGLStencilOperation(e,u),t._getGLStencilOperation(e,c),t._getGLStencilOperation(e,h)),r.failOperationFront=u,r.zFailOperationFront=c,r.passOperationFront=h),d===r.failOperationBack&&_===r.zFailOperationBack&&f===r.passOperationBack||(n.stencilOpSeparate(n.BACK,t._getGLStencilOperation(e,d),t._getGLStencilOperation(e,_),t._getGLStencilOperation(e,f)),r.failOperationBack=d,r.zFailOperationBack=_,r.passOperationBack=f),p!==r.writeMask&&(n.stencilMask(p),r.writeMask=p)}},t}(),pr=function(){function e(){this.blendState=new Wt,this.depthState=new Xt,this.stencilState=new fr,this.rasterState=new qt}return e.prototype._apply=function(e,t){var r=e._hardwareRenderer,n=e._lastRenderState;this.blendState._apply(r,n),this.depthState._apply(r,n),this.stencilState._apply(r,n),this.rasterState._apply(r,n,t)},e}(),gr=function(t){function r(r,n){var i;return(i=t.call(this,r)||this).name=void 0,i.shader=void 0,i.renderQueueType=e.RenderQueueType.Opaque,i.shaderData=new kt(At.Material),i.renderState=new pr,i.shader=n,i}E(r,t);var n=r.prototype;return n.clone=function(){var e=new r(this._engine,this.shader);return this.cloneTo(e),e},n.cloneTo=function(e){e.shader=this.shader,e.renderQueueType=this.renderQueueType,this.shaderData.cloneTo(e.shaderData),q.deepCloneObject(this.renderState,e.renderState)},n._addRefCount=function(e){t.prototype._addRefCount.call(this,e),this.shaderData._addRefCount(e)},n._preRender=function(e){},n._onDestroy=function(){},r}(Q),vr=function(){function e(e){this._elementPoolIndex=0,this._elementPool=[],this._type=void 0,this._type=e}var t=e.prototype;return t.getFromPool=function(){var e=this._elementPoolIndex,t=this._elementPool;if(this._elementPoolIndex++,t.length===e){var r=new this._type;return t.push(r),r}return t[e]},t.resetPool=function(){this._elementPoolIndex=0},e}(),mr=function(){function e(){this._camera=void 0,this._viewProjectMatrix=new f}return e.prototype._setContext=function(e){this._camera=e,f.multiply(e.projectionMatrix,e.viewMatrix,this._viewProjectMatrix)},e}(),yr=function(){function e(){this.component=void 0,this.mesh=void 0,this.subMesh=void 0,this.material=void 0}return e.prototype.setValue=function(e,t,r,n){this.component=e,this.mesh=t,this.subMesh=r,this.material=n},e}(),xr=function(){function e(){this.component=void 0,this.positions=void 0,this.uv=void 0,this.triangles=void 0,this.color=void 0,this.material=void 0,this.camera=void 0}return e.prototype.setValue=function(e,t,r,n,i,a,o){this.component=e,this.positions=t,this.uv=r,this.triangles=n,this.color=i,this.material=a,this.camera=o},e}(),Tr=function(){function e(){this.component=void 0,this.positions=void 0,this.uv=void 0,this.triangles=void 0,this.material=void 0,this.isAdd=!0,this.camera=void 0}return e.prototype.setValue=function(e,t,r,n,i){this.component=e,this.positions=t,this.uv=r,this.triangles=n,this.material=i},e}();e.SpriteMaskInteraction=void 0,(Yt=e.SpriteMaskInteraction||(e.SpriteMaskInteraction={}))[Yt.None=0]="None",Yt[Yt.VisibleInsideMask=1]="VisibleInsideMask",Yt[Yt.VisibleOutsideMask=2]="VisibleOutsideMask";var wr,br,Cr,Sr,Mr,Ar,Pr,Fr,Er,Rr=((_r=function(e){function t(r){var n;V(n=e.call(this,r)||this,"shaderData",Jt,O(n)),V(n,"isCulled",Zt,O(n)),V(n,"_distanceForSort",$t,O(n)),V(n,"_onUpdateIndex",er,O(n)),V(n,"_rendererIndex",tr,O(n)),V(n,"_globalShaderMacro",rr,O(n)),V(n,"_renderSortId",nr,O(n)),V(n,"_overrideUpdate",ir,O(n)),V(n,"_materials",ar,O(n)),V(n,"_transformChangeFlag",or,O(n)),V(n,"_bounds",sr,O(n)),V(n,"_mvMatrix",lr,O(n)),V(n,"_mvpMatrix",ur,O(n)),V(n,"_mvInvMatrix",cr,O(n)),V(n,"_normalMatrix",hr,O(n)),V(n,"_materialsInstanced",dr,O(n));var i=t.prototype;return n._overrideUpdate=n.update!==i.update,n._transformChangeFlag=n.entity.transform.registerWorldChangeFlag(),n.shaderData._addRefCount(1),n}E(t,e);var r=t.prototype;return r.getInstanceMaterial=function(e){void 0===e&&(e=0);var t=this._materials;if(t.length>e){var r=t[e];if(r)return this._materialsInstanced[e]?r:this._createInstanceMaterial(r,e)}return null},r.getMaterial=function(e){return void 0===e&&(e=0),this._materials[e]||null},r.setMaterial=function(e,t){var r;void 0===t&&(t=null),"number"==typeof e?r=e:(r=0,t=e);var n=this._materials;r>=n.length&&(n.length=r+1);var i=this._materialsInstanced,a=n[r];a!==t&&(n[r]=t,r<i.length&&(i[r]=!1),a&&a._addRefCount(-1),t&&t._addRefCount(1))},r.getInstanceMaterials=function(){for(var e=this._materials,t=this._materialsInstanced,r=0,n=e.length;r<n;r++)t[r]||this._createInstanceMaterial(this._materials[r],r);return e},r.getMaterials=function(){return this._materials},r.setMaterials=function(e){for(var t=e.length,r=this._materials,n=this._materialsInstanced,i=t,a=r.length;i<a;i++){var o=r[i];o&&o._addRefCount(-1)}r.length!==t&&(r.length=t),0!==n.length&&(n.length=0);for(var s=0;s<t;s++){var l=r[s],u=e[s];l!==u&&(r[s]=u,l&&l._addRefCount(-1),u&&u._addRefCount(1))}},r.update=function(e){},r._updateShaderData=function(e){var r=this.shaderData,n=this.entity.transform.worldMatrix,i=this._mvMatrix,a=this._mvpMatrix,o=this._mvInvMatrix,s=this._normalMatrix;f.multiply(e._camera.viewMatrix,n,i),f.multiply(e._viewProjectMatrix,n,a),f.invert(i,o),f.invert(n,s),s.transpose(),r.setMatrix(t._localMatrixProperty,this.entity.transform.localMatrix),r.setMatrix(t._worldMatrixProperty,n),r.setMatrix(t._mvMatrixProperty,i),r.setMatrix(t._mvpMatrixProperty,a),r.setMatrix(t._mvInvMatrixProperty,o),r.setMatrix(t._normalMatrixProperty,s)},r._onEnable=function(){var e=this.engine._componentsManager;this._overrideUpdate&&e.addOnUpdateRenderers(this),e.addRenderer(this)},r._onDisable=function(){var e=this.engine._componentsManager;this._overrideUpdate&&e.removeOnUpdateRenderers(this),e.removeRenderer(this)},r._onDestroy=function(){var e=this._transformChangeFlag;e&&(e.destroy(),this._transformChangeFlag=null),this.shaderData._addRefCount(-1);for(var t=0,r=this._materials.length;t<r;t++)this._materials[t]._addRefCount(-1)},r._updateBounds=function(e){},r._createInstanceMaterial=function(e,t){var r=e.clone();return r.name=r.name+"(Instance)",e._addRefCount(-1),r._addRefCount(1),this._materialsInstanced[t]=!0,this._materials[t]=r,r},A(t,[{key:"materialCount",get:function(){return this._materials.length},set:function(e){var t=this._materials,r=this._materialsInstanced;t.length!==e&&(t.length=e),r.length>e&&(r.length=e)}},{key:"bounds",get:function(){var e=this._transformChangeFlag;return e.flag&&(this._updateBounds(this._bounds),e.flag=!1),this._bounds}}]),t}(Je))._localMatrixProperty=zt.getPropertyByName("u_localMat"),_r._worldMatrixProperty=zt.getPropertyByName("u_modelMat"),_r._mvMatrixProperty=zt.getPropertyByName("u_MVMat"),_r._mvpMatrixProperty=zt.getPropertyByName("u_MVPMat"),_r._mvInvMatrixProperty=zt.getPropertyByName("u_MVInvMat"),_r._normalMatrixProperty=zt.getPropertyByName("u_normalMat"),Jt=N((Qt=_r).prototype,"shaderData",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kt(At.Renderer)}}),Zt=N(Qt.prototype,"isCulled",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$t=N(Qt.prototype,"_distanceForSort",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),er=N(Qt.prototype,"_onUpdateIndex",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),tr=N(Qt.prototype,"_rendererIndex",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),rr=N(Qt.prototype,"_globalShaderMacro",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new we}}),nr=N(Qt.prototype,"_renderSortId",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ir=N(Qt.prototype,"_overrideUpdate",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ar=N(Qt.prototype,"_materials",[G],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),or=N(Qt.prototype,"_transformChangeFlag",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),sr=N(Qt.prototype,"_bounds",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new l(new o,new o)}}),lr=N(Qt.prototype,"_mvMatrix",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new f}}),ur=N(Qt.prototype,"_mvpMatrix",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new f}}),cr=N(Qt.prototype,"_mvInvMatrix",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new f}}),hr=N(Qt.prototype,"_normalMatrix",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new f}}),dr=N(Qt.prototype,"_materialsInstanced",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Qt);e.SpriteMaskLayer=void 0,(wr=e.SpriteMaskLayer||(e.SpriteMaskLayer={}))[wr.Layer0=1]="Layer0",wr[wr.Layer1=2]="Layer1",wr[wr.Layer2=4]="Layer2",wr[wr.Layer3=8]="Layer3",wr[wr.Layer4=16]="Layer4",wr[wr.Layer5=32]="Layer5",wr[wr.Layer6=64]="Layer6",wr[wr.Layer7=128]="Layer7",wr[wr.Layer8=256]="Layer8",wr[wr.Layer9=512]="Layer9",wr[wr.Layer10=1024]="Layer10",wr[wr.Layer11=2048]="Layer11",wr[wr.Layer12=4096]="Layer12",wr[wr.Layer13=8192]="Layer13",wr[wr.Layer14=16384]="Layer14",wr[wr.Layer15=32768]="Layer15",wr[wr.Layer16=65536]="Layer16",wr[wr.Layer17=131072]="Layer17",wr[wr.Layer18=262144]="Layer18",wr[wr.Layer19=524288]="Layer19",wr[wr.Layer20=1048576]="Layer20",wr[wr.Layer21=2097152]="Layer21",wr[wr.Layer22=4194304]="Layer22",wr[wr.Layer23=8388608]="Layer23",wr[wr.Layer24=16777216]="Layer24",wr[wr.Layer25=33554432]="Layer25",wr[wr.Layer26=67108864]="Layer26",wr[wr.Layer27=134217728]="Layer27",wr[wr.Layer28=268435456]="Layer28",wr[wr.Layer29=536870912]="Layer29",wr[wr.Layer30=1073741824]="Layer30",wr[wr.Layer31=2147483648]="Layer31",wr[wr.Everything=4294967295]="Everything";var Lr,Br,Dr,Ir=((Er=function(e){function t(r){var n;return(n=e.call(this,r)||this)._maskElement=void 0,V(n,"_positions",Cr,O(n)),V(n,"_worldMatrixDirtyFlag",Sr,O(n)),V(n,"_sprite",Mr,O(n)),V(n,"_alphaCutoff",Ar,O(n)),V(n,"_spriteDirty",Pr,O(n)),V(n,"influenceLayers",Fr,O(n)),n._worldMatrixDirtyFlag=r.transform.registerWorldChangeFlag(),n.setMaterial(n._engine._spriteMaskDefaultMaterial),n.shaderData.setFloat(t._alphaCutoffProperty,n._alphaCutoff),n}E(t,e);var r=t.prototype;return r._onDestroy=function(){this._worldMatrixDirtyFlag.destroy(),this._spriteDirty&&this._spriteDirty.destroy(),e.prototype._onDestroy.call(this)},r._render=function(e){var r=this.sprite;if(!r)return null;var n=r.texture;if(!n)return null;var i=this._positions,a=this.entity.transform;if(r._updateMesh(),this._worldMatrixDirtyFlag.flag||this._spriteDirty.flag){for(var s=r._positions,l=t._tempVec3,u=a.worldMatrix,c=0,h=i.length;c<h;c++){var d=s[c];l.setValue(d.x,d.y,0),o.transformToVec3(l,u,i[c])}this._spriteDirty.flag=!1,this._worldMatrixDirtyFlag.flag=!1}this.shaderData.setTexture(t._textureProperty,n);var _=this._engine._spriteMaskElementPool.getFromPool();_.setValue(this,i,r._uv,r._triangles,this.getMaterial()),_.camera=e,e._renderPipeline._allSpriteMasks.add(this),this._maskElement=_},r._cloneTo=function(e){e.sprite=this._sprite},A(t,[{key:"sprite",get:function(){return this._sprite},set:function(e){this._sprite!==e&&(this._spriteDirty&&this._spriteDirty.destroy(),this._sprite=e,e&&(this._spriteDirty=e._registerUpdateFlag()))}},{key:"alphaCutoff",get:function(){return this._alphaCutoff},set:function(e){this._alphaCutoff!==e&&(this._alphaCutoff=e,this.shaderData.setFloat(t._alphaCutoffProperty,e))}}]),t}(Rr))._textureProperty=zt.getPropertyByName("u_maskTexture"),Er._alphaCutoffProperty=zt.getPropertyByName("u_maskAlphaCutoff"),Er._tempVec3=new o,Cr=N((br=Er).prototype,"_positions",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new o,new o,new o,new o]}}),Sr=N(br.prototype,"_worldMatrixDirtyFlag",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Mr=N(br.prototype,"_sprite",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ar=N(br.prototype,"_alphaCutoff",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),Pr=N(br.prototype,"_spriteDirty",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Fr=N(br.prototype,"influenceLayers",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return e.SpriteMaskLayer.Everything}}),br);e.VertexElementFormat=void 0,(Lr=e.VertexElementFormat||(e.VertexElementFormat={}))[Lr.Float=0]="Float",Lr[Lr.Vector2=1]="Vector2",Lr[Lr.Vector3=2]="Vector3",Lr[Lr.Vector4=3]="Vector4",Lr[Lr.Byte4=4]="Byte4",Lr[Lr.UByte4=5]="UByte4",Lr[Lr.NormalizedByte4=6]="NormalizedByte4",Lr[Lr.NormalizedUByte4=7]="NormalizedUByte4",Lr[Lr.Short2=8]="Short2",Lr[Lr.UShort2=9]="UShort2",Lr[Lr.NormalizedShort2=10]="NormalizedShort2",Lr[Lr.NormalizedUShort2=11]="NormalizedUShort2",Lr[Lr.Short4=12]="Short4",Lr[Lr.UShort4=13]="UShort4",Lr[Lr.NormalizedShort4=14]="NormalizedShort4",Lr[Lr.NormalizedUShort4=15]="NormalizedUShort4",e.BufferUsage=void 0,(Br=e.BufferUsage||(e.BufferUsage={}))[Br.Static=0]="Static",Br[Br.Dynamic=1]="Dynamic",Br[Br.Stream=2]="Stream",e.IndexFormat=void 0,(Dr=e.IndexFormat||(e.IndexFormat={}))[Dr.UInt8=0]="UInt8",Dr[Dr.UInt16=1]="UInt16",Dr[Dr.UInt32=2]="UInt32";var Or,zr,Vr=function(){function t(){}return t._getGLBufferUsage=function(t,r){switch(r){case e.BufferUsage.Static:return t.STATIC_DRAW;case e.BufferUsage.Dynamic:return t.DYNAMIC_DRAW;case e.BufferUsage.Stream:return t.STREAM_DRAW}},t._getGLIndexType=function(t){switch(t){case e.IndexFormat.UInt8:return e.DataType.UNSIGNED_BYTE;case e.IndexFormat.UInt16:return e.DataType.UNSIGNED_SHORT;case e.IndexFormat.UInt32:return e.DataType.UNSIGNED_INT}},t._getGLIndexByteCount=function(t){switch(t){case e.IndexFormat.UInt8:return 1;case e.IndexFormat.UInt16:return 2;case e.IndexFormat.UInt32:return 4}},t._getElementInfo=function(t){var r,n,i=!1;switch(t){case e.VertexElementFormat.Float:r=1,n=e.DataType.FLOAT;break;case e.VertexElementFormat.Vector2:r=2,n=e.DataType.FLOAT;break;case e.VertexElementFormat.Vector3:r=3,n=e.DataType.FLOAT;break;case e.VertexElementFormat.Vector4:r=4,n=e.DataType.FLOAT;break;case e.VertexElementFormat.Byte4:r=4,n=e.DataType.BYTE;break;case e.VertexElementFormat.UByte4:r=4,n=e.DataType.UNSIGNED_BYTE;break;case e.VertexElementFormat.NormalizedByte4:r=4,n=e.DataType.BYTE,i=!0;break;case e.VertexElementFormat.NormalizedUByte4:r=4,n=e.DataType.UNSIGNED_BYTE,i=!0;break;case e.VertexElementFormat.Short2:r=2,n=e.DataType.SHORT;break;case e.VertexElementFormat.UShort2:r=2,n=e.DataType.UNSIGNED_SHORT;break;case e.VertexElementFormat.NormalizedShort2:r=2,n=e.DataType.SHORT,i=!0;break;case e.VertexElementFormat.NormalizedUShort2:r=2,n=e.DataType.UNSIGNED_SHORT,i=!0;break;case e.VertexElementFormat.Short4:r=4,n=e.DataType.SHORT;break;case e.VertexElementFormat.UShort4:r=4,n=e.DataType.UNSIGNED_SHORT;break;case e.VertexElementFormat.NormalizedShort4:r=4,n=e.DataType.SHORT,i=!0;break;case e.VertexElementFormat.NormalizedUShort4:r=4,n=e.DataType.UNSIGNED_SHORT,i=!0}return{size:r,type:n,normalized:i}},t}(),Nr=function(){function e(e,t,r,n,i){void 0===i&&(i=0),this._glElementInfo=void 0,this._semantic=void 0,this._offset=void 0,this._format=void 0,this._bindingIndex=void 0,this._instanceStepRate=void 0,this._semantic=e,this._offset=t,this._format=r,this._bindingIndex=n,this._glElementInfo=Vr._getElementInfo(this.format),this._instanceStepRate=Math.floor(i)}return A(e,[{key:"semantic",get:function(){return this._semantic}},{key:"offset",get:function(){return this._offset}},{key:"format",get:function(){return this._format}},{key:"bindingIndex",get:function(){return this._bindingIndex}},{key:"instanceStepRate",get:function(){return this._instanceStepRate}}]),e}();e.BufferBindFlag=void 0,(Or=e.BufferBindFlag||(e.BufferBindFlag={}))[Or.VertexBuffer=0]="VertexBuffer",Or[Or.IndexBuffer=1]="IndexBuffer",e.SetDataOptions=void 0,(zr=e.SetDataOptions||(e.SetDataOptions={}))[zr.None=0]="None",zr[zr.Discard=1]="Discard";var Ur,kr=function(t){function r(r,n,i,a){var o;void 0===a&&(a=e.BufferUsage.Static),(o=t.call(this,r)||this)._glBindTarget=void 0,o._glBufferUsage=void 0,o._nativeBuffer=void 0,o._hardwareRenderer=void 0,o._type=void 0,o._byteLength=void 0,o._bufferUsage=void 0,o._engine=r,o._type=n,o._bufferUsage=a;var s=r._hardwareRenderer,l=s.gl,u=Vr._getGLBufferUsage(l,a),c=n===e.BufferBindFlag.VertexBuffer?l.ARRAY_BUFFER:l.ELEMENT_ARRAY_BUFFER;return o._nativeBuffer=l.createBuffer(),o._hardwareRenderer=s,o._glBufferUsage=u,o._glBindTarget=c,o.bind(),"number"==typeof i?(o._byteLength=i,l.bufferData(c,i,u)):(o._byteLength=i.byteLength,l.bufferData(c,i,u)),l.bindBuffer(c,null),o}E(r,t);var n=r.prototype;return n.bind=function(){this._hardwareRenderer.gl.bindBuffer(this._glBindTarget,this._nativeBuffer)},n.setData=function(t,r,n,i,a){void 0===r&&(r=0),void 0===n&&(n=0),void 0===a&&(a=e.SetDataOptions.None);var o=this._hardwareRenderer.gl,s=this._hardwareRenderer.isWebGL2,l=this._glBindTarget;this.bind(),a===e.SetDataOptions.Discard&&o.bufferData(l,this._byteLength,this._glBufferUsage);var u=t.BYTES_PER_ELEMENT||1,c=i?u*i:t.byteLength;if(0!==n||c<t.byteLength){var h=void 0!==t.byteOffset;if(s&&h)o.bufferSubData(l,r,t,n,c/u);else{var d=new Uint8Array(h?t.buffer:t,n*u,c);o.bufferSubData(l,r,d)}}else o.bufferSubData(l,r,t);o.bindBuffer(l,null)},n.getData=function(e,t,r,n){if(void 0===t&&(t=0),void 0===r&&(r=0),!this._hardwareRenderer.isWebGL2)throw"Buffer is write-only on WebGL1.0 platforms.";var i=this._hardwareRenderer.gl;this.bind(),i.getBufferSubData(this._glBindTarget,t,e,r,n)},n._onDestroy=function(){this._hardwareRenderer.gl.deleteBuffer(this._nativeBuffer),this._nativeBuffer=null,this._hardwareRenderer=null},n.resize=function(e){this.bind(),this._hardwareRenderer.gl.bufferData(this._glBindTarget,e,this._glBufferUsage),this._byteLength=e},A(r,[{key:"type",get:function(){return this._type}},{key:"byteLength",get:function(){return this._byteLength}},{key:"bufferUsage",get:function(){return this._bufferUsage}}]),r}(Q);e.MeshTopology=void 0,(Ur=e.MeshTopology||(e.MeshTopology={}))[Ur.Points=0]="Points",Ur[Ur.Lines=1]="Lines",Ur[Ur.LineLoop=2]="LineLoop",Ur[Ur.LineStrip=3]="LineStrip",Ur[Ur.Triangles=4]="Triangles",Ur[Ur.TriangleStrip=5]="TriangleStrip",Ur[Ur.TriangleFan=6]="TriangleFan";var Gr,Hr,Wr=function(){function e(e,t){this._buffer=void 0,this._format=void 0,this._buffer=e,this._format=t}return A(e,[{key:"buffer",get:function(){return this._buffer}},{key:"format",get:function(){return this._format}}]),e}(),jr=function(t,r,n){void 0===t&&(t=0),void 0===r&&(r=0),void 0===n&&(n=e.MeshTopology.Triangles),this.start=void 0,this.count=void 0,this.topology=void 0,this.start=t,this.count=r,this.topology=n},Xr=function(t){function r(e,r){var n;return(n=t.call(this,e)||this).name=void 0,n.bounds=new l,n._vertexElementMap={},n._glIndexType=void 0,n._glIndexByteCount=void 0,n._platformPrimitive=void 0,n._instanceCount=0,n._vertexBufferBindings=[],n._indexBufferBinding=null,n._vertexElements=[],n._subMeshes=[],n._updateFlagManager=new Ze,n.name=r,n._platformPrimitive=n._engine._hardwareRenderer.createPlatformPrimitive(O(n)),n}E(r,t);var n=r.prototype;return n.addSubMesh=function(t,r,n){return void 0===n&&(n=e.MeshTopology.Triangles),"number"==typeof t&&(t=new jr(t,r,n)),this._subMeshes.push(t),t},n.removeSubMesh=function(e){var t=this._subMeshes,r=t.indexOf(e);-1!==r&&t.splice(r,1)},n.clearSubMesh=function(){this._subMeshes.length=0},n.registerUpdateFlag=function(){return this._updateFlagManager.createFlag(Qe)},n._clearVertexElements=function(){this._vertexElements.length=0;var e=this._vertexElementMap;for(var t in e)delete e[t]},n._addVertexElement=function(e){var t=e.semantic;this._vertexElementMap[t]=e,this._vertexElements.push(e),this._updateFlagManager.dispatch()},n._draw=function(e,t){this._platformPrimitive.draw(e,t)},n._addRefCount=function(e){t.prototype._addRefCount.call(this,e);for(var r=this._vertexBufferBindings,n=0,i=r.length;n<i;n++)r[n]._buffer._addRefCount(e)},n._onDestroy=function(){this._vertexBufferBindings=null,this._indexBufferBinding=null,this._vertexElements=null,this._vertexElementMap=null,this._platformPrimitive.destroy()},n._setVertexElements=function(e){this._clearVertexElements();for(var t=0,r=e.length;t<r;t++)this._addVertexElement(e[t])},n._setVertexBufferBinding=function(e,t){if(this._getRefCount()>0){var r=this._vertexBufferBindings[e];r&&r._buffer._addRefCount(-1),t._buffer._addRefCount(1)}this._vertexBufferBindings[e]=t},n._setIndexBufferBinding=function(e){e?(this._indexBufferBinding=e,this._glIndexType=Vr._getGLIndexType(e.format),this._glIndexByteCount=Vr._getGLIndexByteCount(e.format)):(this._indexBufferBinding=null,this._glIndexType=void 0)},A(r,[{key:"subMesh",get:function(){return this._subMeshes[0]||null}},{key:"subMeshes",get:function(){return this._subMeshes}}]),r}(Q),Kr=function(){function e(e,t){this._buffer=void 0,this._stride=void 0,this._buffer=e,this._stride=t}return A(e,[{key:"buffer",get:function(){return this._buffer}},{key:"stride",get:function(){return this._stride}}]),e}(),qr=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).listener=void 0,t}return E(t,e),t.prototype.dispatch=function(e){this.listener&&this.listener(e)},t}(Ye);e.RenderBufferDepthFormat=void 0,(Gr=e.RenderBufferDepthFormat||(e.RenderBufferDepthFormat={}))[Gr.Depth=0]="Depth",Gr[Gr.DepthStencil=1]="DepthStencil",Gr[Gr.Stencil=2]="Stencil",Gr[Gr.Depth16=3]="Depth16",Gr[Gr.Depth24=4]="Depth24",Gr[Gr.Depth32=5]="Depth32",Gr[Gr.Depth24Stencil8=6]="Depth24Stencil8",Gr[Gr.Depth32Stencil8=7]="Depth32Stencil8",e.TextureCubeFace=void 0,(Hr=e.TextureCubeFace||(e.TextureCubeFace={}))[Hr.PositiveX=0]="PositiveX",Hr[Hr.NegativeX=1]="NegativeX",Hr[Hr.PositiveY=2]="PositiveY",Hr[Hr.NegativeY=3]="NegativeY",Hr[Hr.PositiveZ=4]="PositiveZ",Hr[Hr.NegativeZ=5]="NegativeZ";var Yr,Qr=function(t){function r(r,n,i,a,o,s){var l;return void 0===o&&(o=e.RenderBufferDepthFormat.Depth),void 0===s&&(s=1),(l=t.call(this,r)||this)._platformRenderTarget=void 0,l._depth=void 0,l._antiAliasing=void 0,l._autoGenerateMipmaps=!0,l._width=void 0,l._height=void 0,l._colorTextures=void 0,l._depthTexture=void 0,l._width=n,l._height=i,l._antiAliasing=s,l._depth=o,l._colorTextures=a?a instanceof Array?a.slice():[a]:[],o instanceof ne&&(l._depthTexture=o),l._platformRenderTarget=r._hardwareRenderer.createPlatformRenderTarget(O(l)),l}E(r,t);var n=r.prototype;return n.getColorTexture=function(e){return void 0===e&&(e=0),this._colorTextures[e]},n.generateMipmaps=function(){if(this._autoGenerateMipmaps){for(var e=this._colorTextures,t=0,r=e.length;t<r;t++)e[t].generateMipmaps();this._depthTexture&&this._depthTexture.generateMipmaps()}},n.destroy=function(){this._platformRenderTarget.destroy(),this._colorTextures.length=0,this._depthTexture=null,this._depth=null},n._setRenderTargetInfo=function(e,t){this._platformRenderTarget.setRenderTargetInfo(e,t)},n._blitRenderTarget=function(){this._platformRenderTarget.blitRenderTarget()},A(r,[{key:"autoGenerateMipmaps",get:function(){return this._autoGenerateMipmaps},set:function(e){this._autoGenerateMipmaps=e}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"colorTextureCount",get:function(){return this._colorTextures.length}},{key:"depthTexture",get:function(){return this._depthTexture}},{key:"antiAliasing",get:function(){return this._antiAliasing}}]),r}(Y),Jr=function(t){function r(r,n,i,a,o,s){var l;return void 0===o&&(o=e.TextureFormat.R8G8B8A8),void 0===s&&(s=!0),(l=t.call(this,r)||this)._length=void 0,l._mipmap=s,l._width=n,l._height=i,l._length=a,l._format=o,l._mipmapCount=l._getMipmapCount(),l._platformTexture=r._hardwareRenderer.createPlatformTexture2DArray(O(l)),l.filterMode=e.TextureFilterMode.Bilinear,l.wrapModeU=l.wrapModeV=e.TextureWrapMode.Repeat,l}E(r,t);var n=r.prototype;return n.setPixelBuffer=function(e,t,r,n,i,a,o,s){void 0===r&&(r=0),void 0===n&&(n=0),void 0===i&&(i=0),this._platformTexture.setPixelBuffer(e,t,r,n,i,a,o,s)},n.setImageSource=function(e,t,r,n,i,a,o){void 0===r&&(r=0),void 0===n&&(n=!1),void 0===i&&(i=!1),void 0===a&&(a=0),void 0===o&&(o=0),this._platformTexture.setImageSource(e,t,r,n,i,a,o)},n.getPixelBuffer=function(e,t,r,n,i,a,o){var s=arguments.length;1===s?this._platformTexture.getPixelBuffer(e,0,0,this._width,this._height,0,t):2===s?this._platformTexture.getPixelBuffer(e,0,0,this._width>>t,this._height>>t,t,r):5===s?this._platformTexture.getPixelBuffer(e,t,r,n,i,0,a):6===s&&this._platformTexture.getPixelBuffer(e,t,r,n,i,a,o)},A(r,[{key:"length",get:function(){return this._length}}]),r}(ne),Zr=function(t){function r(r,n,i,a){var o;return void 0===i&&(i=e.TextureFormat.R8G8B8A8),void 0===a&&(a=!0),(o=t.call(this,r)||this)._mipmap=a,o._width=n,o._height=n,o._format=i,o._mipmapCount=o._getMipmapCount(),o._platformTexture=r._hardwareRenderer.createPlatformTextureCube(O(o)),o.filterMode=e.TextureFilterMode.Bilinear,o.wrapModeU=o.wrapModeV=e.TextureWrapMode.Clamp,o}E(r,t);var n=r.prototype;return n.setPixelBuffer=function(e,t,r,n,i,a,o){void 0===r&&(r=0),void 0===n&&(n=0),void 0===i&&(i=0),this._platformTexture.setPixelBuffer(e,t,r,n,i,a,o)},n.setImageSource=function(e,t,r,n,i,a,o){void 0===r&&(r=0),void 0===n&&(n=!1),void 0===i&&(i=!1),void 0===a&&(a=0),void 0===o&&(o=0),this._platformTexture.setImageSource(e,t,r,n,i,a,o)},n.getPixelBuffer=function(e,t,r,n,i,a,o){var s=arguments.length;2===s?this._platformTexture.getPixelBuffer(e,0,0,this._width,this._height,0,t):3===s?this._platformTexture.getPixelBuffer(e,0,0,this._width>>t,this._height>>t,t,r):6===s?this._platformTexture.getPixelBuffer(e,t,r,n,i,0,a):7===s&&this._platformTexture.getPixelBuffer(e,t,r,n,i,a,o)},r}(ne),$r=function(){function t(e){this._useBlendNormal=!0,this._useBlendTangent=!0,this._blendShapes=[],this._blendShapeNames=void 0,this._blendShapeCount=0,this._layoutDirtyFlag=new qr,this._subDataDirtyFlags=[],this._dataTextureBuffer=void 0,this._dataTexture=void 0,this._dataTextureInfo=new o,this._engine=void 0,this._lastUpdateLayoutAndCountInfo=new o(0,0,0),this._canUseTextureStoreData=!0,this._engine=e,this._canUseTextureStoreData=this._engine._hardwareRenderer.capability.canUseFloatTextureBlendShape,this._layoutDirtyFlag.listener=this._updateUsePropertyFlag.bind(this)}var r=t.prototype;return r._addBlendShape=function(e){this._blendShapes.push(e),this._blendShapeCount++,e._addLayoutChangeFlag(this._layoutDirtyFlag),this._updateUsePropertyFlag(e),this._subDataDirtyFlags.push(e._createSubDataDirtyFlag())},r._clearBlendShapes=function(){this._useBlendNormal=!0,this._useBlendTangent=!0,this._blendShapes.length=0,this._blendShapeCount=0,this._layoutDirtyFlag.clearFromManagers();for(var e=this._subDataDirtyFlags,t=0,r=e.length;t<r;t++)e[t].destroy();e.length=0},r._useTextureStore=function(){return!!this._canUseTextureStoreData&&(this._useBlendNormal||this._useBlendTangent?this._blendShapeCount>4:this._blendShapeCount>8)},r._layoutOrCountChange=function(){var e=this._lastUpdateLayoutAndCountInfo;if(e.x!==this._blendShapeCount||!!e.y!==this._useBlendNormal||!!e.z!==this._useBlendTangent)return!0},r._needUpdateData=function(){for(var e=this._subDataDirtyFlags,t=0,r=e.length;t<r;t++)if(e[t].flag)return!0;return!1},r._updateVertexElements=function(t,r){for(var n=0,i=0,a=this._blendShapeCount;i<a;i++)t._addVertexElement(new Nr("POSITION_BS"+i,r,e.VertexElementFormat.Vector3,0)),r+=12,n+=3,this._useBlendNormal&&(t._addVertexElement(new Nr("NORMAL_BS"+i,r,e.VertexElementFormat.Vector3,0)),r+=12,n+=3),this._useBlendTangent&&(t._addVertexElement(new Nr("TANGENT_BS"+i,r,e.VertexElementFormat.Vector3,0)),n+=3);return this._lastUpdateLayoutAndCountInfo.setValue(this._blendShapeCount,+this._useBlendNormal,+this._useBlendTangent),n},r._updateDataToVertices=function(e,t,r,n,i){for(var a=this._blendShapes,o=this._subDataDirtyFlags,s=0,l=a.length;s<l;s++){var u=o[s];if(i||u.flag){var c=a[s].frames,h=c.length,d=c[h-1];if(h>0&&d.deltaPositions.length!==r)throw"BlendShape frame deltaPositions length must same with mesh vertexCount.";for(var _=d.deltaPositions,f=0;f<r;f++){var p=n*f+t,g=_[f];g&&(e[p]=g.x,e[p+1]=g.y,e[p+2]=g.z)}if(t+=3,this._useBlendNormal){var v=d.deltaNormals;if(v)for(var m=0;m<r;m++){var y=n*m+t,x=v[m];x&&(e[y]=x.x,e[y+1]=x.y,e[y+2]=x.z)}t+=3}if(this._useBlendTangent){var T=d.deltaTangents;if(T)for(var w=0;w<r;w++){var b=n*w+t,C=T[w];C&&(e[b]=C.x,e[b+1]=C.y,e[b+2]=C.z)}t+=3}u.flag=!1}}},r._updateTexture=function(e,t,r,n){var i=!this._dataTexture||e||t;i&&(this._createDataTexture(n),this._lastUpdateLayoutAndCountInfo.setValue(this._blendShapeCount,+this._useBlendNormal,+this._useBlendTangent)),r&&this._updateDataToTexture(n,i)},r._createDataTexture=function(t){var r=this._engine._hardwareRenderer.capability.maxTextureSize,n=1;this._useBlendNormal&&n++,this._useBlendTangent&&n++;var i=n*t,a=1;i>r&&(a=Math.ceil(i/r),i=r);var o=this._dataTexture,s=this._blendShapes.length;o&&o.destroy(),(o=new Jr(this._engine,i,a,s,e.TextureFormat.R32G32B32A32,!1)).filterMode=e.TextureFilterMode.Point,this._dataTextureBuffer=new Float32Array(s*i*a*4),this._dataTexture=o,this._dataTextureInfo.setValue(n,i,a)},r._updateDataToTexture=function(e,t){for(var r=this._blendShapes,n=this._dataTexture,i=this._dataTextureBuffer,a=this._subDataDirtyFlags,o=0,s=0,l=r.length;s<l;s++){var u=a[s],c=n.width*n.height*4;if(t||u.flag){var h=r[s].frames,d=h.length,_=h[d-1];if(d>0&&_.deltaPositions.length!==e)throw"BlendShape frame deltaPositions length must same with mesh vertexCount.";var f=_.deltaPositions,p=_.deltaNormals,g=_.deltaTangents;o=s*c;for(var v=0;v<e;v++){var m=f[v];if(i[o]=m.x,i[o+1]=m.y,i[o+2]=m.z,o+=4,p){var y=p[v];i[o]=y.x,i[o+1]=y.y,i[o+2]=y.z,o+=4}if(g){var x=g[v];i[o]=x.x,i[o+1]=x.y,i[o+2]=x.z,o+=4}}u.flag=!1}}n.setPixelBuffer(0,i)},r._releaseMemoryCache=function(){for(var e=this._blendShapes,t=new Array(e.length),r=0,n=e.length;r<n;r++)t[r]=e[r].name;this._blendShapeNames=t,this._layoutDirtyFlag.destroy();for(var i=this._subDataDirtyFlags,a=0,o=i.length;a<o;a++)i[a].destroy();this._layoutDirtyFlag=null,this._subDataDirtyFlags=null,this._blendShapes=null},r._updateUsePropertyFlag=function(e){this._useBlendNormal=e._useBlendShapeNormal&&this._useBlendNormal,this._useBlendTangent=e._useBlendShapeTangent&&this._useBlendTangent},t}(),en=function(t){function r(e,r){var n;return(n=t.call(this,e)||this)._blendShapeManager=void 0,n._vertexCount=0,n._accessible=!0,n._verticesFloat32=null,n._verticesUint8=null,n._indices=null,n._indicesFormat=null,n._vertexSlotChanged=!0,n._vertexChangeFlag=0,n._indicesChangeFlag=!1,n._elementCount=0,n._lastUploadVertexCount=-1,n._positions=[],n._normals=null,n._colors=null,n._tangents=null,n._uv=null,n._uv1=null,n._uv2=null,n._uv3=null,n._uv4=null,n._uv5=null,n._uv6=null,n._uv7=null,n._boneWeights=null,n._boneIndices=null,n.name=r,n._blendShapeManager=new $r(e),n}E(r,t);var n=r.prototype;return n.setPositions=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";this._positions=e,this._vertexCount=e.length,this._vertexChangeFlag|=Yr.Position},n.getPositions=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._positions},n.setNormals=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._normals!=!!e,this._vertexChangeFlag|=Yr.Normal,this._normals=e},n.getNormals=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._normals},n.setColors=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._colors!=!!e,this._vertexChangeFlag|=Yr.Color,this._colors=e},n.getColors=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._colors},n.setBoneWeights=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=null!=e,this._vertexChangeFlag|=Yr.BoneWeight,this._boneWeights=e},n.getBoneWeights=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._boneWeights},n.setBoneIndices=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._boneIndices!=!!e,this._vertexChangeFlag|=Yr.BoneIndex,this._boneIndices=e},n.getBoneIndices=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._boneIndices},n.setTangents=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._tangents!=!!e,this._vertexChangeFlag|=Yr.Tangent,this._tangents=e},n.getTangents=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._tangents},n.setUVs=function(e,t){var r;if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";switch(t=null!=(r=t)?r:0){case 0:this._vertexSlotChanged=!!this._uv!=!!e,this._vertexChangeFlag|=Yr.UV,this._uv=e;break;case 1:this._vertexSlotChanged=!!this._uv1!=!!e,this._vertexChangeFlag|=Yr.UV1,this._uv1=e;break;case 2:this._vertexSlotChanged=!!this._uv2!=!!e,this._vertexChangeFlag|=Yr.UV2,this._uv2=e;break;case 3:this._vertexSlotChanged=!!this._uv3!=!!e,this._vertexChangeFlag|=Yr.UV3,this._uv3=e;break;case 4:this._vertexSlotChanged=!!this._uv4!=!!e,this._vertexChangeFlag|=Yr.UV4,this._uv4=e;break;case 5:this._vertexSlotChanged=!!this._uv5!=!!e,this._vertexChangeFlag|=Yr.UV5,this._uv5=e;break;case 6:this._vertexSlotChanged=!!this._uv6!=!!e,this._vertexChangeFlag|=Yr.UV6,this._uv6=e;break;case 7:this._vertexSlotChanged=!!this._uv7!=!!e,this._vertexChangeFlag|=Yr.UV7,this._uv7=e;break;default:throw"The index of channel needs to be in range [0 - 7]."}},n.getUVs=function(e){var t;if(!this._accessible)throw"Not allowed to access data while accessible is false.";switch(e=null!=(t=e)?t:0){case 0:return this._uv;case 1:return this._uv1;case 2:return this._uv2;case 3:return this._uv3;case 4:return this._uv4;case 5:return this._uv5;case 6:return this._uv6;case 7:return this._uv7}throw"The index of channel needs to be in range [0 - 7]."},n.setIndices=function(t){if(!this._accessible)throw"Not allowed to access data while accessible is false.";this._indices!==t&&(this._indices=t,t instanceof Uint8Array?this._indicesFormat=e.IndexFormat.UInt8:t instanceof Uint16Array?this._indicesFormat=e.IndexFormat.UInt16:t instanceof Uint32Array&&(this._indicesFormat=e.IndexFormat.UInt32)),this._indicesChangeFlag=!0},n.getIndices=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._indices},n.addBlendShape=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";this._blendShapeManager._addBlendShape(e)},n.clearBlendShapes=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";this._blendShapeManager._clearBlendShapes()},n.getBlendShapeName=function(e){return this._accessible?this._blendShapeManager._blendShapes[e].name:this._blendShapeManager._blendShapeNames[e]},n.uploadData=function(t){var r,n;if(!this._accessible)throw"Not allowed to access data while accessible is false.";var i=this._blendShapeManager,a=i._useTextureStore(),o=i._layoutOrCountChange(),s=i._needUpdateData(),l=!a&&o,u=this._vertexSlotChanged||l;u&&this._updateVertexElements(l);var c=this._vertexCount,h=this._lastUploadVertexCount!==c,d=null===(r=this._vertexBufferBindings[0])||void 0===r?void 0:r._buffer;if(h){null==d||d.destroy();var _=this._elementCount,f=new Float32Array(_*c);this._verticesFloat32=f,this._verticesUint8=new Uint8Array(f.buffer),this._updateVertices(f,!a,!0);var p=new kr(this._engine,e.BufferBindFlag.VertexBuffer,f,t?e.BufferUsage.Static:e.BufferUsage.Dynamic);this._setVertexBufferBinding(0,new Kr(p,4*_)),this._lastUploadVertexCount=c}else{var g=!a&&s;if(this._vertexChangeFlag&Yr.All||g){var v=this._verticesFloat32;this._updateVertices(v,g,u),d.setData(v)}}var m=this._indices,y=null===(n=this._indexBufferBinding)||void 0===n?void 0:n._buffer;if(m)if(y&&m.byteLength==y.byteLength)this._indicesChangeFlag&&(y.setData(m),this._indexBufferBinding._format!==this._indicesFormat&&this._setIndexBufferBinding(new Wr(y,this._indicesFormat)),this._indicesChangeFlag=!1);else{null==y||y.destroy();var x=new kr(this._engine,e.BufferBindFlag.IndexBuffer,m);this._setIndexBufferBinding(new Wr(x,this._indicesFormat)),this._indicesChangeFlag=!1}else y&&(y.destroy(),this._setIndexBufferBinding(null));a&&i._updateTexture(o,h,s,c),t&&(this._accessible=!1,this._releaseCache())},n._onDestroy=function(){t.prototype._onDestroy.call(this),this._accessible&&this._releaseCache()},n._updateVertexElements=function(t){this._clearVertexElements(),this._addVertexElement(tn);var r=12,n=3;this._normals&&(this._addVertexElement(new Nr("NORMAL",r,e.VertexElementFormat.Vector3,0)),r+=12,n+=3),this._colors&&(this._addVertexElement(new Nr("COLOR_0",r,e.VertexElementFormat.Vector4,0)),r+=16,n+=4),this._boneWeights&&(this._addVertexElement(new Nr("WEIGHTS_0",r,e.VertexElementFormat.Vector4,0)),r+=16,n+=4),this._boneIndices&&(this._addVertexElement(new Nr("JOINTS_0",r,e.VertexElementFormat.UByte4,0)),r+=4,n+=1),this._tangents&&(this._addVertexElement(new Nr("TANGENT",r,e.VertexElementFormat.Vector4,0)),r+=16,n+=4),this._uv&&(this._addVertexElement(new Nr("TEXCOORD_0",r,e.VertexElementFormat.Vector2,0)),r+=8,n+=2),this._uv1&&(this._addVertexElement(new Nr("TEXCOORD_1",r,e.VertexElementFormat.Vector2,0)),r+=8,n+=2),this._uv2&&(this._addVertexElement(new Nr("TEXCOORD_2",r,e.VertexElementFormat.Vector2,0)),r+=8,n+=2),this._uv3&&(this._addVertexElement(new Nr("TEXCOORD_3",r,e.VertexElementFormat.Vector2,0)),r+=8,n+=2),this._uv4&&(this._addVertexElement(new Nr("TEXCOORD_4",r,e.VertexElementFormat.Vector2,0)),r+=8,n+=2),this._uv5&&(this._addVertexElement(new Nr("TEXCOORD_5",r,e.VertexElementFormat.Vector2,0)),r+=8,n+=2),this._uv6&&(this._addVertexElement(new Nr("TEXCOORD_6",r,e.VertexElementFormat.Vector2,0)),r+=8,n+=2),this._uv7&&(this._addVertexElement(new Nr("TEXCOORD_7",r,e.VertexElementFormat.Vector2,0)),r+=8,n+=2),this._vertexSlotChanged=!1,t&&(n+=this._blendShapeManager._updateVertexElements(this,r)),this._elementCount=n},n._updateVertices=function(e,t,r){var n=this._elementCount,i=this._vertexCount,a=this._positions,o=this._normals,s=this._colors,l=this._vertexChangeFlag,u=this._boneWeights,c=this._boneIndices,h=this._tangents,d=this._uv,_=this._uv1,f=this._uv2,p=this._uv3,g=this._uv4,v=this._uv5,m=this._uv6,y=this._uv7;if(r&&(this._vertexChangeFlag=Yr.All),l&Yr.Position)for(var x=0;x<i;x++){var T=n*x,w=a[x];e[T]=w.x,e[T+1]=w.y,e[T+2]=w.z}var b=3;if(o){if(l&Yr.Normal)for(var C=0;C<i;C++){var S=n*C+b,M=o[C];M&&(e[S]=M.x,e[S+1]=M.y,e[S+2]=M.z)}b+=3}if(s){if(l&Yr.Color)for(var A=0;A<i;A++){var P=n*A+b,F=s[A];F&&(e[P]=F.r,e[P+1]=F.g,e[P+2]=F.b,e[P+3]=F.a)}b+=4}if(u){if(l&Yr.BoneWeight)for(var E=0;E<i;E++){var R=n*E+b,L=u[E];L&&(e[R]=L.x,e[R+1]=L.y,e[R+2]=L.z,e[R+3]=L.w)}b+=4}if(c){if(l&Yr.BoneIndex)for(var B=this._verticesUint8,D=0;D<i;D++){var I=n*D+b,O=c[D];if(O){var z=4*I;B[z]=O.x,B[z+1]=O.y,B[z+2]=O.z,B[z+3]=O.w}}b+=1}if(h){if(l&Yr.Tangent)for(var V=0;V<i;V++){var N=n*V+b,U=h[V];U&&(e[N]=U.x,e[N+1]=U.y,e[N+2]=U.z)}b+=4}if(d){if(l&Yr.UV)for(var k=0;k<i;k++){var G=n*k+b,H=d[k];H&&(e[G]=H.x,e[G+1]=H.y)}b+=2}if(_){if(l&Yr.UV1)for(var W=0;W<i;W++){var j=n*W+b,X=_[W];X&&(e[j]=X.x,e[j+1]=X.y)}b+=2}if(f){if(l&Yr.UV2)for(var K=0;K<i;K++){var q=n*K+b,Y=f[K];Y&&(e[q]=Y.x,e[q+1]=Y.y)}b+=2}if(p){if(l&Yr.UV3)for(var Q=0;Q<i;Q++){var J=n*Q+b,Z=p[Q];Z&&(e[J]=Z.x,e[J+1]=Z.y)}b+=2}if(g){if(l&Yr.UV4)for(var $=0;$<i;$++){var ee=n*$+b,te=g[$];te&&(e[ee]=te.x,e[ee+1]=te.y)}b+=2}if(v){if(l&Yr.UV5)for(var re=0;re<i;re++){var ne=n*re+b,ie=v[re];ie&&(e[ne]=ie.x,e[ne+1]=ie.y)}b+=2}if(m){if(l&Yr.UV6)for(var ae=0;ae<i;ae++){var oe=n*ae+b,se=m[ae];se&&(e[oe]=se.x,e[oe+1]=se.y)}b+=2}if(y){if(l&Yr.UV7)for(var le=0;le<i;le++){var ue=n*le+b,ce=y[le];ce&&(e[ue]=ce.x,e[ue+1]=ce.y)}b+=2}this._vertexChangeFlag=0,t&&this._blendShapeManager._updateDataToVertices(e,b,i,n,r)},n._releaseCache=function(){this._verticesUint8=null,this._indices=null,this._verticesFloat32=null,this._positions.length=0,this._tangents=null,this._normals=null,this._colors=null,this._uv=null,this._uv1=null,this._uv2=null,this._uv3=null,this._uv4=null,this._uv5=null,this._uv6=null,this._uv7=null,this._blendShapeManager._releaseMemoryCache()},A(r,[{key:"accessible",get:function(){return this._accessible}},{key:"vertexCount",get:function(){return this._vertexCount}},{key:"blendShapes",get:function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._blendShapeManager._blendShapes}},{key:"blendShapeCount",get:function(){return this._blendShapeManager._blendShapeCount}}]),r}(Xr),tn=new Nr("POSITION",0,e.VertexElementFormat.Vector3,0);!function(e){e[e.Position=1]="Position",e[e.Normal=2]="Normal",e[e.Color=4]="Color",e[e.Tangent=8]="Tangent",e[e.BoneWeight=16]="BoneWeight",e[e.BoneIndex=32]="BoneIndex",e[e.UV=64]="UV",e[e.UV1=128]="UV1",e[e.UV2=256]="UV2",e[e.UV3=512]="UV3",e[e.UV4=1024]="UV4",e[e.UV5=2048]="UV5",e[e.UV6=4096]="UV6",e[e.UV7=8192]="UV7",e[e.All=65535]="All"}(Yr||(Yr={}));var rn,nn,an,on,sn,ln,un,cn,hn,dn,_n,fn,pn=function(e){function t(t){var r;return(r=e.call(this,null)||this).name=t,r.inverseBindMatrices=void 0,r.joints=void 0,r.skeleton=void 0,r.inverseBindMatrices=[],r.joints=[],r.skeleton="none",r}return E(t,e),t}(Y),gn=((on=function(e){function t(t){var r;return V(r=e.call(this,t)||this,"_mesh",nn,O(r)),V(r,"_meshUpdateFlag",an,O(r)),r}E(t,e);var r=t.prototype;return r._render=function(e){var r=this._mesh;if(r){if(this._meshUpdateFlag.flag){var n=this.shaderData,i=r._vertexElements;n.disableMacro(t._uvMacro),n.disableMacro(t._uv1Macro),n.disableMacro(t._normalMacro),n.disableMacro(t._tangentMacro),n.disableMacro(t._vertexColorMacro);for(var a=0,o=i.length;a<o;a++)switch(i[a].semantic){case"TEXCOORD_0":n.enableMacro(t._uvMacro);break;case"TEXCOORD_1":n.enableMacro(t._uv1Macro);break;case"NORMAL":n.enableMacro(t._normalMacro);break;case"TANGENT":n.enableMacro(t._tangentMacro);break;case"COLOR_0":n.enableMacro(t._vertexColorMacro)}this._meshUpdateFlag.flag=!1}for(var s=r.subMeshes,l=e._renderPipeline,u=this._engine._renderElementPool,c=0,h=s.length;c<h;c++){var d=this._materials[c];if(d){var _=u.getFromPool();_.setValue(this,r,s[c],d),l.pushPrimitive(_)}}}else re.error("mesh is null.")},r._onDestroy=function(){e.prototype._onDestroy.call(this);var t=this._mesh;t&&!t.destroyed&&(t._addRefCount(-1),this._mesh=null)},r._cloneTo=function(e){e.mesh=this._mesh},r._updateBounds=function(e){var t=this._mesh;if(t){var r=t.bounds,n=this._entity.transform.worldMatrix;l.transform(r,n,e)}else e.min.setValue(0,0,0),e.max.setValue(0,0,0)},A(t,[{key:"mesh",get:function(){return this._mesh},set:function(e){var t=this._mesh;t!==e&&(t&&(t._addRefCount(-1),this._meshUpdateFlag.destroy()),e&&(e._addRefCount(1),this._meshUpdateFlag=e.registerUpdateFlag()),this._mesh=e)}}]),t}(Rr))._uvMacro=zt.getMacroByName("O3_HAS_UV"),on._uv1Macro=zt.getMacroByName("O3_HAS_UV1"),on._normalMacro=zt.getMacroByName("O3_HAS_NORMAL"),on._tangentMacro=zt.getMacroByName("O3_HAS_TANGENT"),on._vertexColorMacro=zt.getMacroByName("O3_HAS_VERTEXCOLOR"),nn=N((rn=on).prototype,"_mesh",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),an=N(rn.prototype,"_meshUpdateFlag",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),rn),vn=((fn=function(t){function r(e){var r;return V(r=t.call(this,e)||this,"matrixPalette",ln,O(r)),V(r,"jointNodes",un,O(r)),V(r,"jointTexture",cn,O(r)),V(r,"_hasInitJoints",hn,O(r)),V(r,"_mat",dn,O(r)),V(r,"_useJointTexture",_n,O(r)),r._skin=void 0,r._blendShapeWeights=void 0,r._mat=new f,r._skin=null,r}E(r,t);var n=r.prototype;return n._updateShaderData=function(e){t.prototype._updateShaderData.call(this,e);var n=this.shaderData;!this._useJointTexture&&this.matrixPalette&&n.setFloatArray(r._jointMatrixProperty,this.matrixPalette);var i=this.mesh._blendShapeManager;i._blendShapeCount>0?(n.enableMacro(r._blendShapeMacro),n.enableMacro("OASIS_BLENDSHAPE_COUNT",i._blendShapeCount.toString()),i._useTextureStore()?(n.enableMacro(r._blendShapeTextureMacro),n.setTexture(r._blendShapeTextureProperty,i._dataTexture),n.setVector3(r._blendShapeTextureInfoProperty,i._dataTextureInfo)):n.disableMacro(r._blendShapeTextureMacro),n.setFloatArray(r._blendShapeWeightsProperty,this._blendShapeWeights),i._useBlendNormal?n.enableMacro(r._blendShapeNormalMacro):n.disableMacro(r._blendShapeNormalMacro),i._useBlendTangent?n.enableMacro(r._blendShapeTangentMacro):n.disableMacro(r._blendShapeTangentMacro)):(n.disableMacro(r._blendShapeMacro),n.disableMacro("OASIS_BLENDSHAPE_COUNT"))},n._initJoints=function(){if(this._skin){for(var e=this._skin.joints,t=[],n=e.length-1;n>=0;n--)t[n]=this.findByNodeName(this.entity,e[n]);this.matrixPalette=new Float32Array(16*t.length),this.jointNodes=t;var i=this.entity.engine._hardwareRenderer;if(i){var a=i.renderStates.getParameter(i.gl.MAX_VERTEX_UNIFORM_VECTORS),o=Math.floor((a-30)/4),s=this.shaderData,l=t.length;if(l)if(s.enableMacro("O3_HAS_SKIN"),s.setInt(r._jointCountProperty,l),l>o)i.canIUseMoreJoints?this._useJointTexture=!0:re.error("component's joints count("+l+") greater than device's MAX_VERTEX_UNIFORM_VECTORS number "+a+", and don't support jointTexture in this device. suggest joint count less than "+o+".",this);else{var u=Math.max(r._maxJoints,l);r._maxJoints=u,s.disableMacro("O3_USE_JOINT_TEXTURE"),s.enableMacro("O3_JOINTS_NUM",u.toString())}else s.disableMacro("O3_HAS_SKIN")}}},n.findByNodeName=function(e,t){return e?e.findByName(t)||this.findByNodeName(e.parent,t):null},n.update=function(){if(this._hasInitJoints||(this._initJoints(),this._hasInitJoints=!0),this._skin){for(var e=this.jointNodes,t=this._skin.inverseBindMatrices,r=this.matrixPalette,n=this.entity.getInvModelMatrix(),i=this._mat,a=e.length-1;a>=0;a--)i.identity(),e[a]?f.multiply(e[a].transform.worldMatrix,t[a],i):t[a].cloneTo(i),f.multiply(n,i,i),r.set(i.elements,16*a);this._useJointTexture&&this.createJointTexture()}},n.createJointTexture=function(){if(!this.jointTexture){var t=this.engine;if(!t._hardwareRenderer)return;this.jointTexture=new ie(t,4,this.jointNodes.length,e.TextureFormat.R32G32B32A32,!1),this.jointTexture.filterMode=e.TextureFilterMode.Point,this.shaderData.enableMacro("O3_USE_JOINT_TEXTURE"),this.shaderData.setTexture(r._jointSamplerProperty,this.jointTexture)}this.jointTexture.setPixelBuffer(this.matrixPalette)},A(r,[{key:"blendShapeWeights",get:function(){return this._blendShapeWeights},set:function(e){this._blendShapeWeights=e}},{key:"skin",get:function(){return this._skin},set:function(e){this._skin=e}}]),r}(gn))._blendShapeMacro=zt.getMacroByName("OASIS_BLENDSHAPE"),fn._blendShapeTextureMacro=zt.getMacroByName("OASIS_BLENDSHAPE_TEXTURE"),fn._blendShapeNormalMacro=zt.getMacroByName("OASIS_BLENDSHAPE_NORMAL"),fn._blendShapeTangentMacro=zt.getMacroByName("OASIS_BLENDSHAPE_TANGENT"),fn._jointCountProperty=zt.getPropertyByName("u_jointCount"),fn._jointSamplerProperty=zt.getPropertyByName("u_jointSampler"),fn._jointMatrixProperty=zt.getPropertyByName("u_jointMatrix"),fn._blendShapeWeightsProperty=zt.getPropertyByName("u_blendShapeWeights"),fn._blendShapeTextureProperty=zt.getPropertyByName("u_blendShapeTexture"),fn._blendShapeTextureInfoProperty=zt.getPropertyByName("u_blendShapeTextureInfo"),fn._maxJoints=0,ln=N((sn=fn).prototype,"matrixPalette",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),un=N(sn.prototype,"jointNodes",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),cn=N(sn.prototype,"jointTexture",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),hn=N(sn.prototype,"_hasInitJoints",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),dn=N(sn.prototype,"_mat",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),_n=N(sn.prototype,"_useJointTexture",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),sn),mn=function(){function t(){}return t.createSphere=function(e,r,n,i){void 0===r&&(r=.5),void 0===n&&(n=18),void 0===i&&(i=!0);for(var a=new en(e),s=(n=Math.max(2,Math.floor(n)))+1,l=s*s,u=n*n,c=t._generateIndices(e,l,6*u),h=Math.PI,d=2*h,_=1/s,f=1/n,p=new Array(l),v=new Array(l),m=new Array(l),y=0;y<l;++y){var x=y%s*f,T=(y*_|0)*f,w=x*d,b=T*h,C=Math.sin(b),S=-r*Math.cos(w)*C,M=r*Math.cos(b),A=r*Math.sin(w)*C;p[y]=new o(S,M,A),v[y]=new o(S,M,A),m[y]=new g(x,T)}for(var P=0,F=0;F<u;++F){var E=(F*f|0)*s+F%n,R=E+1,L=E+s,B=L+1;c[P++]=R,c[P++]=E,c[P++]=B,c[P++]=E,c[P++]=L,c[P++]=B}var D=a.bounds;return D.min.setValue(-r,-r,-r),D.max.setValue(r,r,r),t._initialize(a,p,v,m,c,i),a},t.createCuboid=function(e,r,n,i,a){void 0===r&&(r=1),void 0===n&&(n=1),void 0===i&&(i=1),void 0===a&&(a=!0);var s=new en(e),l=r/2,u=n/2,c=i/2,h=new Array(24),d=new Array(24),_=new Array(24);h[0]=new o(-l,u,-c),h[1]=new o(l,u,-c),h[2]=new o(l,u,c),h[3]=new o(-l,u,c),d[0]=new o(0,1,0),d[1]=new o(0,1,0),d[2]=new o(0,1,0),d[3]=new o(0,1,0),_[0]=new g(0,0),_[1]=new g(1,0),_[2]=new g(1,1),_[3]=new g(0,1),h[4]=new o(-l,-u,-c),h[5]=new o(l,-u,-c),h[6]=new o(l,-u,c),h[7]=new o(-l,-u,c),d[4]=new o(0,-1,0),d[5]=new o(0,-1,0),d[6]=new o(0,-1,0),d[7]=new o(0,-1,0),_[4]=new g(0,1),_[5]=new g(1,1),_[6]=new g(1,0),_[7]=new g(0,0),h[8]=new o(-l,u,-c),h[9]=new o(-l,u,c),h[10]=new o(-l,-u,c),h[11]=new o(-l,-u,-c),d[8]=new o(-1,0,0),d[9]=new o(-1,0,0),d[10]=new o(-1,0,0),d[11]=new o(-1,0,0),_[8]=new g(0,0),_[9]=new g(1,0),_[10]=new g(1,1),_[11]=new g(0,1),h[12]=new o(l,u,-c),h[13]=new o(l,u,c),h[14]=new o(l,-u,c),h[15]=new o(l,-u,-c),d[12]=new o(1,0,0),d[13]=new o(1,0,0),d[14]=new o(1,0,0),d[15]=new o(1,0,0),_[12]=new g(1,0),_[13]=new g(0,0),_[14]=new g(0,1),_[15]=new g(1,1),h[16]=new o(-l,u,c),h[17]=new o(l,u,c),h[18]=new o(l,-u,c),h[19]=new o(-l,-u,c),d[16]=new o(0,0,1),d[17]=new o(0,0,1),d[18]=new o(0,0,1),d[19]=new o(0,0,1),_[16]=new g(0,0),_[17]=new g(1,0),_[18]=new g(1,1),_[19]=new g(0,1),h[20]=new o(-l,u,-c),h[21]=new o(l,u,-c),h[22]=new o(l,-u,-c),h[23]=new o(-l,-u,-c),d[20]=new o(0,0,-1),d[21]=new o(0,0,-1),d[22]=new o(0,0,-1),d[23]=new o(0,0,-1),_[20]=new g(1,0),_[21]=new g(0,0),_[22]=new g(0,1),_[23]=new g(1,1);var f=new Uint16Array(36);f[0]=0,f[1]=2,f[2]=1,f[3]=2,f[4]=0,f[5]=3,f[6]=4,f[7]=6,f[8]=7,f[9]=6,f[10]=4,f[11]=5,f[12]=8,f[13]=10,f[14]=9,f[15]=10,f[16]=8,f[17]=11,f[18]=12,f[19]=14,f[20]=15,f[21]=14,f[22]=12,f[23]=13,f[24]=16,f[25]=18,f[26]=17,f[27]=18,f[28]=16,f[29]=19,f[30]=20,f[31]=22,f[32]=23,f[33]=22,f[34]=20,f[35]=21;var p=s.bounds;return p.min.setValue(-l,-u,-c),p.max.setValue(l,u,c),t._initialize(s,h,d,_,f,a),s},t.createPlane=function(e,r,n,i,a,s){void 0===r&&(r=1),void 0===n&&(n=1),void 0===i&&(i=1),void 0===a&&(a=1),void 0===s&&(s=!0);for(var l=new en(e),u=(i=Math.max(1,Math.floor(i)))+1,c=r/2,h=n/2,d=r/i,_=n/(a=Math.max(1,Math.floor(a))),f=u*(a+1),p=a*i,v=t._generateIndices(e,f,6*p),m=1/u,y=1/i,x=1/a,T=new Array(f),w=new Array(f),b=new Array(f),C=0;C<f;++C){var S=C%u,M=C*m|0;T[C]=new o(S*d-c,0,M*_-h),w[C]=new o(0,1,0),b[C]=new g(S*y,M*x)}for(var A=0,P=0;P<p;++P){var F=(P*y|0)*u+P%i,E=F+1,R=F+u,L=R+1;v[A++]=F,v[A++]=R,v[A++]=E,v[A++]=R,v[A++]=L,v[A++]=E}var B=l.bounds;return B.min.setValue(-c,0,-h),B.max.setValue(c,0,h),t._initialize(l,T,w,b,v,s),l},t.createCylinder=function(e,r,n,i,a,s,l){void 0===r&&(r=.5),void 0===n&&(n=.5),void 0===i&&(i=2),void 0===a&&(a=20),void 0===s&&(s=1),void 0===l&&(l=!0);for(var u=new en(e),c=(a=Math.floor(a))+1,h=.5*i,d=i/(s=Math.floor(s)),_=c*(s+1),f=a*s,p=2*a,v=_+2+p,m=t._generateIndices(e,v,6*f+3*p),y=1/c,x=1/a,T=1/s,w=new Array(v),b=new Array(v),C=new Array(v),S=0,M=Math.PI,A=2*Math.PI,P=n-r,F=P/i,E=P/s,R=0;R<_;++R){var L=R*y|0,B=R%c*x,D=L*T,I=M+B*A,O=Math.sin(I),z=Math.cos(I),V=n-L*E,N=V*O,U=L*d-h,k=V*z;w[R]=new o(N,U,k),b[R]=new o(O,F,z),C[R]=new g(B,1-D)}for(var G=0;G<f;++G){var H=(G*x|0)*c+G%a,W=H+1,j=H+c,X=j+1;m[S++]=W,m[S++]=j,m[S++]=H,m[S++]=W,m[S++]=X,m[S++]=j}w[_]=new o(0,-h,0),b[_]=new o(0,-1,0),C[_]=new g(.5,.5),w[_+1]=new o(0,h,0),b[_+1]=new o(0,1,0),C[_+1]=new g(.5,.5);for(var K=_+2,q=1/(2*r),Y=1/(2*n),Q=c*s,J=0;J<a;++J){var Z=w[J],$=Z.x,ee=Z.z;w[K]=new o($,-h,ee),b[K]=new o(0,-1,0),C[K++]=new g($*Y+.5,.5-ee*Y);var te=w[J+Q];$=te.x,ee=te.z,w[K]=new o($,h,ee),b[K]=new o(0,1,0),C[K++]=new g($*q+.5,ee*q+.5)}for(var re=_+1,ne=_+2,ie=ne+1,ae=0;ae<a;++ae){var oe=2*ae,se=ae===a-1?0:oe+2;m[S++]=_,m[S++]=ne+se,m[S++]=ne+oe,m[S++]=re,m[S++]=ie+oe,m[S++]=ie+se}var le=u.bounds,ue=Math.max(r,n);return le.min.setValue(-ue,-h,-ue),le.max.setValue(ue,h,ue),t._initialize(u,w,b,C,m,l),u},t.createTorus=function(e,r,n,i,a,s,l){void 0===r&&(r=.5),void 0===n&&(n=.1),void 0===i&&(i=30),void 0===a&&(a=30),void 0===s&&(s=360),void 0===l&&(l=!0);var u=new en(e),c=((i=Math.floor(i))+1)*((a=Math.floor(a))+1),h=i*a,d=t._generateIndices(e,c,6*h),_=new Array(c),f=new Array(c),p=new Array(c);s=s/180*Math.PI;for(var v=0,m=0;m<=i;m++)for(var y=0;y<=a;y++){var x=y/a*s,T=m/i*Math.PI*2,w=Math.cos(T),b=Math.sin(T),C=Math.cos(x),S=Math.sin(x),M=new o((r+n*w)*C,(r+n*w)*S,n*b);_[v]=M;var A=r*C,P=r*S;f[v]=new o(M.x-A,M.y-P,M.z).normalize(),p[v++]=new g(y/a,m/i)}v=0;for(var F=1;F<=i;F++)for(var E=1;E<=a;E++){var R=(a+1)*F+E-1,L=(a+1)*(F-1)+E-1,B=(a+1)*(F-1)+E,D=(a+1)*F+E;d[v++]=R,d[v++]=L,d[v++]=D,d[v++]=L,d[v++]=B,d[v++]=D}var I=u.bounds,O=r+n;return I.min.setValue(-O,-O,-n),I.max.setValue(O,O,n),t._initialize(u,_,f,p,d,l),u},t.createCone=function(e,r,n,i,a,s){void 0===r&&(r=.5),void 0===n&&(n=2),void 0===i&&(i=20),void 0===a&&(a=1),void 0===s&&(s=!0);for(var l=new en(e),u=(i=Math.floor(i))+1,c=.5*n,h=n/(a=Math.floor(a)),d=u*(a+1),_=i*a,f=d+1+i,p=t._generateIndices(e,f,6*_+3*i),v=1/u,m=1/i,y=1/a,x=new Array(f),T=new Array(f),w=new Array(f),b=0,C=Math.PI,S=2*Math.PI,M=r/n,A=0;A<d;++A){var P=A*v|0,F=A%u*m,E=P*y,R=C+F*S,L=Math.sin(R),B=Math.cos(R),D=r-P*r,I=D*L,O=P*h-c,z=D*B;x[A]=new o(I,O,z),T[A]=new o(L,M,B),w[A]=new g(F,1-E)}for(var V=0;V<_;++V){var N=(V*m|0)*u+V%i,U=N+1,k=N+u,G=k+1;p[b++]=U,p[b++]=k,p[b++]=N,p[b++]=U,p[b++]=G,p[b++]=k}x[d]=new o(0,-c,0),T[d]=new o(0,-1,0),w[d]=new g(.5,.5);for(var H=d+1,W=1/(2*r),j=0;j<i;++j){var X=x[j],K=X.x,q=X.z;x[H]=new o(K,-c,q),T[H]=new o(0,-1,0),w[H++]=new g(K*W+.5,.5-q*W)}for(var Y=d+1,Q=0;Q<i;++Q){var J=Q,Z=Q===i-1?0:J+1;p[b++]=d,p[b++]=Y+Z,p[b++]=Y+J}var $=l.bounds;return $.min.setValue(-r,-c,-r),$.max.setValue(r,c,r),t._initialize(l,x,T,w,p,s),l},t.createCapsule=function(e,r,n,i,a,s){void 0===r&&(r=.5),void 0===n&&(n=2),void 0===i&&(i=6),void 0===a&&(a=1),void 0===s&&(s=!0);for(var l=new en(e),u=(i=Math.max(2,Math.floor(i)))+1,c=.5*n,h=n/(a=Math.floor(a)),d=u*(a+1),_=i*a,f=u*u,p=i*i,v=d+2*f,m=t._generateIndices(e,v,6*(_+2*p)),y=1/u,x=1/i,T=1/a,w=Math.PI,b=2*Math.PI,C=new Array(v),S=new Array(v),M=new Array(v),A=0,P=0;P<d;++P){var F=P*y|0,E=P%u*x,R=F*T,L=w+E*b,B=Math.sin(L),D=Math.cos(L);C[P]=new o(r*B,F*h-c,r*D),S[P]=new o(B,0,D),M[P]=new g(E,1-R)}for(var I=0;I<_;++I){var O=(I*x|0)*u+I%i,z=O+1,V=O+u,N=V+1;m[A++]=z,m[A++]=V,m[A++]=O,m[A++]=z,m[A++]=N,m[A++]=V}t._createCapsuleCap(r,n,i,b,d,1,C,S,M,m,A),t._createCapsuleCap(r,n,i,-b,d+f,-1,C,S,M,m,A+6*p);var U=l.bounds;return U.min.setValue(-r,-r-c,-r),U.max.setValue(r,r+c,r),t._initialize(l,C,S,M,m,s),l},t._initialize=function(e,t,r,n,i,a){e.setPositions(t),e.setNormals(r),e.setUVs(n),e.setIndices(i),e.uploadData(a),e.addSubMesh(0,i.length)},t._generateIndices=function(t,r,n){var i=null;if(r>65535){if(!t._hardwareRenderer.canIUse(e.GLCapabilityType.elementIndexUint))throw Error("The vertex count is over limit.");i=new Uint32Array(n)}else i=new Uint16Array(n);return i},t._createCapsuleCap=function(e,t,r,n,i,a,s,l,u,c,h){for(var d=r+1,_=.5*t*a,f=d*d,p=r*r,v=1/d,m=1/r,y=0;y<f;++y){var x=y%d*m,T=(y*v|0)*m,w=x*n,b=T*Math.PI/2,C=Math.sin(b),S=-e*Math.cos(w)*C,M=e*Math.cos(b)*a+_,A=e*Math.sin(w)*C,P=y+i;s[P]=new o(S,M,A),l[P]=new o(S,M-_,A),u[P]=new g(x,T)}for(var F=0;F<p;++F){var E=(F*m|0)*d+F%r+i,R=E+1,L=E+d,B=L+1;c[h++]=R,c[h++]=E,c[h++]=B,c[h++]=E,c[h++]=L,c[h++]=B}},t}(),yn=function(e){function t(){return e.apply(this,arguments)||this}E(t,e);var r=t.prototype;return r.setVertexElements=function(e){this._setVertexElements(e)},r.setVertexBufferBinding=function(e,t,r){void 0===t&&(t=0),void 0===r&&(r=0);var n=e,i=void 0!==n.buffer;i||(n=new Kr(e,t));var a=this._vertexBufferBindings;a.length<=r&&(a.length=r+1),this._setVertexBufferBinding(i?t:r,n)},r.setVertexBufferBindings=function(e,t){void 0===t&&(t=0);var r=this._vertexBufferBindings,n=e.length,i=t+n;r.length<i&&(r.length=i);for(var a=0;a<n;a++)this._setVertexBufferBinding(t+a,e[a])},r.setIndexBufferBinding=function(e,t){var r=e;r&&(void 0!==r.buffer||(r=new Wr(e,t))),this._setIndexBufferBinding(r)},A(t,[{key:"instanceCount",get:function(){return this._instanceCount},set:function(e){this._instanceCount=e}},{key:"vertexBufferBindings",get:function(){return this._vertexBufferBindings}},{key:"indexBufferBinding",get:function(){return this._indexBufferBinding}},{key:"vertexElements",get:function(){return this._vertexElements}}]),t}(Xr),xn=function(e,t,r,n){if(void 0===r&&(r=null),void 0===n&&(n=null),this.weight=void 0,this.deltaPositions=void 0,this.deltaNormals=void 0,this.deltaTangents=void 0,r&&r.length!==t.length)throw"deltaNormals length must same with deltaPositions length.";if(n&&n.length!==t.length)throw"deltaTangents length must same with deltaPositions length.";this.weight=e,this.deltaPositions=t,this.deltaNormals=r,this.deltaTangents=n},Tn=function(){function e(e){this.name=void 0,this._useBlendShapeNormal=!0,this._useBlendShapeTangent=!0,this._layoutChangeManager=new Ze,this._dataChangeManager=new Ze,this._frames=[],this.name=e}var t=e.prototype;return t.addFrame=function(e,t,r,n){if("number"==typeof e){var i=new xn(e,t,r,n);return this._addFrame(i),i}this._addFrame(e)},t.clearFrames=function(){this._frames.length=0,this._updateUseNormalAndTangent(!0,!0),this._dataChangeManager.dispatch()},t._addLayoutChangeFlag=function(e){this._layoutChangeManager.addFlag(e)},t._addDataDirtyFlag=function(e){this._dataChangeManager.addFlag(e)},t._createSubDataDirtyFlag=function(){return this._dataChangeManager.createFlag(Qe)},t._addFrame=function(e){var t=this._frames,r=t.length;if(r>0&&e.deltaPositions.length!==t[r-1].deltaPositions.length)throw"Frame's deltaPositions length must same with before frame deltaPositions length.";this._frames.push(e),this._updateUseNormalAndTangent(!!e.deltaNormals,!!e.deltaTangents),this._dataChangeManager.dispatch()},t._updateUseNormalAndTangent=function(e,t){var r=this._useBlendShapeNormal&&e,n=this._useBlendShapeTangent&&t;this._useBlendShapeNormal===r&&this._useBlendShapeTangent===n||(this._useBlendShapeNormal=r,this._useBlendShapeTangent=n,this._layoutChangeManager.dispatch(this))},A(e,[{key:"frames",get:function(){return this._frames}}]),e}(),wn=function(){function t(e){this._subMeshPool=new vr(jr),this._batchedQueue=[],this._meshes=[],this._meshCount=1,this._vertexBuffers=[],this._indiceBuffers=[],this._vertices=void 0,this._indices=void 0,this._flushId=0,this._vertexCount=0,this._elementCount=0;var r=t.MAX_VERTEX_COUNT;this._vertices=new Float32Array(9*r),this._indices=new Uint16Array(3*r);for(var n=this._meshes,i=this._meshCount,a=0;a<i;a++)n[a]=this._createMesh(e,a)}var r=t.prototype;return r.drawElement=function(e){var r=e.positions.length;this._vertexCount+r>t.MAX_VERTEX_COUNT&&this.flush(e.camera.engine),this._vertexCount+=r,this._batchedQueue[this._elementCount++]=e},r.flush=function(e){var r=this._batchedQueue;0!==r.length&&(this._updateData(e),this.drawBatches(e),t._canUploadSameBuffer||this._flushId++,r.length=0,this._subMeshPool.resetPool(),this._vertexCount=0,this._elementCount=0)},r.clear=function(){this._flushId=0,this._vertexCount=0,this._elementCount=0,this._batchedQueue.length=0},r.destroy=function(){this._batchedQueue=null;for(var e=this._meshes,t=this._vertexBuffers,r=this._indiceBuffers,n=0,i=e.length;n<i;++n)e[n].destroy();this._meshes=null;for(var a=0,o=t.length;a<o;++a)t[a].destroy();this._vertexBuffers=null;for(var s=0,l=r.length;s<l;++s)r[s].destroy();this._indiceBuffers=null},r._createMesh=function(r,n){var i=t.MAX_VERTEX_COUNT,a=new yn(r,"BufferMesh"+n),o=[],s=this.createVertexElements(o);return this._vertexBuffers[n]=new kr(r,e.BufferBindFlag.VertexBuffer,4*i*s,e.BufferUsage.Dynamic),this._indiceBuffers[n]=new kr(r,e.BufferBindFlag.IndexBuffer,3*i,e.BufferUsage.Dynamic),a.setVertexBufferBinding(this._vertexBuffers[n],s),a.setIndexBufferBinding(this._indiceBuffers[n],e.IndexFormat.UInt16),a.setVertexElements(o),a},r._updateData=function(e){var r=this._meshes,n=this._flushId;!t._canUploadSameBuffer&&this._meshCount<=n&&(this._meshCount++,r[n]=this._createMesh(e,n));var i=this._batchedQueue,a=this._vertices,o=this._indices,s=r[n];s.clearSubMesh();for(var l=0,u=0,c=0,h=0,d=0,_=0,f=null,p=0,g=i.length;p<g;p++){var v=i[p];l=this.updateVertices(v,a,l);for(var m=v.triangles,y=m.length,x=0;x<y;x++)o[u++]=m[x]+d;d+=v.positions.length,null===f||this.canBatch(f,v)?h+=y:(s.addSubMesh(this._getSubMeshFromPool(c,h)),c+=h,h=y,i[_++]=f),f=v}s.addSubMesh(this._getSubMeshFromPool(c,h)),i[_]=f,this._vertexBuffers[n].setData(a,0,0,l),this._indiceBuffers[n].setData(o,0,0,u)},r._getSubMeshFromPool=function(t,r){var n=this._subMeshPool.getFromPool();return n.start=t,n.count=r,n.topology=e.MeshTopology.Triangles,n},t}();wn.MAX_VERTEX_COUNT=4096,wn._canUploadSameBuffer=!0;var bn,Cn,Sn=function(t){function r(){return t.apply(this,arguments)||this}E(r,t);var n=r.prototype;return n.createVertexElements=function(t){return t[0]=new Nr("POSITION",0,e.VertexElementFormat.Vector3,0),t[1]=new Nr("TEXCOORD_0",12,e.VertexElementFormat.Vector2,0),20},n.canBatch=function(e,t){if(e.isAdd!==t.isAdd)return!1;var r=e.component.shaderData,n=t.component.shaderData,i=Ir._textureProperty,a=Ir._alphaCutoffProperty;return r.getTexture(i)===n.getTexture(i)&&r.getTexture(a)===n.getTexture(a)},n.updateVertices=function(e,t,r){for(var n=e.positions,i=e.uv,a=n.length,o=0;o<a;o++){var s=n[o],l=i[o];t[r++]=s.x,t[r++]=s.y,t[r++]=s.z,t[r++]=l.x,t[r++]=l.y}return r},n.drawBatches=function(t){for(var r=this._meshes[this._flushId],n=r.subMeshes,i=this._batchedQueue,a=0,o=n.length;a<o;a++){var s=n[a],l=i[a];if(!s||!l)return;var u=l.component,c=l.material,h=zt._compileMacros;we.unionCollection(u._globalShaderMacro,c.shaderData._macroCollection,h);var d=c.renderState.stencilState,_=l.isAdd?e.StencilOperation.IncrementSaturate:e.StencilOperation.DecrementSaturate;d.passOperationFront=_,d.passOperationBack=_;var f=c.shader._getShaderProgram(t,h);if(!f.isValid)return;var p=l.camera;f.bind(),f.groupingOtherUniformBlock(),f.uploadAll(f.sceneUniformBlock,p.scene.shaderData),f.uploadAll(f.cameraUniformBlock,p.shaderData),f.uploadAll(f.rendererUniformBlock,u.shaderData),f.uploadAll(f.materialUniformBlock,c.shaderData),c.renderState._apply(t,!1),t._hardwareRenderer.drawPrimitive(r,s,f)}},r}(wn),Mn=function(){function t(e){this._batcher=void 0,this._preMaskLayer=0,this._batcher=new Sn(e)}var r=t.prototype;return r.clear=function(){this._preMaskLayer=0,this._batcher.clear()},r.preRender=function(t,r){r.maskInteraction!==e.SpriteMaskInteraction.None&&(this._batcher.clear(),this._processMasksDiff(t,r),this._batcher.flush(t.engine))},r.postRender=function(t){t.maskInteraction!==e.SpriteMaskInteraction.None&&(this._preMaskLayer=t.maskLayer)},r.destroy=function(){this._batcher.destroy(),this._batcher=null},r._processMasksDiff=function(e,t){var r=this._preMaskLayer,n=t.maskLayer;if(r!==n)for(var i=e._renderPipeline._allSpriteMasks,a=r&n,o=n&~r,s=r&~n,l=i._elements,u=0,c=i.length;u<c;u++){var h=l[u],d=h.influenceLayers;if(!(d&a))if(d&o){var _=h._maskElement;_.isAdd=!0,this._batcher.drawElement(_)}else if(d&s){var f=h._maskElement;f.isAdd=!1,this._batcher.drawElement(f)}}},t}();e.BackgroundMode=void 0,(bn=e.BackgroundMode||(e.BackgroundMode={}))[bn.SolidColor=0]="SolidColor",bn[bn.Sky=1]="Sky",bn[bn.Texture=2]="Texture",e.BackgroundTextureFillMode=void 0,(Cn=e.BackgroundTextureFillMode||(e.BackgroundTextureFillMode={}))[Cn.AspectFitWidth=0]="AspectFitWidth",Cn[Cn.AspectFitHeight=1]="AspectFitHeight",Cn[Cn.Fill=2]="Fill";var An,Pn=function(){this.material=void 0,this.mesh=void 0,this._matrix=new f},Fn=function(){function t(t){this._engine=t,this.mode=e.BackgroundMode.SolidColor,this.solidColor=new T(.25,.25,.25,1),this.sky=new Pn,this._textureFillMode=e.BackgroundTextureFillMode.AspectFitHeight,this._mesh=void 0,this._texture=null,this._mesh=this._createPlane(t)}var r=t.prototype;return r._resizeBackgroundTexture=function(){if(this._texture){var t=this._engine.canvas,r=t.width,n=t.height,i=this._mesh,a=i.getPositions();switch(this._textureFillMode){case e.BackgroundTextureFillMode.Fill:a[0].setValue(-1,-1,1),a[1].setValue(1,-1,1),a[2].setValue(-1,1,1),a[3].setValue(1,1,1);break;case e.BackgroundTextureFillMode.AspectFitWidth:var o=this._texture.height*r/this.texture.width/n;a[0].setValue(-1,-o,1),a[1].setValue(1,-o,1),a[2].setValue(-1,o,1),a[3].setValue(1,o,1);break;case e.BackgroundTextureFillMode.AspectFitHeight:var s=this._texture.width*n/this.texture.height/r;a[0].setValue(-s,-1,1),a[1].setValue(s,-1,1),a[2].setValue(-s,1,1),a[3].setValue(s,1,1)}i.setPositions(a),i.uploadData(!1)}},r._createPlane=function(e){var t=new en(e);t.isGCIgnored=!0;for(var r=new Uint8Array([1,2,0,1,3,2]),n=new Array(4),i=new Array(4),a=0;a<4;++a)n[a]=new o,i[a]=new g(a%2,1-(.5*a|0));return t.setPositions(n),t.setUVs(i),t.setIndices(r),t.uploadData(!1),t.addSubMesh(0,r.length),t},A(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture!==e&&(this._texture=e,this._engine._backgroundTextureMaterial.shaderData.setTexture("u_baseTexture",e))}},{key:"textureFillMode",get:function(){return this._textureFillMode},set:function(e){e!==this._textureFillMode&&(this._textureFillMode=e,this._resizeBackgroundTexture())}}]),t}();e.DiffuseMode=void 0,(An=e.DiffuseMode||(e.DiffuseMode={}))[An.SolidColor=0]="SolidColor",An[An.SphericalHarmonics=1]="SphericalHarmonics";var En=function(){function t(){this._diffuseSphericalHarmonics=void 0,this._diffuseSolidColor=new T(.212,.227,.259),this._diffuseIntensity=1,this._specularReflection=void 0,this._specularIntensity=1,this._diffuseMode=e.DiffuseMode.SolidColor,this._shArray=new Float32Array(27),this._scene=void 0,this._specularTextureDecodeRGBM=!1}var r=t.prototype;return r._setScene=function(e){this._scene=e,e&&(e.shaderData.setColor(t._diffuseColorProperty,this._diffuseSolidColor),this.diffuseMode=this._diffuseMode,this.diffuseSphericalHarmonics=this._diffuseSphericalHarmonics,this.diffuseIntensity=this._diffuseIntensity,this.specularTexture=this._specularReflection,this.specularIntensity=this._specularIntensity,this.specularTextureDecodeRGBM=this._specularTextureDecodeRGBM)},r._preComputeSH=function(e,t){var r=e.coefficients;return t[0]=.886227*r[0],t[1]=.886227*r[1],t[2]=.886227*r[2],t[3]=-1.023327*r[3],t[4]=-1.023327*r[4],t[5]=-1.023327*r[5],t[6]=1.023327*r[6],t[7]=1.023327*r[7],t[8]=1.023327*r[8],t[9]=-1.023327*r[9],t[10]=-1.023327*r[10],t[11]=-1.023327*r[11],t[12]=.858086*r[12],t[13]=.858086*r[13],t[14]=.858086*r[14],t[15]=-.858086*r[15],t[16]=-.858086*r[16],t[17]=-.858086*r[17],t[18]=.247708*r[18],t[19]=.247708*r[19],t[20]=.247708*r[20],t[21]=-.858086*r[21],t[22]=-.858086*r[22],t[23]=-.858086*r[23],t[24]=.429042*r[24],t[25]=.429042*r[25],t[26]=.429042*r[26],t},A(t,[{key:"specularTextureDecodeRGBM",get:function(){return this._specularTextureDecodeRGBM},set:function(e){this._specularTextureDecodeRGBM=e,this._scene&&(e?this._scene.shaderData.enableMacro(t._decodeRGBMMacro):this._scene.shaderData.disableMacro(t._decodeRGBMMacro))}},{key:"diffuseMode",get:function(){return this._diffuseMode},set:function(r){this._diffuseMode=r,this._scene&&(r===e.DiffuseMode.SphericalHarmonics?this._scene.shaderData.enableMacro(t._shMacro):this._scene.shaderData.disableMacro(t._shMacro))}},{key:"diffuseSolidColor",get:function(){return this._diffuseSolidColor},set:function(e){e!==this._diffuseSolidColor&&e.cloneTo(this._diffuseSolidColor)}},{key:"diffuseSphericalHarmonics",get:function(){return this._diffuseSphericalHarmonics},set:function(e){this._diffuseSphericalHarmonics=e,this._scene&&e&&this._scene.shaderData.setFloatArray(t._diffuseSHProperty,this._preComputeSH(e,this._shArray))}},{key:"diffuseIntensity",get:function(){return this._diffuseIntensity},set:function(e){this._diffuseIntensity=e,this._scene&&this._scene.shaderData.setFloat(t._diffuseIntensityProperty,e)}},{key:"specularTexture",get:function(){return this._specularReflection},set:function(e){if(this._specularReflection=e,this._scene){var r=this._scene.shaderData;e?(r.setTexture(t._specularTextureProperty,e),r.setFloat(t._mipLevelProperty,this._specularReflection.mipmapCount-1),r.enableMacro(t._specularMacro)):r.disableMacro(t._specularMacro)}}},{key:"specularIntensity",get:function(){return this._specularIntensity},set:function(e){this._specularIntensity=e,this._scene&&this._scene.shaderData.setFloat(t._specularIntensityProperty,e)}}]),t}();En._shMacro=zt.getMacroByName("O3_USE_SH"),En._specularMacro=zt.getMacroByName("O3_USE_SPECULAR_ENV"),En._decodeRGBMMacro=zt.getMacroByName("O3_DECODE_ENV_RGBM"),En._diffuseColorProperty=zt.getPropertyByName("u_envMapLight.diffuse"),En._diffuseSHProperty=zt.getPropertyByName("u_env_sh"),En._diffuseIntensityProperty=zt.getPropertyByName("u_envMapLight.diffuseIntensity"),En._specularTextureProperty=zt.getPropertyByName("u_env_specularSampler"),En._specularIntensityProperty=zt.getPropertyByName("u_envMapLight.specularIntensity"),En._mipLevelProperty=zt.getPropertyByName("u_envMapLight.mipMapLevel");var Rn=function(){function e(){}var t=e.prototype;return t.preUpdate=function(e){},t.postUpdate=function(e){},t.preRender=function(e,t){},t.postRender=function(e,t){},t.destroy=function(e){},e}(),Ln=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this)._viewMat=void 0,t._inverseViewMat=void 0,t}E(t,e);var r=t.prototype;return r._onEnable=function(){this.scene.findFeature(On).attachRenderLight(this)},r._onDisable=function(){this.scene.findFeature(On).detachRenderLight(this)},A(t,[{key:"viewMatrix",get:function(){return this._viewMat||(this._viewMat=new f),f.invert(this.entity.transform.worldMatrix,this._viewMat),this._viewMat}},{key:"inverseViewMatrix",get:function(){return this._inverseViewMat||(this._inverseViewMat=new f),f.invert(this.viewMatrix,this._inverseViewMat),this._inverseViewMat}}]),t}(Je);Ln._maxLight=10;var Bn=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).color=new T(1,1,1,1),t.intensity=1,t._forward=new o,t._lightColor=new T(1,1,1,1),t._reverseDirection=new o,t}return E(t,e),t._updateShaderData=function(e){var r=t._combinedData;e.setFloatArray(t._colorProperty,r.color),e.setFloatArray(t._directionProperty,r.direction)},t.prototype._appendData=function(e){var r=3*e,n=3*e,i=this.lightColor,a=this.direction,o=t._combinedData;o.color[r]=i.r,o.color[r+1]=i.g,o.color[r+2]=i.b,o.direction[n]=a.x,o.direction[n+1]=a.y,o.direction[n+2]=a.z},A(t,[{key:"direction",get:function(){return this.entity.transform.getWorldForward(this._forward),this._forward}},{key:"lightColor",get:function(){return this._lightColor.r=this.color.r*this.intensity,this._lightColor.g=this.color.g*this.intensity,this._lightColor.b=this.color.b*this.intensity,this._lightColor.a=this.color.a*this.intensity,this._lightColor}},{key:"reverseDirection",get:function(){return o.scale(this.direction,-1,this._reverseDirection),this._reverseDirection}}]),t}(Ln);Bn._colorProperty=zt.getPropertyByName("u_directLightColor"),Bn._directionProperty=zt.getPropertyByName("u_directLightDirection"),Bn._combinedData={color:new Float32Array(3*Ln._maxLight),direction:new Float32Array(3*Ln._maxLight)};var Dn=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).color=new T(1,1,1,1),t.intensity=1,t.distance=100,t._lightColor=new T(1,1,1,1),t}return E(t,e),t._updateShaderData=function(e){var r=t._combinedData;e.setFloatArray(t._colorProperty,r.color),e.setFloatArray(t._positionProperty,r.position),e.setFloatArray(t._distanceProperty,r.distance)},t.prototype._appendData=function(e){var r=3*e,n=3*e,i=e,a=this.lightColor,o=this.position,s=t._combinedData;s.color[r]=a.r,s.color[r+1]=a.g,s.color[r+2]=a.b,s.position[n]=o.x,s.position[n+1]=o.y,s.position[n+2]=o.z,s.distance[i]=this.distance},A(t,[{key:"position",get:function(){return this.entity.transform.worldPosition}},{key:"lightColor",get:function(){return this._lightColor.r=this.color.r*this.intensity,this._lightColor.g=this.color.g*this.intensity,this._lightColor.b=this.color.b*this.intensity,this._lightColor.a=this.color.a*this.intensity,this._lightColor}}]),t}(Ln);Dn._colorProperty=zt.getPropertyByName("u_pointLightColor"),Dn._positionProperty=zt.getPropertyByName("u_pointLightPosition"),Dn._distanceProperty=zt.getPropertyByName("u_pointLightDistance"),Dn._combinedData={color:new Float32Array(3*Ln._maxLight),position:new Float32Array(3*Ln._maxLight),distance:new Float32Array(Ln._maxLight)};var In=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).color=new T(1,1,1,1),t.intensity=1,t.distance=100,t.angle=Math.PI/6,t.penumbra=Math.PI/12,t._forward=new o,t._lightColor=new T(1,1,1,1),t._inverseDirection=new o,t}return E(t,e),t._updateShaderData=function(e){var r=t._combinedData;e.setFloatArray(t._colorProperty,r.color),e.setFloatArray(t._positionProperty,r.position),e.setFloatArray(t._directionProperty,r.direction),e.setFloatArray(t._distanceProperty,r.distance),e.setFloatArray(t._angleCosProperty,r.angleCos),e.setFloatArray(t._penumbraCosProperty,r.penumbraCos)},t.prototype._appendData=function(e){var r=3*e,n=3*e,i=3*e,a=e,o=e,s=e,l=this.lightColor,u=this.position,c=this.direction,h=t._combinedData;h.color[r]=l.r,h.color[r+1]=l.g,h.color[r+2]=l.b,h.position[n]=u.x,h.position[n+1]=u.y,h.position[n+2]=u.z,h.direction[i]=c.x,h.direction[i+1]=c.y,h.direction[i+2]=c.z,h.distance[a]=this.distance,h.angleCos[s]=Math.cos(this.angle),h.penumbraCos[o]=Math.cos(this.angle+this.penumbra)},A(t,[{key:"position",get:function(){return this.entity.transform.worldPosition}},{key:"direction",get:function(){return this.entity.transform.getWorldForward(this._forward),this._forward}},{key:"reverseDirection",get:function(){return o.scale(this.direction,-1,this._inverseDirection),this._inverseDirection}},{key:"lightColor",get:function(){return this._lightColor.r=this.color.r*this.intensity,this._lightColor.g=this.color.g*this.intensity,this._lightColor.b=this.color.b*this.intensity,this._lightColor.a=this.color.a*this.intensity,this._lightColor}}]),t}(Ln);In._colorProperty=zt.getPropertyByName("u_spotLightColor"),In._positionProperty=zt.getPropertyByName("u_spotLightPosition"),In._directionProperty=zt.getPropertyByName("u_spotLightDirection"),In._distanceProperty=zt.getPropertyByName("u_spotLightDistance"),In._angleCosProperty=zt.getPropertyByName("u_spotLightAngleCos"),In._penumbraCosProperty=zt.getPropertyByName("u_spotLightPenumbraCos"),In._combinedData={color:new Float32Array(3*Ln._maxLight),position:new Float32Array(3*Ln._maxLight),direction:new Float32Array(3*Ln._maxLight),distance:new Float32Array(Ln._maxLight),angleCos:new Float32Array(Ln._maxLight),penumbraCos:new Float32Array(Ln._maxLight)};var On=function(e){function t(){var t;return(t=e.call(this)||this).visibleLights=void 0,t.visibleLights=[],t}E(t,e);var r=t.prototype;return r.attachRenderLight=function(e){-1==this.visibleLights.indexOf(e)?this.visibleLights.push(e):re.warn("Light already attached.")},r.detachRenderLight=function(e){var t=this.visibleLights.indexOf(e);-1!=t&&this.visibleLights.splice(t,1)},r._updateShaderData=function(e){for(var t=0,r=0,n=0,i=this.visibleLights,a=0,o=i.length;a<o;a++){var s=i[a];s instanceof Bn?s._appendData(t++):s instanceof Dn?s._appendData(r++):s instanceof In&&s._appendData(n++)}t?(Bn._updateShaderData(e),e.enableMacro("O3_DIRECT_LIGHT_COUNT",t.toString())):e.disableMacro("O3_DIRECT_LIGHT_COUNT"),r?(Dn._updateShaderData(e),e.enableMacro("O3_POINT_LIGHT_COUNT",r.toString())):e.disableMacro("O3_POINT_LIGHT_COUNT"),n?(In._updateShaderData(e),e.enableMacro("O3_SPOT_LIGHT_COUNT",n.toString())):e.disableMacro("O3_SPOT_LIGHT_COUNT")},t}(Rn),zn=function(e){function t(r,n){var i;(i=e.call(this,r)||this).name=void 0,i.background=new Fn(i._engine),i.shaderData=new kt(At.Scene),i._activeCameras=[],i._isActiveInEngine=!1,i._globalShaderMacro=new we,i._rootEntities=[],i._ambientLight=void 0,i.features=[],i.name=n||"";var a=i.shaderData;return t.sceneFeatureManager.addObject(O(i)),a._addRefCount(1),i.ambientLight=new En,i}E(t,e);var r=t.prototype;return r.createRootEntity=function(e){var t=new tt(this._engine,e);return this.addRootEntity(t),t},r.addRootEntity=function(e){var t=e._isRoot;t||(e._isRoot=!0,e._removeFromParent());var r=e._scene;r!==this?(r&&t&&r._removeEntity(e),this._rootEntities.push(e),tt._traverseSetOwnerScene(e,this)):t||this._rootEntities.push(e),this._isActiveInEngine?!e._isActiveInHierarchy&&e._isActive&&e._processActive():e._isActiveInHierarchy&&e._processInActive()},r.removeRootEntity=function(e){e._isRoot&&e._scene==this&&(this._removeEntity(e),this._isActiveInEngine&&e._isActiveInHierarchy&&e._processInActive(),tt._traverseSetOwnerScene(e,null))},r.getRootEntity=function(e){return void 0===e&&(e=0),this._rootEntities[e]},r.findEntityByName=function(e){for(var t=this._rootEntities,r=t.length-1;r>=0;r--){var n=t[r];if(n.name===e)return n}for(var i=t.length-1;i>=0;i--){var a=t[i].findByName(e);if(a)return a}return null},r.findEntityByPath=function(e){for(var t=e.split("/").filter(Boolean),r=0,n=this.rootEntitiesCount;r<n;r++){var i=this.getRootEntity(r);if(i.name==t[0]){for(var a=1,o=t.length;a<o&&(i=tt._findChildByName(i,t[a]));++a);return i}}return null},r.destroy=function(){if(!this._destroyed){this._isActiveInEngine&&(this._engine.sceneManager.activeScene=null),t.sceneFeatureManager.callFeatureMethod(this,"destroy",[this]);for(var e=0,r=this.rootEntitiesCount;e<r;e++)this._rootEntities[e].destroy();this._rootEntities.length=0,this._activeCameras.length=0,t.sceneFeatureManager._objects=[],this.shaderData._addRefCount(-1)}},r._attachRenderCamera=function(e){-1===this._activeCameras.indexOf(e)?this._activeCameras.push(e):re.warn("Camera already attached.")},r._detachRenderCamera=function(e){var t=this._activeCameras.indexOf(e);-1!==t&&this._activeCameras.splice(t,1)},r._processActive=function(e){this._isActiveInEngine=e;for(var t=this._rootEntities,r=t.length-1;r>=0;r--){var n=t[r];n._isActive&&(e?n._processActive():n._processInActive())}},r._updateShaderData=function(){we.unionCollection(this.engine._macroCollection,this.shaderData._macroCollection,this._globalShaderMacro),this.findFeature(On)._updateShaderData(this.shaderData)},r._removeEntity=function(e){var t=this._rootEntities;t.splice(t.indexOf(e),1)},t.registerFeature=function(e){t.sceneFeatureManager.registerFeature(e)},r.findFeature=function(e){return t.sceneFeatureManager.findFeature(this,e)},A(t,[{key:"ambientLight",get:function(){return this._ambientLight},set:function(e){if(e){var t=this._ambientLight;t!==e&&(t&&t._setScene(null),e._setScene(this),this._ambientLight=e)}else re.warn("The scene must have one ambient light")}},{key:"rootEntitiesCount",get:function(){return this._rootEntities.length}},{key:"rootEntities",get:function(){return this._rootEntities}}]),t}(Y);zn.sceneFeatureManager=new rt;var Vn=function(){function e(e){this.engine=e,this._activeScene=void 0}var t=e.prototype;return t.loadScene=function(e,t){var r=this;void 0===t&&(t=!0);var n=this.engine.resourceManager.load(e);return n.then((function(e){var n=r._activeScene;r.activeScene=e,n&&t&&n.destroy()})),n},t.mergeScenes=function(e,t){for(var r=e.rootEntities,n=0,i=r.length;n<i;n++)t.addRootEntity(r[n])},A(e,[{key:"activeScene",get:function(){return this._activeScene},set:function(e){var t=this._activeScene;t!==e&&(t&&t._processActive(!1),e&&e._processActive(!0),this._activeScene=e)}}]),e}(),Nn="#define GLSLIFY 1\n#include <common>\n#include <common_vert>\n#include <blendShape_input>\n#include <uv_share>\n#include <color_share>\n#include <normal_share>\n#include <worldpos_share>\n#include <shadow_share>\n#include <fog_share>\nvoid main(){\n#include <begin_position_vert>\n#include <begin_normal_vert>\n#include <blendShape_vert>\n#include <skinning_vert>\n#include <uv_vert>\n#include <color_vert>\n#include <normal_vert>\n#include <worldpos_vert>\n#include <shadow_vert>\n#include <position_vert>\n#include <fog_vert>\n}",Un="#define GLSLIFY 1\n#include <common_vert>\n#include <blendShape_input>\n#include <normal_share>\n#include <shadow_share>\nvoid main(){\n#include <begin_position_vert>\n#include <begin_normal_vert>\n#include <blendShape_vert>\n#include <skinning_vert>\n#include <shadow_vert>\n#include <position_vert>\n}",kn=function(){function e(){}return e.init=function(){zt.create("blinn-phong","#define GLSLIFY 1\n#include <common>\n#include <common_vert>\n#include <blendShape_input>\n#include <uv_share>\n#include <color_share>\n#include <normal_share>\n#include <worldpos_share>\n#include <shadow_share>\n#include <fog_share>\nvoid main(){\n#include <begin_position_vert>\n#include <begin_normal_vert>\n#include <blendShape_vert>\n#include <skinning_vert>\n#include <uv_vert>\n#include <color_vert>\n#include <normal_vert>\n#include <worldpos_vert>\n#include <shadow_vert>\n#include <position_vert>\n#include <fog_vert>\n}","#define GLSLIFY 1\n#include <common>\n#include <common_frag>\n#include <uv_share>\n#include <normal_share>\n#include <color_share>\n#include <worldpos_share>\n#include <light_frag_define>\n#include <mobile_material_frag>\n#include <fog_share>\n#include <normal_get>\nvoid main(){\n#include <begin_mobile_frag>\n#include <begin_viewdir_frag>\n#include <mobile_blinnphong_frag>\ngl_FragColor=emission+ambient+diffuse+specular;gl_FragColor.a=diffuse.a;\n#ifndef OASIS_COLORSPACE_GAMMA\ngl_FragColor=linearToGamma(gl_FragColor);\n#endif\n#include <fog_frag>\n}"),zt.create("pbr",Nn,"#define GLSLIFY 1\n#define IS_METALLIC_WORKFLOW\n#include <common>\n#include <common_frag>\n#include <fog_share>\n#include <uv_share>\n#include <normal_share>\n#include <color_share>\n#include <worldpos_share>\n#include <light_frag_define>\n#include <pbr_frag_define>\n#include <pbr_helper>\nvoid main(){\n#include <pbr_frag>\n#include <fog_frag>\n}"),zt.create("pbr-specular",Nn,"#define GLSLIFY 1\n#include <common>\n#include <common_frag>\n#include <fog_share>\n#include <uv_share>\n#include <normal_share>\n#include <color_share>\n#include <worldpos_share>\n#include <light_frag_define>\n#include <pbr_frag_define>\n#include <pbr_helper>\nvoid main(){\n#include <pbr_frag>\n#include <fog_frag>\n}"),zt.create("unlit","#define GLSLIFY 1\n#include <common_vert>\n#include <blendShape_input>\n#include <uv_share>\n#include <fog_share>\nvoid main(){\n#include <begin_position_vert>\n#include <blendShape_vert>\n#include <skinning_vert>\n#include <uv_vert>\n#include <position_vert>\n#include <fog_vert>\n}","#define GLSLIFY 1\n#include <common>\n#include <uv_share>\n#include <fog_share>\nuniform vec4 u_baseColor;uniform float u_alphaCutoff;\n#ifdef O3_BASE_TEXTURE\nuniform sampler2D u_baseTexture;\n#endif\nvoid main(){vec4 baseColor=u_baseColor;\n#ifdef O3_BASE_TEXTURE\nvec4 textureColor=texture2D(u_baseTexture,v_uv);\n#ifndef OASIS_COLORSPACE_GAMMA\ntextureColor=gammaToLinear(textureColor);\n#endif\nbaseColor*=textureColor;\n#endif\n#ifdef ALPHA_CUTOFF\nif(baseColor.a<u_alphaCutoff){discard;}\n#endif\n#ifndef OASIS_COLORSPACE_GAMMA\nbaseColor=linearToGamma(baseColor);\n#endif\ngl_FragColor=baseColor;\n#include <fog_frag>\n}"),zt.create("shadow-map",Un,"#define GLSLIFY 1\nvec4 pack(float depth){const vec4 bitShift=vec4(1.0,256.0,256.0*256.0,256.0*256.0*256.0);const vec4 bitMask=vec4(1.0/256.0,1.0/256.0,1.0/256.0,0.0);vec4 rgbaDepth=fract(depth*bitShift);rgbaDepth-=rgbaDepth.gbaa*bitMask;return rgbaDepth;}void main(){gl_FragColor=pack(gl_FragCoord.z);}"),zt.create("shadow",Un,"#define GLSLIFY 1\n#ifdef O3_SHADOW_MAP_COUNT\nuniform float u_shadowBias[O3_SHADOW_MAP_COUNT];uniform float u_shadowIntensity[O3_SHADOW_MAP_COUNT];uniform float u_shadowRadius[O3_SHADOW_MAP_COUNT];uniform vec2 u_shadowMapSize[O3_SHADOW_MAP_COUNT];uniform sampler2D u_shadowMaps[O3_SHADOW_MAP_COUNT];varying vec4 v_PositionFromLight[O3_SHADOW_MAP_COUNT];const vec4 bitShift=vec4(1.0,1.0/256.0,1.0/(256.0*256.0),1.0/(256.0*256.0*256.0));float unpack(const in vec4 rgbaDepth){return dot(rgbaDepth,bitShift);}float getVisibility(vec4 positionFromLight,const in sampler2D shadowMap,vec2 mapSize,float intensity,float bias,float radius){vec3 shadowCoord=(positionFromLight.xyz/positionFromLight.w)/2.0+0.5;float filterX=step(0.0,shadowCoord.x)*(1.0-step(1.0,shadowCoord.x));float filterY=step(0.0,shadowCoord.y)*(1.0-step(1.0,shadowCoord.y));shadowCoord.z-=bias;vec2 texelSize=vec2(1.0)/mapSize;float visibility=0.0;for(float y=-1.0;y<=1.0;y+=1.0){for(float x=-1.0;x<=1.0;x+=1.0){vec2 uv=shadowCoord.xy+texelSize*vec2(x,y)*radius;vec4 rgbaDepth=texture2D(shadowMap,uv);float depth=unpack(rgbaDepth);visibility+=step(depth,shadowCoord.z)*intensity;}}visibility*=(1.0/9.0);return visibility*filterX*filterY;}\n#endif\nvoid main(){vec4 shadowColor=vec4(1.0,1.0,1.0,1.0);\n#ifdef O3_SHADOW_MAP_COUNT\nfloat visibility=1.0;\n#if (O3_SHADOW_MAP_COUNT == 1)\nvisibility-=getVisibility(v_PositionFromLight[0],u_shadowMaps[0],u_shadowMapSize[0],u_shadowIntensity[0],u_shadowBias[0],u_shadowRadius[0]);\n#elif (O3_SHADOW_MAP_COUNT == 2)\nvisibility-=getVisibility(v_PositionFromLight[0],u_shadowMaps[0],u_shadowMapSize[0],u_shadowIntensity[0],u_shadowBias[0],u_shadowRadius[0]);visibility-=getVisibility(v_PositionFromLight[1],u_shadowMaps[1],u_shadowMapSize[1],u_shadowIntensity[1],u_shadowBias[1],u_shadowRadius[1]);\n#elif (O3_SHADOW_MAP_COUNT == 3)\nvisibility-=getVisibility(v_PositionFromLight[0],u_shadowMaps[0],u_shadowMapSize[0],u_shadowIntensity[0],u_shadowBias[0],u_shadowRadius[0]);visibility-=getVisibility(v_PositionFromLight[1],u_shadowMaps[1],u_shadowMapSize[1],u_shadowIntensity[1],u_shadowBias[1],u_shadowRadius[1]);visibility-=getVisibility(v_PositionFromLight[2],u_shadowMaps[2],u_shadowMapSize[2],u_shadowIntensity[2],u_shadowBias[2],u_shadowRadius[2]);\n#endif\nvisibility=clamp(visibility,0.0,1.0);shadowColor=vec4(visibility,visibility,visibility,1.0);\n#endif\ngl_FragColor=shadowColor;}"),zt.create("skybox","#define GLSLIFY 1\n#include <common_vert>\nuniform mat4 u_mvpNoscale;varying vec3 v_cubeUV;void main(){v_cubeUV=POSITION.xyz;gl_Position=u_mvpNoscale*vec4(POSITION,1.0);gl_Position.z=gl_Position.w;}","#define GLSLIFY 1\n#include <common>\nuniform samplerCube u_cube;varying vec3 v_cubeUV;uniform vec4 u_cubeDecodeParam;void main(){vec4 textureColor=textureCube(u_cube,v_cubeUV);if(u_cubeDecodeParam.x>0.0){textureColor=RGBMToLinear(textureColor,u_cubeDecodeParam.y);textureColor=linearToGamma(textureColor);}gl_FragColor=textureColor;}"),zt.create("particle-shader","#define GLSLIFY 1\nattribute vec3 a_position;attribute vec3 a_velocity;attribute vec3 a_acceleration;attribute vec4 a_color;attribute vec4 a_lifeAndSize;attribute vec2 a_rotation;attribute vec3 a_uv;attribute vec2 a_normalizedUv;uniform float u_time;uniform bool u_once;uniform mat4 u_MVPMat;varying vec4 v_color;varying float v_lifeLeft;varying vec2 v_uv;\n#ifdef is2d\nuniform mat4 u_viewInvMat;uniform mat4 u_projMat;uniform mat4 u_viewMat;uniform mat4 u_modelMat;\n#endif\nmat2 rotation2d(float angle){float s=sin(angle);float c=cos(angle);return mat2(c,-s,s,c);}void main(){v_color=a_color;v_uv=a_uv.xy;float life=a_lifeAndSize.y;float startTime=a_lifeAndSize.x;float deltaTime=max(mod(u_time-startTime,life),0.0);if((u_once&&u_time>life+startTime)){deltaTime=0.0;}v_lifeLeft=1.0-deltaTime/life;float scale=a_lifeAndSize.z;vec3 position=a_position+(a_velocity+a_acceleration*deltaTime*0.5)*deltaTime;\n#ifdef isScaleByLifetime\nscale*=v_lifeLeft;\n#else\nscale*=pow(a_lifeAndSize.w,deltaTime);\n#endif\n#ifdef rotateToVelocity\nvec3 v=a_velocity+a_acceleration*deltaTime;float angle=atan(v.z,v.x)*2.0;\n#else\nfloat deltaAngle=deltaTime*a_rotation.y;float angle=a_rotation.x+deltaAngle;\n#endif\n#ifdef is2d\nvec2 rotatedPoint=rotation2d(angle)*vec2(a_normalizedUv.x,a_normalizedUv.y*a_uv.z);vec3 basisX=u_viewInvMat[0].xyz;vec3 basisZ=u_viewInvMat[1].xyz;vec3 localPosition=vec3(basisX*rotatedPoint.x+basisZ*rotatedPoint.y)*scale+position;gl_Position=u_projMat*u_viewMat*vec4(localPosition+u_modelMat[3].xyz,1.);\n#else\n#ifdef rotateToVelocity\nfloat s=sin(angle);float c=cos(angle);\n#else\nfloat s=sin(angle);float c=cos(angle);\n#endif\nvec4 rotatedPoint=vec4((a_normalizedUv.x*c+a_normalizedUv.y*a_uv.z*s)*scale,0.,(a_normalizedUv.x*s-a_normalizedUv.y*a_uv.z*c)*scale,1.);vec4 orientation=vec4(0,0,0,1);vec4 q2=orientation+orientation;vec4 qx=orientation.xxxw*q2.xyzx;vec4 qy=orientation.xyyw*q2.xyzy;vec4 qz=orientation.xxzw*q2.xxzz;mat4 localMatrix=mat4((1.0-qy.y)-qz.z,qx.y+qz.w,qx.z-qy.w,0,qx.y-qz.w,(1.0-qx.x)-qz.z,qy.z+qx.w,0,qx.z+qy.w,qy.z-qx.w,(1.0-qx.x)-qy.y,0,position.x,position.y,position.z,1);rotatedPoint=localMatrix*rotatedPoint;gl_Position=u_MVPMat*rotatedPoint;\n#endif\n}","#define GLSLIFY 1\nvarying vec4 v_color;varying float v_lifeLeft;varying vec2 v_uv;uniform sampler2D u_texture;void main(){if(v_lifeLeft==1.0){discard;}float alphaFactor=1.0;\n#ifdef fadeIn\nfloat fadeInFactor=step(0.5,v_lifeLeft);alphaFactor=2.0*fadeInFactor*(1.0-v_lifeLeft)+(1.0-fadeInFactor);\n#endif\n#ifdef fadeOut\nfloat fadeOutFactor=step(0.5,v_lifeLeft);alphaFactor=alphaFactor*2.0*(1.0-fadeOutFactor)*v_lifeLeft+alphaFactor*fadeOutFactor;\n#endif\n#ifdef particleTexture\nvec4 tex=texture2D(u_texture,v_uv);\n#ifdef useOriginColor\ngl_FragColor=vec4(tex.rgb,alphaFactor*tex.a*v_color.w);\n#else\ngl_FragColor=vec4(v_color.xyz*tex.rgb,alphaFactor*tex.a*v_color.w);\n#endif\n#else\ngl_FragColor=vec4(v_color.xyz,alphaFactor*v_color.w);\n#endif\n}"),zt.create("SpriteMask","#define GLSLIFY 1\nuniform mat4 u_VPMat;attribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 v_uv;void main(){gl_Position=u_VPMat*vec4(POSITION,1.0);v_uv=TEXCOORD_0;}","#define GLSLIFY 1\nuniform sampler2D u_maskTexture;uniform float u_maskAlphaCutoff;varying vec2 v_uv;void main(){vec4 color=texture2D(u_maskTexture,v_uv);if(color.a<u_maskAlphaCutoff){discard;}gl_FragColor=color;}"),zt.create("Sprite","#define GLSLIFY 1\n#ifdef USE_MODEL_MATRIX\nuniform mat4 u_MVPMat;\n#else\nuniform mat4 u_VPMat;\n#endif\nattribute vec3 POSITION;attribute vec2 TEXCOORD_0;attribute vec4 COLOR_0;varying vec2 v_uv;varying vec4 v_color;void main(){\n#ifdef USE_MODEL_MATRIX\ngl_Position=u_MVPMat*vec4(POSITION,1.0);\n#else\ngl_Position=u_VPMat*vec4(POSITION,1.0);\n#endif\nv_uv=TEXCOORD_0;v_color=COLOR_0;}","#define GLSLIFY 1\n#ifdef USE_CUSTOM_TEXTURE\nuniform sampler2D u_cusTomTexture;\n#else\nuniform sampler2D u_spriteTexture;\n#endif\nvarying vec2 v_uv;varying vec4 v_color;void main(){\n#ifdef USE_CUSTOM_TEXTURE\nvec4 baseColor=texture2D(u_cusTomTexture,v_uv);\n#else\nvec4 baseColor=texture2D(u_spriteTexture,v_uv);\n#endif\ngl_FragColor=baseColor*v_color;}"),zt.create("background-texture","#define GLSLIFY 1\nattribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 v_uv;void main(){gl_Position=vec4(POSITION,1.0);v_uv=TEXCOORD_0;}","#define GLSLIFY 1\nuniform sampler2D u_baseTexture;varying vec2 v_uv;void main(){gl_FragColor=texture2D(u_baseTexture,v_uv);}")},e}(),Gn=function(){function e(){this._cacheHierarchy=1,this._cacheMap=Object.create(null),this._lastQueryMap=void 0,this._lastQueryKey=void 0}var t=e.prototype;return t.get=function(e){var t=this._cacheMap,r=e._length;r>this._cacheHierarchy&&this._resizeCacheMapHierarchy(t,0,r);for(var n=e._mask,i=e._length-1,a=this._cacheHierarchy-1,o=0;o<a;o++){var s=i<o?0:n[o],l=t[s];l||(t[s]=l=Object.create(null)),t=l}var u=i<a?0:n[a],c=t[u];return c||(this._lastQueryKey=u,this._lastQueryMap=t),c},t.cache=function(e){this._lastQueryMap[this._lastQueryKey]=e},t._resizeCacheMapHierarchy=function(e,t,r){var n=this._cacheHierarchy-1;if(t==n){for(var i in e)for(var a=e[i],o=0,s=r-n;o<s;o++)o==s-1?e[0]=a:e=e[0==o?i:0]=Object.create(null);this._cacheHierarchy=r}else for(var l in e)this._resizeCacheMapHierarchy(e[l],++t,r)},e}(),Hn=new rt;kn.init();var Wn=function(t){function r(n,i,a){var o;(o=t.call(this)||this).physicsManager=void 0,o.inputManager=void 0,o._componentsManager=new be,o._hardwareRenderer=void 0,o._lastRenderState=new pr,o._renderElementPool=new vr(yr),o._spriteElementPool=new vr(xr),o._spriteMaskElementPool=new vr(Tr),o._spriteDefaultMaterial=void 0,o._spriteMaskDefaultMaterial=void 0,o._renderContext=new mr,o._whiteTexture2D=void 0,o._whiteTextureCube=void 0,o._whiteTexture2DArray=void 0,o._backgroundTextureMaterial=void 0,o._renderCount=0,o._shaderProgramPools=[],o._spriteMaskManager=void 0,o._macroCollection=new we,o._dynamicTextAtlasManager=new se(O(o)),o._canvas=void 0,o._settings={},o._resourceManager=new de(O(o)),o._sceneManager=new Vn(O(o)),o._vSyncCount=1,o._targetFrameRate=60,o._time=new xe,o._isPaused=!0,o._requestId=void 0,o._timeoutId=void 0,o._vSyncCounter=1,o._targetFrameInterval=1e3/60,o._animate=function(){o._vSyncCount?(o._requestId=requestAnimationFrame(o._animate),o._vSyncCounter++%o._vSyncCount==0&&(o.update(),o._vSyncCounter=1)):(o._timeoutId=window.setTimeout(o._animate,o._targetFrameInterval),o.update())},o.features=[],o._hardwareRenderer=i,o._hardwareRenderer.init(n),o.physicsManager=new lt(O(o)),o._canvas=n,Hn.addObject(O(o)),o._sceneManager.activeScene=new zn(O(o),"DefaultScene"),o._spriteMaskManager=new Mn(O(o)),o._spriteDefaultMaterial=o._createSpriteMaterial(),o._spriteMaskDefaultMaterial=o._createSpriteMaskMaterial(),o.inputManager=new Pt(O(o));var s=new Uint8Array([255,255,255,255]),l=new ie(O(o),1,1,e.TextureFormat.R8G8B8A8,!1);l.setPixelBuffer(s),l.isGCIgnored=!0;var u=new Zr(O(o),1,e.TextureFormat.R8G8B8A8,!1);if(u.setPixelBuffer(e.TextureCubeFace.PositiveX,s),u.setPixelBuffer(e.TextureCubeFace.NegativeX,s),u.setPixelBuffer(e.TextureCubeFace.PositiveY,s),u.setPixelBuffer(e.TextureCubeFace.NegativeY,s),u.setPixelBuffer(e.TextureCubeFace.PositiveZ,s),u.setPixelBuffer(e.TextureCubeFace.NegativeZ,s),u.isGCIgnored=!0,o._whiteTexture2D=l,o._whiteTextureCube=u,i.isWebGL2){var c=new Jr(O(o),1,1,1,e.TextureFormat.R8G8B8A8,!1);c.setPixelBuffer(0,s),c.isGCIgnored=!0,o._whiteTexture2DArray=c}o._backgroundTextureMaterial=new gr(O(o),zt.find("background-texture")),o._backgroundTextureMaterial.isGCIgnored=!0,o._backgroundTextureMaterial.renderState.depthState.compareFunction=e.CompareFunction.LessEqual;var h=(null==a?void 0:a.colorSpace)||e.ColorSpace.Linear;return h===e.ColorSpace.Gamma&&o._macroCollection.enable(r._gammaMacro),o._settings.colorSpace=h,o}E(r,t);var n=r.prototype;return n.createEntity=function(e){return new tt(this,e)},n.pause=function(){this._isPaused=!0,cancelAnimationFrame(this._requestId),clearTimeout(this._timeoutId)},n.resume=function(){this._isPaused&&(this._isPaused=!1,this.time.reset(),this._requestId=requestAnimationFrame(this._animate))},n.update=function(){var e=this._time,t=e.deltaTime;e.tick(),this._renderElementPool.resetPool(),this._spriteElementPool.resetPool(),this._spriteMaskElementPool.resetPool(),Hn.callFeatureMethod(this,"preTick",[this,this._sceneManager._activeScene]);var r=this._sceneManager._activeScene,n=this._componentsManager;r&&(r._activeCameras.sort((function(e,t){return e.priority-t.priority})),n.callScriptOnStart(),this.physicsManager._initialized&&this.physicsManager._update(t/1e3),this.inputManager._update(),n.callScriptOnUpdate(t),n.callAnimationUpdate(t),n.callScriptOnLateUpdate(t),this._render(r),n.handlingInvalidScripts()),Hn.callFeatureMethod(this,"postTick",[this,this._sceneManager._activeScene])},n.run=function(){Hn.callFeatureMethod(this,"preLoad",[this]),this.resume(),this.trigger(new me("run",this))},n.destroy=function(){this._sceneManager&&(this._whiteTexture2D.destroy(!0),this._whiteTextureCube.destroy(!0),this.inputManager._destroy(),this.trigger(new me("shutdown",this)),Hn.callFeatureMethod(this,"shutdown",[this]),this.pause(),this._animate=null,this._sceneManager._activeScene.destroy(),this._resourceManager._destroy(),this._componentsManager.handlingInvalidScripts(),this._sceneManager=null,this._resourceManager=null,this._canvas=null,this.features=[],this._time=null,this._spriteMaskManager.destroy(),Hn._objects=[],this.removeAllEventListeners())},n._getShaderProgramPool=function(e){var t=e._shaderId,r=this._shaderProgramPools,n=r[t];if(!n){var i=t+1;i<r.length&&(r.length=i),r[t]=n=new Gn}return n},n._render=function(e){var t=e._activeCameras,r=this._componentsManager,n=this.time.deltaTime;if(r.callRendererOnUpdate(n),e._updateShaderData(),t.length>0)for(var i=0,a=t.length;i<a;i++){var o=t[i];r.callCameraOnBeginRender(o),zn.sceneFeatureManager.callFeatureMethod(e,"preRender",[e,o]),o.render(),zn.sceneFeatureManager.callFeatureMethod(e,"postRender",[e,o]),r.callCameraOnEndRender(o)}else re.debug("NO active camera.")},n._createSpriteMaterial=function(){var t=new gr(this,zt.find("Sprite")),r=t.renderState,n=r.blendState.targetBlendState;return n.enabled=!0,n.sourceColorBlendFactor=e.BlendFactor.SourceAlpha,n.destinationColorBlendFactor=e.BlendFactor.OneMinusSourceAlpha,n.sourceAlphaBlendFactor=e.BlendFactor.One,n.destinationAlphaBlendFactor=e.BlendFactor.OneMinusSourceAlpha,n.colorBlendOperation=n.alphaBlendOperation=e.BlendOperation.Add,r.depthState.writeEnabled=!1,r.rasterState.cullMode=e.CullMode.Off,t.renderQueueType=e.RenderQueueType.Transparent,t.isGCIgnored=!0,t},n._createSpriteMaskMaterial=function(){var t=new gr(this,zt.find("SpriteMask")),r=t.renderState;return r.blendState.targetBlendState.colorWriteMask=e.ColorWriteMask.None,r.rasterState.cullMode=e.CullMode.Off,r.stencilState.enabled=!0,r.depthState.enabled=!1,t.isGCIgnored=!0,t},n.findFeature=function(e){return Hn.findFeature(this,e)},r.registerFeature=function(e){Hn.registerFeature(e)},A(r,[{key:"settings",get:function(){return this._settings}},{key:"canvas",get:function(){return this._canvas}},{key:"resourceManager",get:function(){return this._resourceManager}},{key:"sceneManager",get:function(){return this._sceneManager}},{key:"time",get:function(){return this._time}},{key:"isPaused",get:function(){return this._isPaused}},{key:"vSyncCount",get:function(){return this._vSyncCount},set:function(e){this._vSyncCount=Math.max(0,Math.floor(e))}},{key:"targetFrameRate",get:function(){return this._targetFrameRate},set:function(e){e=Math.max(1e-6,e),this._targetFrameRate=e,this._targetFrameInterval=1e3/e}}]),r}(ye);Wn._gammaMacro=zt.getMacroByName("OASIS_COLORSPACE_GAMMA");var jn,Xn,Kn,qn,Yn,Qn,Jn,Zn,$n,ei,ti=function(){function e(){}return e._isIos=function(){if(!window)return!1;var e=window.navigator.userAgent.toLocaleLowerCase();return/iphone|ipad|ipod/.test(e)},A(e,null,[{key:"devicePixelRatio",get:function(){return window.devicePixelRatio}}]),e}(),ri=function(){function e(){}var t=e.prototype;return t.preLoad=function(e){},t.preTick=function(e,t){},t.postTick=function(e,t){},t.shutdown=function(e){},e}(),ni=(jn=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return V(t=e.call.apply(e,[this].concat(n))||this,"_started",Xn,O(t)),V(t,"_onStartIndex",Kn,O(t)),V(t,"_onUpdateIndex",qn,O(t)),V(t,"_onLateUpdateIndex",Yn,O(t)),V(t,"_onPhysicsUpdateIndex",Qn,O(t)),V(t,"_onPreRenderIndex",Jn,O(t)),V(t,"_onPostRenderIndex",Zn,O(t)),V(t,"_entityScriptsIndex",$n,O(t)),V(t,"_waitHandlingInValid",ei,O(t)),t}E(t,e);var r=t.prototype;return r.onAwake=function(){},r.onEnable=function(){},r.onStart=function(){},r.onUpdate=function(e){},r.onLateUpdate=function(e){},r.onBeginRender=function(e){},r.onEndRender=function(e){},r.onPhysicsUpdate=function(){},r.onTriggerEnter=function(e){},r.onTriggerExit=function(e){},r.onTriggerStay=function(e){},r.onCollisionEnter=function(e){},r.onCollisionExit=function(e){},r.onCollisionStay=function(e){},r.onPointerDown=function(){},r.onPointerUp=function(){},r.onPointerClick=function(){},r.onPointerEnter=function(){},r.onPointerExit=function(){},r.onPointerDrag=function(){},r.onDisable=function(){},r.onDestroy=function(){},r._onAwake=function(){this.onAwake()},r._onEnable=function(){if(this._waitHandlingInValid)this._waitHandlingInValid=!1;else{var e=this.engine._componentsManager,r=t.prototype;this._started||e.addOnStartScript(this),this.onUpdate!==r.onUpdate&&e.addOnUpdateScript(this),this.onLateUpdate!==r.onLateUpdate&&e.addOnLateUpdateScript(this),this.onPhysicsUpdate!==r.onPhysicsUpdate&&e.addOnPhysicsUpdateScript(this),this._entity._addScript(this)}this.onEnable()},r._onDisable=function(){this._waitHandlingInValid=!0,this._engine._componentsManager.addDisableScript(this),this.onDisable()},r._onDestroy=function(){this._engine._componentsManager.addDestroyScript(this)},r._handlingInValid=function(){var e=this.engine._componentsManager;-1!==this._onUpdateIndex&&e.removeOnUpdateScript(this),-1!==this._onLateUpdateIndex&&e.removeOnLateUpdateScript(this),-1!==this._onPhysicsUpdateIndex&&e.removeOnPhysicsUpdateScript(this),-1!==this._entityScriptsIndex&&this._entity._removeScript(this),this._waitHandlingInValid=!1},t}(Je),Xn=N(jn.prototype,"_started",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Kn=N(jn.prototype,"_onStartIndex",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),qn=N(jn.prototype,"_onUpdateIndex",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Yn=N(jn.prototype,"_onLateUpdateIndex",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Qn=N(jn.prototype,"_onPhysicsUpdateIndex",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Jn=N(jn.prototype,"_onPreRenderIndex",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Zn=N(jn.prototype,"_onPostRenderIndex",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),$n=N(jn.prototype,"_entityScriptsIndex",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),ei=N(jn.prototype,"_waitHandlingInValid",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),jn),ii=0,ai=function(){function t(t,r,n,i,a){void 0===t&&(t="RENDER_PASS"+ii++),void 0===r&&(r=0),void 0===n&&(n=null),void 0===i&&(i=null),void 0===a&&(a=null),this.name=void 0,this.enabled=void 0,this.priority=void 0,this.renderTarget=void 0,this.replaceMaterial=void 0,this.mask=void 0,this.renderOverride=void 0,this.clearFlags=void 0,this.clearColor=void 0,this.name=t,this.enabled=!0,this.priority=r,this.renderTarget=n,this.replaceMaterial=i,this.mask=a||e.Layer.Everything,this.renderOverride=!1}var r=t.prototype;return r.render=function(e,t,r,n){},r.preRender=function(e,t,r,n){},r.postRender=function(e,t,r,n){},t}(),oi=function(t){function r(){return t.apply(this,arguments)||this}E(r,t);var n=r.prototype;return n.createVertexElements=function(t){return t[0]=new Nr("POSITION",0,e.VertexElementFormat.Vector3,0),t[1]=new Nr("TEXCOORD_0",12,e.VertexElementFormat.Vector2,0),t[2]=new Nr("COLOR_0",20,e.VertexElementFormat.Vector4,0),36},n.canBatch=function(e,t){var n=e.component,i=t.component;if(!this.checkBatchWithMask(n,i))return!1;var a=r._textureProperty;return n.shaderData.getTexture(a)===i.shaderData.getTexture(a)&&e.material===t.material},n.checkBatchWithMask=function(t,r){var n=t.maskInteraction;return n===r.maskInteraction&&(n===e.SpriteMaskInteraction.None||t.maskLayer===r.maskLayer)},n.updateVertices=function(e,t,r){for(var n=e.positions,i=e.uv,a=e.color,o=n.length,s=0;s<o;s++){var l=n[s],u=i[s];t[r++]=l.x,t[r++]=l.y,t[r++]=l.z,t[r++]=u.x,t[r++]=u.y,t[r++]=a.r,t[r++]=a.g,t[r++]=a.b,t[r++]=a.a}return r},n.drawBatches=function(e){for(var t=this._meshes[this._flushId],r=t.subMeshes,n=this._batchedQueue,i=e._spriteMaskManager,a=0,o=r.length;a<o;a++){var s=r[a],l=n[a];if(!s||!l)return;var u=l.component,c=l.camera,h=l.material;i.preRender(c,u);var d=zt._compileMacros;we.unionCollection(u._globalShaderMacro,h.shaderData._macroCollection,d);var _=h.shader._getShaderProgram(e,d);if(!_.isValid)return;_.bind(),_.groupingOtherUniformBlock(),_.uploadAll(_.sceneUniformBlock,c.scene.shaderData),_.uploadAll(_.cameraUniformBlock,c.shaderData),_.uploadAll(_.rendererUniformBlock,u.shaderData),_.uploadAll(_.materialUniformBlock,h.shaderData),h.renderState._apply(e,!1),e._hardwareRenderer.drawPrimitive(t,s,_),i.postRender(u)}},n.destroy=function(){this._batchedQueue=null;for(var e=this._meshes,t=this._vertexBuffers,r=this._indiceBuffers,n=0,i=e.length;n<i;++n)e[n].destroy();this._meshes=null;for(var a=0,o=t.length;a<o;++a)t[a].destroy();this._vertexBuffers=null;for(var s=0,l=r.length;s<l;++s)r[s].destroy();this._indiceBuffers=null},r}(wn);oi._textureProperty=zt.getPropertyByName("u_spriteTexture");var si,li,ui,ci,hi,di,_i,fi,pi,gi,vi,mi,yi,xi,Ti,wi=function(){function e(e){this.items=[],this._spriteBatcher=void 0,this._spriteBatcher=new oi(e)}e._compareFromNearToFar=function(e,t){return e.material.renderQueueType-t.material.renderQueueType||e.component._distanceForSort-t.component._distanceForSort||t.component._renderSortId-e.component._renderSortId},e._compareFromFarToNear=function(e,t){return e.material.renderQueueType-t.material.renderQueueType||t.component._distanceForSort-e.component._distanceForSort||t.component._renderSortId-e.component._renderSortId};var t=e.prototype;return t.pushPrimitive=function(e){this.items.push(e)},t.render=function(e,t,r){var n=this.items;if(0!==n.length){for(var i=e.engine,a=e.scene,o=i._renderCount,s=i._hardwareRenderer,l=a.shaderData,u=e.shaderData,c=0,h=n.length;c<h;c++){var d=n[c];if(d.component.entity.layer&r)if(d.mesh){this._spriteBatcher.flush(i);var _=zt._compileMacros,f=d,p=f.component,g=t||f.material,v=p.shaderData,m=g.shaderData;g._preRender(f),we.unionCollection(p._globalShaderMacro,m._macroCollection,_);var y=g.shader._getShaderProgram(i,_);if(!y.isValid)continue;var x=y.bind();o!==y._uploadRenderCount?(y.groupingOtherUniformBlock(),y.uploadAll(y.sceneUniformBlock,l),y.uploadAll(y.cameraUniformBlock,u),y.uploadAll(y.rendererUniformBlock,v),y.uploadAll(y.materialUniformBlock,m),y.uploadUnGroupTextures(),y._uploadCamera=e,y._uploadRenderer=p,y._uploadMaterial=g,y._uploadRenderCount=o):(y._uploadCamera!==e?(y.uploadAll(y.cameraUniformBlock,u),y._uploadCamera=e):x&&y.uploadTextures(y.cameraUniformBlock,u),y._uploadRenderer!==p?(y.uploadAll(y.rendererUniformBlock,v),y._uploadRenderer=p):x&&y.uploadTextures(y.rendererUniformBlock,v),y._uploadMaterial!==g?(y.uploadAll(y.materialUniformBlock,m),y._uploadMaterial=g):x&&y.uploadTextures(y.materialUniformBlock,m),x&&y.uploadUnGroupTextures()),g.renderState._apply(e.engine,p.entity.transform._isFrontFaceInvert()),s.drawPrimitive(f.mesh,f.subMesh,y)}else{var T=d;this._spriteBatcher.drawElement(T)}}this._spriteBatcher.flush(i)}},t.clear=function(){this.items.length=0,this._spriteBatcher.clear()},t.destroy=function(){this._spriteBatcher.destroy(),this._spriteBatcher=null},t.sort=function(e){this._quickSort(this.items,0,this.items.length,e)},t._quickSort=function(e,t,r,n){for(;;){if(r-t<=10)return void this._insertionSort(e,t,r,n);var i=t+r>>1,a=e[t],o=e[r-1],s=e[i];if(n(a,o)>0){var l=a;a=o,o=l}if(n(a,s)>=0){var u=a;a=s,s=o,o=u}else if(n(o,s)>0){var c=o;o=s,s=c}e[t]=a,e[r-1]=s;var h=o,d=t+1,_=r-1;e[i]=e[d],e[d]=h;e:for(var f=d+1;f<_;f++){var p=e[f],g=n(p,h);if(g<0)e[f]=e[d],e[d]=p,d++;else if(g>0){do{if(--_==f)break e;g=n(e[_],h)}while(g>0);e[f]=e[_],e[_]=p,g<0&&(p=e[f],e[f]=e[d],e[d]=p,d++)}}r-_<d-t?(this._quickSort(e,_,r,n),r=d):(this._quickSort(e,t,d,n),t=_)}},t._insertionSort=function(e,t,r,n){for(var i=t+1;i<r;i++){var a=void 0,o=e[i];for(a=i-1;a>=t;a--){var s=e[a];if(!(n(s,o)>0))break;e[a+1]=s}e[a+1]=o}},e}(),bi=function(){function t(e){this._opaqueQueue=void 0,this._transparentQueue=void 0,this._alphaTestQueue=void 0,this._allSpriteMasks=new Te,this._camera=void 0,this._defaultPass=void 0,this._renderPassArray=void 0,this._lastCanvasSize=new g,this._camera=e;var t=e.engine;this._opaqueQueue=new wi(t),this._alphaTestQueue=new wi(t),this._transparentQueue=new wi(t),this._renderPassArray=[],this._defaultPass=new ai("default",0,null,null,0),this.addRenderPass(this._defaultPass)}var r=t.prototype;return r.addRenderPass=function(e,t,r,n,i){if(void 0===t&&(t=null),void 0===r&&(r=null),void 0===n&&(n=null),void 0===i&&(i=null),"string"==typeof e){var a=new ai(e,t,r,n,i);this._renderPassArray.push(a)}else e instanceof ai&&this._renderPassArray.push(e);this._renderPassArray.sort((function(e,t){return e.priority-t.priority}))},r.removeRenderPass=function(e){var t;if("string"==typeof e?t=this.getRenderPass(e):e instanceof ai&&(t=e),t){var r=this._renderPassArray.indexOf(t);this._renderPassArray.splice(r,1)}},r.getRenderPass=function(e){for(var t=0,r=this._renderPassArray.length;t<r;t++){var n=this._renderPassArray[t];if(n.name===e)return n}return null},r.destroy=function(){this._opaqueQueue.destroy(),this._alphaTestQueue.destroy(),this._transparentQueue.destroy(),this._allSpriteMasks=null,this._renderPassArray=null,this._defaultPass=null,this._camera=null},r.render=function(e,t,r){var n=this._camera,i=this._opaqueQueue,a=this._alphaTestQueue,o=this._transparentQueue;n.engine._spriteMaskManager.clear(),i.clear(),a.clear(),o.clear(),this._allSpriteMasks.length=0,n.engine._componentsManager.callRender(e),i.sort(wi._compareFromNearToFar),a.sort(wi._compareFromNearToFar),o.sort(wi._compareFromFarToNear);for(var s=0,l=this._renderPassArray.length;s<l;s++)this._drawRenderPass(this._renderPassArray[s],n,t,r)},r._drawRenderPass=function(t,r,n,i){if(t.preRender(r,this._opaqueQueue,this._alphaTestQueue,this._transparentQueue),t.enabled){var a,o,s=r.engine,l=r.scene.background,u=s._hardwareRenderer,c=r.renderTarget||t.renderTarget;u.activeRenderTarget(c,r,i),null==c||c._setRenderTargetInfo(n,i);var h=null!=(a=t.clearFlags)?a:r.clearFlags,d=null!=(o=t.clearColor)?o:l.solidColor;h!==e.CameraClearFlags.None&&u.clearRenderTarget(r.engine,h,d),t.renderOverride?t.render(r,this._opaqueQueue,this._alphaTestQueue,this._transparentQueue):(this._opaqueQueue.render(r,t.replaceMaterial,t.mask),this._alphaTestQueue.render(r,t.replaceMaterial,t.mask),r.clearFlags===e.CameraClearFlags.DepthColor&&(l.mode===e.BackgroundMode.Sky?this._drawSky(s,r,l.sky):l.mode===e.BackgroundMode.Texture&&l.texture&&this._drawBackgroundTexture(s,l)),this._transparentQueue.render(r,t.replaceMaterial,t.mask)),null==c||c._blitRenderTarget(),null==c||c.generateMipmaps()}t.postRender(r,this._opaqueQueue,this._alphaTestQueue,this._transparentQueue)},r.pushPrimitive=function(t){var r=t.material.renderQueueType;r>e.RenderQueueType.Transparent+e.RenderQueueType.AlphaTest>>1?this._transparentQueue.pushPrimitive(t):r>e.RenderQueueType.AlphaTest+e.RenderQueueType.Opaque>>1?this._alphaTestQueue.pushPrimitive(t):this._opaqueQueue.pushPrimitive(t)},r._drawBackgroundTexture=function(t,r){var n=t._hardwareRenderer,i=t._backgroundTextureMaterial,a=t.canvas,o=r._mesh;this._lastCanvasSize.x===a.width&&this._lastCanvasSize.y===a.height||r._textureFillMode===e.BackgroundTextureFillMode.Fill||(this._lastCanvasSize.setValue(a.width,a.height),r._resizeBackgroundTexture());var s=i.shader._getShaderProgram(t,zt._compileMacros);s.bind(),s.uploadAll(s.materialUniformBlock,i.shaderData),s.uploadUnGroupTextures(),i.renderState._apply(t,!1),n.drawPrimitive(o,o.subMesh,s)},r._drawSky=function(e,t,r){var n=r.material,i=r.mesh,a=r._matrix;if(n)if(i){var o=e._hardwareRenderer,s=n.shaderData,l=n.shader,u=n.renderState,c=zt._compileMacros;we.unionCollection(t._globalShaderMacro,s._macroCollection,c);var h=t.viewMatrix,d=t.projectionMatrix;h.cloneTo(a);var _=a.elements;_[12]=_[13]=_[14]=0,f.multiply(d,a,a),s.setMatrix("u_mvpNoscale",a);var p=l._getShaderProgram(e,c);p.bind(),p.groupingOtherUniformBlock(),p.uploadAll(p.materialUniformBlock,s),p.uploadUnGroupTextures(),u._apply(e,!1),o.drawPrimitive(i,i.subMesh,p)}else re.warn("The mesh of sky is not defined.");else re.warn("The material of sky is not defined.")},A(t,[{key:"defaultRenderPass",get:function(){return this._defaultPass}}]),t}(),Ci=function(){};Ci.tempVec4=new v,Ci.tempVec3=new o,Ci.tempVec2=new g;var Si=Ae($e)(((Ti=function(t){function r(r){var n;(n=t.call(this,r)||this).shaderData=new kt(At.Camera),n.priority=0,n.enableFrustumCulling=!0,n.clearFlags=e.CameraClearFlags.DepthColor,n.cullingMask=e.Layer.Everything,n._globalShaderMacro=new we,V(n,"_frustum",ui,O(n)),V(n,"_renderPipeline",ci,O(n)),n._isOrthographic=!1,n._isProjMatSetting=!1,n._nearClipPlane=.1,n._farClipPlane=100,n._fieldOfView=45,n._orthographicSize=10,n._isProjectionDirty=!0,n._isInvProjMatDirty=!0,n._isFrustumProjectDirty=!0,n._customAspectRatio=void 0,n._renderTarget=null,V(n,"_frustumViewChangeFlag",hi,O(n)),V(n,"_transform",di,O(n)),V(n,"_isViewMatrixDirty",_i,O(n)),V(n,"_isInvViewProjDirty",fi,O(n)),V(n,"_projectionMatrix",pi,O(n)),V(n,"_viewMatrix",gi,O(n)),V(n,"_viewport",vi,O(n)),V(n,"_inverseProjectionMatrix",mi,O(n)),V(n,"_lastAspectSize",yi,O(n)),V(n,"_invViewProjMat",xi,O(n));var i=n.entity.transform;return n._transform=i,n._isViewMatrixDirty=i.registerWorldChangeFlag(),n._isInvViewProjDirty=i.registerWorldChangeFlag(),n._frustumViewChangeFlag=i.registerWorldChangeFlag(),n._renderPipeline=new bi(O(n)),n.shaderData._addRefCount(1),n}E(r,t),r._rotationTranslationInv=function(e,t,r){var n=r.elements,i=e.x,a=e.y,o=e.z,s=e.w,l=i+i,u=a+a,c=o+o,h=i*l,d=i*u,_=i*c,f=a*u,p=a*c,g=o*c,v=s*l,m=s*u,y=s*c;n[0]=1-(f+g),n[1]=d+y,n[2]=_-m,n[3]=0,n[4]=d-y,n[5]=1-(h+g),n[6]=p+v,n[7]=0,n[8]=_+m,n[9]=p-v,n[10]=1-(h+f),n[11]=0,n[12]=t.x,n[13]=t.y,n[14]=t.z,n[15]=1,r.invert()};var n=r.prototype;return n.resetProjectionMatrix=function(){this._isProjMatSetting=!1,this._projMatChange()},n.resetAspectRatio=function(){this._customAspectRatio=void 0,this._projMatChange()},n.worldToViewportPoint=function(e,t){var r=Ci.tempVec3,n=Ci.tempVec4;o.transformCoordinate(e,this.viewMatrix,r),o.transformToVec4(r,this.projectionMatrix,n);var i=n.w;return t.setValue(.5*(n.x/i+1),.5*(1-n.y/i),-r.z),t},n.viewportToWorldPoint=function(e,t){var r,n=this.nearClipPlane,i=this.farClipPlane,a=1/(n-i);if(this.isOrthographic)r=2*-e.z*a,r+=(i+n)*a;else{var o=e.z;r=-o*(n+i)*a,r+=2*n*i*a,r/=o}return this._innerViewportToWorldPoint(e.x,e.y,(r+1)/2,this._getInvViewProjMat(),t),t},n.viewportPointToRay=function(e,t){var r=this._getInvViewProjMat(),n=this._innerViewportToWorldPoint(e.x,e.y,0,r,t.origin),i=this._innerViewportToWorldPoint(e.x,e.y,1,r,t.direction);return o.subtract(i,n,i),i.normalize(),t},n.screenToViewportPoint=function(e,t){var r=this.engine.canvas,n=this.viewport;return t.x=(e.x/r.width-n.x)/n.z,t.y=(e.y/r.height-n.y)/n.w,void 0!==e.z&&(t.z=e.z),t},n.viewportToScreenPoint=function(e,t){var r=this.engine.canvas,n=this.viewport;return t.x=(n.x+e.x*n.z)*r.width,t.y=(n.y+e.y*n.w)*r.height,void 0!==e.z&&(t.z=e.z),t},n.worldToScreenPoint=function(e,t){return this.worldToViewportPoint(e,t),this.viewportToScreenPoint(t,t)},n.screenToWorldPoint=function(e,t){return this.screenToViewportPoint(e,t),this.viewportToWorldPoint(t,t)},n.screenPointToRay=function(e,t){var r=Ci.tempVec2;return this.screenToViewportPoint(e,r),this.viewportPointToRay(r,t)},n.render=function(e,t){void 0===t&&(t=0);var r=this.engine._renderContext;r._setContext(this),this.enableFrustumCulling&&(this._frustumViewChangeFlag.flag||this._isFrustumProjectDirty)&&(this._frustum.calculateFromMatrix(r._viewProjectMatrix),this._frustumViewChangeFlag.flag=!1,this._isFrustumProjectDirty=!1),this._updateShaderData(r),we.unionCollection(this.scene._globalShaderMacro,this.shaderData._macroCollection,this._globalShaderMacro),t>0&&!this.engine._hardwareRenderer.isWebGL2&&(t=0,re.error("mipLevel only take effect in WebGL2.0")),this._renderPipeline.render(r,e,t),this._engine._renderCount++},n._onEnable=function(){this.entity.scene._attachRenderCamera(this)},n._onDisable=function(){this.entity.scene._detachRenderCamera(this)},n._onDestroy=function(){var e;null===(e=this._renderPipeline)||void 0===e||e.destroy(),this._isInvViewProjDirty.destroy(),this._isViewMatrixDirty.destroy(),this.shaderData._addRefCount(-1)},n._projMatChange=function(){this._isFrustumProjectDirty=!0,this._isProjectionDirty=!0,this._isInvProjMatDirty=!0,this._isInvViewProjDirty.flag=!0},n._innerViewportToWorldPoint=function(e,t,r,n,i){var a=Ci.tempVec3;return a.setValue(2*e-1,1-2*t,2*r-1),o.transformCoordinate(a,n,i),i},n._updateShaderData=function(e){var t=this.shaderData;t.setMatrix(r._viewMatrixProperty,this.viewMatrix),t.setMatrix(r._projectionMatrixProperty,this.projectionMatrix),t.setMatrix(r._vpMatrixProperty,e._viewProjectMatrix),t.setMatrix(r._inverseViewMatrixProperty,this._transform.worldMatrix),t.setMatrix(r._inverseProjectionMatrixProperty,this._getInverseProjectionMatrix()),t.setVector3(r._cameraPositionProperty,this._transform.worldPosition)},n._getInvViewProjMat=function(){return this._isInvViewProjDirty.flag&&(this._isInvViewProjDirty.flag=!1,f.multiply(this._transform.worldMatrix,this._getInverseProjectionMatrix(),this._invViewProjMat)),this._invViewProjMat},n._getInverseProjectionMatrix=function(){return this._isInvProjMatDirty&&(this._isInvProjMatDirty=!1,f.invert(this.projectionMatrix,this._inverseProjectionMatrix)),this._inverseProjectionMatrix},A(r,[{key:"nearClipPlane",get:function(){return this._nearClipPlane},set:function(e){this._nearClipPlane=e,this._projMatChange()}},{key:"farClipPlane",get:function(){return this._farClipPlane},set:function(e){this._farClipPlane=e,this._projMatChange()}},{key:"fieldOfView",get:function(){return this._fieldOfView},set:function(e){this._fieldOfView=e,this._projMatChange()}},{key:"aspectRatio",get:function(){var e,t=this._entity.engine.canvas;return null!=(e=this._customAspectRatio)?e:t.width*this._viewport.z/(t.height*this._viewport.w)},set:function(e){this._customAspectRatio=e,this._projMatChange()}},{key:"viewport",get:function(){return this._viewport},set:function(e){e!==this._viewport&&e.cloneTo(this._viewport),this._projMatChange()}},{key:"isOrthographic",get:function(){return this._isOrthographic},set:function(e){this._isOrthographic=e,this._projMatChange()}},{key:"orthographicSize",get:function(){return this._orthographicSize},set:function(e){this._orthographicSize=e,this._projMatChange()}},{key:"viewMatrix",get:function(){return this._isViewMatrixDirty.flag&&(this._isViewMatrixDirty.flag=!1,r._rotationTranslationInv(this._transform.worldRotationQuaternion,this._transform.worldPosition,this._viewMatrix)),this._viewMatrix}},{key:"projectionMatrix",get:function(){var e=this._entity.engine.canvas;if((!this._isProjectionDirty||this._isProjMatSetting)&&this._lastAspectSize.x===e.width&&this._lastAspectSize.y===e.height)return this._projectionMatrix;this._isProjectionDirty=!1,this._lastAspectSize.x=e.width,this._lastAspectSize.y=e.height;var t=this.aspectRatio;if(this._isOrthographic){var r=this._orthographicSize*t,n=this._orthographicSize;f.ortho(-r,r,-n,n,this._nearClipPlane,this._farClipPlane,this._projectionMatrix)}else f.perspective(a.degreeToRadian(this._fieldOfView),t,this._nearClipPlane,this._farClipPlane,this._projectionMatrix);return this._projectionMatrix},set:function(e){this._projectionMatrix=e,this._isProjMatSetting=!0,this._projMatChange()}},{key:"enableHDR",get:function(){return console.log("not implementation"),!1},set:function(e){console.log("not implementation")}},{key:"renderTarget",get:function(){return this._renderTarget},set:function(e){this._renderTarget=e}}]),r}(Je))._viewMatrixProperty=zt.getPropertyByName("u_viewMat"),Ti._projectionMatrixProperty=zt.getPropertyByName("u_projMat"),Ti._vpMatrixProperty=zt.getPropertyByName("u_VPMat"),Ti._inverseViewMatrixProperty=zt.getPropertyByName("u_viewInvMat"),Ti._inverseProjectionMatrixProperty=zt.getPropertyByName("u_projInvMat"),Ti._cameraPositionProperty=zt.getPropertyByName("u_cameraPos"),ui=N((li=Ti).prototype,"_frustum",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new h}}),ci=N(li.prototype,"_renderPipeline",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),hi=N(li.prototype,"_frustumViewChangeFlag",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),di=N(li.prototype,"_transform",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),_i=N(li.prototype,"_isViewMatrixDirty",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),fi=N(li.prototype,"_isInvViewProjDirty",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),pi=N(li.prototype,"_projectionMatrix",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new f}}),gi=N(li.prototype,"_viewMatrix",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new f}}),vi=N(li.prototype,"_viewport",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new v(0,0,1,1)}}),mi=N(li.prototype,"_inverseProjectionMatrix",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new f}}),yi=N(li.prototype,"_lastAspectSize",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new g(0,0)}}),xi=N(li.prototype,"_invViewProjMat",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new f}}),si=li))||si,Mi={json:"json",gltf:"json",mtl:"json",prefab:"json",txt:"text",bin:"arraybuffer",png:"image",webp:"image",jpg:"image"};function Ai(e,t){return void 0===t&&(t={}),new he((function(r,n,i){var a,o,s,l,u=null!=(a=t.retryCount)?a:4,c=null!=(o=t.retryInterval)?o:500;t.timeout=null!=(s=t.timeout)?s:15e3,t.type=null!=(l=t.type)?l:function(e){var t=e.substring(e.lastIndexOf(".")+1);return Mi[t]}(e);var h,d="image"===t.type?Pi:Fi,_=new Di((function(){return d(e,t).onProgress(i).then((function(e){r(e),_.stop()})).catch((function(e){return h=e}))}),u,c);_.start((function(){n(h)}))}))}function Pi(e,t){return new he((function(r,n){var i=t.timeout,a=new Image,o=function(){n(new Error("request "+e+" fail"))};a.onerror=o,a.onabort=o;var s=setTimeout((function(){n(new Error("request "+e+" timeout"))}),i);a.onload=function(e){return function(){requestAnimationFrame((function(){r(a),a.onload=null,a.onerror=null,a.onabort=null})),clearTimeout(e)}}(s),a.crossOrigin="anonymous",a.src=e}))}function Fi(e,t){return new he((function(r,n,i){var a,o=new XMLHttpRequest;o.timeout=t.timeout,t.method=null!=(a=t.method)?a:"get",o.onload=function(){var t;if(o.status<200||o.status>=300)n(new Error("request failed from: "+e));else{var i=null!=(t=o.response)?t:o.responseText;r(i)}},o.onerror=function(){n(new Error("request failed from: "+e))},o.ontimeout=function(){n(new Error("request timeout from: "+e))},o.onprogress=function(e){i(e.loaded/e.total)},o.open(t.method,e,!0),o.withCredentials="include"===t.credentials,o.responseType=t.type;var s=t.headers;s&&Object.keys(s).forEach((function(e){o.setRequestHeader(e,s[e])})),o.send(t.body)}))}var Ei,Ri,Li,Bi,Di=function(){function e(e,t,r){this.execFunc=e,this.totalCount=t,this.interval=r,this._timeoutId=-100,this._currentCount=0,this.done=void 0,this.exec=this.exec.bind(this)}var t=e.prototype;return t.start=function(e){this.done=e,this.exec()},t.stop=function(){clearTimeout(this._timeoutId)},t.exec=function(){var e=this;this._currentCount>=this.totalCount?this.done&&this.done():(this._currentCount++,this.execFunc(this._currentCount).then((function(){e._timeoutId=setTimeout(e.exec,e.interval)})))},e}(),Ii=function(e){this.useCache=e,this.request=Ai};e.AssetType=void 0,(Ei=e.AssetType||(e.AssetType={})).Text="text",Ei.JSON="json",Ei.Buffer="buffer",Ei.Texture2D="texture2d",Ei.TextureCube="texture-cube",Ei.Material="material",Ei.Mesh="mesh",Ei.AnimationClip="animation-clip",Ei.Prefab="prefab",Ei.KTX="ktx",Ei.KTXCube="ktx-cube",Ei.SpriteAtlas="sprite-atlas",Ei.Env="environment",Ei.HDR="HDR",e.RenderFace=void 0,(Ri=e.RenderFace||(e.RenderFace={}))[Ri.Front=0]="Front",Ri[Ri.Back=1]="Back",Ri[Ri.Double=2]="Double",e.BlendMode=void 0,(Li=e.BlendMode||(e.BlendMode={}))[Li.Normal=0]="Normal",Li[Li.Additive=1]="Additive",e.TextureCoordinate=void 0,(Bi=e.TextureCoordinate||(e.TextureCoordinate={}))[Bi.UV0=0]="UV0",Bi[Bi.UV1=1]="UV1",Bi[Bi.UV2=2]="UV2",Bi[Bi.UV3=3]="UV3",Bi[Bi.UV4=4]="UV4",Bi[Bi.UV5=5]="UV5",Bi[Bi.UV6=6]="UV6",Bi[Bi.UV7=7]="UV7";var Oi=function(t){function r(n,i){var a;return(a=t.call(this,n,i)||this)._renderFace=e.RenderFace.Front,a._isTransparent=!1,a._blendMode=void 0,a.blendMode=e.BlendMode.Normal,a.shaderData.setFloat(r._alphaCutoffProp,0),a}E(r,t);var n=r.prototype;return n.clone=function(){var e=new r(this._engine,this.shader);return this.cloneTo(e),e},n.cloneTo=function(e){t.prototype.cloneTo.call(this,e),e._renderFace=this._renderFace,e._isTransparent=this._isTransparent,e._blendMode=this._blendMode},A(r,[{key:"isTransparent",get:function(){return this._isTransparent},set:function(t){if(t!==this._isTransparent){this._isTransparent=t;var n=this.renderState,i=n.depthState,a=n.blendState.targetBlendState;t?(a.enabled=!0,i.writeEnabled=!1,this.renderQueueType=e.RenderQueueType.Transparent):(a.enabled=!1,i.writeEnabled=!0,this.renderQueueType=this.shaderData.getFloat(r._alphaCutoffProp)?e.RenderQueueType.AlphaTest:e.RenderQueueType.Opaque)}}},{key:"alphaCutoff",get:function(){return this.shaderData.getFloat(r._alphaCutoffProp)},set:function(t){this.shaderData.setFloat(r._alphaCutoffProp,t),t>0?(this.shaderData.enableMacro(r._alphaCutoffMacro),this.renderQueueType=this._isTransparent?e.RenderQueueType.Transparent:e.RenderQueueType.AlphaTest):(this.shaderData.disableMacro(r._alphaCutoffMacro),this.renderQueueType=this._isTransparent?e.RenderQueueType.Transparent:e.RenderQueueType.Opaque)}},{key:"renderFace",get:function(){return this._renderFace},set:function(t){if(t!==this._renderFace)switch(this._renderFace=t,t){case e.RenderFace.Front:this.renderState.rasterState.cullMode=e.CullMode.Back;break;case e.RenderFace.Back:this.renderState.rasterState.cullMode=e.CullMode.Front;break;case e.RenderFace.Double:this.renderState.rasterState.cullMode=e.CullMode.Off}}},{key:"blendMode",get:function(){return this._blendMode},set:function(t){if(t!==this._blendMode){this._blendMode=t;var r=this.renderState.blendState.targetBlendState;switch(t){case e.BlendMode.Normal:r.sourceColorBlendFactor=e.BlendFactor.SourceAlpha,r.destinationColorBlendFactor=e.BlendFactor.OneMinusSourceAlpha,r.sourceAlphaBlendFactor=e.BlendFactor.One,r.destinationAlphaBlendFactor=e.BlendFactor.OneMinusSourceAlpha,r.colorBlendOperation=r.alphaBlendOperation=e.BlendOperation.Add;break;case e.BlendMode.Additive:r.sourceColorBlendFactor=e.BlendFactor.SourceAlpha,r.destinationColorBlendFactor=e.BlendFactor.One,r.sourceAlphaBlendFactor=e.BlendFactor.One,r.destinationAlphaBlendFactor=e.BlendFactor.OneMinusSourceAlpha,r.colorBlendOperation=r.alphaBlendOperation=e.BlendOperation.Add}}}}]),r}(gr);Oi._alphaCutoffMacro=zt.getMacroByName("ALPHA_CUTOFF"),Oi._alphaCutoffProp=zt.getPropertyByName("u_alphaCutoff");var zi=function(e){function t(r){var n,i=(n=e.call(this,r,zt.find("blinn-phong"))||this).shaderData;return i.enableMacro("O3_NEED_WORLDPOS"),i.enableMacro("O3_NEED_TILINGOFFSET"),i.setColor(t._diffuseColorProp,new T(1,1,1,1)),i.setColor(t._specularColorProp,new T(1,1,1,1)),i.setColor(t._emissiveColorProp,new T(0,0,0,1)),i.setVector4(t._tilingOffsetProp,new v(1,1,0,0)),i.setFloat(t._shininessProp,16),i.setFloat(t._normalIntensityProp,1),n}return E(t,e),t.prototype.clone=function(){var e=new t(this._engine);return this.cloneTo(e),e},A(t,[{key:"baseColor",get:function(){return this.shaderData.getColor(t._diffuseColorProp)},set:function(e){var r=this.shaderData.getColor(t._diffuseColorProp);e!==r&&e.cloneTo(r)}},{key:"baseTexture",get:function(){return this.shaderData.getTexture(t._baseTextureProp)},set:function(e){this.shaderData.setTexture(t._baseTextureProp,e),e?this.shaderData.enableMacro("O3_DIFFUSE_TEXTURE"):this.shaderData.disableMacro("O3_DIFFUSE_TEXTURE")}},{key:"specularColor",get:function(){return this.shaderData.getColor(t._specularColorProp)},set:function(e){var r=this.shaderData.getColor(t._specularColorProp);e!==r&&e.cloneTo(r)}},{key:"specularTexture",get:function(){return this.shaderData.getTexture(t._specularTextureProp)},set:function(e){this.shaderData.setTexture(t._specularTextureProp,e),e?this.shaderData.enableMacro("O3_SPECULAR_TEXTURE"):this.shaderData.disableMacro("O3_SPECULAR_TEXTURE")}},{key:"emissiveColor",get:function(){return this.shaderData.getColor(t._emissiveColorProp)},set:function(e){var r=this.shaderData.getColor(t._emissiveColorProp);e!==r&&e.cloneTo(r)}},{key:"emissiveTexture",get:function(){return this.shaderData.getTexture(t._emissiveTextureProp)},set:function(e){this.shaderData.setTexture(t._emissiveTextureProp,e),e?this.shaderData.enableMacro("O3_EMISSIVE_TEXTURE"):this.shaderData.disableMacro("O3_EMISSIVE_TEXTURE")}},{key:"normalTexture",get:function(){return this.shaderData.getTexture(t._normalTextureProp)},set:function(e){this.shaderData.setTexture(t._normalTextureProp,e),e?this.shaderData.enableMacro("O3_NORMAL_TEXTURE"):this.shaderData.disableMacro("O3_NORMAL_TEXTURE")}},{key:"normalIntensity",get:function(){return this.shaderData.getFloat(t._normalIntensityProp)},set:function(e){this.shaderData.setFloat(t._normalIntensityProp,e)}},{key:"shininess",get:function(){return this.shaderData.getFloat(t._shininessProp)},set:function(e){this.shaderData.setFloat(t._shininessProp,Math.max(e,1e-4))}},{key:"tilingOffset",get:function(){return this.shaderData.getVector4(t._tilingOffsetProp)},set:function(e){var r=this.shaderData.getVector4(t._tilingOffsetProp);e!==r&&e.cloneTo(r)}}]),t}(Oi);zi._diffuseColorProp=zt.getPropertyByName("u_diffuseColor"),zi._specularColorProp=zt.getPropertyByName("u_specularColor"),zi._emissiveColorProp=zt.getPropertyByName("u_emissiveColor"),zi._tilingOffsetProp=zt.getPropertyByName("u_tilingOffset"),zi._shininessProp=zt.getPropertyByName("u_shininess"),zi._normalIntensityProp=zt.getPropertyByName("u_normalIntensity"),zi._baseTextureProp=zt.getPropertyByName("u_diffuseTexture"),zi._specularTextureProp=zt.getPropertyByName("u_specularTexture"),zi._emissiveTextureProp=zt.getPropertyByName("u_emissiveTexture"),zi._normalTextureProp=zt.getPropertyByName("u_normalTexture");var Vi=function(t){function r(n,i){var a,o=(a=t.call(this,n,i)||this).shaderData;return o.enableMacro("O3_NEED_WORLDPOS"),o.enableMacro("O3_NEED_TILINGOFFSET"),o.setColor(r._baseColorProp,new T(1,1,1,1)),o.setColor(r._emissiveColorProp,new T(0,0,0,1)),o.setVector4(r._tilingOffsetProp,new v(1,1,0,0)),o.setFloat(r._normalTextureIntensityProp,1),o.setFloat(r._occlusionTextureIntensityProp,1),o.setFloat(r._occlusionTextureCoordProp,e.TextureCoordinate.UV0),o.setFloat(r._clearCoatProp,0),o.setFloat(r._clearCoatRoughnessProp,0),a}return E(r,t),A(r,[{key:"baseColor",get:function(){return this.shaderData.getColor(r._baseColorProp)},set:function(e){var t=this.shaderData.getColor(r._baseColorProp);e!==t&&e.cloneTo(t)}},{key:"baseTexture",get:function(){return this.shaderData.getTexture(r._baseTextureProp)},set:function(e){this.shaderData.setTexture(r._baseTextureProp,e),e?this.shaderData.enableMacro("HAS_BASECOLORMAP"):this.shaderData.disableMacro("HAS_BASECOLORMAP")}},{key:"normalTexture",get:function(){return this.shaderData.getTexture(r._normalTextureProp)},set:function(e){this.shaderData.setTexture(r._normalTextureProp,e),e?this.shaderData.enableMacro("O3_NORMAL_TEXTURE"):this.shaderData.disableMacro("O3_NORMAL_TEXTURE")}},{key:"normalTextureIntensity",get:function(){return this.shaderData.getFloat(r._normalTextureIntensityProp)},set:function(e){this.shaderData.setFloat(r._normalTextureIntensityProp,e)}},{key:"emissiveColor",get:function(){return this.shaderData.getColor(r._emissiveColorProp)},set:function(e){var t=this.shaderData.getColor(r._emissiveColorProp);e!==t&&e.cloneTo(t)}},{key:"emissiveTexture",get:function(){return this.shaderData.getTexture(r._emissiveTextureProp)},set:function(e){this.shaderData.setTexture(r._emissiveTextureProp,e),e?this.shaderData.enableMacro("HAS_EMISSIVEMAP"):this.shaderData.disableMacro("HAS_EMISSIVEMAP")}},{key:"occlusionTexture",get:function(){return this.shaderData.getTexture(r._occlusionTextureProp)},set:function(e){this.shaderData.setTexture(r._occlusionTextureProp,e),e?this.shaderData.enableMacro("HAS_OCCLUSIONMAP"):this.shaderData.disableMacro("HAS_OCCLUSIONMAP")}},{key:"occlusionTextureIntensity",get:function(){return this.shaderData.getFloat(r._occlusionTextureIntensityProp)},set:function(e){this.shaderData.setFloat(r._occlusionTextureIntensityProp,e)}},{key:"occlusionTextureCoord",get:function(){return this.shaderData.getFloat(r._occlusionTextureCoordProp)},set:function(t){t>e.TextureCoordinate.UV1&&re.warn("Occlusion texture uv coordinate must be UV0 or UV1."),this.shaderData.setFloat(r._occlusionTextureCoordProp,t)}},{key:"tilingOffset",get:function(){return this.shaderData.getVector4(r._tilingOffsetProp)},set:function(e){var t=this.shaderData.getVector4(r._tilingOffsetProp);e!==t&&e.cloneTo(t)}},{key:"clearCoat",get:function(){return this.shaderData.getFloat(r._clearCoatProp)},set:function(e){!!this.shaderData.getFloat(r._clearCoatProp)!=!!e&&(0===e?this.shaderData.disableMacro("CLEARCOAT"):this.shaderData.enableMacro("CLEARCOAT")),this.shaderData.setFloat(r._clearCoatProp,e)}},{key:"clearCoatTexture",get:function(){return this.shaderData.getTexture(r._clearCoatTextureProp)},set:function(e){this.shaderData.setTexture(r._clearCoatTextureProp,e),e?this.shaderData.enableMacro("HAS_CLEARCOATTEXTURE"):this.shaderData.disableMacro("HAS_CLEARCOATTEXTURE")}},{key:"clearCoatRoughness",get:function(){return this.shaderData.getFloat(r._clearCoatRoughnessProp)},set:function(e){this.shaderData.setFloat(r._clearCoatRoughnessProp,e)}},{key:"clearCoatRoughnessTexture",get:function(){return this.shaderData.getTexture(r._clearCoatRoughnessTextureProp)},set:function(e){this.shaderData.setTexture(r._clearCoatRoughnessTextureProp,e),e?this.shaderData.enableMacro("HAS_CLEARCOATROUGHNESSTEXTURE"):this.shaderData.disableMacro("HAS_CLEARCOATROUGHNESSTEXTURE")}},{key:"clearCoatNormalTexture",get:function(){return this.shaderData.getTexture(r._clearCoatNormalTextureProp)},set:function(e){this.shaderData.setTexture(r._clearCoatNormalTextureProp,e),e?this.shaderData.enableMacro("HAS_CLEARCOATNORMALTEXTURE"):this.shaderData.disableMacro("HAS_CLEARCOATNORMALTEXTURE")}}]),r}(Oi);Vi._baseColorProp=zt.getPropertyByName("u_baseColor"),Vi._emissiveColorProp=zt.getPropertyByName("u_emissiveColor"),Vi._tilingOffsetProp=zt.getPropertyByName("u_tilingOffset"),Vi._baseTextureProp=zt.getPropertyByName("u_baseColorSampler"),Vi._normalTextureProp=zt.getPropertyByName("u_normalTexture"),Vi._normalTextureIntensityProp=zt.getPropertyByName("u_normalIntensity"),Vi._occlusionTextureIntensityProp=zt.getPropertyByName("u_occlusionStrength"),Vi._occlusionTextureCoordProp=zt.getPropertyByName("u_occlusionTextureCoord"),Vi._emissiveTextureProp=zt.getPropertyByName("u_emissiveSampler"),Vi._occlusionTextureProp=zt.getPropertyByName("u_occlusionSampler"),Vi._clearCoatProp=zt.getPropertyByName("u_clearCoat"),Vi._clearCoatTextureProp=zt.getPropertyByName("u_clearCoatTexture"),Vi._clearCoatRoughnessProp=zt.getPropertyByName("u_clearCoatRoughness"),Vi._clearCoatRoughnessTextureProp=zt.getPropertyByName("u_clearCoatRoughnessTexture"),Vi._clearCoatNormalTextureProp=zt.getPropertyByName("u_clearCoatNormalTexture");var Ni=function(e){function t(r){var n;return(n=e.call(this,r,zt.find("pbr"))||this).shaderData.setFloat(t._metallicProp,1),n.shaderData.setFloat(t._roughnessProp,1),n}return E(t,e),t.prototype.clone=function(){var e=new t(this._engine);return this.cloneTo(e),e},A(t,[{key:"metallic",get:function(){return this.shaderData.getFloat(t._metallicProp)},set:function(e){this.shaderData.setFloat(t._metallicProp,e)}},{key:"roughness",get:function(){return this.shaderData.getFloat(t._roughnessProp)},set:function(e){this.shaderData.setFloat(t._roughnessProp,e)}},{key:"roughnessMetallicTexture",get:function(){return this.shaderData.getTexture(t._metallicRoughnessTextureProp)},set:function(e){this.shaderData.setTexture(t._metallicRoughnessTextureProp,e),e?this.shaderData.enableMacro("HAS_METALROUGHNESSMAP"):this.shaderData.disableMacro("HAS_METALROUGHNESSMAP")}}]),t}(Vi);Ni._metallicProp=zt.getPropertyByName("u_metal"),Ni._roughnessProp=zt.getPropertyByName("u_roughness"),Ni._metallicRoughnessTextureProp=zt.getPropertyByName("u_metallicRoughnessSampler");var Ui=function(e){function t(r){var n;return(n=e.call(this,r,zt.find("pbr-specular"))||this).shaderData.setColor(t._specularColorProp,new T(1,1,1,1)),n.shaderData.setFloat(t._glossinessProp,1),n}return E(t,e),t.prototype.clone=function(){var e=new t(this._engine);return this.cloneTo(e),e},A(t,[{key:"specularColor",get:function(){return this.shaderData.getColor(t._specularColorProp)},set:function(e){var r=this.shaderData.getColor(t._specularColorProp);e!==r&&e.cloneTo(r)}},{key:"glossiness",get:function(){return this.shaderData.getFloat(t._glossinessProp)},set:function(e){this.shaderData.setFloat(t._glossinessProp,e)}},{key:"specularGlossinessTexture",get:function(){return this.shaderData.getTexture(t._specularGlossinessTextureProp)},set:function(e){this.shaderData.setTexture(t._specularGlossinessTextureProp,e),e?this.shaderData.enableMacro("HAS_SPECULARGLOSSINESSMAP"):this.shaderData.disableMacro("HAS_SPECULARGLOSSINESSMAP")}}]),t}(Vi);Ui._specularColorProp=zt.getPropertyByName("u_specularColor"),Ui._glossinessProp=zt.getPropertyByName("u_glossiness"),Ui._specularGlossinessTextureProp=zt.getPropertyByName("u_specularGlossinessSampler");var ki,Gi,Hi,Wi,ji=function(e){function t(r){var n,i=(n=e.call(this,r,zt.find("unlit"))||this).shaderData;return i.enableMacro("OMIT_NORMAL"),i.enableMacro("O3_NEED_TILINGOFFSET"),i.setColor(t._baseColorProp,new T(1,1,1,1)),i.setVector4(t._tilingOffsetProp,new v(1,1,0,0)),n}return E(t,e),t.prototype.clone=function(){var e=new t(this._engine);return this.cloneTo(e),e},A(t,[{key:"baseColor",get:function(){return this.shaderData.getColor(t._baseColorProp)},set:function(e){var r=this.shaderData.getColor(t._baseColorProp);e!==r&&e.cloneTo(r)}},{key:"baseTexture",get:function(){return this.shaderData.getTexture(t._baseTextureProp)},set:function(e){this.shaderData.setTexture(t._baseTextureProp,e),e?this.shaderData.enableMacro("O3_BASE_TEXTURE"):this.shaderData.disableMacro("O3_BASE_TEXTURE")}},{key:"tilingOffset",get:function(){return this.shaderData.getVector4(t._tilingOffsetProp)},set:function(e){var r=this.shaderData.getVector4(t._tilingOffsetProp);e!==r&&e.cloneTo(r)}}]),t}(Oi);ji._baseColorProp=zt.getPropertyByName("u_baseColor"),ji._baseTextureProp=zt.getPropertyByName("u_baseTexture"),ji._tilingOffsetProp=zt.getPropertyByName("u_tilingOffset"),e.TextHorizontalAlignment=void 0,(ki=e.TextHorizontalAlignment||(e.TextHorizontalAlignment={}))[ki.Left=0]="Left",ki[ki.Center=1]="Center",ki[ki.Right=2]="Right",e.TextVerticalAlignment=void 0,(Gi=e.TextVerticalAlignment||(e.TextVerticalAlignment={}))[Gi.Top=0]="Top",Gi[Gi.Center=1]="Center",Gi[Gi.Bottom=2]="Bottom",e.OverflowMode=void 0,(Hi=e.OverflowMode||(e.OverflowMode={}))[Hi.Overflow=0]="Overflow",Hi[Hi.Truncate=1]="Truncate",e.FontStyle=void 0,(Wi=e.FontStyle||(e.FontStyle={}))[Wi.None=0]="None",Wi[Wi.Bold=1]="Bold",Wi[Wi.Italic=2]="Italic";var Xi,Ki,qi,Yi,Qi,Ji,Zi,$i,ea,ta,ra,na,ia,aa,oa,sa,la,ua=function(e){E(r,e);var t=r.prototype;function r(t){var r;return(r=e.call(this,t)||this)._sprites=new Array,r._spriteNamesToIndex={},r}return t.getSprite=function(e){var t=this._sprites[this._spriteNamesToIndex[e]];return t||console.warn("There is no sprite named "+e+" in the atlas."),t},t.getSprites=function(e,t){t.length=0;var r=this._spriteNamesToIndex[e];if(void 0!==r)for(var n=this._sprites;r>=0;r--){var i=n[r];i.name===e&&t.push(i)}else console.warn("The name of the sprite you want to find is not exit in SpriteAtlas.");return t},t._addSprite=function(e){this._spriteNamesToIndex[e.name]=this._sprites.push(e)-1},t._onDestroy=function(){this._sprites=null,this._spriteNamesToIndex=null},A(r,[{key:"sprites",get:function(){return this._sprites}}]),r}(Q),ca=function(e){function t(r,n,i,a,o,s){var u;return void 0===n&&(n=null),void 0===i&&(i=null),void 0===a&&(a=null),void 0===o&&(o=128),void 0===s&&(s=null),(u=e.call(this,r)||this).name=void 0,u._uv=[new g,new g,new g,new g],u._positions=[new g,new g,new g,new g],u._bounds=new l,u._triangles=void 0,u._assetID=void 0,u._pixelsPerUnit=void 0,u._texture=null,u._atlasRotated=!1,u._region=new w(0,0,1,1),u._pivot=new g(.5,.5),u._atlasRegion=new w(0,0,1,1),u._atlasRegionOffset=new v(0,0,0,0),u._dirtyFlag=Xi.all,u._updateFlagManager=new Ze,u.name=s,u._texture=n,u._pixelsPerUnit=o,i&&i.cloneTo(u._region),a&&a.cloneTo(u._pivot),u._triangles=t._rectangleTriangles,u}E(t,e);var r=t.prototype;return r.clone=function(){var e=new t(this._engine,this._texture,this._region,this._pivot,this._pixelsPerUnit,this.name);return e._assetID=this._assetID,e._atlasRotated=this._atlasRotated,this._atlasRegion.cloneTo(e._atlasRegion),this._atlasRegionOffset.cloneTo(e._atlasRegionOffset),e},r._registerUpdateFlag=function(){return this._updateFlagManager.createFlag(Qe)},r._onDestroy=function(){this._texture&&(this._texture=null)},r._updatePositionsAndBounds=function(){var e=this._texture,t=this._bounds;if(e){var r,n,i,a,o,s,l=this._atlasRegion,u=this._pivot,c=this._atlasRegionOffset,h=this._region,d=h.x,_=h.y,f=h.width,p=h.height,g=1/this._pixelsPerUnit;if(this._atlasRotated?(o=e.height*l.height*g,s=e.width*l.width*g):(o=e.width*l.width*g,s=e.height*l.height*g),0==c.x&&0==c.y&&0==c.z&&0==c.w){var v=o*f,m=s*p;i=v+(r=-u.x*v),n=m+(a=-u.y*m)}else{var y=c.x,x=c.y,T=c.z,w=c.w,b=o/(1-T-y),C=s/(1-w-x);r=(-u.x*f+Math.max(y,d)-d)*b,n=(u.y*p-Math.max(x,_)+_)*C,i=(-u.x*f+Math.min(1-T,d+f)-d)*b,a=(u.y*p-Math.min(1-w,_+p)+_)*C}var S=this._positions;S[0].setValue(r,n),S[1].setValue(i,n),S[2].setValue(i,a),S[3].setValue(r,a),t.min.setValue(r,a,0),t.max.setValue(i,n,0)}else t.min.setValue(0,0,0),t.max.setValue(0,0,0)},r._updateMesh=function(){if(this._isContainDirtyFlag(Xi.positions)&&this._updatePositionsAndBounds(),this._isContainDirtyFlag(Xi.uv)){var e,t,r,n,i=this._atlasRegion,a=this._uv,o=this._region,s=this._atlasRotated,l=this._atlasRegionOffset;if(0==l.x&&0==l.y&&0==l.z&&0==l.w){var u=i.width,c=i.height;s?(e=u*(1-o.y-o.height)+i.x,t=c*o.x+i.y,r=u*o.height+e,n=c*o.width+t):(e=u*o.x+i.x,t=c*o.y+i.y,r=u*o.width+e,n=c*o.height+t)}else{var h=o.x,d=o.y,_=i.x,f=i.y,p=l.x,g=l.y,v=l.z,m=l.w;if(s){var y=i.width/(1-m-g),x=i.height/(1-v-p);e=(Math.max(m,1-d-o.height)-m)*y+_,t=(Math.max(p,h)-p)*x+f,r=(Math.min(1-g,1-d)-m)*y+_,n=(Math.min(1-v,h+o.width)-p)*x+f}else{var T=i.width/(1-v-p),w=i.height/(1-m-g);e=(Math.max(p,h)-p)*T+_,t=(Math.max(g,d)-g)*w+f,r=(Math.min(1-v,h+o.width)-p)*T+_,n=(Math.min(1-m,d+o.height)-g)*w+f}}s?(a[0].setValue(r,t),a[1].setValue(r,n),a[2].setValue(e,n),a[3].setValue(e,t)):(a[0].setValue(e,t),a[1].setValue(r,t),a[2].setValue(r,n),a[3].setValue(e,n))}this._setDirtyFlagFalse(Xi.all)},r._isContainDirtyFlag=function(e){return 0!=(this._dirtyFlag&e)},r._setDirtyFlagTrue=function(e){this._dirtyFlag|=e,this._updateFlagManager.dispatch()},r._setDirtyFlagFalse=function(e){this._dirtyFlag&=~e},A(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture!==e&&(this._texture=e,this._setDirtyFlagTrue(Xi.positions))}},{key:"bounds",get:function(){return this._isContainDirtyFlag(Xi.positions)&&this._texture&&(this._updatePositionsAndBounds(),this._setDirtyFlagFalse(Xi.positions)),this._bounds}},{key:"atlasRotated",get:function(){return this._atlasRotated},set:function(e){this._atlasRotated!=e&&(this._atlasRotated=e,this._setDirtyFlagTrue(Xi.positions|Xi.uv))}},{key:"atlasRegion",get:function(){return this._atlasRegion},set:function(e){var t=a.clamp(e.x,0,1),r=a.clamp(e.y,0,1);this._atlasRegion.setValue(t,r,a.clamp(e.width,0,1-t),a.clamp(e.height,0,1-r)),this._setDirtyFlagTrue(Xi.positions|Xi.uv)}},{key:"atlasRegionOffset",get:function(){return this._atlasRegionOffset},set:function(e){var t=a.clamp(e.x,0,1),r=a.clamp(e.y,0,1);this._atlasRegionOffset.setValue(t,r,a.clamp(e.z,0,1-t),a.clamp(e.w,0,1-r)),this._setDirtyFlagTrue(Xi.positions|Xi.uv)}},{key:"pivot",get:function(){return this._pivot},set:function(e){var t=this._pivot,r=a.clamp(e.x,0,1),n=a.clamp(e.y,0,1);t!==e&&t.x===r&&t.y===n||(t.setValue(r,n),this._setDirtyFlagTrue(Xi.positions))}},{key:"region",get:function(){return this._region},set:function(e){var t=this._region,r=a.clamp(e.x,0,1),n=a.clamp(e.y,0,1);t.setValue(r,n,a.clamp(e.width,0,1-r),a.clamp(e.height,0,1-n)),this._setDirtyFlagTrue(Xi.positions|Xi.uv)}},{key:"pixelsPerUnit",get:function(){return this._pixelsPerUnit},set:function(e){this._pixelsPerUnit!==e&&(this._pixelsPerUnit=e,this._setDirtyFlagTrue(Xi.positions))}}]),t}(Q);ca._rectangleTriangles=[0,2,1,2,0,3],function(e){e[e.positions=1]="positions",e[e.uv=2]="uv",e[e.all=3]="all"}(Xi||(Xi={}));var ha,da=((la=function(t){function r(e){var r;return V(r=t.call(this,e)||this,"_customLocalBounds",qi,O(r)),V(r,"_customRootEntity",Yi,O(r)),V(r,"_positions",Qi,O(r)),V(r,"_sprite",Ji,O(r)),V(r,"_color",Zi,O(r)),V(r,"_flipX",$i,O(r)),V(r,"_flipY",ea,O(r)),V(r,"_cacheFlipX",ta,O(r)),V(r,"_cacheFlipY",ra,O(r)),V(r,"_dirtyFlag",na,O(r)),V(r,"_isWorldMatrixDirty",ia,O(r)),V(r,"_spriteDirty",aa,O(r)),V(r,"_maskInteraction",oa,O(r)),V(r,"_maskLayer",sa,O(r)),r._isWorldMatrixDirty=e.transform.registerWorldChangeFlag(),r.setMaterial(r._engine._spriteDefaultMaterial),r}E(r,t);var n=r.prototype;return n._render=function(e){var t=this.sprite;if(t){var n=t.texture;if(n){var i=this._positions,a=this.entity.transform;if(t._updateMesh(),this._isWorldMatrixDirty.flag||this._spriteDirty.flag){for(var s=t._positions,l=r._tempVec3,u=a.worldMatrix,c=this.flipX,h=this.flipY,d=0,_=i.length;d<_;d++){var f=s[d];l.setValue(c?-f.x:f.x,h?-f.y:f.y,0),o.transformToVec3(l,u,i[d])}this._setDirtyFlagFalse(ha.Flip),this._isWorldMatrixDirty.flag=!1,this._spriteDirty.flag=!1,this._cacheFlipX=c,this._cacheFlipY=h}else if(this._isContainDirtyFlag(ha.Flip)){var p=this.flipX,g=this.flipY,v=this._cacheFlipX!==p,m=this._cacheFlipY!==g;if(v||m)for(var y=a.worldPosition,x=y.x,T=y.y,w=0,b=i.length;w<b;w++){var C=i[w];v&&(C.x=2*x-C.x),m&&(C.y=2*T-C.y)}this._setDirtyFlagFalse(ha.Flip),this._cacheFlipX=p,this._cacheFlipY=g}this._isContainDirtyFlag(ha.MaskInteraction)&&(this._updateStencilState(),this._setDirtyFlagFalse(ha.MaskInteraction)),this.shaderData.setTexture(r._textureProperty,n);var S=this.getMaterial(),M=this._engine._spriteElementPool.getFromPool();M.setValue(this,i,t._uv,t._triangles,this.color,S,e),e._renderPipeline.pushPrimitive(M)}}},n._onDestroy=function(){this._isWorldMatrixDirty.destroy(),this._spriteDirty&&this._spriteDirty.destroy(),t.prototype._onDestroy.call(this)},n._isContainDirtyFlag=function(e){return 0!=(this._dirtyFlag&e)},n._setDirtyFlagTrue=function(e){this._dirtyFlag|=e},n._setDirtyFlagFalse=function(e){this._dirtyFlag&=~e},n._cloneTo=function(e){e.sprite=this._sprite},n._updateBounds=function(e){var t=this._sprite;if(t)if(this._customLocalBounds&&this._customRootEntity){var r=this._customRootEntity.transform.worldMatrix;l.transform(this._customLocalBounds,r,e)}else{var n=t.bounds,i=this._entity.transform.worldMatrix;l.transform(n,i,e)}else e.min.setValue(0,0,0),e.max.setValue(0,0,0)},n._updateStencilState=function(){var t=this.getInstanceMaterial().renderState.stencilState,r=this._maskInteraction;if(r===e.SpriteMaskInteraction.None)t.enabled=!1,t.writeMask=255,t.referenceValue=0,t.compareFunctionFront=t.compareFunctionBack=e.CompareFunction.Always;else{t.enabled=!0,t.writeMask=0,t.referenceValue=1;var n=r===e.SpriteMaskInteraction.VisibleInsideMask?e.CompareFunction.LessEqual:e.CompareFunction.Greater;t.compareFunctionFront=n,t.compareFunctionBack=n}},A(r,[{key:"sprite",get:function(){return this._sprite},set:function(e){this._sprite!==e&&(this._spriteDirty&&this._spriteDirty.destroy(),this._sprite=e,e&&(this._spriteDirty=e._registerUpdateFlag()))}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&e.cloneTo(this._color)}},{key:"flipX",get:function(){return this._flipX},set:function(e){this._flipX!==e&&(this._flipX=e,this._setDirtyFlagTrue(ha.Flip))}},{key:"flipY",get:function(){return this._flipY},set:function(e){this._flipY!==e&&(this._flipY=e,this._setDirtyFlagTrue(ha.Flip))}},{key:"maskInteraction",get:function(){return this._maskInteraction},set:function(e){this._maskInteraction!==e&&(this._maskInteraction=e,this._setDirtyFlagTrue(ha.MaskInteraction))}},{key:"maskLayer",get:function(){return this._maskLayer},set:function(e){this._maskLayer=e}}]),r}(Rr))._textureProperty=zt.getPropertyByName("u_spriteTexture"),la._tempVec3=new o,qi=N((Ki=la).prototype,"_customLocalBounds",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Yi=N(Ki.prototype,"_customRootEntity",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Qi=N(Ki.prototype,"_positions",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new o,new o,new o,new o]}}),Ji=N(Ki.prototype,"_sprite",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Zi=N(Ki.prototype,"_color",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new T(1,1,1,1)}}),$i=N(Ki.prototype,"_flipX",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ea=N(Ki.prototype,"_flipY",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ta=N(Ki.prototype,"_cacheFlipX",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ra=N(Ki.prototype,"_cacheFlipY",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),na=N(Ki.prototype,"_dirtyFlag",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ia=N(Ki.prototype,"_isWorldMatrixDirty",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),aa=N(Ki.prototype,"_spriteDirty",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),oa=N(Ki.prototype,"_maskInteraction",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return e.SpriteMaskInteraction.None}}),sa=N(Ki.prototype,"_maskLayer",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return e.SpriteMaskLayer.Layer0}}),Ki);!function(e){e[e.Flip=1]="Flip",e[e.MaskInteraction=2]="MaskInteraction"}(ha||(ha={}));var _a=function(e){function t(t,r){var n;return void 0===r&&(r=""),(n=e.call(this,t)||this)._name="",n._name=r,n}return E(t,e),t.createFromOS=function(e,r){void 0===r&&(r="");var n=t._fontMap,i=n[r];return i||(i=new t(e,r),n[r]=i,i)},t.prototype._onDestroy=function(){},A(t,[{key:"name",get:function(){return this._name}}]),t}(Q);_a._fontMap={};var fa,pa,ga,va,ma,ya,xa,Ta,wa,ba,Ca,Sa,Ma,Aa,Pa,Fa,Ea,Ra,La,Ba,Da,Ia,Oa=function(){function t(){}return t.textContext=function(){var e=t._textContext;if(!e){var r;try{r=new OffscreenCanvas(0,0)}catch(e){r=document.createElement("canvas")}var n=r.getContext("2d");e={canvas:r,context:n},t._textContext=e}return e},t.measureFont=function(e){var r=t._fontSizeCache,n=r[e];if(n)return n;var i=t.textContext(),a=i.canvas,o=i.context;o.font=e;var s=t._measureString,l=Math.ceil(o.measureText(s).width),u=Math.ceil(o.measureText(t._measureBaseline).width),c=u*t._heightMultiplier;u=t._baselineMultiplier*u|0,a.width=l,a.height=c,o.font=e,o.fillStyle="#000",o.clearRect(0,0,l,c),o.textBaseline="alphabetic",o.fillStyle="#f00",o.fillText(s,0,u);var h=o.getImageData(0,0,l,c).data,d=4*l,_=!1,f=0,p=0;for(f=0;f<u;++f){p=f*d;for(var g=0;g<d;g+=4)if(0!==h[p+g]){_=!0;break}if(_)break}var v=u-f;for(_=!1,f=c-1;f>=u;--f){p=f*d;for(var m=0;m<d;m+=4)if(0!==h[p+m]){_=!0;break}if(_)break}return n=v+(f-u+1),r[e]=n,n},t.measureText=function(r,n,i,a,o,s,l){var u=t._pixelsPerUnit,c=t.measureFont(l),h=t.textContext().context,d=t._wordWrap(r,n,o,l),_=d.length,f=new Array,p=c+a*u;h.font=l;for(var g=0,v=0;v<_;++v){var m=Math.ceil(h.measureText(d[v]).width);m>g&&(g=m),f.push(m)}var y=i*u;return s===e.OverflowMode.Overflow&&(y=Math.min(p*_,t._maxHeight)),{width:g,height:y,lines:d,lineWidths:f,lineHeight:p}},t.trimCanvas=function(){for(var e,r,n=t.textContext(),i=n.canvas,a=n.context,o=i.width,s=i.height,l=a.getImageData(0,0,o,s).data,u=l.length,c=-1,h=-1,d=o,_=-1,f=null,p=0;p<u;p+=4)if(0!==l[p+3]){var g=p/4;r=~~(g/o),-1===c&&(c=r),(e=g%o)<d&&(d=e),e>_&&(_=e),r>h&&(h=r)}return-1!==c&&(c=Math.max(0,c-1),h=Math.min(s-1,h+1),d=Math.max(0,d-1),o=(_=Math.min(o-1,_+1))-d+1,s=h-c+1,f=a.getImageData(d,c,o,s)),{width:o,height:s,data:f}},t.getNativeFontString=function(r,n,i){var a=i&e.FontStyle.Bold?"bold ":"";return i&e.FontStyle.Italic&&(a+="italic "),/([\"\'])[^\'\"]+\1/.test(r)||-1!=t._genericFontFamilies.indexOf(r)||(r='"'+r+'"'),a+(n+"px ")+r},t.updateText=function(e,r,n,i){var a=t.textContext(),o=a.canvas,s=a.context,l=e.width,u=e.height;o.width=l,o.height=u,s.font=r,s.clearRect(0,0,l,u),s.textBaseline="middle",s.fillStyle="#fff";for(var c=e.lines,h=e.lineHeight,d=e.lineWidths,_=.5*h,f=0,p=c.length;f<p;++f){var g=d[f],v=t._tempVec2;t._calculateLinePosition(l,u,g,h,f,p,n,i,v);var m=v.x,y=v.y;y+h>=0&&y<u&&s.fillText(c[f],m,y+_)}},t.updateCanvas=function(e,r,n){var i=t.textContext(),a=i.canvas,o=i.context;return a.width=e,a.height=r,o.putImageData(n,0,0),a},t._wordWrap=function(e,r,n,i){var a=t.textContext().context,o=t._maxWidth,s=r*t._pixelsPerUnit,l=Math.min(s,o),u=new Array,c=e.split(/(?:\r\n|\r|\n)/);a.font=i;for(var h=0,d=c.length;h<d;++h){var _=c[h],f=Math.ceil(a.measureText(_).width);if(n||f>o)if(f<=l)u.push(_);else{for(var p="",g=0,v=0,m=_.length;v<m;++v){var y=_[v],x=Math.ceil(a.measureText(y).width);g+x>l?0===g?u.push(y):(u.push(p),p=y,g=x):(p+=y,g+=x)}g>0&&u.push(p)}else u.push(_)}return u},t._calculateLinePosition=function(t,r,n,i,a,o,s,l,u){switch(l){case e.TextVerticalAlignment.Top:u.y=a*i;break;case e.TextVerticalAlignment.Bottom:u.y=r-(o-a)*i;break;default:u.y=.5*r-.5*o*i+a*i}switch(s){case e.TextHorizontalAlignment.Left:u.x=0;break;case e.TextHorizontalAlignment.Right:u.x=t-n;break;default:u.x=.5*(t-n)}},t}();Oa._genericFontFamilies=["serif","sans-serif","monospace","cursive","fantasy","system-ui","math","emoji","fangsong"],Oa._measureString="|ÉqÅ",Oa._measureBaseline="M",Oa._heightMultiplier=2,Oa._baselineMultiplier=1.4,Oa._maxWidth=2048,Oa._maxHeight=2048,Oa._pixelsPerUnit=128,Oa._fontSizeCache={},Oa._textContext=null,Oa._tempVec2=new g;var za,Va=((Ia=function(t){function r(e){var r;V(r=t.call(this,e)||this,"_customLocalBounds",pa,O(r)),V(r,"_customRootEntity",ga,O(r)),V(r,"_sprite",va,O(r)),V(r,"_positions",ma,O(r)),V(r,"_color",ya,O(r)),V(r,"_text",xa,O(r)),V(r,"_width",Ta,O(r)),V(r,"_height",wa,O(r)),V(r,"_font",ba,O(r)),V(r,"_fontSize",Ca,O(r)),V(r,"_fontStyle",Sa,O(r)),V(r,"_lineSpacing",Ma,O(r)),V(r,"_horizontalAlignment",Aa,O(r)),V(r,"_verticalAlignment",Pa,O(r)),V(r,"_enableWrapping",Fa,O(r)),V(r,"_overflowMode",Ea,O(r)),V(r,"_dirtyFlag",Ra,O(r)),V(r,"_isWorldMatrixDirty",La,O(r)),V(r,"_maskInteraction",Ba,O(r)),V(r,"_maskLayer",Da,O(r));var n=O(r).engine;return r._isWorldMatrixDirty=e.transform.registerWorldChangeFlag(),r._sprite=new ca(n),r.font=_a.createFromOS(n),r.setMaterial(n._spriteDefaultMaterial),r}E(r,t);var n=r.prototype;return n._render=function(t){if(""===this._text||this.enableWrapping&&this.width<=0||this.overflowMode===e.OverflowMode.Truncate&&this.height<=0)this._clearTexture();else{var r=this._sprite,n=this._isContainDirtyFlag(za.Property);n&&(this._updateText(),this._setDirtyFlagFalse(za.Property)),(this._isWorldMatrixDirty.flag||n)&&(this._updatePosition(),this._isWorldMatrixDirty.flag=!1),this._isContainDirtyFlag(za.MaskInteraction)&&(this._updateStencilState(),this._setDirtyFlagFalse(za.MaskInteraction)),this.shaderData.setTexture(da._textureProperty,r.texture);var i=this._engine._spriteElementPool.getFromPool();i.setValue(this,this._positions,r._uv,r._triangles,this.color,this.getMaterial(),t),t._renderPipeline.pushPrimitive(i)}},n._onDestroy=function(){this.engine._dynamicTextAtlasManager.removeSprite(this._sprite),this._isWorldMatrixDirty.destroy(),t.prototype._onDestroy.call(this)},n._cloneTo=function(e){e.font=this._font},n._updateBounds=function(e){var t=this._sprite;if(t&&t.texture)if(this._customLocalBounds&&this._customRootEntity){var r=this._customRootEntity.transform.worldMatrix;l.transform(this._customLocalBounds,r,e)}else{var n=t.bounds,i=this._entity.transform.worldMatrix;l.transform(n,i,e)}else e.min.setValue(0,0,0),e.max.setValue(0,0,0)},n._isContainDirtyFlag=function(e){return 0!=(this._dirtyFlag&e)},n._setDirtyFlagTrue=function(e){this._dirtyFlag|=e},n._setDirtyFlagFalse=function(e){this._dirtyFlag&=~e},n._updateText=function(){var e=this.width,t=this.height,r=this.enableWrapping,n=this.overflowMode,i=Oa.getNativeFontString(this._font.name,this._fontSize,this._fontStyle),a=Oa.measureText(this.text,e,t,this.lineSpacing,r,n,i);Oa.updateText(a,i,this.horizontalAlignment,this.verticalAlignment),this._updateTexture()},n._updateTexture=function(){var e=Oa.trimCanvas(),t=e.width,r=e.height,n=Oa.updateCanvas(t,r,e.data);this._clearTexture();var i=this._sprite;if(!this.engine._dynamicTextAtlasManager.addSprite(i,n)){var a=new ie(this.engine,t,r);a.setImageSource(n),a.generateMipmaps(),i.texture=a}i._updateMesh()},n._updateStencilState=function(){var t=this.getInstanceMaterial().renderState.stencilState,r=this._maskInteraction;if(r===e.SpriteMaskInteraction.None)t.enabled=!1,t.writeMask=255,t.referenceValue=0,t.compareFunctionFront=t.compareFunctionBack=e.CompareFunction.Always;else{t.enabled=!0,t.writeMask=0,t.referenceValue=1;var n=r===e.SpriteMaskInteraction.VisibleInsideMask?e.CompareFunction.LessEqual:e.CompareFunction.Greater;t.compareFunctionFront=n,t.compareFunctionBack=n}},n._updatePosition=function(){for(var e=this._sprite._positions,t=r._tempVec3,n=this.entity.transform.worldMatrix,i=this._positions,a=0,s=i.length;a<s;a++){var l=e[a];t.setValue(l.x,l.y,0),o.transformToVec3(t,n,i[a])}},n._clearTexture=function(){var e=this._sprite;this.engine._dynamicTextAtlasManager.removeSprite(e),this.shaderData.setTexture(da._textureProperty,null),e.atlasRegion=e.region},A(r,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&e.cloneTo(this._color)}},{key:"text",get:function(){return this._text},set:function(e){e=e||"",this._text!==e&&(this._text=e,this._setDirtyFlagTrue(za.Property))}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._setDirtyFlagTrue(za.Property))}},{key:"height",get:function(){return this._height},set:function(e){this._height!==e&&(this._height=e,this._setDirtyFlagTrue(za.Property))}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._font=e,this._setDirtyFlagTrue(za.Property))}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._setDirtyFlagTrue(za.Property))}},{key:"fontStyle",get:function(){return this._fontStyle},set:function(e){this.fontStyle!==e&&(this._fontStyle=e,this._setDirtyFlagTrue(za.Property))}},{key:"lineSpacing",get:function(){return this._lineSpacing},set:function(e){this._lineSpacing!==e&&(this._lineSpacing=e,this._setDirtyFlagTrue(za.Property))}},{key:"horizontalAlignment",get:function(){return this._horizontalAlignment},set:function(e){this._horizontalAlignment!==e&&(this._horizontalAlignment=e,this._setDirtyFlagTrue(za.Property))}},{key:"verticalAlignment",get:function(){return this._verticalAlignment},set:function(e){this._verticalAlignment!==e&&(this._verticalAlignment=e,this._setDirtyFlagTrue(za.Property))}},{key:"enableWrapping",get:function(){return this._enableWrapping},set:function(e){this._enableWrapping!==e&&(this._enableWrapping=e,this._setDirtyFlagTrue(za.Property))}},{key:"overflowMode",get:function(){return this._overflowMode},set:function(e){this._overflowMode!==e&&(this._overflowMode=e,this._setDirtyFlagTrue(za.Property))}},{key:"maskInteraction",get:function(){return this._maskInteraction},set:function(e){this._maskInteraction!==e&&(this._maskInteraction=e,this._setDirtyFlagTrue(za.MaskInteraction))}},{key:"maskLayer",get:function(){return this._maskLayer},set:function(e){this._maskLayer=e}}]),r}(Rr))._tempVec3=new o,pa=N((fa=Ia).prototype,"_customLocalBounds",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ga=N(fa.prototype,"_customRootEntity",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),va=N(fa.prototype,"_sprite",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ma=N(fa.prototype,"_positions",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new o,new o,new o,new o]}}),ya=N(fa.prototype,"_color",[H],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new T(1,1,1,1)}}),xa=N(fa.prototype,"_text",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ta=N(fa.prototype,"_width",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wa=N(fa.prototype,"_height",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ba=N(fa.prototype,"_font",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ca=N(fa.prototype,"_fontSize",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 24}}),Sa=N(fa.prototype,"_fontStyle",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return e.FontStyle.None}}),Ma=N(fa.prototype,"_lineSpacing",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Aa=N(fa.prototype,"_horizontalAlignment",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return e.TextHorizontalAlignment.Center}}),Pa=N(fa.prototype,"_verticalAlignment",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return e.TextVerticalAlignment.Center}}),Fa=N(fa.prototype,"_enableWrapping",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ea=N(fa.prototype,"_overflowMode",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return e.OverflowMode.Overflow}}),Ra=N(fa.prototype,"_dirtyFlag",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return za.Property}}),La=N(fa.prototype,"_isWorldMatrixDirty",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ba=N(fa.prototype,"_maskInteraction",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return e.SpriteMaskInteraction.None}}),Da=N(fa.prototype,"_maskLayer",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return e.SpriteMaskLayer.Layer0}}),fa);!function(e){e[e.Property=1]="Property",e[e.MaskInteraction=2]="MaskInteraction",e[e.All=3]="All"}(za||(za={}));var Na,Ua=function(){this.relativePath=void 0,this.type=void 0,this.property=void 0,this.curve=void 0},ka=function(){this.time=void 0,this.functionName=void 0,this.parameter=void 0};e.AnimationProperty=void 0,(Na=e.AnimationProperty||(e.AnimationProperty={}))[Na.Position=0]="Position",Na[Na.Rotation=1]="Rotation",Na[Na.Scale=2]="Scale",Na[Na.BlendShapeWeights=3]="BlendShapeWeights";var Ga,Ha,Wa,ja=function(t){function r(e){var r;return(r=t.call(this)||this).name=e,r._curveBindings=[],r._length=0,r._events=[],r}E(r,t);var n=r.prototype;return n.addEvent=function(e,t,r){if("string"==typeof e){var n=new ka;n.functionName=e,n.time=t,n.parameter=r,this._events.push(n)}else this._events.push(e);this._events.sort((function(e,t){return e.time-t.time}))},n.clearEvents=function(){this._events.length=0},n.addCurveBinding=function(t,r,n,i){var a;switch(n){case"position":a=e.AnimationProperty.Position;break;case"rotation":a=e.AnimationProperty.Rotation;break;case"scale":a=e.AnimationProperty.Scale;break;case"blendShapeWeights":a=e.AnimationProperty.BlendShapeWeights}var o=new Ua;o.relativePath=t,o.type=r,o.property=a,o.curve=i,i.length>this._length&&(this._length=i.length),this._curveBindings.push(o)},n.clearCurveBindings=function(){this._curveBindings.length=0,this._length=0},n._sampleAnimation=function(t,r){for(var n=this._curveBindings.length-1;n>=0;n--){var i=this._curveBindings[n],a=i.curve,o=i.property,s=i.relativePath,l=i.type,u=a.evaluate(r),c=t.findByName(s).transform;if(l===$e)switch(o){case e.AnimationProperty.Position:c.position=u;break;case e.AnimationProperty.Rotation:c.rotationQuaternion=u;break;case e.AnimationProperty.Scale:c.scale=u}}},A(r,[{key:"events",get:function(){return this._events}},{key:"curveBindings",get:function(){return this._curveBindings}},{key:"length",get:function(){return this._length}}]),r}((function(){})),Xa=function(){function e(){}return e.scaleWeight=function(e,t,r){var n=e.x,i=e.y,a=e.z;r.x=n>0?Math.pow(Math.abs(n),t):-Math.pow(Math.abs(n),t),r.y=i>0?Math.pow(Math.abs(i),t):-Math.pow(Math.abs(i),t),r.z=a>0?Math.pow(Math.abs(a),t):-Math.pow(Math.abs(a),t)},e.scaleBlend=function(t,r,n,i){var a=e._tempVector30,o=e._tempVector31;e.scaleWeight(t,1-n,a),e.scaleWeight(r,n,o);var s=n>.5?r:t;i.x=s.x>0?Math.abs(a.x*o.x):-Math.abs(a.x*o.x),i.y=s.y>0?Math.abs(a.y*o.y):-Math.abs(a.y*o.y),i.z=s.z>0?Math.abs(a.z*o.z):-Math.abs(a.z*o.z)},e.quaternionWeight=function(e,t,r){r.x=e.x*t,r.y=e.y*t,r.z=e.z*t,r.w=e.w},e}();Xa._tempVector30=new o,Xa._tempVector31=new o,e.AnimatorLayerBlendingMode=void 0,(Ga=e.AnimatorLayerBlendingMode||(e.AnimatorLayerBlendingMode={}))[Ga.Override=0]="Override",Ga[Ga.Additive=1]="Additive",function(e){e[e.UnStarted=0]="UnStarted",e[e.Playing=1]="Playing",e[e.Finished=2]="Finished"}(Ha||(Ha={})),function(e){e[e.Standby=0]="Standby",e[e.Playing=1]="Playing",e[e.CrossFading=2]="CrossFading",e[e.FixedCrossFading=3]="FixedCrossFading"}(Wa||(Wa={}));var Ka,qa=function(){function t(t,r,n){switch(this.crossCurveMark=0,this.crossCurveIndex=void 0,this.target=void 0,this.type=void 0,this.property=void 0,this.component=void 0,this.defaultValue=void 0,this.fixedPoseValue=void 0,this._hasSavedDefaultValue=!1,this.target=t,this.type=r,this.property=n,n){case e.AnimationProperty.Position:this.defaultValue=new o,this.fixedPoseValue=new o,this.component=t.transform;break;case e.AnimationProperty.Rotation:this.defaultValue=new _,this.fixedPoseValue=new _,this.component=t.transform;break;case e.AnimationProperty.Scale:this.defaultValue=new o,this.fixedPoseValue=new o,this.component=t.transform;break;case e.AnimationProperty.BlendShapeWeights:this.defaultValue=new Float32Array(4),this.fixedPoseValue=new Float32Array(4),this.component=t.getComponent(vn)}}var r=t.prototype;return r.saveDefaultValue=function(){switch(this.property){case e.AnimationProperty.Position:this.target.transform.position.cloneTo(this.defaultValue);break;case e.AnimationProperty.Rotation:this.target.transform.rotationQuaternion.cloneTo(this.defaultValue);break;case e.AnimationProperty.Scale:this.target.transform.scale.cloneTo(this.defaultValue);break;case e.AnimationProperty.BlendShapeWeights:for(var t=0,r=this.component.blendShapeWeights.length;t<r;++t)this.defaultValue[t]=this.component.blendShapeWeights[t]}this._hasSavedDefaultValue=!0},r.saveFixedPoseValue=function(){switch(this.property){case e.AnimationProperty.Position:this.target.transform.position.cloneTo(this.fixedPoseValue);break;case e.AnimationProperty.Rotation:this.target.transform.rotationQuaternion.cloneTo(this.fixedPoseValue);break;case e.AnimationProperty.Scale:this.target.transform.scale.cloneTo(this.fixedPoseValue);break;case e.AnimationProperty.BlendShapeWeights:for(var t=0,r=this.component.blendShapeWeights.length;t<r;++t)this.fixedPoseValue[t]=this.component.blendShapeWeights[t]}},t}(),Ya=function(){this.event=void 0,this.handlers=[]},Qa=function(){this.duration=0,this.offset=0,this.exitTime=1,this.destinationState=void 0};e.WrapMode=void 0,(Ka=e.WrapMode||(e.WrapMode={}))[Ka.Once=0]="Once",Ka[Ka.Loop=1]="Loop";var Ja,Za,$a,eo,to,ro,no,io,ao,oo,so,lo=function(){function t(){this.state=void 0,this.stateData=void 0,this.frameTime=void 0,this.playState=void 0,this.clipTime=void 0,this.currentEventIndex=void 0}var r=t.prototype;return r.reset=function(e,t,r){this.state=e,this.frameTime=r,this.stateData=t,this.playState=Ha.UnStarted,this.clipTime=e.clipStartTime*e.clip.length,this.currentEventIndex=0},r.update=function(t){var r=this.state,n=this.frameTime,i=r._getDuration();this.playState=Ha.Playing,r.wrapMode===e.WrapMode.Loop?n%=i:Math.abs(n)>i&&(n=n<0?-i:i,this.playState=Ha.Finished),t&&0===n?this.clipTime=r.clipEndTime*r.clip.length:(n<0&&(n+=i),this.clipTime=n+r.clipStartTime*r.clip.length)},t}(),uo=function(){function e(){this.animatorStateDataMap={},this.srcPlayData=new lo,this.destPlayData=new lo,this.layerState=Wa.Standby,this.crossCurveMark=0,this.manuallyTransition=new Qa,this.crossFadeTransition=void 0}return e.prototype.switchPlayData=function(){var e=this.destPlayData,t=this.srcPlayData;this.srcPlayData=e,this.destPlayData=t},e}(),co=function(){this.curveOwners=[],this.eventHandlers=[]},ho=function(){this.curveOwner=void 0,this.srcCurveIndex=void 0,this.destCurveIndex=void 0},_o=((ao=function(t){function r(e){var r;return(r=t.call(this,e)||this)._animatorController=void 0,V(r,"_speed",Za,O(r)),V(r,"_controllerUpdateFlag",$a,O(r)),V(r,"_animatorLayersData",eo,O(r)),V(r,"_crossCurveDataCollection",to,O(r)),V(r,"_animationCurveOwners",ro,O(r)),V(r,"_crossCurveDataPool",no,O(r)),V(r,"_animationEventHandlerPool",io,O(r)),r}E(r,t);var n=r.prototype;return n.play=function(e,t,n){var i;void 0===t&&(t=-1),void 0===n&&(n=0),null!==(i=this._controllerUpdateFlag)&&void 0!==i&&i.flag&&this._clearPlayData();var a=this._getAnimatorStateInfo(e,t,r._animatorInfo),o=a.state;if(o)if(o.clip){var s=this._getAnimatorLayerData(a.layerIndex),l=s.srcPlayData,u=l.state;u&&u!==o&&this._revertDefaultValue(l.state,l.stateData);var c=this._getAnimatorStateData(e,o,s);s.layerState=Wa.Playing,l.reset(o,c,o._getDuration()*n),this._saveDefaultValues(c)}else console.warn("The state named "+e+" has no AnimationClip data.")},n._reset=function(){var e=this._animatorController;if(e)for(var t=e.layers,r=0,n=t.length;r<n;++r)for(var i=t[r].stateMachine.states,a=this._getAnimatorLayerData(r),o=0,s=i.length;o<s;++o){var l=i[o],u=this._getAnimatorStateData(l.name,l,a);this._revertDefaultValue(l,u)}this._clearPlayData()},n.crossFade=function(e,t,n,i){var a;void 0===n&&(n=-1),void 0===i&&(i=0),null!==(a=this._controllerUpdateFlag)&&void 0!==a&&a.flag&&this._clearPlayData();var o=this._getAnimatorStateInfo(e,n,r._animatorInfo).state,s=this._getAnimatorLayerData(n).manuallyTransition;s.duration=t,s.offset=i,s.destinationState=o,this._crossFadeByTransition(s,n)},n.update=function(e){var t;if(0!==this.speed){var r=this._animatorController;if(r&&(null===(t=this._controllerUpdateFlag)||void 0===t||!t.flag)){e*=this.speed;for(var n=0,i=r.layers.length;n<i;n++)this._getAnimatorLayerData(n).layerState!==Wa.Standby&&this._updateLayer(n,0===n,e/1e3)}}},n.getCurrentAnimatorState=function(e){var t,r;return null===(t=this._animatorLayersData[e])||void 0===t||null===(r=t.srcPlayData)||void 0===r?void 0:r.state},n._onEnable=function(){this.engine._componentsManager.addOnUpdateAnimations(this)},n._onDisable=function(){this.engine._componentsManager.removeOnUpdateAnimations(this)},n._getAnimatorStateInfo=function(e,t,r){var n=null,i=this._animatorController;if(i){var a=i.layers;if(-1===t){for(var o=0,s=a.length;o<s;o++)if(n=a[o].stateMachine.findStateByName(e)){t=o;break}}else n=a[t].stateMachine.findStateByName(e)}return r.layerIndex=t,r.state=n,r},n._saveDefaultValues=function(e){for(var t=e.curveOwners,r=t.length-1;r>=0;r--)t[r].saveDefaultValue()},n._getAnimatorStateData=function(e,t,r){var n=r.animatorStateDataMap,i=n[e];return i||(i=new co,n[e]=i,this._saveAnimatorStateData(t,i),this._saveAnimatorEventHandlers(t,i)),i},n._saveAnimatorStateData=function(e,t){for(var r=this.entity,n=this._animationCurveOwners,i=t.curveOwners,a=e.clip._curveBindings,o=a.length-1;o>=0;o--){var s=a[o],l=""===s.relativePath?r:r.findByPath(s.relativePath),u=s.property,c=l.instanceId,h=n[c]||(n[c]=[]);i[o]=h[u]||(h[u]=new qa(l,s.type,u))}},n._saveAnimatorEventHandlers=function(e,t){var r=this._animationEventHandlerPool,n=this._entity._scripts,i=n.length,a=t.eventHandlers,o=e.clip.events;r.resetPool(),a.length=0;for(var s=0,l=o.length;s<l;s++){var u=o[s],c=r.getFromPool(),h=u.functionName,d=c.handlers;c.event=u,d.length=0;for(var _=i-1;_>=0;_--){var f=n.get(_)[h];f&&d.push(f)}a.push(c)}},n._clearCrossData=function(e){e.crossCurveMark++,this._crossCurveDataCollection.length=0,this._crossCurveDataPool.resetPool()},n._addCrossCurveData=function(e,t,r,n){var i=this._crossCurveDataPool.getFromPool();i.curveOwner=t,i.srcCurveIndex=r,i.destCurveIndex=n,e.push(i)},n._prepareCrossFading=function(e){var t=this._crossCurveDataCollection,r=e.crossCurveMark;this._prepareSrcCrossData(t,e.srcPlayData,r,!1),this._prepareDestCrossData(t,e.destPlayData,r,!1)},n._prepareStandbyCrossFading=function(e){var t=this._crossCurveDataCollection,r=e.srcPlayData,n=e.crossCurveMark;r&&this._prepareSrcCrossData(t,r,n,!0),this._prepareDestCrossData(t,e.destPlayData,n,!0)},n._prepareFixedPoseCrossFading=function(e){for(var t=this._crossCurveDataCollection,r=t.length-1;r>=0;r--){var n=t[r];n.curveOwner.saveFixedPoseValue(),n.destCurveIndex=-1}this._prepareDestCrossData(t,e.destPlayData,e.crossCurveMark,!0)},n._prepareSrcCrossData=function(e,t,r,n){for(var i=t.stateData.curveOwners,a=i.length-1;a>=0;a--){var o=i[a];o.crossCurveMark=r,o.crossCurveIndex=e.length,n&&o.saveFixedPoseValue(),this._addCrossCurveData(e,o,a,-1)}},n._prepareDestCrossData=function(e,t,r,n){for(var i=t.stateData.curveOwners,a=i.length-1;a>=0;a--){var o=i[a];o.crossCurveMark===r?e[o.crossCurveIndex].destCurveIndex=a:(o.saveDefaultValue(),n&&o.saveFixedPoseValue(),o.crossCurveMark=r,o.crossCurveIndex=e.length,this._addCrossCurveData(e,o,-1,a))}},n._evaluateCurve=function(t,n,i,a){var s=n.evaluate(i);if(a){var l=n.keys[0].value;switch(t){case e.AnimationProperty.Position:var u=r._tempVector3;return o.subtract(s,l,u),u;case e.AnimationProperty.Rotation:var c=r._tempQuaternion;return _.conjugate(l,c),_.multiply(c,s,c),c;case e.AnimationProperty.Scale:var h=r._tempVector3;return o.divide(s,l,h),h}}return s},n._getAnimatorLayerData=function(e){var t=this._animatorLayersData[e];return t||(this._animatorLayersData[e]=t=new uo),t},n._updateLayer=function(t,r,n){var i=this._animatorController.layers[t],a=i.blendingMode,o=i.weight,s=this._animatorLayersData[t],l=s.srcPlayData,u=s.destPlayData,c=s.crossFadeTransition,h=a===e.AnimatorLayerBlendingMode.Additive,d=r?1:o;switch(this._checkTransition(l,c,t),s.layerState){case Wa.Playing:this._updatePlayingState(l,s,t,d,n,h);break;case Wa.FixedCrossFading:this._updateCrossFadeFromPose(u,s,t,d,n,h);break;case Wa.CrossFading:this._updateCrossFade(l,u,s,t,d,n,h)}},n._updatePlayingState=function(e,t,r,n,i,a){var o=e.stateData,s=o.curveOwners,l=o.eventHandlers,u=e.state,c=e.playState,h=e.clipTime,d=u.clip._curveBindings;e.update(this.speed<0);var _=e.clipTime,f=e.playState;l.length&&this._fireAnimationEvents(e,l,h,_),c===Ha.UnStarted&&this._callAnimatorScriptOnEnter(u,r),f===Ha.Finished?this._callAnimatorScriptOnExit(u,r):this._callAnimatorScriptOnUpdate(u,r);for(var p=d.length-1;p>=0;p--){var g=s[p],v=this._evaluateCurve(g.property,d[p].curve,_,a);a?this._applyClipValueAdditive(g,v,n):this._applyClipValue(g,v,n)}e.frameTime+=u.speed*i,f===Ha.Finished&&(t.layerState=Wa.Standby)},n._updateCrossFade=function(e,t,r,n,i,a,o){var s=this._crossCurveDataCollection,l=e.state.clip._curveBindings,u=e.state,c=e.stateData,h=e.playState,d=c.eventHandlers,_=t.state,f=t.stateData,p=t.playState,g=f.eventHandlers,v=_.clip._curveBindings,m=e.clipTime,y=t.clipTime,x=Math.abs(t.frameTime)/(_._getDuration()*r.crossFadeTransition.duration);x>=1&&(x=1),e.update(this.speed<0),t.update(this.speed<0);var T=e.playState,w=t.playState;this._updateCrossFadeData(r,x,a,!1);var b=e.clipTime,C=t.clipTime;d.length&&this._fireAnimationEvents(e,d,m,b),g.length&&this._fireAnimationEvents(t,g,y,C),h===Ha.UnStarted&&this._callAnimatorScriptOnEnter(u,n),1===x||T===Ha.Finished?this._callAnimatorScriptOnExit(u,n):this._callAnimatorScriptOnUpdate(u,n),p===Ha.UnStarted&&this._callAnimatorScriptOnEnter(_,n),w===Ha.Finished?this._callAnimatorScriptOnExit(_,n):this._callAnimatorScriptOnUpdate(_,n);for(var S=s.length-1;S>=0;S--){var M=s[S],A=M.curveOwner,P=M.srcCurveIndex,F=M.destCurveIndex,E=A.property,R=A.defaultValue,L=P>=0?this._evaluateCurve(E,l[P].curve,b,o):R,B=F>=0?this._evaluateCurve(E,v[F].curve,C,o):R;this._applyCrossClipValue(A,L,B,x,i,o)}},n._updateCrossFadeFromPose=function(e,t,r,n,i,a){var o=this._crossCurveDataCollection,s=e.state,l=e.stateData,u=e.playState,c=l.eventHandlers,h=s.clip._curveBindings,d=e.clipTime,_=Math.abs(e.frameTime)/(s._getDuration()*t.crossFadeTransition.duration);_>=1&&(_=1),e.update(this.speed<0);var f=e.playState;this._updateCrossFadeData(t,_,i,!0);var p=e.clipTime;c.length&&this._fireAnimationEvents(e,c,d,p),u===Ha.UnStarted&&this._callAnimatorScriptOnEnter(s,r),f===Ha.Finished?this._callAnimatorScriptOnExit(s,r):this._callAnimatorScriptOnUpdate(s,r);for(var g=o.length-1;g>=0;g--){var v=o[g],m=v.curveOwner,y=v.destCurveIndex,x=y>=0?this._evaluateCurve(m.property,h[y].curve,p,a):m.defaultValue;this._applyCrossClipValue(m,m.fixedPoseValue,x,_,n,a)}},n._updateCrossFadeData=function(e,t,r,n){var i=e.destPlayData;i.frameTime+=i.state.speed*r,1===t?(i.playState===Ha.Finished?e.layerState=Wa.Standby:e.layerState=Wa.Playing,e.switchPlayData()):n||(e.srcPlayData.frameTime+=e.srcPlayData.state.speed*r)},n._applyCrossClipValue=function(t,n,i,a,s,l){var u;if(t.type===$e)switch(t.property){case e.AnimationProperty.Position:o.lerp(n,i,a,r._tempVector3),u=r._tempVector3;break;case e.AnimationProperty.Rotation:_.slerp(n,i,a,r._tempQuaternion),u=r._tempQuaternion;break;case e.AnimationProperty.Scale:o.lerp(n,i,a,r._tempVector3),u=r._tempVector3}else t.type===vn&&t.property===e.AnimationProperty.BlendShapeWeights&&(t.component.blendShapeWeights=u);l?this._applyClipValueAdditive(t,u,s):this._applyClipValue(t,u,s)},n._applyClipValue=function(t,r,n){if(t.type===$e){var i=t.target.transform;switch(t.property){case e.AnimationProperty.Position:if(1===n)i.position=r;else{var a=i.position;o.lerp(a,r,n,a)}break;case e.AnimationProperty.Rotation:if(1===n)i.rotationQuaternion=r;else{var s=i.rotationQuaternion;_.slerp(s,r,n,s)}break;case e.AnimationProperty.Scale:if(1===n)i.scale=r;else{var l=i.scale;o.lerp(l,r,n,l)}}}else t.type===vn&&t.property===e.AnimationProperty.BlendShapeWeights&&(t.component.blendShapeWeights=r)},n._applyClipValueAdditive=function(t,r,n){if(t.type===$e){var i=t.target.transform;switch(t.property){case e.AnimationProperty.Position:var a=i.position;a.x+=r.x*n,a.y+=r.y*n,a.z+=r.z*n,i.position=a;break;case e.AnimationProperty.Rotation:var s=i.rotationQuaternion;Xa.quaternionWeight(r,n,r),r.normalize(),s.multiply(r),i.rotationQuaternion=s;break;case e.AnimationProperty.Scale:var l=i.scale;Xa.scaleWeight(l,n,l),o.multiply(l,r,l),i.scale=l}}},n._revertDefaultValue=function(t,r){var n=t.clip;if(n)for(var i=n._curveBindings,a=r.curveOwners,o=i.length-1;o>=0;o--){var s=a[o],l=s.target.transform;if(s._hasSavedDefaultValue)switch(s.property){case e.AnimationProperty.Position:l.position=s.defaultValue;break;case e.AnimationProperty.Rotation:l.rotationQuaternion=s.defaultValue;break;case e.AnimationProperty.Scale:l.scale=s.defaultValue;break;case e.AnimationProperty.BlendShapeWeights:for(var u=0,c=s.component.blendShapeWeights.length;u<c;++u)s.component.blendShapeWeights[u]=s.defaultValue[u]}}},n._checkTransition=function(e,t,r){for(var n=e.state,i=e.clipTime,a=n._getDuration(),o=n.transitions,s=0,l=o.length;s<l;++s){var u=o[s];a*u.exitTime<=i&&t!==u&&this._crossFadeByTransition(u,r)}},n._crossFadeByTransition=function(e,t){var n=e.destinationState.name,i=this._getAnimatorStateInfo(n,t,r._animatorInfo),a=i.state;if(a)if(a.clip){var o=this._getAnimatorLayerData(i.layerIndex),s=o.layerState,l=o.destPlayData,u=this._getAnimatorStateData(n,a,o),c=a._getDuration()*e.offset;switch(l.reset(a,u,c),s){case Wa.Standby:o.layerState=Wa.FixedCrossFading,this._clearCrossData(o),this._prepareStandbyCrossFading(o);break;case Wa.Playing:o.layerState=Wa.CrossFading,this._clearCrossData(o),this._prepareCrossFading(o);break;case Wa.CrossFading:o.layerState=Wa.FixedCrossFading,this._prepareFixedPoseCrossFading(o);break;case Wa.FixedCrossFading:this._prepareFixedPoseCrossFading(o)}o.crossFadeTransition=e}else console.warn("The state named "+n+" has no AnimationClip data.")},n._fireAnimationEvents=function(e,t,r,n){var i=e.state,a=i.clip.length;this.speed>=0?n<r?(this._fireSubAnimationEvents(e,t,r,i.clipEndTime*a),e.currentEventIndex=0,this._fireSubAnimationEvents(e,t,i.clipStartTime*a,n)):this._fireSubAnimationEvents(e,t,r,n):n>r?(this._fireBackwardSubAnimationEvents(e,t,r,i.clipStartTime*a),e.currentEventIndex=t.length-1,this._fireBackwardSubAnimationEvents(e,t,i.clipEndTime*a,n)):this._fireBackwardSubAnimationEvents(e,t,r,n)},n._fireSubAnimationEvents=function(e,t,r,n){for(var i=e.currentEventIndex,a=t.length;i<a;i++){var o=t[i],s=o.event,l=s.time,u=s.parameter;if(l>n)break;var c=o.handlers;if(l>=r){for(var h=c.length-1;h>=0;h--)c[h](u);e.currentEventIndex=Math.min(i+1,a-1)}}},n._fireBackwardSubAnimationEvents=function(e,t,r,n){for(var i=e.currentEventIndex;i>=0;i--){var a=t[i],o=a.event,s=o.time,l=o.parameter;if(s<n)break;var u=a.handlers;if(s<=r){for(var c=u.length-1;c>=0;c--)u[c](l);e.currentEventIndex=Math.max(i-1,0)}}},n._callAnimatorScriptOnEnter=function(e,t){for(var r=e._onStateEnterScripts,n=0,i=r.length;n<i;n++)r[n].onStateEnter(this,e,t)},n._callAnimatorScriptOnUpdate=function(e,t){for(var r=e._onStateUpdateScripts,n=0,i=r.length;n<i;n++)r[n].onStateUpdate(this,e,t)},n._callAnimatorScriptOnExit=function(e,t){for(var r=e._onStateExitScripts,n=0,i=r.length;n<i;n++)r[n].onStateExit(this,e,t)},n._clearPlayData=function(){this._animatorLayersData.length=0,this._crossCurveDataCollection.length=0,this._animationCurveOwners.length=0,this._controllerUpdateFlag&&(this._controllerUpdateFlag.flag=!1)},A(r,[{key:"speed",get:function(){return this._speed},set:function(e){this._speed=e}},{key:"animatorController",get:function(){return this._animatorController},set:function(e){e!==this._animatorController&&(this._controllerUpdateFlag&&this._controllerUpdateFlag.destroy(),this._controllerUpdateFlag=e&&e._registerChangeFlag(),this._animatorController=e)}}]),r}(Je))._tempVector3=new o,ao._tempQuaternion=new _,ao._animatorInfo=new function(){this.layerIndex=void 0,this.state=void 0},Za=N((Ja=ao).prototype,"_speed",[k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),$a=N(Ja.prototype,"_controllerUpdateFlag",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),eo=N(Ja.prototype,"_animatorLayersData",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),to=N(Ja.prototype,"_crossCurveDataCollection",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ro=N(Ja.prototype,"_animationCurveOwners",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),no=N(Ja.prototype,"_crossCurveDataPool",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vr(ho)}}),io=N(Ja.prototype,"_animationEventHandlerPool",[U],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vr(Ya)}}),Ja),fo=function(){function e(){this._updateFlagManager=new Ze,this._layers=[],this._layersMap={}}var t=e.prototype;return t.findLayerByName=function(e){return this._layersMap[e]},t.addLayer=function(e){this._layers.push(e),this._layersMap[e.name]=e,this._distributeUpdateFlag()},t.removeLayer=function(e){var t=this.layers[e];this._layers.splice(e,1),delete this._layersMap[t.name],this._distributeUpdateFlag()},t.clearLayers=function(){for(var e in this._layers.length=0,this._layersMap)delete this._layersMap[e];this._distributeUpdateFlag()},t._registerChangeFlag=function(){return this._updateFlagManager.createFlag(Qe)},t._distributeUpdateFlag=function(){this._updateFlagManager.dispatch()},A(e,[{key:"layers",get:function(){return this._layers}}]),e}(),po=function(t){this.name=t,this.weight=1,this.blendingMode=e.AnimatorLayerBlendingMode.Override,this.stateMachine=void 0},go=function(){function e(){this._destroyed=!1,this._state=void 0}var t=e.prototype;return t.onStateEnter=function(e,t,r){},t.onStateUpdate=function(e,t,r){},t.onStateExit=function(e,t,r){},t.destroy=function(){this._destroyed||(this._state._removeStateMachineScript(this),this._destroyed=!0)},e}(),vo=function(){function t(t){this.name=t,this.speed=1,this.wrapMode=e.WrapMode.Loop,this._onStateEnterScripts=[],this._onStateUpdateScripts=[],this._onStateExitScripts=[],this._clipStartTime=0,this._clipEndTime=1,this._clip=void 0,this._transitions=[]}var r=t.prototype;return r.addTransition=function(e){this._transitions.push(e)},r.removeTransition=function(e){var t=this._transitions.indexOf(e);-1!==t&&this._transitions.splice(t,1)},r.addStateMachineScript=function(e){var t=new e;t._state=this;var r=go.prototype;return t.onStateEnter!==r.onStateEnter&&this._onStateEnterScripts.push(t),t.onStateUpdate!==r.onStateUpdate&&this._onStateUpdateScripts.push(t),t.onStateExit!==r.onStateExit&&this._onStateExitScripts.push(t),t},r.clearTransitions=function(){this._transitions.length=0},r._getDuration=function(){return this.clip?(this._clipEndTime-this._clipStartTime)*this.clip.length:null},r._removeStateMachineScript=function(e){var t=go.prototype;if(e.onStateEnter!==t.onStateEnter){var r=this._onStateEnterScripts.indexOf(e);-1!==r&&this._onStateEnterScripts.splice(r,1)}if(e.onStateUpdate!==t.onStateUpdate){var n=this._onStateUpdateScripts.indexOf(e);-1!==n&&this._onStateUpdateScripts.splice(n,1)}if(e.onStateExit!==t.onStateExit){var i=this._onStateExitScripts.indexOf(e);-1!==i&&this._onStateExitScripts.splice(i,1)}},A(t,[{key:"transitions",get:function(){return this._transitions}},{key:"clip",get:function(){return this._clip},set:function(e){this._clip=e,this._clipEndTime=Math.min(this._clipEndTime,1)}},{key:"clipStartTime",get:function(){return this._clipStartTime},set:function(e){this._clipStartTime=Math.max(e,0)}},{key:"clipEndTime",get:function(){return this._clipEndTime},set:function(e){this._clipEndTime=Math.min(e,1)}}]),t}(),mo=function(){function e(){this.states=[],this._statesMap={}}var t=e.prototype;return t.addState=function(e){var t=this.findStateByName(e);return t?console.warn("The state named "+e+" has existed."):(t=new vo(e),this.states.push(t),this._statesMap[e]=t),t},t.removeState=function(e){var t=e.name,r=this.states.indexOf(e);r>-1&&this.states.splice(r,1),delete this._statesMap[t]},t.findStateByName=function(e){return this._statesMap[e]},t.makeUniqueStateName=function(e){for(var t=this._statesMap,r=e,n=0;t[e];)e=r+" "+n,n++;return e},e}();e.InterpolableValueType=void 0,(oo=e.InterpolableValueType||(e.InterpolableValueType={}))[oo.Float=0]="Float",oo[oo.FloatArray=1]="FloatArray",oo[oo.Vector2=2]="Vector2",oo[oo.Vector3=3]="Vector3",oo[oo.Vector4=4]="Vector4",oo[oo.Quaternion=5]="Quaternion",e.InterpolationType=void 0,(so=e.InterpolationType||(e.InterpolationType={}))[so.Linear=0]="Linear",so[so.CubicSpine=1]="CubicSpine",so[so.Step=2]="Step",so[so.Hermite=3]="Hermite";var yo,xo=function(){function t(){this.keys=[],this.interpolation=void 0,this._valueSize=void 0,this._valueType=void 0,this._currentValue=void 0,this._length=0,this._currentIndex=0}var r=t.prototype;return r.addKey=function(t){var r=t.time;if(this.keys.push(t),r>this._length&&(this._length=r),!this._valueSize&&("number"==typeof t.value&&(this._valueSize=1,this._valueType=e.InterpolableValueType.Float,this._currentValue=0),t.value instanceof g&&(this._valueSize=2,this._valueType=e.InterpolableValueType.Vector2,this._currentValue=new g),t.value instanceof o&&(this._valueSize=3,this._valueType=e.InterpolableValueType.Vector3,this._currentValue=new o),t.value instanceof v&&(this._valueSize=4,this._valueType=e.InterpolableValueType.Vector4,this._currentValue=new v),t.value instanceof _&&(this._valueSize=4,this._valueType=e.InterpolableValueType.Quaternion,this._currentValue=new _),t.value instanceof Float32Array)){var n=t.value.length;this._valueSize=n,this._valueType=e.InterpolableValueType.FloatArray,this._currentValue=new Float32Array(n)}this.keys.sort((function(e,t){return e.time-t.time}))},r.evaluate=function(t){var r=this.keys,n=this.interpolation,i=this.keys.length,a=this._currentIndex;-1!==a&&t<r[a].time&&(a=-1);for(var o,s=a+1;s<i&&!(t<r[s].time);)a++,s++;if(this._currentIndex=a,-1===a)o=r[0].value;else if(s===i)o=r[a].value;else{var l=r[a].time,u=r[s].time-l,c=(t-l)/u,h=u;switch(n){case e.InterpolationType.Linear:o=this._evaluateLinear(a,s,c);break;case e.InterpolationType.Step:o=this._evaluateStep(s);break;case e.InterpolationType.CubicSpine:case e.InterpolationType.Hermite:o=this._evaluateHermite(a,s,c,h)}}return o},r.moveKey=function(e,t){this.keys[e]=t},r.removeKey=function(e){this.keys.splice(e,1);for(var t=this.keys,r=0,n=this.keys.length-1;n>=0;n--)t[n].time>length&&(r=t[n].time);this._length=r},r._evaluateLinear=function(t,r,n){var i=this._valueType,a=this.keys;switch(i){case e.InterpolableValueType.Float:return a[t].value*(1-n)+a[r].value*n;case e.InterpolableValueType.FloatArray:for(var s=this._currentValue,l=a[t].value,u=a[r].value,c=0,h=l.length;c<h;c++)s[c]=l[c]*(1-n)+u[c]*n;return s;case e.InterpolableValueType.Vector2:return g.lerp(a[t].value,a[r].value,n,this._currentValue),this._currentValue;case e.InterpolableValueType.Vector3:return o.lerp(a[t].value,a[r].value,n,this._currentValue),this._currentValue;case e.InterpolableValueType.Quaternion:return _.slerp(a[t].value,a[r].value,n,this._currentValue),this._currentValue}},r._evaluateStep=function(e){return this._valueSize,this.keys[e].value},r._evaluateHermite=function(e,t,r,n){var i=this._valueSize,a=this.keys,o=a[e],s=a[t];switch(i){case 1:var l=o.outTangent,u=s.inTangent,c=o.value,h=s.value;if(Number.isFinite(l)&&Number.isFinite(u)){var d=r*r,_=d*r;return(2*_-3*d+1)*c+(_-2*d+r)*l*n+(_-d)*u*n+(-2*_+3*d)*h}return o.value;case 2:var f=o.value,p=o.outTangent,g=s.value,v=s.inTangent,m=r*r,y=m*r,x=2*y-3*m+1,T=y-2*m+r,w=y-m,b=-2*y+3*m,C=p.x,S=v.x;return Number.isFinite(C)&&Number.isFinite(S)?this._currentValue.x=x*f.x+T*C*n+w*S*n+b*g.x:this._currentValue.x=f.x,C=p.y,S=v.y,Number.isFinite(C)&&Number.isFinite(S)?this._currentValue.y=x*f.y+T*C*n+w*S*n+b*g.y:this._currentValue.y=f.y,this._currentValue;case 3:var M=o.value,A=o.outTangent,P=s.value,F=s.inTangent,E=r*r,R=E*r,L=2*R-3*E+1,B=R-2*E+r,D=R-E,I=-2*R+3*E,O=A.x,z=F.x;return Number.isFinite(O)&&Number.isFinite(z)?this._currentValue.x=L*M.x+B*O*n+D*z*n+I*P.x:this._currentValue.x=M.x,O=A.y,z=F.y,Number.isFinite(O)&&Number.isFinite(z)?this._currentValue.y=L*M.y+B*O*n+D*z*n+I*P.y:this._currentValue.y=M.y,O=A.z,z=F.z,Number.isFinite(O)&&Number.isFinite(z)?this._currentValue.z=L*M.z+B*O*n+D*z*n+I*P.z:this._currentValue.z=M.z,this._currentValue;case 4:var V=o.value,N=o.outTangent,U=s.value,k=s.inTangent,G=r*r,H=G*r,W=2*H-3*G+1,j=H-2*G+r,X=H-G,K=-2*H+3*G,q=N.x,Y=k.x;return Number.isFinite(q)&&Number.isFinite(Y)?this._currentValue.x=W*V.x+j*q*n+X*Y*n+K*U.x:this._currentValue.x=V.x,q=N.y,Y=k.y,Number.isFinite(q)&&Number.isFinite(Y)?this._currentValue.y=W*V.y+j*q*n+X*Y*n+K*U.y:this._currentValue.y=V.y,q=N.z,Y=k.z,Number.isFinite(q)&&Number.isFinite(Y)?this._currentValue.z=W*V.z+j*q*n+X*Y*n+K*U.z:this._currentValue.z=V.z,q=N.w,Y=k.w,Number.isFinite(q)&&Number.isFinite(Y)?this._currentValue.w=W*V.w+j*q*n+X*Y*n+K*U.w:this._currentValue.w=V.w,this._currentValue}},A(t,[{key:"length",get:function(){return this._length}}]),t}(),To=function(){this.time=void 0,this.value=void 0},wo=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).inTangent=void 0,t.outTangent=void 0,t}return E(t,e),t}(To);e.AnimatorConditionMode=void 0,(yo=e.AnimatorConditionMode||(e.AnimatorConditionMode={}))[yo.If=0]="If",yo[yo.IfNot=1]="IfNot",yo[yo.Greater=2]="Greater",yo[yo.Less=3]="Less",yo[yo.Equals=4]="Equals",yo[yo.NotEquals=5]="NotEquals";var bo,Co,So=function(t){function r(r){var n;return(n=t.call(this,r,zt.find("skybox"))||this)._decodeParam=new v(0,5,0,0),n.renderState.rasterState.cullMode=e.CullMode.Off,n.renderState.depthState.compareFunction=e.CompareFunction.LessEqual,n.shaderData.setVector4("u_cubeDecodeParam",n._decodeParam),n}return E(r,t),A(r,[{key:"textureDecodeRGBM",get:function(){return Boolean(this._decodeParam.x)},set:function(e){this._decodeParam.x=Number(e)}},{key:"RGBMDecodeFactor",get:function(){return this._decodeParam.y},set:function(e){this._decodeParam.y=e}},{key:"textureCubeMap",get:function(){return this.shaderData.getTexture("u_cube")},set:function(e){this.shaderData.setTexture("u_cube",e)}}]),r}(gr);!function(e){e[e.Position=1]="Position",e[e.Velocity=2]="Velocity",e[e.Acceleration=4]="Acceleration",e[e.Color=8]="Color",e[e.Alpha=16]="Alpha",e[e.Size=32]="Size",e[e.StartAngle=64]="StartAngle",e[e.StartTime=128]="StartTime",e[e.LifeTime=256]="LifeTime",e[e.RotateVelocity=512]="RotateVelocity",e[e.Scale=1024]="Scale",e[e.Everything=4294967295]="Everything"}(bo||(bo={})),e.ParticleRendererBlendMode=void 0,(Co=e.ParticleRendererBlendMode||(e.ParticleRendererBlendMode={}))[Co.Transparent=0]="Transparent",Co[Co.Additive=1]="Additive";var Mo=function(t){function r(r){var n;return(n=t.call(this,r)||this)._vertexStride=void 0,n._vertices=void 0,n._vertexBuffer=void 0,n._maxCount=1e3,n._position=new o,n._positionRandomness=new o,n._positionArray=void 0,n._velocity=new o,n._velocityRandomness=new o,n._acceleration=new o,n._accelerationRandomness=new o,n._color=new T(1,1,1,1),n._colorRandomness=0,n._size=1,n._sizeRandomness=0,n._alpha=1,n._alphaRandomness=0,n._startAngle=0,n._startAngleRandomness=0,n._rotateVelocity=0,n._rotateVelocityRandomness=0,n._lifetime=5,n._startTimeRandomness=0,n._scale=1,n._isOnce=!1,n._onceTime=0,n._time=0,n._isInit=!1,n._isStart=!1,n._updateDirtyFlag=bo.Everything,n._isRotateToVelocity=!1,n._isUseOriginColor=!1,n._isScaleByLifetime=!1,n._is2d=!0,n._isFadeIn=!1,n._isFadeOut=!1,n._playOnEnable=!0,n._blendMode=e.ParticleRendererBlendMode.Transparent,n.spriteSheet=void 0,n.setMaterial(n._createMaterial()),n}E(r,t),r._getRandom=function(){return Math.random()-.5};var n=r.prototype;return n.update=function(e){if(this._isInit&&this._isStart){if(this._isOnce&&this._time>this._onceTime)return this.stop();this._updateDirtyFlag&&(this._updateBuffer(),this._updateDirtyFlag=0),this._time+=e/1e3,this.shaderData.setFloat("u_time",this._time)}},n._onEnable=function(){t.prototype._onEnable.call(this),this._playOnEnable&&this.start()},n.start=function(){this._isStart=!0,this._time=0},n.stop=function(){this._isStart=!1},n._createMaterial=function(){var t=new gr(this.engine,zt.find("particle-shader")),r=t.renderState,n=r.blendState.targetBlendState;return n.enabled=!0,n.sourceColorBlendFactor=e.BlendFactor.SourceAlpha,n.destinationColorBlendFactor=e.BlendFactor.OneMinusSourceAlpha,n.sourceAlphaBlendFactor=e.BlendFactor.One,n.destinationAlphaBlendFactor=e.BlendFactor.OneMinusSourceAlpha,r.depthState.writeEnabled=!1,t.renderQueueType=e.RenderQueueType.Transparent,this.isUseOriginColor=!0,this.is2d=!0,this.isFadeOut=!0,t},n._createMesh=function(){var t=new yn(this._entity.engine,"particleMesh"),n=4*this._maxCount,i=96*n,a=new Float32Array(i),o=null,s=!1;if(n>r._uint16VertexLimit){if(!this.engine._hardwareRenderer.canIUse(e.GLCapabilityType.elementIndexUint))throw Error("The vertex count is over limit.");s=!0,o=new Uint32Array(6*this._maxCount)}else o=new Uint16Array(6*this._maxCount);for(var l=0,u=0;l<this._maxCount;++l){var c=4*l;o[u++]=c,o[u++]=c+1,o[u++]=c+2,o[u++]=c,o[u++]=c+2,o[u++]=c+3}var h=[new Nr("a_position",0,e.VertexElementFormat.Vector3,0),new Nr("a_velocity",12,e.VertexElementFormat.Vector3,0),new Nr("a_acceleration",24,e.VertexElementFormat.Vector3,0),new Nr("a_color",36,e.VertexElementFormat.Vector4,0),new Nr("a_lifeAndSize",52,e.VertexElementFormat.Vector4,0),new Nr("a_rotation",68,e.VertexElementFormat.Vector2,0),new Nr("a_uv",76,e.VertexElementFormat.Vector3,0),new Nr("a_normalizedUv",88,e.VertexElementFormat.Vector2,0)],d=new kr(this.engine,e.BufferBindFlag.VertexBuffer,4*i,e.BufferUsage.Dynamic),_=new kr(this.engine,e.BufferBindFlag.IndexBuffer,o,e.BufferUsage.Dynamic);return t.setVertexBufferBinding(d,96),t.setIndexBufferBinding(_,s?e.IndexFormat.UInt32:e.IndexFormat.UInt16),t.setVertexElements(h),t.addSubMesh(0,o.length),this._vertexBuffer=d,this._vertexStride=24,this._vertices=a,t},n._updateBuffer=function(){for(var e=0;e<this._maxCount;e++)this._updateSingleBuffer(e);this._vertexBuffer.setData(this._vertices)},n._updateSingleBuffer=function(e){var t=this._updateDirtyFlag,n=this._vertices,i=this._vertexStride,o=r._getRandom,s=4*e,l=s*i,u=(s+1)*i,c=(s+2)*i,h=(s+3)*i;if(t&bo.Position){var d=this._position,_=d.x,f=d.y,p=d.z,g=this._positionArray,v=this._positionRandomness;if(g){if(g.length!==this._maxCount)throw Error("The length of positionArray must be equal to maxCount.");var m=g[e];_+=m.x,f+=m.y,p+=m.z}else _+=o()*v.x,f+=o()*v.y,p+=o()*v.z;n[l]=n[u]=n[c]=n[h]=_,n[l+1]=n[u+1]=n[c+1]=n[h+1]=f,n[l+2]=n[u+2]=n[c+2]=n[h+2]=p}if(t&bo.Velocity){var y=this._velocity,x=this._velocityRandomness;n[l+3]=n[u+3]=n[c+3]=n[h+3]=y.x+o()*x.x,n[l+4]=n[u+4]=n[c+4]=n[h+4]=y.y+o()*x.y,n[l+5]=n[u+5]=n[c+5]=n[h+5]=y.z+o()*x.z}if(t&bo.Acceleration){var T=this._acceleration,w=this._accelerationRandomness;n[l+6]=n[u+6]=n[c+6]=n[h+6]=T.x+o()*w.x,n[l+7]=n[u+7]=n[c+7]=n[h+7]=T.y+o()*w.y,n[l+8]=n[u+8]=n[c+8]=n[h+8]=T.z+o()*w.z}if(t&bo.Color){var b=this._color,C=this._colorRandomness;n[l+9]=n[u+9]=n[c+9]=n[h+9]=a.clamp(b.r+o()*C,0,1),n[l+10]=n[u+10]=n[c+10]=n[h+10]=a.clamp(b.g+o()*C,0,1),n[l+11]=n[u+11]=n[c+11]=n[h+11]=a.clamp(b.b+o()*C,0,1)}if(t&bo.Alpha&&(n[l+12]=n[u+12]=n[c+12]=n[h+12]=a.clamp(this._alpha+o()*this._alphaRandomness,0,1)),t&bo.StartTime&&(n[l+13]=n[u+13]=n[c+13]=n[h+13]=Math.random()*this._startTimeRandomness),t&bo.LifeTime){var S=this._lifetime;n[l+14]=n[u+14]=n[c+14]=n[h+14]=S+o()*S}if((t&bo.StartTime||t&bo.LifeTime)&&(this._onceTime=Math.max(this._onceTime,n[l+13]+n[l+14])),t&bo.Size){var M=this._size;n[l+15]=n[u+15]=n[c+15]=n[h+15]=Math.max(M+o()*this._sizeRandomness*M*2,0)}t&bo.Scale&&(n[l+16]=n[u+16]=n[c+16]=n[h+16]=this._scale),t&bo.StartAngle&&(n[l+17]=n[u+17]=n[c+17]=n[h+17]=this._startAngle+o()*Math.PI*this._startAngleRandomness*2),t&bo.RotateVelocity&&(n[l+18]=n[u+18]=n[c+18]=n[h+18]=this._rotateVelocity+o()*this._rotateVelocityRandomness),this._updateSingleUv(e,l,u,c,h)},n._updateSingleUv=function(e,t,r,n,i){var a=this.spriteSheet,o=this.getMaterial().shaderData.getTexture("u_texture"),s=this._vertices;if(o){var l=o.width,u=o.height;if(a){var c=a[e%a.length],h=c.x,d=c.y,_=c.w,f=c.h,p=h/l,g=d/u,v=p+_/l,m=g+f/u,y=f/_;s[t+19]=p,s[t+20]=m,s[t+21]=y,s[r+19]=v,s[r+20]=m,s[r+21]=y,s[n+19]=v,s[n+20]=g,s[n+21]=y,s[i+19]=p,s[i+20]=g,s[i+21]=y}else{var x=u/l;s[t+19]=0,s[t+20]=1,s[t+21]=x,s[r+19]=1,s[r+20]=1,s[r+21]=x,s[n+19]=1,s[n+20]=0,s[n+21]=x,s[i+19]=0,s[i+20]=0,s[i+21]=x}}else s[t+19]=0,s[t+20]=0,s[t+21]=1,s[r+19]=1,s[r+20]=0,s[r+21]=1,s[n+19]=1,s[n+20]=1,s[n+21]=1,s[i+19]=0,s[i+20]=1,s[i+21]=1;s[t+22]=-.5,s[t+23]=-.5,s[r+22]=.5,s[r+23]=-.5,s[n+22]=.5,s[n+23]=.5,s[i+22]=-.5,s[i+23]=.5},A(r,[{key:"texture",get:function(){return this.getMaterial().shaderData.getTexture("u_texture")},set:function(e){e?(this.shaderData.enableMacro("particleTexture"),this.getMaterial().shaderData.setTexture("u_texture",e)):this.shaderData.disableMacro("particleTexture")}},{key:"position",get:function(){return this._position},set:function(e){this._updateDirtyFlag|=bo.Position,this._position=e}},{key:"positionRandomness",get:function(){return this._positionRandomness},set:function(e){this._updateDirtyFlag|=bo.Position,this._positionRandomness=e}},{key:"positionArray",get:function(){return this._positionArray},set:function(e){this._updateDirtyFlag|=bo.Position,this._positionArray=e}},{key:"velocity",get:function(){return this._velocity},set:function(e){this._updateDirtyFlag|=bo.Velocity,this._velocity=e}},{key:"velocityRandomness",get:function(){return this._velocityRandomness},set:function(e){this._updateDirtyFlag|=bo.Velocity,this._velocityRandomness=e}},{key:"acceleration",get:function(){return this._acceleration},set:function(e){this._updateDirtyFlag|=bo.Acceleration,this._acceleration=e}},{key:"accelerationRandomness",get:function(){return this._accelerationRandomness},set:function(e){this._updateDirtyFlag|=bo.Acceleration,this._accelerationRandomness=e}},{key:"color",get:function(){return this._color},set:function(e){this._updateDirtyFlag|=bo.Color,this._color=e}},{key:"colorRandomness",get:function(){return this._colorRandomness},set:function(e){this._updateDirtyFlag|=bo.Color,this._colorRandomness=e}},{key:"size",get:function(){return this._size},set:function(e){this._updateDirtyFlag|=bo.Size,this._size=e}},{key:"sizeRandomness",get:function(){return this._sizeRandomness},set:function(e){this._updateDirtyFlag|=bo.Size,this._sizeRandomness=e}},{key:"alpha",get:function(){return this._alpha},set:function(e){this._updateDirtyFlag|=bo.Alpha,this._alpha=e}},{key:"alphaRandomness",get:function(){return this._alphaRandomness},set:function(e){this._updateDirtyFlag|=bo.Alpha,this._alphaRandomness=e}},{key:"angle",get:function(){return this._startAngle},set:function(e){this._updateDirtyFlag|=bo.StartAngle,this._startAngle=e}},{key:"angleRandomness",get:function(){return this._startAngleRandomness},set:function(e){this._updateDirtyFlag|=bo.StartAngle,this._startAngleRandomness=e}},{key:"rotateVelocity",get:function(){return this._rotateVelocity},set:function(e){this._updateDirtyFlag|=bo.RotateVelocity,this._rotateVelocity=e}},{key:"rotateVelocityRandomness",get:function(){return this._rotateVelocityRandomness},set:function(e){this._updateDirtyFlag|=bo.RotateVelocity,this._rotateVelocityRandomness=e}},{key:"lifetime",get:function(){return this._lifetime},set:function(e){this._updateDirtyFlag|=bo.LifeTime,this._lifetime=e,this._onceTime=0}},{key:"startTimeRandomness",get:function(){return this._startTimeRandomness},set:function(e){this._updateDirtyFlag|=bo.StartTime,this._startTimeRandomness=e,this._onceTime=0}},{key:"scale",get:function(){return this._scale},set:function(e){this._updateDirtyFlag|=bo.Scale,this._scale=e}},{key:"maxCount",get:function(){return this._maxCount},set:function(e){this._isStart=!1,this._isInit=!1,this._maxCount=e,this._updateDirtyFlag=bo.Everything,this.mesh=this._createMesh(),this._updateBuffer(),this._isInit=!0,this.shaderData.setFloat("u_time",0)}},{key:"isOnce",get:function(){return this._isOnce},set:function(e){this._time=0,this.shaderData.setInt("u_once",e?1:0),this._isOnce=e}},{key:"isRotateToVelocity",get:function(){return this._isRotateToVelocity},set:function(e){e?this.shaderData.enableMacro("rotateToVelocity"):this.shaderData.disableMacro("rotateToVelocity"),this._isRotateToVelocity=e}},{key:"isUseOriginColor",get:function(){return this._isUseOriginColor},set:function(e){e?this.shaderData.enableMacro("useOriginColor"):this.shaderData.disableMacro("useOriginColor"),this._isUseOriginColor=e}},{key:"isScaleByLifetime",get:function(){return this._isScaleByLifetime},set:function(e){e?this.shaderData.enableMacro("isScaleByLifetime"):this.shaderData.disableMacro("isScaleByLifetime"),this._isScaleByLifetime=e}},{key:"is2d",get:function(){return this._is2d},set:function(t){t?this.shaderData.enableMacro("is2d"):(this.shaderData.disableMacro("is2d"),this.getMaterial().renderState.rasterState.cullMode=e.CullMode.Off),this._is2d=t}},{key:"isFadeIn",get:function(){return this._isFadeIn},set:function(e){e?this.shaderData.enableMacro("fadeIn"):this.shaderData.disableMacro("fadeIn"),this._isFadeIn=e}},{key:"isFadeOut",get:function(){return this._isFadeOut},set:function(e){e?this.shaderData.enableMacro("fadeOut"):this.shaderData.disableMacro("fadeOut"),this._isFadeOut=e}},{key:"playOnEnable",get:function(){return this._playOnEnable},set:function(e){this._playOnEnable=e,e?this.start():this.stop()}},{key:"blendMode",get:function(){return this._blendMode},set:function(t){var r=this.getMaterial().renderState.blendState.targetBlendState;t===e.ParticleRendererBlendMode.Transparent?(r.enabled=!0,r.sourceColorBlendFactor=e.BlendFactor.SourceAlpha,r.destinationColorBlendFactor=e.BlendFactor.OneMinusSourceAlpha,r.sourceAlphaBlendFactor=e.BlendFactor.One,r.destinationAlphaBlendFactor=e.BlendFactor.OneMinusSourceAlpha):t===e.ParticleRendererBlendMode.Additive&&(r.enabled=!0,r.sourceColorBlendFactor=e.BlendFactor.SourceAlpha,r.destinationColorBlendFactor=e.BlendFactor.One,r.sourceAlphaBlendFactor=e.BlendFactor.One,r.destinationAlphaBlendFactor=e.BlendFactor.OneMinusSourceAlpha),this._blendMode=t}}]),r}(gn);Mo._uint16VertexLimit=65535,zt.create("trail","#define GLSLIFY 1\nattribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 v_uv;uniform mat4 u_projMat;uniform mat4 u_viewMat;void main(){gl_Position=u_projMat*u_viewMat*vec4(POSITION,1.0);v_uv=TEXCOORD_0;}","#define GLSLIFY 1\nvarying vec2 v_uv;uniform sampler2D u_texture;void main(void){gl_FragColor=texture2D(u_texture,v_uv);}");var Ao=function(t){function r(r){var n,i=(n=t.call(this,r,zt.find("trail"))||this).renderState.blendState.targetBlendState;return i.enabled=!0,i.sourceColorBlendFactor=i.sourceAlphaBlendFactor=e.BlendFactor.SourceAlpha,i.destinationColorBlendFactor=i.destinationAlphaBlendFactor=e.BlendFactor.One,n.renderState.depthState.writeEnabled=!1,n}return E(r,t),r}(gr),Po=new o,Fo=function(t){function r(e,r){var n;(n=t.call(this,e)||this)._vertexStride=void 0,n._vertices=void 0,n._vertexBuffer=void 0,n._stroke=void 0,n._minSeg=void 0,n._lifetime=void 0,n._maxPointNum=void 0,n._points=void 0,n._pointStates=void 0,n._strapPoints=void 0,n._curPointNum=void 0,n._prePointsNum=void 0,n._stroke=r.stroke||.2,n._minSeg=r.minSeg||.02,n._lifetime=r.lifetime||1e3,n._maxPointNum=n._lifetime/1e3*e.engine.targetFrameRate,n._points=[],n._pointStates=[],n._strapPoints=[];for(var i=0;i<n._maxPointNum;i++)n._points.push(new o),n._pointStates.push(n._lifetime),n._strapPoints.push(new o),n._strapPoints.push(new o);n._curPointNum=0;var a=r.material||new Ao(n.engine);return n.setMaterial(a),n.setTexture(r.texture),n._initGeometry(),n}E(r,t);var n=r.prototype;return n.update=function(e){for(var t=0,r=0,n=0;n<this._curPointNum;n++)this._pointStates[n]-=e,this._pointStates[n]<0?t++:t>0&&(r=n-t,this._pointStates[r]=this._pointStates[n],this._points[n].cloneTo(this._points[r]));this._curPointNum-=t;var i=!0;if(this._curPointNum===this._maxPointNum)i=!1;else if(this._curPointNum>0){var a=this._points[this._points.length-1];o.distance(this.entity.transform.worldPosition,a)<this._minSeg&&(i=!1)}i&&(this._pointStates[this._curPointNum]=this._lifetime,this.entity.transform.worldPosition.cloneTo(this._points[this._curPointNum]),this._curPointNum++)},n._render=function(e){this._updateStrapVertices(e,this._points),this._updateStrapCoords(),this._vertexBuffer.setData(this._vertices),t.prototype._render.call(this,e)},n.setTexture=function(e){e&&this.getMaterial().shaderData.setTexture("u_texture",e)},n._initGeometry=function(){var t=new yn(this._entity.engine),r=2*this._maxPointNum,n=20*r,i=new Float32Array(n),a=[new Nr("POSITION",0,e.VertexElementFormat.Vector3,0),new Nr("TEXCOORD_0",12,e.VertexElementFormat.Vector2,0)],o=new kr(this.engine,4*n,e.BufferUsage.Dynamic);t.setVertexBufferBinding(o,20),t.setVertexElements(a),t.addSubMesh(0,r,e.MeshTopology.TriangleStrip),this._vertexBuffer=o,this._vertexStride=20,this._vertices=i,this.mesh=t},n._updateStrapVertices=function(e,t){var r=e.viewMatrix.elements,n=new o(r[0],r[4],r[8]),i=new o(r[1],r[5],r[9]),a=new o(r[2],r[6],r[10]),s=this._stroke;i.scale(s);var l=new o,u=new o,c=new _;o.transformByQuat(n,c,n),o.transformByQuat(i,c,i);var h=new o,d=new o,f=new o;n.normalize();for(var p=this._vertices,g=0;g<this._maxPointNum;g++){if(g<this._curPointNum){var v=t[g];g===this._curPointNum-1&&0!==g?o.subtract(v,t[g-1],f):o.subtract(t[g+1],v,f),this._projectOnPlane(f,a,f),f.normalize();var m=Math.acos(o.dot(n,f));o.cross(n,f,d),o.dot(d,a)<=0&&(m=2*Math.PI-m),_.rotationAxisAngle(a,m,c),o.transformByQuat(i,c,h),o.add(v,h,l),o.subtract(v,h,u)}var y=2*g*this._vertexStride/4,x=(2*g+1)*this._vertexStride/4;p[y]=l.x,p[y+1]=l.y,p[y+2]=l.z,p[x]=u.x,p[x+1]=u.y,p[x+2]=u.z}},n._updateStrapCoords=function(){if(this._prePointsNum!==this._curPointNum){this._prePointsNum=this._curPointNum;for(var e=this._curPointNum,t=1/e,r=this._vertices,n=0;n<e;n++){var i=1-n*t,a=2*n*this._vertexStride/4,o=(2*n+1)*this._vertexStride/4;r[a]=0,r[a+1]=i,r[o]=1,r[o+1]=i}}},n._projectOnVector=function(e,t,r){var n=t.clone();o.normalize(n,n);var i=o.dot(e,n);r.x=n.x*i,r.y=n.y*i,r.z=n.z*i},n._projectOnPlane=function(e,t,r){this._projectOnVector(e,t,Po),o.subtract(e,Po,r)},r}(gn),Eo=function(e){function t(t){var r;return(r=e.call(this,t)||this)._color=new T(1,0,0,1),r.color=r._color,r}E(t,e);var r=t.prototype;return r._onEnable=function(){this.scene.shaderData.enableMacro("O3_HAS_FOG")},r._onDisable=function(){this.scene.shaderData.disableMacro("O3_HAS_FOG")},A(t,[{key:"color",get:function(){return this._color},set:function(e){this._color=e,this.scene.shaderData.setColor(t._colorProperty,e)}}]),t}(Je);Eo._colorProperty=zt.getPropertyByName("u_fogColor");var Ro=function(e){function t(t){var r;return(r=e.call(this,t)||this)._density=.0025,r.density=r._density,r}E(t,e);var r=t.prototype;return r._onEnable=function(){this.scene.shaderData.enableMacro("O3_FOG_EXP2")},r._onDisable=function(){this.scene.shaderData.disableMacro("O3_FOG_EXP2")},A(t,[{key:"density",get:function(){return this._density},set:function(e){this._density=e,this.scene.shaderData.setFloat(t._densityProperty,e)}}]),t}(Eo);Ro._densityProperty=zt.getPropertyByName("u_fogDensity");var Lo=function(e){function t(t){var r;return(r=e.call(this,t)||this)._near=1,r._far=1e3,r.near=r._near,r.far=r._far,r}return E(t,e),A(t,[{key:"near",get:function(){return this._near},set:function(e){this._near=e,this.scene.shaderData.setFloat(t._nearProperty,e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=e,this.scene.shaderData.setFloat(t._farProperty,e)}}]),t}(Eo);Lo._nearProperty=zt.getPropertyByName("u_fogNear"),Lo._farProperty=zt.getPropertyByName("u_fogFar");var Bo=function(t){function r(){for(var r,n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return(r=t.call.apply(t,[this].concat(i))||this).probeLayer=e.Layer.Everything,r.width=1024,r.height=1024,r.antiAliasing=1,r._isCube=!1,r._oriCameraRenderTarget=void 0,r._renderTarget=void 0,r._renderTargetSwap=void 0,r._activeRenderTarget=void 0,r._camera=void 0,r._oriCameraCullingMask=void 0,r}E(r,t);var n=r.prototype;return n.onTextureChange=function(e){},n.onBeginRender=function(t){this.enabled&&(this._camera=t,this._oriCameraCullingMask=t.cullingMask,t.cullingMask=this.probeLayer,this._activeRenderTarget&&this._activeRenderTarget.width===this.width&&this._activeRenderTarget.height===this.height&&this._activeRenderTarget.antiAliasing===this.antiAliasing||(this._renderTarget=new Qr(this.engine,this.width,this.height,this._isCube?new Zr(this.engine,this.width):new ie(this.engine,this.width,this.height),e.RenderBufferDepthFormat.Depth,this.antiAliasing),this._renderTargetSwap=new Qr(this.engine,this.width,this.height,this._isCube?new Zr(this.engine,this.width):new ie(this.engine,this.width,this.height),e.RenderBufferDepthFormat.Depth,this.antiAliasing),this._activeRenderTarget=this._renderTarget),this._oriCameraRenderTarget=t.renderTarget,t.renderTarget=this._activeRenderTarget)},n.onEndRender=function(e){this.enabled&&(this.onTextureChange&&this.onTextureChange(this._texture),this._activeRenderTarget=this._activeRenderTarget===this._renderTarget?this._renderTargetSwap:this._renderTarget)},n._reset=function(){this.enabled&&(this._camera.renderTarget=this._oriCameraRenderTarget,this._camera.cullingMask=this._oriCameraCullingMask)},A(r,[{key:"_texture",get:function(){var e;return null===(e=this._activeRenderTarget)||void 0===e?void 0:e.getColorTexture()}}]),r}(ni),Do=new o,Io=new o,Oo=new o,zo=function(t){function r(){for(var e,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(e=t.call.apply(t,[this].concat(n))||this).position=new o(0,0,0),e._isCube=!0,e.oriViewMatrix=new f,e._oriFieldOfView=void 0,e}E(r,t);var n=r.prototype;return n.onBeginRender=function(r){if(this.enabled){t.prototype.onBeginRender.call(this,r),this._storeCamera(r);for(var n=0;n<6;n++)this._setCamera(n,r),r.render(e.TextureCubeFace.PositiveX+n);this._restoreCamera(r),t.prototype._reset.call(this)}},n._storeCamera=function(e){e.viewMatrix.cloneTo(this.oriViewMatrix),this._oriFieldOfView=e.fieldOfView},n._restoreCamera=function(e){this.oriViewMatrix.cloneTo(e.viewMatrix),e.fieldOfView=this._oriFieldOfView},n._setCamera=function(e,t){switch(e){case 0:Io.setValue(0,-1,0),Oo.setValue(1,0,0);break;case 1:Io.setValue(0,-1,0),Oo.setValue(-1,0,0);break;case 2:Io.setValue(0,0,1),Oo.setValue(0,1,0);break;case 3:Io.setValue(0,0,-1),Oo.setValue(0,-1,0);break;case 4:Io.setValue(0,-1,0),Oo.setValue(0,0,1);break;case 5:Io.setValue(0,-1,0),Oo.setValue(0,0,-1)}o.add(this.position,Oo,Do),f.lookAt(this.position,Do,Io,t.viewMatrix),t.fieldOfView=90},r}(Bo),Vo=function(){function e(e,t){void 0===t&&(t={engine:null,width:512,height:512}),this._mapSize=void 0,this._renderTarget=void 0,this.light=void 0,this.bias=.005,this.intensity=.2,this.radius=1,this.projectionMatrix=new f,this.light=e;var r=t,n=r.engine,i=r.width,a=r.height;this._mapSize=new g(i,a),this._renderTarget=new Qr(n,i,a,new ie(n,i,a))}e._updateShaderData=function(t){var r=e._combinedData;t.setFloatArray(e._viewMatFromLightProperty,r.viewMatrix),t.setFloatArray(e._projMatFromLightProperty,r.projectionMatrix),t.setFloatArray(e._shadowBiasProperty,r.bias),t.setFloatArray(e._shadowIntensityProperty,r.intensity),t.setFloatArray(e._shadowRadiusProperty,r.radius),t.setFloatArray(e._shadowMapSizeProperty,r.mapSize),t.setTextureArray(e._shadowMapsProperty,r.map)},e.clearMap=function(){e._combinedData.map.length=0};var t=e.prototype;return t.initShadowProjectionMatrix=function(e){if(e instanceof Bn&&f.ortho(-5,5,-5,5,.1,50,this.projectionMatrix),e instanceof Dn&&f.perspective(a.degreeToRadian(50),1,.5,50,this.projectionMatrix),e instanceof In){var t=Math.min(Math.PI/2,2*e.angle*Math.sqrt(2));f.perspective(t,1,.1,e.distance+5,this.projectionMatrix)}},t.appendData=function(t){var r=16*t,n=16*t,i=t,a=t,o=t,s=2*t,l=t,u=e._combinedData;u.viewMatrix.set(this.light.viewMatrix.elements,r),u.projectionMatrix.set(this.projectionMatrix.elements,n),u.bias[i]=this.bias,u.intensity[a]=this.intensity,u.radius[o]=this.radius,u.mapSize[s]=this.mapSize.x,u.mapSize[s+1]=this.mapSize.y,u.map[l]=this.map},A(e,[{key:"renderTarget",get:function(){return this._renderTarget}},{key:"map",get:function(){return this._renderTarget.getColorTexture()}},{key:"mapSize",get:function(){return this._mapSize}}]),e}();Vo._viewMatFromLightProperty=zt.getPropertyByName("u_viewMatFromLight"),Vo._projMatFromLightProperty=zt.getPropertyByName("u_projMatFromLight"),Vo._shadowBiasProperty=zt.getPropertyByName("u_shadowBias"),Vo._shadowIntensityProperty=zt.getPropertyByName("u_shadowIntensity"),Vo._shadowRadiusProperty=zt.getPropertyByName("u_shadowRadius"),Vo._shadowMapSizeProperty=zt.getPropertyByName("u_shadowMapSize"),Vo._shadowMapsProperty=zt.getPropertyByName("u_shadowMaps"),Vo._maxLight=3,Vo._combinedData={viewMatrix:new Float32Array(16*Vo._maxLight),projectionMatrix:new Float32Array(16*Vo._maxLight),bias:new Float32Array(Vo._maxLight),intensity:new Float32Array(Vo._maxLight),radius:new Float32Array(Vo._maxLight),mapSize:new Float32Array(2*Vo._maxLight),map:[]},Object.defineProperty(Ln.prototype,"enableShadow",{get:function(){return this._enableShadow},set:function(e){if(this._enableShadow=e,this._enableShadow){if(this instanceof En)return this._enableShadow=!1,void re.warn("Has no shadow!");this.shadow=this.shadow||new Vo(this,{engine:this.engine,width:512,height:512}),this.shadow.initShadowProjectionMatrix(this)}}}),Object.defineProperty(Je.prototype,"receiveShadow",{get:function(){return this._recieveShadow},set:function(e){this._recieveShadow=e}}),Object.defineProperty(Je.prototype,"castShadow",{get:function(){return this._castShadow},set:function(e){this._castShadow=e}});var No=function(e){function t(t){var r;return(r=e.call(this,t,zt.find("shadow-map"))||this).shaderData.enableMacro("O3_GENERATE_SHADOW_MAP"),r}return E(t,e),t}(gr),Uo=function(e){function t(t,r,n,i,a,o){var s;return(s=e.call(this,t,r,n,i,a)||this).light=void 0,s.light=o,s.clearColor=new T(1,1,1,1),s}return E(t,e),t.prototype.preRender=function(e,r){var n=this.replaceMaterial.shaderData;n.setMatrix(t._viewMatFromLightProperty,this.light.viewMatrix),n.setMatrix(t._projMatFromLightProperty,this.light.shadow.projectionMatrix)},t}(ai);Uo._viewMatFromLightProperty=zt.getPropertyByName("u_viewMatFromLight"),Uo._projMatFromLightProperty=zt.getPropertyByName("u_projMatFromLight");var ko,Go=function(t){function r(r){var n,i=(n=t.call(this,r,zt.find("shadow"))||this).renderState.blendState.targetBlendState;return i.enabled=!0,i.sourceColorBlendFactor=i.sourceAlphaBlendFactor=e.BlendFactor.DestinationColor,i.destinationColorBlendFactor=i.destinationAlphaBlendFactor=e.BlendFactor.Zero,n.renderState.depthState.compareFunction=e.CompareFunction.LessEqual,n.renderQueueType=e.RenderQueueType.Transparent,n}return E(r,t),r}(gr),Ho=function(t){function r(){for(var r,n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return(r=t.call.apply(t,[this].concat(i))||this).clearFlags=e.CameraClearFlags.None,r}return E(r,t),r.prototype.preRender=function(e,t){this.enabled=!1;var r=e.scene.findFeature(On).visibleLights,n=this.replaceMaterial.shaderData,i=e._renderPipeline.defaultRenderPass;this.renderTarget=i.renderTarget;var a=0;Vo.clearMap();for(var o=0,s=r.length;o<s;o++){var l=r[o];l.enableShadow&&l.shadow.appendData(a++)}a?(this.enabled=!0,Vo._updateShaderData(n),n.enableMacro("O3_SHADOW_MAP_COUNT",a.toString())):n.disableMacro("O3_SHADOW_MAP_COUNT")},r}(ai),Wo=function(t){function r(){for(var e,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(e=t.call.apply(t,[this].concat(n))||this)._shadowPass=void 0,e._shadowMapMaterial=void 0,e}E(r,t);var n=r.prototype;return n.preRender=function(e,t){var r=e.findFeature(On).visibleLights;if(r.length>0){this._shadowPass||this.addShadowPass(t);for(var n=t._renderPipeline,i=0,a=r.length;i<a;i++){var o=r[i];o.enableShadow&&!o.shadowMapPass?o.shadowMapPass=this.addShadowMapPass(t,o):!o.enableShadow&&o.shadowMapPass&&(n.removeRenderPass(o.shadowMapPass),o.shadowMapPass=null)}this.updatePassRenderFlag(n._opaqueQueue),this.updatePassRenderFlag(n._alphaTestQueue),this.updatePassRenderFlag(n._transparentQueue)}},n.addShadowPass=function(t){var r=new Go(t.engine);this._shadowPass=new Ho("ShadowPass",1,null,r,e.Layer.Layer30),t._renderPipeline.addRenderPass(this._shadowPass)},n.addShadowMapPass=function(t,r){this._shadowMapMaterial=this._shadowMapMaterial||new No(t.engine);var n=new Uo("ShadowMapPass",-1,r.shadow.renderTarget,this._shadowMapMaterial,e.Layer.Layer31,r);return t._renderPipeline.addRenderPass(n),n},n.updatePassRenderFlag=function(t){for(var r=t.items,n=0,i=r.length;n<i;n++){var a=r[n].component,o=a.recieveShadow,s=a.castShadow;!0===o?a.entity.layer|=e.Layer.Layer30:!1===o&&(a.entity.layer&=~e.Layer.Layer30),!0===s?a.entity.layer|=e.Layer.Layer31:!1===s&&(a.entity.layer&=~e.Layer.Layer31)}},r}(Rn);function jo(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function Xo(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Ko(e,t,r){return t&&Xo(e.prototype,t),r&&Xo(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function qo(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Yo(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,Qo(e,t)}function Qo(e,t){return(Qo=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}zn.registerFeature(Wo),zn.registerFeature(On),zn.prototype.hasLight=function(){return this.findFeature(On).visibleLights.length>0},e.GLCompressedTextureInternalFormat=void 0,(ko=e.GLCompressedTextureInternalFormat||(e.GLCompressedTextureInternalFormat={}))[ko.RGBA_ASTC_4X4_KHR=37808]="RGBA_ASTC_4X4_KHR",ko[ko.RGBA_ASTC_5X4_KHR=37809]="RGBA_ASTC_5X4_KHR",ko[ko.RGBA_ASTC_5X5_KHR=37810]="RGBA_ASTC_5X5_KHR",ko[ko.RGBA_ASTC_6X5_KHR=37811]="RGBA_ASTC_6X5_KHR",ko[ko.RGBA_ASTC_6X6_KHR=37812]="RGBA_ASTC_6X6_KHR",ko[ko.RGBA_ASTC_8X5_KHR=37813]="RGBA_ASTC_8X5_KHR",ko[ko.RGBA_ASTC_8X6_KHR=37814]="RGBA_ASTC_8X6_KHR",ko[ko.RGBA_ASTC_8X8_KHR=37815]="RGBA_ASTC_8X8_KHR",ko[ko.RGBA_ASTC_10X5_KHR=37816]="RGBA_ASTC_10X5_KHR",ko[ko.RGBA_ASTC_10X6_KHR=37817]="RGBA_ASTC_10X6_KHR",ko[ko.RGBA_ASTC_10X8_KHR=37818]="RGBA_ASTC_10X8_KHR",ko[ko.RGBA_ASTC_10X10_KHR=37819]="RGBA_ASTC_10X10_KHR",ko[ko.RGBA_ASTC_12X10_KHR=37820]="RGBA_ASTC_12X10_KHR",ko[ko.RGBA_ASTC_12X12_KHR=37821]="RGBA_ASTC_12X12_KHR",ko[ko.SRGB8_ALPHA8_ASTC_4X4_KHR=37840]="SRGB8_ALPHA8_ASTC_4X4_KHR",ko[ko.SRGB8_ALPHA8_ASTC_5X4_KHR=37841]="SRGB8_ALPHA8_ASTC_5X4_KHR",ko[ko.SRGB8_ALPHA8_ASTC_5X5_KHR=37842]="SRGB8_ALPHA8_ASTC_5X5_KHR",ko[ko.SRGB8_ALPHA8_ASTC_6X5_KHR=37843]="SRGB8_ALPHA8_ASTC_6X5_KHR",ko[ko.SRGB8_ALPHA8_ASTC_6X6_KHR=37844]="SRGB8_ALPHA8_ASTC_6X6_KHR",ko[ko.SRGB8_ALPHA8_ASTC_8X5_KHR=37845]="SRGB8_ALPHA8_ASTC_8X5_KHR",ko[ko.SRGB8_ALPHA8_ASTC_8X6_KHR=37846]="SRGB8_ALPHA8_ASTC_8X6_KHR",ko[ko.SRGB8_ALPHA8_ASTC_8X8_KHR=37847]="SRGB8_ALPHA8_ASTC_8X8_KHR",ko[ko.SRGB8_ALPHA8_ASTC_10X5_KHR=37848]="SRGB8_ALPHA8_ASTC_10X5_KHR",ko[ko.SRGB8_ALPHA8_ASTC_10X6_KHR=37849]="SRGB8_ALPHA8_ASTC_10X6_KHR",ko[ko.SRGB8_ALPHA8_ASTC_10X8_KHR=37850]="SRGB8_ALPHA8_ASTC_10X8_KHR",ko[ko.SRGB8_ALPHA8_ASTC_10X10_KHR=37851]="SRGB8_ALPHA8_ASTC_10X10_KHR",ko[ko.SRGB8_ALPHA8_ASTC_12X10_KHR=37852]="SRGB8_ALPHA8_ASTC_12X10_KHR",ko[ko.SRGB8_ALPHA8_ASTC_12X12_KHR=37853]="SRGB8_ALPHA8_ASTC_12X12_KHR",ko[ko.RGB_ETC1_WEBGL=36196]="RGB_ETC1_WEBGL",ko[ko.R11_EAC=37488]="R11_EAC",ko[ko.SIGNED_R11_EAC=37489]="SIGNED_R11_EAC",ko[ko.RG11_EAC=37490]="RG11_EAC",ko[ko.SIGNED_RG11_EAC=37491]="SIGNED_RG11_EAC",ko[ko.RGB8_ETC2=37492]="RGB8_ETC2",ko[ko.SRGB8_ETC2=37493]="SRGB8_ETC2",ko[ko.RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="RGB8_PUNCHTHROUGH_ALPHA1_ETC2",ko[ko.SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",ko[ko.RGBA8_ETC2_EAC=37496]="RGBA8_ETC2_EAC",ko[ko.SRGB8_ALPHA8_ETC2_EAC=37497]="SRGB8_ALPHA8_ETC2_EAC",ko[ko.RGB_PVRTC_4BPPV1_IMG=35840]="RGB_PVRTC_4BPPV1_IMG",ko[ko.RGB_PVRTC_2BPPV1_IMG=35841]="RGB_PVRTC_2BPPV1_IMG",ko[ko.RGBA_PVRTC_4BPPV1_IMG=35842]="RGBA_PVRTC_4BPPV1_IMG",ko[ko.RGBA_PVRTC_2BPPV1_IMG=35843]="RGBA_PVRTC_2BPPV1_IMG",ko[ko.RGB_S3TC_DXT1_EXT=33776]="RGB_S3TC_DXT1_EXT",ko[ko.RGBA_S3TC_DXT1_EXT=33777]="RGBA_S3TC_DXT1_EXT",ko[ko.RGBA_S3TC_DXT3_EXT=33778]="RGBA_S3TC_DXT3_EXT",ko[ko.RGBA_S3TC_DXT5_EXT=33779]="RGBA_S3TC_DXT5_EXT";var Jo,Zo=function(){var e=t.prototype;function t(e){this._webCanvas=void 0,this._width=void 0,this._height=void 0,this._scale=new g;var t=e.width,r=e.height;this._webCanvas=e,this._width=t,this._height=r}return e.resizeByClientSize=function(e){void 0===e&&(e=window.devicePixelRatio);var t=this._webCanvas;t instanceof HTMLCanvasElement&&(this.width=t.clientWidth*e,this.height=t.clientHeight*e)},e.setScale=function(e,t){this._scale.setValue(e,t),this.scale=this._scale},Ko(t,[{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._webCanvas.width=e,this._width=e)}},{key:"height",get:function(){return this._height},set:function(e){this._height!==e&&(this._webCanvas.height=e,this._height=e)}},{key:"scale",get:function(){var e=this._webCanvas;return e instanceof HTMLCanvasElement&&this._scale.setValue(e.clientWidth*devicePixelRatio/e.width,e.clientHeight*devicePixelRatio/e.height),this._scale},set:function(e){var t=this._webCanvas;t instanceof HTMLCanvasElement&&(t.style.transformOrigin="left top",t.style.transform="scale("+e.x+", "+e.y+")")}}]),t}(),$o=function(){function t(e){this._maxDrawBuffers=void 0,this._maxAnisoLevel=void 0,this._maxAntiAliasing=void 0,this._rhi=void 0,this.capabilityList=void 0,this._rhi=e,this.capabilityList=new Map,this._init(),this._compatibleAllInterface()}var r=t.prototype;return r.canIUse=function(e){return this.capabilityList.get(e)},r.canIUseCompressedTextureInternalFormat=function(t){var r=e.GLCompressedTextureInternalFormat.RGBA_ASTC_4X4_KHR,n=e.GLCompressedTextureInternalFormat.RGBA_ASTC_12X12_KHR,i=e.GLCompressedTextureInternalFormat.SRGB8_ALPHA8_ASTC_4X4_KHR,a=e.GLCompressedTextureInternalFormat.SRGB8_ALPHA8_ASTC_12X12_KHR,o=e.GLCompressedTextureInternalFormat.RGB_ETC1_WEBGL,s=e.GLCompressedTextureInternalFormat.R11_EAC,l=e.GLCompressedTextureInternalFormat.SRGB8_ALPHA8_ETC2_EAC,u=e.GLCompressedTextureInternalFormat.RGB_PVRTC_4BPPV1_IMG,c=e.GLCompressedTextureInternalFormat.RGBA_PVRTC_2BPPV1_IMG,h=e.GLCompressedTextureInternalFormat.RGB_S3TC_DXT1_EXT,d=e.GLCompressedTextureInternalFormat.RGBA_S3TC_DXT5_EXT;return t>=r&&n<=n||t>=i&&t<=a?this.canIUse(e.GLCapabilityType.astc):t===o?this.canIUse(e.GLCapabilityType.etc1):t>=s&&t<=l?this.canIUse(e.GLCapabilityType.etc):t>=u&&t<=c?this.canIUse(e.GLCapabilityType.pvrtc):t>=h&&t<=d&&this.canIUse(e.GLCapabilityType.s3tc)},r._init=function(){var t=this.capabilityList,r=this.rhi.isWebGL2,n=this.rhi.requireExtension.bind(this.rhi),i=e.GLCapabilityType.shaderVertexID,a=e.GLCapabilityType.standardDerivatives,o=e.GLCapabilityType.shaderTextureLod,s=e.GLCapabilityType.elementIndexUint,l=e.GLCapabilityType.depthTexture,u=e.GLCapabilityType.vertexArrayObject,c=e.GLCapabilityType.instancedArrays,h=e.GLCapabilityType.multipleSample,d=e.GLCapabilityType.drawBuffers,_=e.GLCapabilityType.astc,f=e.GLCapabilityType.astc_webkit,p=e.GLCapabilityType.etc,g=e.GLCapabilityType.etc_webkit,v=e.GLCapabilityType.etc1,m=e.GLCapabilityType.etc1_webkit,y=e.GLCapabilityType.pvrtc,x=e.GLCapabilityType.pvrtc_webkit,T=e.GLCapabilityType.s3tc,w=e.GLCapabilityType.s3tc_webkit,b=e.GLCapabilityType.textureFloat,C=e.GLCapabilityType.textureHalfFloat,S=e.GLCapabilityType.textureFloatLinear,M=e.GLCapabilityType.textureHalfFloatLinear,A=e.GLCapabilityType.WEBGL_colorBufferFloat,P=e.GLCapabilityType.colorBufferFloat,F=e.GLCapabilityType.colorBufferHalfFloat,E=e.GLCapabilityType.textureFilterAnisotropic;t.set(i,r),t.set(a,r||!!n(a)),t.set(o,r||!!n(o)),t.set(s,r||!!n(s)),t.set(l,r||!!n(l)),t.set(u,r||!!n(u)),t.set(c,r||!!n(c)),t.set(h,r),t.set(d,r||!!n(d)),t.set(b,r||!!n(b)),t.set(C,r||!!n(C)),t.set(S,!!n(S)),t.set(M,r||!!n(M)),t.set(P,r&&!!n(P)||!!n(A)),t.set(F,r&&!!n(P)||!!n(F)),t.set(E,!!n(E)),t.set(_,!(!n(_)&&!n(f))),t.set(p,!(!n(p)&&!n(g))),t.set(v,!(!n(v)&&!n(m))),t.set(y,!(!n(y)&&!n(x))),t.set(T,!(!n(T)&&!n(w)))},r._compatibleInterface=function(e,t){var r,n=this.rhi,i=n.gl;if(r=n.requireExtension(e))for(var a in t){var o=r[t[a]];null!=o&&o.bind?i[a]=o.bind(r):i[a]=o}},r._compatibleAllInterface=function(){var t=e.GLCapabilityType.depthTexture,r=e.GLCapabilityType.vertexArrayObject,n=e.GLCapabilityType.instancedArrays,i=e.GLCapabilityType.drawBuffers,a=e.GLCapabilityType.textureFilterAnisotropic,o=e.GLCapabilityType.textureHalfFloat,s=e.GLCapabilityType.colorBufferHalfFloat,l=e.GLCapabilityType.WEBGL_colorBufferFloat;if(!this.rhi.isWebGL2){this._compatibleInterface(t,{UNSIGNED_INT_24_8:"UNSIGNED_INT_24_8_WEBGL"}),this._compatibleInterface(r,{createVertexArray:"createVertexArrayOES",deleteVertexArray:"deleteVertexArrayOES",isVertexArray:"isVertexArrayOES",bindVertexArray:"bindVertexArrayOES"}),this._compatibleInterface(n,{drawArraysInstanced:"drawArraysInstancedANGLE",drawElementsInstanced:"drawElementsInstancedANGLE",vertexAttribDivisor:"vertexAttribDivisorANGLE"}),this._compatibleInterface(i,{MAX_DRAW_BUFFERS:"MAX_DRAW_BUFFERS_WEBGL"});var u={};if(this.canIUse(e.GLCapabilityType.drawBuffers)){for(var c=this.maxDrawBuffers,h=0;h<c;h++)0!=h&&(u["COLOR_ATTACHMENT"+h]="COLOR_ATTACHMENT"+h+"_WEBGL"),u["DRAW_BUFFER"+h]="DRAW_BUFFER"+h+"_WEBGL";this._compatibleInterface(i,function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?jo(Object(r),!0).forEach((function(t){qo(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):jo(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({drawBuffers:"drawBuffersWEBGL"},u))}this._compatibleInterface(o,{HAFL_FLOAT:"HALF_FLOAT_OES"}),this._compatibleInterface(s,{RGBA16F:"RBGA16F_EXT"}),this._compatibleInterface(l,{RGBA32F:"RBGA32F_EXT"})}this._compatibleInterface(a,{TEXTURE_MAX_ANISOTROPY_EXT:"TEXTURE_MAX_ANISOTROPY_EXT"})},Ko(t,[{key:"maxTextureSize",get:function(){return this.rhi.renderStates.getParameter(this.rhi.gl.MAX_TEXTURE_SIZE)}},{key:"canUseFloatTextureBlendShape",get:function(){return this.canIUse(e.GLCapabilityType.shaderVertexID)&&this.canIUse(e.GLCapabilityType.textureFloat)&&this.rhi.renderStates.getParameter(this.rhi.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0}},{key:"canIUseMoreJoints",get:function(){return this.canIUse(e.GLCapabilityType.textureFloat)&&this.rhi.renderStates.getParameter(this.rhi.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0}},{key:"maxDrawBuffers",get:function(){return this._maxDrawBuffers||(this.canIUse(e.GLCapabilityType.drawBuffers)?this._maxDrawBuffers=this._rhi.gl.getParameter(this._rhi.gl.MAX_DRAW_BUFFERS):this._maxDrawBuffers=1),this._maxDrawBuffers}},{key:"maxAnisoLevel",get:function(){if(!this._maxAnisoLevel){var t=this._rhi.requireExtension(e.GLCapabilityType.textureFilterAnisotropic);this._maxAnisoLevel=t?this._rhi.gl.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1}return this._maxAnisoLevel}},{key:"maxAntiAliasing",get:function(){if(!this._maxAntiAliasing){var t=this._rhi.gl,r=this.canIUse(e.GLCapabilityType.multipleSample);this._maxAntiAliasing=r?t.getParameter(t.MAX_SAMPLES):1}return this._maxAntiAliasing}},{key:"rhi",get:function(){return this._rhi}}]),t}(),es=function(){function e(e){this.rhi=void 0,this._requireResult=void 0,this.rhi=e,this._requireResult={}}return e.prototype.requireExtension=function(e){return void 0!==this._requireResult[e]||(this._requireResult[e]=this.rhi.gl.getExtension(e)),this._requireResult[e]},e}(),ts=function(){function t(t,r){this.attribLocArray=void 0,this._primitive=void 0,this.canUseInstancedArrays=void 0,this.gl=void 0,this.vao=new Map,this._useVao=void 0,this._primitive=r,this.canUseInstancedArrays=t.canIUse(e.GLCapabilityType.instancedArrays),this._useVao=t.canIUse(e.GLCapabilityType.vertexArrayObject),this.gl=t.gl}var r=t.prototype;return r.draw=function(e,t){var r=this.gl,n=this._primitive;if(this._useVao){this.vao.has(e.id)||this.registerVAO(e);var i=this.vao.get(e.id);r.bindVertexArray(i)}else this.bindBufferAndAttrib(e);var a=n._indexBufferBinding,o=n._instanceCount,s=n._glIndexType,l=n._glIndexByteCount,u=t.topology,c=t.start,h=t.count;if(o)if(this.canUseInstancedArrays)if(a)if(this._useVao)r.drawElementsInstanced(u,h,s,c*l,o);else{var d=a.buffer._nativeBuffer;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,d),r.drawElementsInstanced(u,h,s,c*l,o),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null)}else r.drawArraysInstanced(u,c,h,o);else re.error("ANGLE_instanced_arrays extension is not supported");else if(a)if(this._useVao)r.drawElements(u,h,s,c*l);else{var _=a.buffer._nativeBuffer;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,_),r.drawElements(u,h,s,c*l),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null)}else r.drawArrays(u,c,h);this._useVao?r.bindVertexArray(null):this.disableAttrib()},r.destroy=function(){if(this._useVao){var e=this.gl;this.vao.forEach((function(t){e.deleteVertexArray(t)})),this.vao.clear()}},r.bindBufferAndAttrib=function(e){var t=this.gl,r=this._primitive,n=r._vertexBufferBindings;this.attribLocArray=[];var i,a,o=e.attributeLocation,s=r._vertexElementMap;for(var l in o){var u=o[l];if(-1!==u){var c=s[l];if(c){var h=n[c.bindingIndex],d=h.buffer,_=h.stride;a!==(i=d._nativeBuffer)&&(a=i,t.bindBuffer(t.ARRAY_BUFFER,i)),t.enableVertexAttribArray(u);var f=c._glElementInfo,p=f.size,g=f.type,v=f.normalized;t.vertexAttribPointer(u,p,g,v,_,c.offset),this.canUseInstancedArrays&&t.vertexAttribDivisor(u,c.instanceStepRate),this.attribLocArray.push(u)}else re.warn("vertex attribute not found: "+l)}}t.bindBuffer(t.ARRAY_BUFFER,null)},r.disableAttrib=function(){for(var e=this.gl,t=0,r=this.attribLocArray.length;t<r;t++)e.disableVertexAttribArray(this.attribLocArray[t])},r.registerVAO=function(e){var t=this.gl,r=t.createVertexArray();t.bindVertexArray(r);var n=this._primitive._indexBufferBinding;n&&t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,n.buffer._nativeBuffer),this.bindBufferAndAttrib(e),t.bindVertexArray(null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),this.disableAttrib(),this.vao.set(e.id,r)},t}(),rs=function(){function e(e){this._gl=void 0,this._parameters={},this._gl=e,this._parameters={},this._parameters[e.MAX_COMBINED_TEXTURE_IMAGE_UNITS]=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this._parameters[e.MAX_VERTEX_UNIFORM_VECTORS]=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this._parameters[e.MAX_VERTEX_ATTRIBS]=e.getParameter(e.MAX_VERTEX_ATTRIBS),this._parameters[e.MAX_VERTEX_TEXTURE_IMAGE_UNITS]=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._parameters[e.MAX_TEXTURE_SIZE]=e.getParameter(e.MAX_TEXTURE_SIZE),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.enable(e.DEPTH_TEST),e.depthFunc(e.LESS),e.depthMask(!0),e.disable(e.STENCIL_TEST),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,0,255),e.stencilFuncSeparate(e.BACK,e.ALWAYS,0,255),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMask(255),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0)}return e.prototype.getParameter=function(e){return this._parameters[e]},e}(),ns=function(){function t(e,t,r){this._texture=void 0,this._glTexture=void 0,this._rhi=void 0,this._gl=void 0,this._isWebGL2=void 0,this._target=void 0,this._formatDetail=void 0,this._texture=t,this._rhi=e,this._gl=e.gl,this._isWebGL2=e.isWebGL2,this._target=r,this._glTexture=this._gl.createTexture()}t._isPowerOf2=function(e){return 0==(e&e-1)},t._getFormatDetail=function(t,r,n){switch(t){case e.TextureFormat.R8G8B8:return{internalFormat:n?r.RGB8:r.RGB,baseFormat:r.RGB,dataType:r.UNSIGNED_BYTE,isCompressed:!1};case e.TextureFormat.R8G8B8A8:return{internalFormat:n?r.RGBA8:r.RGBA,baseFormat:r.RGBA,dataType:r.UNSIGNED_BYTE,isCompressed:!1};case e.TextureFormat.R4G4B4A4:return{internalFormat:n?r.RGBA4:r.RGBA,baseFormat:r.RGBA,dataType:r.UNSIGNED_SHORT_4_4_4_4,isCompressed:!1};case e.TextureFormat.R5G5B5A1:return{internalFormat:n?r.RGB5_A1:r.RGBA,baseFormat:r.RGBA,dataType:r.UNSIGNED_SHORT_5_5_5_1,isCompressed:!1};case e.TextureFormat.R5G6B5:return{internalFormat:n?r.RGB565:r.RGB,baseFormat:r.RGB,dataType:r.UNSIGNED_SHORT_5_6_5,isCompressed:!1};case e.TextureFormat.Alpha8:return{internalFormat:r.ALPHA,baseFormat:r.ALPHA,dataType:r.UNSIGNED_BYTE,isCompressed:!1};case e.TextureFormat.LuminanceAlpha:return{internalFormat:r.LUMINANCE_ALPHA,baseFormat:r.LUMINANCE_ALPHA,dataType:r.UNSIGNED_BYTE,isCompressed:!1};case e.TextureFormat.R16G16B16A16:return{internalFormat:r.RGBA16F,baseFormat:r.RGBA,dataType:r.HALF_FLOAT,isCompressed:!1};case e.TextureFormat.R32G32B32A32:return{internalFormat:r.RGBA32F,baseFormat:r.RGBA,dataType:r.FLOAT,isCompressed:!1};case e.TextureFormat.DXT1:return{internalFormat:e.GLCompressedTextureInternalFormat.RGB_S3TC_DXT1_EXT,isCompressed:!0};case e.TextureFormat.DXT5:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA_S3TC_DXT5_EXT,isCompressed:!0};case e.TextureFormat.ETC1_RGB:return{internalFormat:e.GLCompressedTextureInternalFormat.RGB_ETC1_WEBGL,isCompressed:!0};case e.TextureFormat.ETC2_RGB:return{internalFormat:e.GLCompressedTextureInternalFormat.RGB8_ETC2,isCompressed:!0};case e.TextureFormat.ETC2_RGBA5:return{internalFormat:e.GLCompressedTextureInternalFormat.RGB8_PUNCHTHROUGH_ALPHA1_ETC2,isCompressed:!0};case e.TextureFormat.ETC2_RGBA8:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA8_ETC2_EAC,isCompressed:!0};case e.TextureFormat.PVRTC_RGB2:return{internalFormat:e.GLCompressedTextureInternalFormat.RGB_PVRTC_2BPPV1_IMG,isCompressed:!0};case e.TextureFormat.PVRTC_RGBA2:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA_PVRTC_2BPPV1_IMG,isCompressed:!0};case e.TextureFormat.PVRTC_RGB4:return{internalFormat:e.GLCompressedTextureInternalFormat.RGB_PVRTC_4BPPV1_IMG,isCompressed:!0};case e.TextureFormat.PVRTC_RGBA4:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA_PVRTC_4BPPV1_IMG,isCompressed:!0};case e.TextureFormat.ASTC_4x4:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA_ASTC_4X4_KHR,isCompressed:!0};case e.TextureFormat.ASTC_5x5:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA_ASTC_5X5_KHR,isCompressed:!0};case e.TextureFormat.ASTC_6x6:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA_ASTC_6X6_KHR,isCompressed:!0};case e.TextureFormat.ASTC_8x8:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA_ASTC_8X8_KHR,isCompressed:!0};case e.TextureFormat.ASTC_10x10:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA_ASTC_10X10_KHR,isCompressed:!0};case e.TextureFormat.ASTC_12x12:return{internalFormat:e.GLCompressedTextureInternalFormat.RGBA_ASTC_12X12_KHR,isCompressed:!0};default:throw new Error("this TextureFormat is not supported in Oasis Engine: "+t)}},t._getRenderBufferDepthFormatDetail=function(t,r,n){switch(t){case e.TextureFormat.Depth:case e.RenderBufferDepthFormat.Depth:return{internalFormat:n?r.DEPTH_COMPONENT32F:r.DEPTH_COMPONENT16,baseFormat:r.DEPTH_COMPONENT,dataType:n?r.FLOAT:r.UNSIGNED_INT,isCompressed:!1,attachment:r.DEPTH_ATTACHMENT};case e.TextureFormat.DepthStencil:case e.RenderBufferDepthFormat.DepthStencil:return{internalFormat:n?r.DEPTH24_STENCIL8:r.DEPTH_STENCIL,baseFormat:r.DEPTH_STENCIL,dataType:r.UNSIGNED_INT_24_8,isCompressed:!1,attachment:r.DEPTH_STENCIL_ATTACHMENT};case e.TextureFormat.Stencil:case e.RenderBufferDepthFormat.Stencil:return{internalFormat:r.STENCIL_INDEX8,baseFormat:r.STENCIL_ATTACHMENT,dataType:r.UNSIGNED_BYTE,isCompressed:!1,attachment:r.STENCIL_ATTACHMENT};case e.TextureFormat.Depth16:case e.RenderBufferDepthFormat.Depth16:return{internalFormat:r.DEPTH_COMPONENT16,baseFormat:r.DEPTH_COMPONENT,dataType:r.UNSIGNED_INT,isCompressed:!1,attachment:r.DEPTH_ATTACHMENT};case e.TextureFormat.Depth24:case e.RenderBufferDepthFormat.Depth24:return{internalFormat:r.DEPTH_COMPONENT24,baseFormat:r.DEPTH_COMPONENT,dataType:r.UNSIGNED_INT,isCompressed:!1,attachment:r.DEPTH_ATTACHMENT};case e.TextureFormat.Depth32:case e.RenderBufferDepthFormat.Depth32:return{internalFormat:r.DEPTH_COMPONENT32F,baseFormat:r.DEPTH_COMPONENT,dataType:r.FLOAT,isCompressed:!1,attachment:r.DEPTH_ATTACHMENT};case e.TextureFormat.Depth24Stencil8:case e.RenderBufferDepthFormat.Depth24Stencil8:return{internalFormat:n?r.DEPTH24_STENCIL8:r.DEPTH_STENCIL,baseFormat:r.DEPTH_STENCIL,dataType:r.UNSIGNED_INT_24_8,isCompressed:!1,attachment:r.DEPTH_STENCIL_ATTACHMENT};case e.TextureFormat.Depth32Stencil8:case e.RenderBufferDepthFormat.Depth32Stencil8:return{internalFormat:r.DEPTH32F_STENCIL8,baseFormat:r.DEPTH_STENCIL,dataType:r.FLOAT_32_UNSIGNED_INT_24_8_REV,isCompressed:!1,attachment:r.DEPTH_STENCIL_ATTACHMENT};default:throw new Error("this TextureFormat is not supported in Oasis Engine: "+t)}},t._supportTextureFormat=function(t,r){var n=!0;switch(t){case e.TextureFormat.R16G16B16A16:r.canIUse(e.GLCapabilityType.textureHalfFloat)||(n=!1);break;case e.TextureFormat.R32G32B32A32:r.canIUse(e.GLCapabilityType.textureFloat)||(n=!1)}return n},t._supportRenderBufferColorFormat=function(t,r){var n=!0;switch(t){case e.TextureFormat.R16G16B16A16:r.canIUse(e.GLCapabilityType.colorBufferHalfFloat)&&r.canIUse(e.GLCapabilityType.textureHalfFloat)||(n=!1);break;case e.TextureFormat.R32G32B32A32:r.canIUse(e.GLCapabilityType.colorBufferFloat)&&r.canIUse(e.GLCapabilityType.textureFloat)||(n=!1)}return n},t._supportRenderBufferDepthFormat=function(t,r,n){var i=r.isWebGL2,a=!0;if(n&&!r.canIUse(e.GLCapabilityType.depthTexture))return!1;switch(t){case e.RenderBufferDepthFormat.Stencil:case e.TextureFormat.Stencil:a=!1;break;case e.TextureFormat.Depth24:case e.TextureFormat.Depth32:case e.TextureFormat.Depth32Stencil8:case e.RenderBufferDepthFormat.Depth24:case e.RenderBufferDepthFormat.Depth32:case e.RenderBufferDepthFormat.Depth32Stencil8:i||(a=!1)}return a};var r=t.prototype;return r.destroy=function(){this._gl.deleteTexture(this._glTexture),this._texture=null,this._glTexture=null,this._formatDetail=null},r.generateMipmaps=function(){this._bind(),this._gl.generateMipmap(this._target)},r._bind=function(){this._rhi.bindTexture(this)},r._initMipmap=function(e){var t=this._gl,r=this._isWebGL2,n=this._formatDetail,i=n.internalFormat,a=n.baseFormat,o=n.dataType,s=this._texture,l=s.mipmapCount,u=s.width,c=s.height;if(this._bind(),r&&a!==t.LUMINANCE_ALPHA&&a!==t.ALPHA)t.texStorage2D(this._target,l,i,u,c);else if(a!==i&&(i=a),e)for(var h=0;h<l;h++)for(var d=Math.max(1,u>>h),_=0;_<6;_++)t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+_,h,i,d,d,0,a,o,null);else for(var f=0;f<l;f++){var p=Math.max(1,u>>f),g=Math.max(1,c>>f);t.texImage2D(this._target,f,i,p,g,0,a,o,null)}},r._getPixelBuffer=function(e,t,r,n,i,a,o){var s=this._gl,l=this._formatDetail,u=l.baseFormat,c=l.dataType;s.bindFramebuffer(s.FRAMEBUFFER,this._getReadFrameBuffer()),a>0&&!this._isWebGL2&&(a=0,re.error("mipLevel only take effect in WebGL2.0")),null!=e?s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_CUBE_MAP_POSITIVE_X+e,this._glTexture,a):s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this._glTexture,a),s.readPixels(t,r,n,i,u,c,o),s.bindFramebuffer(s.FRAMEBUFFER,null)},r._setWrapMode=function(r,n){var i=this._gl,a=this._isWebGL2,o=this._target,s=this._texture,l=s.width,u=s.height;switch(a||r===e.TextureWrapMode.Clamp||t._isPowerOf2(l)&&t._isPowerOf2(u)||(re.warn("non-power-2 texture is not supported for REPEAT or MIRRORED_REPEAT in WebGL1,and has automatically downgraded to CLAMP_TO_EDGE"),r=e.TextureWrapMode.Clamp),r){case e.TextureWrapMode.Clamp:i.texParameteri(o,n,i.CLAMP_TO_EDGE);break;case e.TextureWrapMode.Repeat:i.texParameteri(o,n,i.REPEAT);break;case e.TextureWrapMode.Mirror:i.texParameteri(o,n,i.MIRRORED_REPEAT)}},r._getReadFrameBuffer=function(){var e=this._rhi._readFrameBuffer;return e||(this._rhi._readFrameBuffer=e=this._gl.createFramebuffer()),e},Ko(t,[{key:"wrapModeU",set:function(e){this._bind(),this._setWrapMode(e,this._gl.TEXTURE_WRAP_S)}},{key:"wrapModeV",set:function(e){this._bind(),this._setWrapMode(e,this._gl.TEXTURE_WRAP_T)}},{key:"filterMode",set:function(t){var r=this._gl,n=this._target,i=this._texture._mipmap;switch(this._bind(),t){case e.TextureFilterMode.Point:r.texParameteri(n,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(n,r.TEXTURE_MIN_FILTER,i?r.NEAREST_MIPMAP_NEAREST:r.NEAREST);break;case e.TextureFilterMode.Bilinear:r.texParameteri(n,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(n,r.TEXTURE_MIN_FILTER,i?r.LINEAR_MIPMAP_NEAREST:r.LINEAR);break;case e.TextureFilterMode.Trilinear:r.texParameteri(n,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(n,r.TEXTURE_MIN_FILTER,i?r.LINEAR_MIPMAP_LINEAR:r.LINEAR)}}},{key:"anisoLevel",set:function(e){var t=this._gl;this._bind(),t.texParameterf(this._target,t.TEXTURE_MAX_ANISOTROPY_EXT,e)}}]),t}(),is=function(){function t(t,r){this._gl=void 0,this._isWebGL2=void 0,this._target=void 0,this._frameBuffer=void 0,this._MSAAFrameBuffer=void 0,this._depthRenderBuffer=void 0,this._MSAAColorRenderBuffers=[],this._MSAADepthRenderBuffer=void 0,this._oriDrawBuffers=void 0,this._blitDrawBuffers=void 0,this._curMipLevel=0,this._gl=t.gl,this._isWebGL2=t.isWebGL2,this._target=r;for(var n=r._colorTextures,i=r._depth,a=r.width,o=r.height,s=i instanceof ne,l=0,u=n.length;l<u;l++){var c=n[l]._format;if(!ns._supportRenderBufferColorFormat(c,t))throw new Error("TextureFormat is not supported:"+e.TextureFormat[c]+" in RenderTarget")}if(!ns._supportRenderBufferDepthFormat(s?i.format:i,t,s))throw new Error("TextureFormat is not supported:"+e.TextureFormat[i]+" in RenderTarget");if(n.length>1&&!t.canIUse(e.GLCapabilityType.drawBuffers))throw new Error("MRT is not supported");if(n.some((function(e){return e.width!==a||e.height!==o})))throw new Error("ColorTexture's size must as same as RenderTarget");if(s&&(i.width!==a||i.height!==o))throw new Error("DepthTexture's size must as same as RenderTarget");if(n.length>1&&n.some((function(e){return e instanceof Zr})))throw new Error("MRT+Cube+[,MSAA] is not supported");var h=t.capability.maxAntiAliasing;r.antiAliasing>h&&(re.warn("MSAA antiAliasing exceeds the limit and is automatically downgraded to:"+h),r._antiAliasing=h),this._frameBuffer=this._gl.createFramebuffer(),this._bindMainFBO(),r.antiAliasing>1&&(this._MSAAFrameBuffer=this._gl.createFramebuffer(),this._bindMSAAFBO())}var r=t.prototype;return r.setRenderTargetInfo=function(e,t){var r=this._gl,n=this._target,i=n.depthTexture,a=n.getColorTexture(0),o=t!==this._curMipLevel;if(r.bindFramebuffer(r.FRAMEBUFFER,this._frameBuffer),a){var s=a instanceof Zr;(o||s)&&r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,s?r.TEXTURE_CUBE_MAP_POSITIVE_X+e:r.TEXTURE_2D,a._platformTexture._glTexture,t)}if(i){var l=i instanceof Zr;if(o||l){var u=i._platformTexture;r.framebufferTexture2D(r.FRAMEBUFFER,u._formatDetail.attachment,l?r.TEXTURE_CUBE_MAP_POSITIVE_X+e:r.TEXTURE_2D,u._glTexture,t)}}else if(o){var c=ns._getRenderBufferDepthFormatDetail(n._depth,r,this._isWebGL2).internalFormat;r.bindRenderbuffer(r.RENDERBUFFER,this._depthRenderBuffer),r.renderbufferStorage(r.RENDERBUFFER,c,n.width>>t,n.height>>t)}this._curMipLevel=t,this._activeRenderTarget()},r.blitRenderTarget=function(){if(this._MSAAFrameBuffer){var e=this._gl,t=e.COLOR_BUFFER_BIT|(this._target.depthTexture?e.DEPTH_BUFFER_BIT:0),r=this._target,n=r.colorTextureCount,i=r.width,a=r.height;e.bindFramebuffer(e.READ_FRAMEBUFFER,this._MSAAFrameBuffer),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this._frameBuffer);for(var o=0;o<n;o++){var s=e.COLOR_ATTACHMENT0+o;this._blitDrawBuffers[o]=s,e.readBuffer(s),e.drawBuffers(this._blitDrawBuffers),e.blitFramebuffer(0,0,i,a,0,0,i,a,t,e.NEAREST),this._blitDrawBuffers[o]=e.NONE}e.bindFramebuffer(e.FRAMEBUFFER,null)}},r.destroy=function(){var e=this._gl;this._frameBuffer&&e.deleteFramebuffer(this._frameBuffer),this._depthRenderBuffer&&e.deleteRenderbuffer(this._depthRenderBuffer),this._MSAAFrameBuffer&&e.deleteFramebuffer(this._MSAAFrameBuffer),this._MSAADepthRenderBuffer&&e.deleteRenderbuffer(this._MSAADepthRenderBuffer);for(var t=0;t<this._MSAAColorRenderBuffers.length;t++)e.deleteRenderbuffer(this._MSAAColorRenderBuffers[t]);this._frameBuffer=null,this._depthRenderBuffer=null,this._MSAAFrameBuffer=null,this._MSAAColorRenderBuffers.length=0,this._MSAADepthRenderBuffer=null},r._activeRenderTarget=function(){var e=this._gl;this._MSAAFrameBuffer?e.bindFramebuffer(e.FRAMEBUFFER,this._MSAAFrameBuffer):e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer)},r._bindMainFBO=function(){var e=this._gl,t=this._isWebGL2,r=this._target,n=r._depth,i=r.colorTextureCount,a=r.width,o=r.height,s=new Array(i);e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer);for(var l=0;l<i;l++){var u=this._target.getColorTexture(l),c=e.COLOR_ATTACHMENT0+l;s[l]=c,u instanceof Zr||e.framebufferTexture2D(e.FRAMEBUFFER,c,e.TEXTURE_2D,u._platformTexture._glTexture,0)}if(i>1&&e.drawBuffers(s),this._oriDrawBuffers=s,null!==n)if(n instanceof ne)n instanceof Zr||e.framebufferTexture2D(e.FRAMEBUFFER,n._platformTexture._formatDetail.attachment,e.TEXTURE_2D,n._platformTexture._glTexture,0);else if(this._target.antiAliasing<=1){var h=ns._getRenderBufferDepthFormatDetail(n,e,t),d=h.internalFormat,_=h.attachment,f=e.createRenderbuffer();this._depthRenderBuffer=f,e.bindRenderbuffer(e.RENDERBUFFER,f),e.renderbufferStorage(e.RENDERBUFFER,d,a,o),e.framebufferRenderbuffer(e.FRAMEBUFFER,_,e.RENDERBUFFER,f)}e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindRenderbuffer(e.RENDERBUFFER,null)},r._bindMSAAFBO=function(){var e=this._gl,t=this._isWebGL2,r=e.createRenderbuffer(),n=this._target,i=n._depth,a=n.colorTextureCount,o=n.antiAliasing,s=n.width,l=n.height;this._blitDrawBuffers=new Array(a),this._MSAADepthRenderBuffer=r,e.bindFramebuffer(e.FRAMEBUFFER,this._MSAAFrameBuffer);for(var u=0;u<a;u++){var c=e.createRenderbuffer();this._MSAAColorRenderBuffers[u]=c,this._blitDrawBuffers[u]=e.NONE,e.bindRenderbuffer(e.RENDERBUFFER,c),e.renderbufferStorageMultisample(e.RENDERBUFFER,o,this._target.getColorTexture(u)._platformTexture._formatDetail.internalFormat,s,l),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+u,e.RENDERBUFFER,c)}if(e.drawBuffers(this._oriDrawBuffers),null!==i){var h=i instanceof ne?i._platformTexture._formatDetail:ns._getRenderBufferDepthFormatDetail(i,e,t),d=h.internalFormat,_=h.attachment;e.bindRenderbuffer(e.RENDERBUFFER,r),e.renderbufferStorageMultisample(e.RENDERBUFFER,o,d,s,l),e.framebufferRenderbuffer(e.FRAMEBUFFER,_,e.RENDERBUFFER,r)}this._checkFrameBuffer(),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindRenderbuffer(e.RENDERBUFFER,null)},r._checkFrameBuffer=function(){var e=this._gl,t=this._isWebGL2,r=e.checkFramebufferStatus(e.FRAMEBUFFER);switch(r){case e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw new Error("The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete");case e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw new Error("There is no attachment");case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error(" Height and width of the attachment are not the same.");case e.FRAMEBUFFER_UNSUPPORTED:throw new Error("The format of the attachment is not supported or if depth and stencil attachments are not the same renderbuffer")}if(t&&r===e.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE)throw new Error("The values of gl.RENDERBUFFER_SAMPLES are different among attached renderbuffers, or are non-zero if the attached images are a mix of renderbuffers and textures.")},t}(),as=function(t){function r(r,n){var i;(i=t.call(this,r,n,r.gl.TEXTURE_2D)||this)._compressedMipFilled=0;var a=n.format,o=n._mipmap,s=n.width,l=n.height,u=i._isWebGL2;if(!ns._supportTextureFormat(a,r))throw new Error("Texture format is not supported:"+e.TextureFormat[a]);return!o||u||ns._isPowerOf2(s)&&ns._isPowerOf2(l)||(re.warn("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),n._mipmap=!1,n._mipmapCount=n._getMipmapCount()),i._formatDetail=ns._getFormatDetail(a,i._gl,u),i._formatDetail.isCompressed&&!u||i._initMipmap(!1),i}Yo(r,t);var n=r.prototype;return n.setPixelBuffer=function(e,t,r,n,i,a){void 0===t&&(t=0);var o=this._gl,s=this._isWebGL2,l=this._formatDetail,u=l.internalFormat,c=l.baseFormat,h=l.dataType,d=l.isCompressed,_=Math.max(1,this._texture.width>>t),f=Math.max(1,this._texture.height>>t);if(i=i||_-r,a=a||f-n,this._bind(),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,0),o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),d){var p=1<<t;s||this._compressedMipFilled&p?o.compressedTexSubImage2D(this._target,t,r,n,i,a,u,e):(o.compressedTexImage2D(this._target,t,u,i,a,0,e),this._compressedMipFilled|=p)}else o.texSubImage2D(this._target,t,r,n,i,a,c,h,e)},n.setImageSource=function(e,t,r,n,i,a){var o=this._gl,s=this._formatDetail,l=s.baseFormat,u=s.dataType;this._bind(),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,+r),o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+n),o.texSubImage2D(this._target,t,i||0,a||0,l,u,e)},n.getPixelBuffer=function(e,r,n,i,a,o){if(this._formatDetail.isCompressed)throw new Error("Unable to read compressed texture");t.prototype._getPixelBuffer.call(this,null,e,r,n,i,a,o)},r}(ns),os=function(t){function r(r,n){var i;i=t.call(this,r,n,r.gl.TEXTURE_2D_ARRAY)||this;var a=n.format,o=n.width,s=n.height,l=n.length,u=n.mipmapCount;if(!i._isWebGL2)throw new Error("Texture2D Array is not supported in WebGL1.0");if(!ns._supportTextureFormat(a,r))throw new Error("Texture format is not supported:"+e.TextureFormat[a]);return i._bind(),i._formatDetail=ns._getFormatDetail(a,i._gl,!0),i._gl.texStorage3D(i._target,u,i._formatDetail.internalFormat,o,s,l),i}Yo(r,t);var n=r.prototype;return n.setPixelBuffer=function(e,t,r,n,i,a,o,s){var l=this._target,u=this._gl,c=this._formatDetail,h=c.internalFormat,d=c.baseFormat,_=c.dataType,f=c.isCompressed;a=a||Math.max(1,this._texture.width>>r)-n,o=o||Math.max(1,this._texture.height>>r)-i,s=s||this._texture.length,this._bind(),u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,0),u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),f?u.compressedTexSubImage3D(l,r,n,i,e,a,o,s,h,t):u.texSubImage3D(l,r,n,i,e,a,o,s,d,_,t)},n.setImageSource=function(e,t,r,n,i,a,o){var s=this._gl,l=this._formatDetail,u=l.baseFormat,c=l.dataType;this._bind(),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,+n),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+i),s.texSubImage3D(this._target,r,a,o,e,t.width,t.height,1,u,c,t)},n.getPixelBuffer=function(e,t,r,n,i,a,o){var s=this._gl,l=this._formatDetail;if(l.isCompressed)throw new Error("Unable to read compressed texture");s.bindFramebuffer(s.FRAMEBUFFER,this._getReadFrameBuffer()),s.framebufferTextureLayer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,this._glTexture,a,e),s.readPixels(t,r,n,i,l.baseFormat,l.dataType,o),s.bindFramebuffer(s.FRAMEBUFFER,null)},r}(ns),ss=function(t){function r(r,n){var i;(i=t.call(this,r,n,r.gl.TEXTURE_CUBE_MAP)||this)._compressedFaceFilled=[0,0,0,0,0,0];var a=n.format,o=n._mipmap,s=n.width,l=i._isWebGL2;if(!ns._supportTextureFormat(a,r))throw new Error("Texture format is not supported:"+e.TextureFormat[a]);return!o||l||ns._isPowerOf2(s)||(re.warn("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),n._mipmap=!1,n._mipmapCount=n._getMipmapCount()),i._formatDetail=ns._getFormatDetail(a,i._gl,l),i._formatDetail.isCompressed&&!l||i._initMipmap(!0),i}Yo(r,t);var n=r.prototype;return n.setPixelBuffer=function(e,t,r,n,i,a,o){var s=this._gl,l=this._isWebGL2,u=this._formatDetail,c=u.internalFormat,h=u.baseFormat,d=u.dataType,_=u.isCompressed,f=Math.max(1,this._texture.width>>r);if(a=a||f-n,o=o||f-i,this._bind(),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,0),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),_){var p=1<<r;l||this._compressedFaceFilled[e]&p?s.compressedTexSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+e,r,n,i,a,o,c,t):(s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+e,r,c,a,o,0,t),this._compressedFaceFilled[e]|=p)}else s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+e,r,n,i,a,o,h,d,t)},n.setImageSource=function(e,t,r,n,i,a,o){var s=this._gl,l=this._formatDetail,u=l.baseFormat,c=l.dataType;this._bind(),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,+n),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+i),s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+e,r,a||0,o||0,u,c,t)},n.getPixelBuffer=function(e,r,n,i,a,o,s){if(this._formatDetail.isCompressed)throw new Error("Unable to read compressed texture");t.prototype._getPixelBuffer.call(this,e,r,n,i,a,o,s)},r}(ns);e.WebGLMode=void 0,(Jo=e.WebGLMode||(e.WebGLMode={}))[Jo.Auto=0]="Auto",Jo[Jo.WebGL2=1]="WebGL2",Jo[Jo.WebGL1=2]="WebGL1";var ls=function(){function t(e){void 0===e&&(e={}),this._readFrameBuffer=void 0,this._currentBind=void 0,this._options=void 0,this._gl=void 0,this._renderStates=void 0,this._extensions=void 0,this._capability=void 0,this._isWebGL2=void 0,this._activeTextureID=void 0,this._activeTextures=new Array(32),this._lastViewport=new v(null,null,null,null),this._lastClearColor=new T(null,null,null,null),this._options=e}var r=t.prototype;return r.init=function(t){var r=this._options;void 0===r.alpha&&(r.alpha=!1),void 0===r.stencil&&(r.stencil=!0);var n,i=t._webCanvas,a=r.webGLMode||e.WebGLMode.Auto;if(a!=e.WebGLMode.Auto&&a!=e.WebGLMode.WebGL2||(!(n=i.getContext("webgl2",r))&&i instanceof HTMLCanvasElement&&(n=i.getContext("experimental-webgl2",r)),this._isWebGL2=!0,n&&!n.deleteQuery&&(this._isWebGL2=!1)),n||a!=e.WebGLMode.Auto&&a!=e.WebGLMode.WebGL1||(!(n=i.getContext("webgl",r))&&i instanceof HTMLCanvasElement&&(n=i.getContext("experimental-webgl",r)),this._isWebGL2=!1),!n)throw new Error("Get GL Context FAILED.");this._gl=n,this._activeTextureID=n.TEXTURE0,this._renderStates=new rs(n),this._extensions=new es(this),this._capability=new $o(this),n.activeTexture(n.TEXTURE0),this._options=null},r.createPlatformPrimitive=function(e){return new ts(this,e)},r.createPlatformTexture2D=function(e){return new as(this,e)},r.createPlatformTexture2DArray=function(e){return new os(this,e)},r.createPlatformTextureCube=function(e){return new ss(this,e)},r.createPlatformRenderTarget=function(e){return new is(this,e)},r.requireExtension=function(e){return this._extensions.requireExtension(e)},r.canIUse=function(e){return this.capability.canIUse(e)},r.canIUseCompressedTextureInternalFormat=function(e){return this.capability.canIUseCompressedTextureInternalFormat(e)},r.viewport=function(e,t,r,n){var i=this._gl,a=this._lastViewport;e===a.x&&t===a.y&&r===a.z&&n===a.w||(i.viewport(e,t,r,n),a.setValue(e,t,r,n))},r.colorMask=function(e,t,r,n){this._gl.colorMask(e,t,r,n)},r.clearRenderTarget=function(t,r,n){var i=this._gl,a=t._lastRenderState,o=a.blendState.targetBlendState,s=a.depthState,l=a.stencilState,u=i.DEPTH_BUFFER_BIT|i.STENCIL_BUFFER_BIT;if(r===e.CameraClearFlags.DepthColor){u|=i.COLOR_BUFFER_BIT;var c=this._lastClearColor,h=n.r,d=n.g,_=n.b,f=n.a;!n||h===c.r&&d===c.g&&_===c.b&&f===c.a||(i.clearColor(h,d,_,f),c.setValue(h,d,_,f)),o.colorWriteMask!==e.ColorWriteMask.All&&(i.colorMask(!0,!0,!0,!0),o.colorWriteMask=e.ColorWriteMask.All)}!0!==s.writeEnabled&&(i.depthMask(!0),s.writeEnabled=!0),255!==l.writeMask&&(i.stencilMask(255),l.writeMask=255),i.clear(u)},r.drawPrimitive=function(e,t,r){e?e._draw(r,t):re.error("draw primitive failed.")},r.activeRenderTarget=function(e,t,r){var n=this._gl;if(e){var i;null===(i=e._platformRenderTarget)||void 0===i||i._activeRenderTarget();var a=e.width,o=e.height;this.viewport(0,0,a>>r,o>>r)}else{n.bindFramebuffer(n.FRAMEBUFFER,null);var s=t.viewport,l=n.drawingBufferWidth,u=n.drawingBufferHeight,c=l*s.z,h=u*s.w,d=s.x*l,_=u-s.y*u-h;this.viewport(d,_,c,h)}},r.destroy=function(){},r.activeTexture=function(e){this._activeTextureID!==e&&(this._gl.activeTexture(e),this._activeTextureID=e)},r.bindTexture=function(e){var t=this._activeTextureID-this._gl.TEXTURE0;this._activeTextures[t]!==e&&(this._gl.bindTexture(e._target,e._glTexture),this._activeTextures[t]=e)},Ko(t,[{key:"isWebGL2",get:function(){return this._isWebGL2}},{key:"gl",get:function(){return this._gl}},{key:"renderStates",get:function(){return this._renderStates}},{key:"capability",get:function(){return this._capability}},{key:"canIUseMoreJoints",get:function(){return this.capability.canIUseMoreJoints}}]),t}(),us=function(e){function t(t,r){var n=new Zo("string"==typeof t?document.getElementById(t):t),i=new ls(r);return e.call(this,n,i)||this}return Yo(t,e),Ko(t,[{key:"canvas",get:function(){return this._canvas}}]),t}(Wn);function cs(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var hs,ds,_s,fs,ps,gs,vs,ms,ys,xs,Ts=function(){function e(e,t){var r=this;this._worker=void 0,this._costs={},this._currentLoad=0,this._callbacks={},this._worker=new Worker(e),this._worker.onmessage=function(e){var t=e.data;switch(t.type){case"decode":r._callbacks[t.id].resolve(t.geometry);break;case"error":r._callbacks[t.id].reject(t);break;default:re.error('DRACOWorker: Unexpected message, "'+t.type+'"')}},t?this._worker.postMessage({type:"init",decoderConfig:{wasmBinary:t}}):this._worker.postMessage({type:"init",decoderConfig:{}})}var t,r,n=e.prototype;return n.setCosts=function(e,t){this._costs[e]=t},n.addCurrentLoad=function(e){this._currentLoad+=e},n.setCallback=function(e,t,r){this._callbacks[e]={resolve:t,reject:r}},n.decode=function(e,t,r){this._worker.postMessage({type:"decode",id:e,taskConfig:t,buffer:r},[r])},n.releaseTask=function(e){this._currentLoad-=this._costs[e],delete this._callbacks[e],delete this._costs[e]},t=e,(r=[{key:"currentLoad",get:function(){return this._currentLoad}}])&&cs(t.prototype,r),Object.defineProperty(t,"prototype",{writable:!1}),e}(),ws='let decoderPending;\nlet decoderConfig;\n\nonmessage = function(e) {\n  const message = e.data;\n\n  switch (message.type) {\n    case "init":\n      decoderConfig = message.decoderConfig;\n      decoderPending = new Promise(function(resolve /*, reject*/) {\n        decoderConfig.onModuleLoaded = function(draco) {\n          // Module is Promise-like. Wrap before resolving to avoid loop.\n          resolve({ draco: draco });\n        };\n        DracoDecoderModule(decoderConfig);\n      });\n      break;\n\n    case "decode":\n      const buffer = message.buffer;\n      const taskConfig = message.taskConfig;\n      decoderPending.then(module => {\n        const draco = module.draco;\n        const decoder = new draco.Decoder();\n        const decoderBuffer = new draco.DecoderBuffer();\n        decoderBuffer.Init(new Int8Array(buffer), buffer.byteLength);\n        try {\n          const geometry = decodeGeometry(draco, decoder, decoderBuffer, taskConfig);\n          const buffers = geometry.attributes.map(attr => attr.array.buffer);\n          if (geometry.index) buffers.push(geometry.index.array.buffer);\n          self.postMessage({ type: "decode", id: message.id, geometry }, buffers);\n        } catch (error) {\n          console.error(error);\n          self.postMessage({ type: "error", id: message.id, error: error.message });\n        } finally {\n          draco.destroy(decoderBuffer);\n          draco.destroy(decoder);\n        }\n      });\n      break;\n  }\n};\n\nfunction decodeGeometry(draco, decoder, decoderBuffer, taskConfig) {\n  const attributeIDs = taskConfig.attributeIDs;\n  const attributeTypes = taskConfig.attributeTypes;\n\n  let dracoGeometry;\n  let decodingStatus;\n\n  const geometryType = decoder.GetEncodedGeometryType(decoderBuffer);\n  if (geometryType === draco.TRIANGULAR_MESH) {\n    dracoGeometry = new draco.Mesh();\n    decodingStatus = decoder.DecodeBufferToMesh(decoderBuffer, dracoGeometry);\n  } else {\n    throw new Error("DRACODecoder worker: Unexpected geometry type.");\n  }\n\n  if (!decodingStatus.ok() || dracoGeometry.ptr === 0) {\n    throw new Error("DRACODecoder worker: Decoding failed: " + decodingStatus.error_msg());\n  }\n\n  const geometry = { index: null, attributes: [] };\n\n  // Gather all vertex attributes.\n  for (let attributeName in attributeIDs) {\n    const attributeType = self[attributeTypes[attributeName]];\n\n    let attribute;\n    let attributeID;\n\n    // A Draco file may be created with default vertex attributes, whose attribute IDs\n    // are mapped 1:1 from their semantic name (POSITION, NORMAL, ...). Alternatively,\n    // a Draco file may contain a custom set of attributes, identified by known unique\n    // IDs. glTF files always do the latter, and .drc files typically do the former.\n    if (taskConfig.useUniqueIDs) {\n      attributeID = attributeIDs[attributeName];\n      attribute = decoder.GetAttributeByUniqueId(dracoGeometry, attributeID);\n    } else {\n      attributeID = decoder.GetAttributeId(dracoGeometry, draco[attributeIDs[attributeName]]);\n      if (attributeID === -1) continue;\n      attribute = decoder.GetAttribute(dracoGeometry, attributeID);\n    }\n    geometry.attributes.push(decodeAttribute(draco, decoder, dracoGeometry, attributeName, attributeType, attribute));\n  }\n  // Add index.\n  if (geometryType === draco.TRIANGULAR_MESH) {\n    // Generate mesh faces.\n    const numFaces = dracoGeometry.num_faces();\n    const numIndices = numFaces * 3;\n    let dataSize;\n    let ptr;\n    let index;\n    const indexType = self[taskConfig.indexType];\n\n    switch (indexType) {\n      case Uint16Array:\n        dataSize = numIndices * 2;\n        ptr = draco._malloc(dataSize);\n        decoder.GetTrianglesUInt16Array(dracoGeometry, dataSize, ptr);\n        index = new Uint16Array(draco.HEAPU16.buffer, ptr, numIndices).slice();\n        draco._free(ptr);\n        break;\n      case Uint32Array:\n        dataSize = numIndices * 4;\n        ptr = draco._malloc(dataSize);\n        decoder.GetTrianglesUInt32Array(dracoGeometry, dataSize, ptr);\n        index = new Uint32Array(draco.HEAPU32.buffer, ptr, numIndices).slice();\n        draco._free(ptr);\n        break;\n      default:\n        throw new Error("DRACODecoder: Unexpected index type.");\n    }\n    geometry.index = { array: index, itemSize: 1 };\n  }\n  draco.destroy(dracoGeometry);\n  return geometry;\n}\n\nfunction decodeAttribute(draco, decoder, dracoGeometry, attributeName, attributeType, attribute) {\n  const numComponents = attribute.num_components();\n  const numPoints = dracoGeometry.num_points();\n  const numValues = numPoints * numComponents;\n  let ptr;\n  let array;\n  let dataSize;\n  switch (attributeType) {\n    case Float32Array:\n      dataSize = numValues * 4;\n      ptr = draco._malloc(dataSize);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_FLOAT32, dataSize, ptr);\n      array = new Float32Array(draco.HEAPF32.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Int8Array:\n      ptr = draco._malloc(numValues);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_INT8, numValues, ptr);\n      array = new Int8Array(draco.HEAP8.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Int16Array:\n      dataSize = numValues * 2;\n      ptr = draco._malloc(dataSize);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_INT16, dataSize, ptr);\n      array = new Int16Array(draco.HEAP16.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Int32Array:\n      dataSize = numValues * 4;\n      ptr = draco._malloc(dataSize);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_INT32, dataSize, ptr);\n      array = new Int32Array(draco.HEAP32.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Uint8Array:\n      ptr = draco._malloc(numValues);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_UINT8, numValues, ptr);\n      array = new Uint8Array(draco.HEAPU8.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Uint16Array:\n      dataSize = numValues * 2;\n      ptr = draco._malloc(dataSize);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_UINT16, dataSize, ptr);\n      array = new Uint16Array(draco.HEAPU16.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    case Uint32Array:\n      dataSize = numValues * 4;\n      ptr = draco._malloc(dataSize);\n      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_UINT32, dataSize, ptr);\n      array = new Uint32Array(draco.HEAPU32.buffer, ptr, numValues).slice();\n      draco._free(ptr);\n      break;\n\n    default:\n      throw new Error("DRACODecoder: Unexpected attribute type.");\n  }\n\n  return {\n    name: attributeName,\n    array: array,\n    itemSize: numComponents\n  };\n}\n',bs="https://gw.alipayobjects.com/os/lib/alipay/draco-javascript/1.3.6/lib/",Cs=function(){function e(e){var t;void 0===e&&(e={type:"wasm",workerLimit:4}),this.pool=[],this.workerLimit=Math.min(navigator.hardwareConcurrency||4,4),this.useJS=void 0,this.currentTaskId=1,this.taskCache=new WeakMap,this.loadLibPromise=void 0,e.workerLimit>this.workerLimit?re.warn("DRACOWorkerPool: Can not initialize worker pool with limit:"+e.workerLimit):this.workerLimit=null!=(t=e.workerLimit)?t:4,this.useJS="object"!=typeof WebAssembly||"js"===e.type,this.loadLibPromise=this.preloadLib()}var t=e.prototype;return t.preloadLib=function(){var e=this;return this.loadLibPromise?this.loadLibPromise:new Promise((function(t,r){e.useJS?Ai(bs+"draco_decoder_gltf.js",{type:"text"}).then((function(e){var r=[e,ws].join("\n"),n=URL.createObjectURL(new Blob([r]));t({workerSourceURL:n,decoderWASMBinary:null})})).catch((function(e){r(e)})):Promise.all([Ai(bs+"draco_wasm_wrapper_gltf.js",{type:"text"}),Ai(bs+"draco_decoder_gltf.r3bin",{type:"arraybuffer"})]).then((function(e){var r=e[0],n=e[1],i=[r,ws].join("\n"),a=URL.createObjectURL(new Blob([i]));t({workerSourceURL:a,decoderWASMBinary:n})})).catch((function(e){r(e)}))}))},t.getWorker=function(){var e=this;return this.preloadLib().then((function(t){if(e.pool.length<e.workerLimit){var r=new Ts(t.workerSourceURL,t.decoderWASMBinary);e.pool.push(r)}else e.pool.sort((function(e,t){return e.currentLoad>t.currentLoad?-1:1}));return e.pool[e.pool.length-1]}))},t.decode=function(e,t){var r=this,n=JSON.stringify(t);if(this.taskCache.has(e)){var i=this.taskCache.get(e);if(i.key===n)return i.promise;if(0===e.byteLength)throw new Error("DRACODecoder: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}var a,o=this.currentTaskId++,s=e.byteLength,l=new Promise((function(n,i){r.getWorker().then((function(r){a=r,r.setCosts(o,s),r.addCurrentLoad(s),r.setCallback(o,n,i),r.decode(o,t,e)})).catch((function(e){i(e)}))}));return l.finally((function(){a&&o&&a.releaseTask(o)})),this.taskCache.set(e,{key:n,promise:l}),l},e}();function Ss(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function Ms(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Ss(Object(r),!0).forEach((function(t){Fs(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Ss(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function As(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Ps(e,t,r){return t&&As(e.prototype,t),r&&As(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function Fs(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Es(){return(Es=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function Rs(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,Ls(e,t)}function Ls(e,t){return(Ls=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Bs(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Ds(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function Is(e,t,r,n,i){var a={};return Object.keys(n).forEach((function(e){a[e]=n[e]})),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=r.slice().reverse().reduce((function(r,n){return n(e,t,r)||r}),a),i&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(i):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(e,t,a),a=null),a}_e(e.AssetType.Buffer,["bin","r3bin"],!1)(function(e){function t(){return e.apply(this,arguments)||this}return Rs(t,e),t.prototype.load=function(e){var t=e.url;return function(e){return/^data:(.+?);base64,/.test(e)}(t)?new he((function(e){var r=t.slice(13+RegExp.$1.length);e(Uint8Array.from(atob(r),(function(e){return e.charCodeAt(0)})).buffer)})):this.request(t,Ms(Ms({},e),{},{type:"arraybuffer"}))},t}(Ii)),function(e){e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.UNSIGNED_INT=5125]="UNSIGNED_INT",e[e.FLOAT=5126]="FLOAT"}(hs||(hs={})),function(e){e.SCALAR="SCALAR",e.VEC2="VEC2",e.VEC3="VEC3",e.VEC4="VEC4",e.MAT2="MAT2",e.MAT3="MAT3",e.MAT4="MAT4"}(ds||(ds={})),function(e){e.TRANSLATION="translation",e.ROTATION="rotation",e.SCALE="scale",e.WEIGHTS="weights"}(_s||(_s={})),function(e){e.Linear="LINEAR",e.Step="STEP",e.CubicSpine="CUBICSPLINE"}(fs||(fs={})),function(e){e.PERSPECTIVE="perspective",e.ORTHOGRAPHIC="orthographic"}(ps||(ps={})),function(e){e.JPEG="image/jpeg",e.PNG="image/png"}(gs||(gs={})),function(e){e.OPAQUE="OPAQUE",e.MASK="MASK",e.BLEND="BLEND"}(vs||(vs={})),function(e){e[e.NEAREST=9728]="NEAREST",e[e.LINEAR=9729]="LINEAR"}(ms||(ms={})),function(e){e[e.NEAREST=9728]="NEAREST",e[e.LINEAR=9729]="LINEAR",e[e.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",e[e.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",e[e.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",e[e.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"}(ys||(ys={})),function(e){e[e.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",e[e.REPEAT=10497]="REPEAT"}(xs||(xs={}));var Os=function(){function t(){}return t.floatBufferToVector2Array=function(e){for(var t=e.length,r=new Array(t/2),n=0;n<t;n+=2)r[n/2]=new g(e[n],e[n+1]);return r},t.floatBufferToVector3Array=function(e){for(var t=e.length,r=new Array(t/3),n=0;n<t;n+=3)r[n/3]=new o(e[n],e[n+1],e[n+2]);return r},t.floatBufferToVector4Array=function(e){for(var t=e.length,r=new Array(t/4),n=0;n<t;n+=4)r[n/4]=new v(e[n],e[n+1],e[n+2],e[n+3]);return r},t.floatBufferToColorArray=function(e,t){var r=e.length,n=new Array(r/(t?3:4));if(t)for(var i=0;i<r;i+=3)n[i/3]=new T(e[i],e[i+1],e[i+2],1);else for(var a=0;a<r;a+=4)n[a/4]=new T(e[a],e[a+1],e[a+2],e[a+3]);return n},t.decodeText=function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);for(var t="",r=0,n=e.length;r<n;r++)t+=String.fromCharCode(e[r]);return decodeURIComponent(encodeURIComponent(t))},t.getAccessorTypeSize=function(e){switch(e){case ds.SCALAR:return 1;case ds.VEC2:return 2;case ds.VEC3:return 3;case ds.VEC4:case ds.MAT2:return 4;case ds.MAT3:return 9;case ds.MAT4:return 16}},t.getComponentType=function(e){switch(e){case hs.BYTE:return Int8Array;case hs.UNSIGNED_BYTE:return Uint8Array;case hs.SHORT:return Int16Array;case hs.UNSIGNED_SHORT:return Uint16Array;case hs.UNSIGNED_INT:return Uint32Array;case hs.FLOAT:return Float32Array}},t.getAccessorData=function(e,r,n){var i,a,o=e.bufferViews,s=o[r.bufferView],l=n[s.buffer],u=r.hasOwnProperty("byteOffset")?r.byteOffset:0,c=s.hasOwnProperty("byteOffset")?s.byteOffset:0,h=u+c,d=t.getAccessorTypeSize(r.type),_=d*r.count,f=null!=(i=s.byteStride)?i:0,p=t.getComponentType(r.componentType);if(f){var g=d*p.BYTES_PER_ELEMENT;a=new Uint8Array(r.count*g);for(var v=new Uint8Array(l,c,s.byteLength),m=0;m<r.count;m++)for(var y=0;y<g;y++)a[m*g+y]=v[m*f+u+y]}else a=new Uint8Array(l.slice(h,h+_*p.BYTES_PER_ELEMENT));var x=new p(a.buffer);if(r.sparse)for(var T,w,b,C,S=r.sparse,M=S.count,A=S.indices,P=S.values,F=o[A.bufferView],E=o[P.bufferView],R=n[F.buffer],L=n[E.buffer],B=(null!=(T=A.byteOffset)?T:0)+(null!=(w=F.byteOffset)?w:0),D=F.byteLength,I=(null!=(b=P.byteOffset)?b:0)+(null!=(C=E.byteOffset)?C:0),O=E.byteLength,z=t.getComponentType(A.componentType),V=new z(R,B,D/z.BYTES_PER_ELEMENT),N=new p(L,I,O/p.BYTES_PER_ELEMENT),U=0;U<M;U++)for(var k=V[U],G=0;G<d;G++)x[k*d+G]=N[U*d+G];return x},t.getBufferViewData=function(e,t){var r=e.buffer,n=e.byteOffset,i=void 0===n?0:n,a=e.byteLength;return t[r].slice(i,i+a)},t.getVertexStride=function(e,r){var n;return e.bufferViews[null!=(n=r.bufferView)?n:0].byteStride||t.getAccessorTypeSize(r.type)*t.getComponentType(r.componentType).BYTES_PER_ELEMENT},t.createVertexElement=function(e,r,n){var i=t.getAccessorTypeSize(r.type);return new Nr(e,0,t.getElementFormat(r.componentType,i,r.normalized),n)},t.getIndexFormat=function(t){switch(t){case hs.UNSIGNED_BYTE:return e.IndexFormat.UInt8;case hs.UNSIGNED_SHORT:return e.IndexFormat.UInt16;case hs.UNSIGNED_INT:return e.IndexFormat.UInt32}},t.getElementFormat=function(t,r,n){if(void 0===n&&(n=!1),t==hs.FLOAT)switch(r){case 1:return e.VertexElementFormat.Float;case 2:return e.VertexElementFormat.Vector2;case 3:return e.VertexElementFormat.Vector3;case 4:return e.VertexElementFormat.Vector4}if(t==hs.SHORT)switch(r){case 2:return n?e.VertexElementFormat.NormalizedShort2:e.VertexElementFormat.Short2;case 3:case 4:return n?e.VertexElementFormat.NormalizedShort4:e.VertexElementFormat.Short4}if(t==hs.UNSIGNED_SHORT)switch(r){case 2:return n?e.VertexElementFormat.NormalizedUShort2:e.VertexElementFormat.UShort2;case 3:case 4:return n?e.VertexElementFormat.NormalizedUShort4:e.VertexElementFormat.UShort4}if(t==hs.BYTE)switch(r){case 2:case 3:case 4:return n?e.VertexElementFormat.NormalizedByte4:e.VertexElementFormat.Byte4}if(t==hs.UNSIGNED_BYTE)switch(r){case 2:case 3:case 4:return n?e.VertexElementFormat.NormalizedUByte4:e.VertexElementFormat.UByte4}},t.loadImageBuffer=function(e,t){return new Promise((function(r,n){var i=new window.Blob([e],{type:t}),a=new Image;a.src=URL.createObjectURL(i),a.crossOrigin="anonymous",a.onerror=function(){n(new Error("Failed to load image buffer"))},a.onload=function(){requestAnimationFrame((function(){r(a),a.onload=null,a.onerror=null,a.onabort=null}))}}))},t.isAbsoluteUrl=function(e){return/^(?:http|blob|data:|\/)/.test(e)},t.parseRelativeUrl=function(e,r){return t.isAbsoluteUrl(r)?r:"."===r.charAt(0)?t._formatRelativePath(r+r):e.substring(0,e.lastIndexOf("/")+1)+r},t.parseGLB=function(e){var r=new DataView(e),n={magic:r.getUint32(0,!0),version:r.getUint32(4,!0),length:r.getUint32(8,!0)};if(1179937895!==n.magic)return console.error("Invalid glb magic number. Expected 0x46546C67, found 0x"+n.magic.toString(16)),null;var i=r.getUint32(12,!0),a=r.getUint32(16,!0);if(1313821514!==a)return console.error("Invalid glb chunk type. Expected 0x4E4F534A, found 0x"+a.toString(16)),null;for(var o=new Uint8Array(e,20,i),s=JSON.parse(t.decodeText(o)),l=[],u=20+i;u<n.length;){if(i=r.getUint32(u,!0),5130562!==(a=r.getUint32(u+4,!0)))return console.error("Invalid glb chunk type. Expected 0x004E4942, found 0x"+a.toString(16)),null;var c=u+8,h=e.slice(c,c+i);l.push(h),u+=i+8}return{gltf:s,buffers:l}},t._formatRelativePath=function(e){for(var t=e.split("/"),r=0,n=t.length;r<n;r++)".."==t[r]&&(t.splice(r-1,2),r-=2);return t.join("/")},t}(),zs=function(){function e(){}return e.parseEngineResource=function(t,r,n,i){var a=e._extensionParsers[t];if(null!=a&&a.length){for(var o=arguments.length,s=new Array(o>4?o-4:0),l=4;l<o;l++)s[l-4]=arguments[l];for(var u=0;u<a.length;u++){var c;(c=a[u]).parseEngineResource.apply(c,[r,n,i].concat(s))}}},e.createEngineResource=function(t,r,n){var i=e._extensionParsers[t];if(null!=i&&i.length){for(var a,o=arguments.length,s=new Array(o>3?o-3:0),l=3;l<o;l++)s[l-3]=arguments[l];return(a=i[0]).createEngineResource.apply(a,[r,n].concat(s))}},e.hasExtensionParser=function(t){var r=e._extensionParsers[t];return!(null==r||!r.length)},e.initialize=function(t){var r=e._extensionParsers[t];if(null!=r&&r.length)for(var n=0;n<r.length;n++)r[n].initialize()},e._addExtensionParser=function(t,r){e._extensionParsers[t]||(e._extensionParsers[t]=[]),e._extensionParsers[t].push(r)},e}();function Vs(e){return function(t){var r=new t;zs._addExtensionParser(e,r)}}zs._extensionParsers={};var Ns=function(t){function r(){return t.apply(this,arguments)||this}Rs(r,t);var n=r.prototype;return n.parse=function(t){var r=t.gltf,n=t.buffers,i=t.entities,a=r.animations,o=r.accessors;if(a){for(var s=a.length,l=new Array(s),u=new Array(s),c=0;c<s;c++){for(var h=a[c],d=h.channels,_=h.samplers,f=h.name,p=void 0===f?"AnimationClip"+c:f,g=new ja(p),v=new Array,m=0;m<_.length;m++){var y,x=_[m],T=o[x.input],w=o[x.output],b=Os.getAccessorData(r,T,n),C=Os.getAccessorData(r,w,n),S=C.length/b.length,M=void 0;switch(null!=(y=x.interpolation)?y:fs.Linear){case fs.CubicSpine:M=e.InterpolationType.CubicSpine;break;case fs.Step:M=e.InterpolationType.Step;break;case fs.Linear:M=e.InterpolationType.Linear}b[b.length-1],v.push({type:w.type,interpolation:M,input:b,output:C,outputSize:S})}for(var A=0;A<d.length;A++){for(var P=d[A],F=P.target,E="",R=i[F.node];R.parent;)E=""===E?""+R.name:R.name+"/"+E,R=R.parent;var L=void 0,B=void 0,D=void 0;switch(F.path){case _s.TRANSLATION:L=$e,B="position",D=e.InterpolableValueType.Vector3;break;case _s.ROTATION:L=$e,B="rotation",D=e.InterpolableValueType.Quaternion;break;case _s.SCALE:L=$e,B="scale",D=e.InterpolableValueType.Vector3;break;case _s.WEIGHTS:L=vn,B="blendShapeWeights",D=e.InterpolableValueType.FloatArray}var I=this._addCurve(D,P,v);g.addCurveBinding(E,L,B,I)}l[c]=g,u[c]={name:p,index:c}}t.animations=l,t._animationsIndices=u}},n._addCurve=function(t,r,n){var i=new xo,a=n[r.sampler],s=a.input,l=a.output,u=a.outputSize;i.interpolation=a.interpolation;for(var c=0,h=s.length;c<h;c++){var d=c*u;if(t===e.InterpolableValueType.Float){var f=new wo;f.time=s[c],f.inTangent=0,f.outTangent=0,f.value=l[d],i.addKey(f)}else if(t===e.InterpolableValueType.FloatArray){var p=new wo;p.time=s[c],p.inTangent=new Float32Array(u),p.outTangent=new Float32Array(u),p.value=l.subarray(d,d+u),i.addKey(p)}else if(t===e.InterpolableValueType.Vector2){var m=new wo;m.time=s[c],m.value=new g(l[d],l[d+1]),m.inTangent=new g,m.outTangent=new g,i.addKey(m)}else if(t===e.InterpolableValueType.Vector3){var y=new wo;y.time=s[c],y.value=new o(l[d],l[d+1],l[d+2]),y.inTangent=new o,y.outTangent=new o,i.addKey(y)}else if(t===e.InterpolableValueType.Vector4){var x=new wo;x.time=s[c],x.value=new v(l[d],l[d+1],l[d+2],l[d+3]),x.inTangent=new v,x.outTangent=new v,i.addKey(x)}else if(t===e.InterpolableValueType.Quaternion){var T=new wo;T.time=s[c],T.value=new _(l[d],l[d+1],l[d+2],l[d+3]),T.inTangent=new v,T.outTangent=new v,i.addKey(T)}}return i},r}(zs),Us=function(t){function r(){return t.apply(this,arguments)||this}Rs(r,t);var n=r.prototype;return n.parse=function(t){var r=t.url,n=t.engine;return this._isGLB(r)?n.resourceManager.load({url:r,type:e.AssetType.Buffer}).then(Os.parseGLB).then((function(e){var r=e.gltf,n=e.buffers;t.gltf=r,t.buffers=n})):n.resourceManager.load({url:r,type:e.AssetType.JSON}).then((function(i){return t.gltf=i,Promise.all(i.buffers.map((function(t){return n.resourceManager.load({type:e.AssetType.Buffer,url:Os.parseRelativeUrl(r,t.uri)})}))).then((function(e){t.buffers=e}))}))},n._isGLB=function(e){return"glb"===e.substring(e.lastIndexOf(".")+1)},r}(zs),ks=function(e){function t(){return e.apply(this,arguments)||this}Rs(t,e);var r=t.prototype;return r.parse=function(e){var r=e.engine,n=e.gltf.nodes;if(n){for(var i=[],a=0;a<n.length;a++){var o=n[a],s=o.matrix,l=o.translation,u=o.rotation,c=o.scale,h=new tt(r,o.name||""+t._defaultName+a),d=h.transform;if(s){var _=d.localMatrix;_.setValueByArray(s),d.localMatrix=_}else l&&d.setPosition(l[0],l[1],l[2]),u&&d.setRotationQuaternion(u[0],u[1],u[2],u[3]),c&&d.setScale(c[0],c[1],c[2]);i[a]=h}e.entities=i,this._buildEntityTree(e),this._createSceneRoots(e)}},r._buildEntityTree=function(e){for(var t=e.gltf.nodes,r=e.entities,n=0;n<t.length;n++){var i=t[n].children,a=r[n];if(i)for(var o=0;o<i.length;o++){var s=r[i[o]];a.addChild(s)}}},r._createSceneRoots=function(e){var t=e.engine,r=e.gltf,n=r.scene,i=void 0===n?0:n,a=r.scenes,o=e.entities;if(a){for(var s=[],l=0;l<a.length;l++){var u=a[l].nodes;if(u)if(1===u.length)s[l]=o[u[0]];else{for(var c=new tt(t,"GLTF_ROOT"),h=0;h<u.length;h++)c.addChild(o[u[h]]);s[l]=c}}e.sceneRoots=s,e.defaultSceneRoot=s[i]}},t}(zs);ks._defaultName="_GLTF_ENTITY_";var Gs=function(t){function r(){return t.apply(this,arguments)||this}return Rs(r,t),r._parseTextureTransform=function(e,t,r){void 0===t&&(t={});var n=t.KHR_texture_transform;n&&zs.parseEngineResource("KHR_texture_transform",n,e,r)},r.prototype.parse=function(t){var n=t.gltf,i=t.engine,a=t.textures;if(n.materials){for(var o=[],s=0;s<n.materials.length;s++){var l=n.materials[s],u=l.extensions,c=void 0===u?{}:u,h=l.pbrMetallicRoughness,d=l.normalTexture,_=l.occlusionTexture,f=l.emissiveTexture,p=l.emissiveFactor,g=l.alphaMode,v=l.alphaCutoff,m=l.doubleSided,y=l.name,x=void 0===y?"":y,w=c.KHR_materials_unlit,b=c.KHR_materials_pbrSpecularGlossiness,C=c.KHR_materials_clearcoat,S=null;if((S=w?zs.createEngineResource("KHR_materials_unlit",w,t):b?zs.createEngineResource("KHR_materials_pbrSpecularGlossiness",b,t):new Ni(i)).name=x,C&&zs.parseEngineResource("KHR_materials_clearcoat",C,S,t),h){var M=h.baseColorFactor,A=h.baseColorTexture,P=h.metallicFactor,F=h.roughnessFactor,E=h.metallicRoughnessTexture;if(M&&(S.baseColor=new T(T.linearToGammaSpace(M[0]),T.linearToGammaSpace(M[1]),T.linearToGammaSpace(M[2]),M[3])),A&&(S.baseTexture=a[A.index],r._parseTextureTransform(S,A.extensions,t)),!w&&!b){var R=S;R.metallic=null!=P?P:1,R.roughness=null!=F?F:1,E&&(R.roughnessMetallicTexture=a[E.index],r._parseTextureTransform(S,E.extensions,t))}}if(!w){var L=S;if(f&&(L.emissiveTexture=a[f.index],r._parseTextureTransform(S,f.extensions,t)),p&&(L.emissiveColor=new T(T.linearToGammaSpace(p[0]),T.linearToGammaSpace(p[1]),T.linearToGammaSpace(p[2]))),d){var B=d.index,D=d.scale;L.normalTexture=a[B],r._parseTextureTransform(S,d.extensions,t),void 0!==D&&(L.normalTextureIntensity=D)}if(_){var I=_.index,O=_.strength,z=_.texCoord;L.occlusionTexture=a[I],r._parseTextureTransform(S,_.extensions,t),void 0!==O&&(L.occlusionTextureIntensity=O),z===e.TextureCoordinate.UV1?L.occlusionTextureCoord=e.TextureCoordinate.UV1:z>e.TextureCoordinate.UV1&&re.warn("Occlusion texture uv coordinate must be UV0 or UV1.")}}switch(S.renderFace=m?e.RenderFace.Double:e.RenderFace.Front,g){case vs.OPAQUE:S.isTransparent=!1;break;case vs.BLEND:S.isTransparent=!0;break;case vs.MASK:S.alphaCutoff=null!=v?v:.5}o[s]=S}t.materials=o}},r}(zs),Hs=function(e){function t(){return e.apply(this,arguments)||this}Rs(t,e);var r=t.prototype;return r.parse=function(e){var t=this,r=e.engine,n=e.gltf,i=e.buffers;if(n.meshes){for(var a=[],o=function(o){for(var s=n.meshes[o],l=[],u=function(a){var o=s.primitives[a],u=o.extensions,c=(void 0===u?{}:u).KHR_draco_mesh_compression;l.push(new Promise((function(l){var u=new en(r,s.name||a+"");c?zs.createEngineResource("KHR_draco_mesh_compression",c,e,o).then((function(e){return t._parseMeshFromGLTFPrimitive(u,s,o,n,(function(t){for(var r=0;r<e.attributes.length;r++)if(e.attributes[r].name===t)return e.attributes[r].array;return null}),(function(e,t){throw"BlendShape animation is not supported when using draco."}),(function(){return e.index.array}),r)})).then(l):t._parseMeshFromGLTFPrimitive(u,s,o,n,(function(e){var t=o.attributes[e],r=n.accessors[t];return Os.getAccessorData(n,r,i)}),(function(e,t){var r=o.targets[t][e];if(r){var a=n.accessors[r];return Os.getAccessorData(n,a,i)}return null}),(function(){var e=n.accessors[o.indices];return Os.getAccessorData(n,e,i)}),r).then(l)})))},c=0;c<s.primitives.length;c++)u(c);a.push(Promise.all(l))},s=0;s<n.meshes.length;s++)o(s);return Promise.all(a).then((function(t){e.meshes=t}))}},r._parseMeshFromGLTFPrimitive=function(e,r,n,i,a,s,l,u){var c,h=n.attributes,d=n.targets,_=n.indices,f=n.mode,p=i.accessors,g=p[h.POSITION],v=a("POSITION"),m=Os.floatBufferToVector3Array(v);e.setPositions(m);var y=e.bounds;if(c=g.count,g.min&&g.max)y.min.setValueByArray(g.min),y.max.setValueByArray(g.max);else{var x=t._tempVector3,T=y.min,w=y.max;T.setValue(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),w.setValue(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var b=v.length/c,C=0;C<c;C++){var S=C*b;x.setValueByArray(v,S),o.min(T,x,T),o.max(w,x,w)}}for(var M in h)if("POSITION"!==M){var A=a(M);switch(M){case"NORMAL":var P=Os.floatBufferToVector3Array(A);e.setNormals(P);break;case"TEXCOORD_0":var F=Os.floatBufferToVector2Array(A);e.setUVs(F,0);break;case"TEXCOORD_1":var E=Os.floatBufferToVector2Array(A);e.setUVs(E,1);break;case"TEXCOORD_2":var R=Os.floatBufferToVector2Array(A);e.setUVs(R,2);break;case"TEXCOORD_3":var L=Os.floatBufferToVector2Array(A);e.setUVs(L,3);break;case"TEXCOORD_4":var B=Os.floatBufferToVector2Array(A);e.setUVs(B,4);break;case"TEXCOORD_5":var D=Os.floatBufferToVector2Array(A);e.setUVs(D,5);break;case"TEXCOORD_6":var I=Os.floatBufferToVector2Array(A);e.setUVs(I,6);break;case"TEXCOORD_7":var O=Os.floatBufferToVector2Array(A);e.setUVs(O,7);break;case"COLOR_0":var z=Os.floatBufferToColorArray(A,p[h.COLOR_0].type===ds.VEC3);e.setColors(z);break;case"TANGENT":var V=Os.floatBufferToVector4Array(A);e.setTangents(V);break;case"JOINTS_0":var N=Os.floatBufferToVector4Array(A);e.setBoneIndices(N);break;case"WEIGHTS_0":var U=Os.floatBufferToVector4Array(A);e.setBoneWeights(U)}}if(void 0!==_){var k=i.accessors[_],G=l();e.setIndices(G),e.addSubMesh(0,k.count,f)}else e.addSubMesh(0,c,f);return d&&this._createBlendShape(e,r,d,s),e.uploadData(!0),Promise.resolve(e)},r._createBlendShape=function(e,t,r,n){for(var i=t.extras?t.extras.targetNames:null,a=0,o=r.length;a<o;a++){var s=i?i[a]:"blendShape"+a,l=n("POSITION",a),u=n("NORMAL",a),c=n("TANGENT",a),h=l?Os.floatBufferToVector3Array(l):null,d=u?Os.floatBufferToVector3Array(u):null,_=c?Os.floatBufferToVector3Array(c):null,f=new Tn(s);f.addFrame(1,h,d,_),e.addBlendShape(f)}},t}(zs);Hs._tempVector3=new o;var Ws=function(e){function t(){return e.apply(this,arguments)||this}Rs(t,e),t._getDefaultMaterial=function(e){return t._defaultMaterial||(t._defaultMaterial=new zi(e)),t._defaultMaterial};var r=t.prototype;return r.parse=function(e){var t=e.gltf,r=t.nodes,n=t.cameras,i=e.entities;if(r){for(var a=0;a<r.length;a++){var o=r[a],s=o.camera,l=o.mesh,u=o.extensions,c=(void 0===u?{}:u).KHR_lights_punctual,h=i[a];if(void 0!==s&&this._createCamera(e,n[s],h),void 0!==l&&this._createRenderer(e,o,h),c){var d=c.light,_=e.gltf.extensions.KHR_lights_punctual.lights;zs.parseEngineResource("KHR_lights_punctual",_[d],h,e)}}e.defaultSceneRoot&&this._createAnimator(e)}},r._createCamera=function(e,t,r){var n=t.orthographic,i=t.perspective,a=t.type,o=r.addComponent(Si);if(a===ps.ORTHOGRAPHIC){var s=n.xmag,l=n.ymag,u=n.zfar,c=n.znear;o.isOrthographic=!0,void 0!==c&&(o.nearClipPlane=c),void 0!==u&&(o.farClipPlane=u),o.orthographicSize=Math.max(null!=l?l:0,null!=s?s:0)/2}else if(a===ps.PERSPECTIVE){var h=i.aspectRatio,d=i.yfov,_=i.zfar,f=i.znear;void 0!==h&&(o.aspectRatio=h),void 0!==d&&(o.fieldOfView=180*d/Math.PI),void 0!==_&&(o.farClipPlane=_),void 0!==f&&(o.nearClipPlane=f)}e.cameras||(e.cameras=[]),e.cameras.push(o),o.enabled=!1},r._createRenderer=function(e,r,n){for(var i=e.engine,a=e.gltf.meshes,o=e.meshes,s=e.materials,l=e.skins,u=r.mesh,c=r.skin,h=a[u],d=h.primitives,_=r.weights||h.weights,f=0;f<d.length;f++){var p=o[u][f],g=void 0;if(void 0!==c||_){var v=n.addComponent(vn);v.mesh=p,void 0!==c&&(v.skin=l[c]),_&&(v.blendShapeWeights=new Float32Array(_)),g=v}else(g=n.addComponent(gn)).mesh=p;var m=d[f].material,y=(null==s?void 0:s[m])||t._getDefaultMaterial(i);g.setMaterial(y);var x=d[f].extensions,T=(void 0===x?{}:x).KHR_materials_variants;T&&zs.parseEngineResource("KHR_materials_variants",T,g,e)}},r._createAnimator=function(e){var t=e.defaultSceneRoot,r=e.animations;if(r){var n=t.addComponent(_o),i=new fo,a=new po("layer"),o=new mo;if(i.addLayer(a),n.animatorController=i,a.stateMachine=o,r)for(var s=0;s<r.length;s++){var l=r[s],u=l.name,c=o.makeUniqueStateName(u);c!==u&&console.warn("AnimatorState name is existed, name: "+u+" reset to "+c),o.addState(c).clip=l}}},t}(zs);Ws._defaultMaterial=void 0;var js=function(e){function t(){return e.apply(this,arguments)||this}return Rs(t,e),t.prototype.parse=function(e){var t=e.gltf,r=e.buffers,n=e.entities,i=e.defaultSceneRoot,a=t.skins;if(a){for(var o=[],s=0;s<a.length;s++){var l=a[s],u=l.inverseBindMatrices,c=l.skeleton,h=l.joints,d=l.name,_=void 0===d?"SKIN_"+s:d,p=h.length,g=new pn(_);g.inverseBindMatrices.length=p;for(var v=t.accessors[u],m=Os.getAccessorData(t,v,r),y=0;y<p;y++){var x=new f;x.setValueByArray(m,16*y),g.inverseBindMatrices[y]=x}for(var T=0;T<p;T++)g.joints[T]=n[h[T]].name;g.skeleton=void 0!==c?n[c].name:i.name,o[s]=g}e.skins=o}},t}(zs),Xs=function(t){function r(){return t.apply(this,arguments)||this}Rs(r,t);var n=r.prototype;return n.parse=function(t){var r=this,n=t.gltf,i=t.buffers,a=t.engine,o=t.url;if(n.textures)return Promise.all(n.textures.map((function(t,s){var l=t.sampler,u=t.source,c=void 0===u?0:u,h=t.name,d=n.images[c],_=d.uri,f=d.bufferView,p=d.mimeType,g=d.name;if(_)return a.resourceManager.load({url:Os.parseRelativeUrl(o,_),type:e.AssetType.Texture2D}).then((function(e){return e.name||(e.name=h||g||"texture_"+s),void 0!==l&&r._parseSampler(e,n.samplers[l]),e}));var v=n.bufferViews[f],m=Os.getBufferViewData(v,i);return Os.loadImageBuffer(m,p).then((function(e){var t=new ie(a,e.width,e.height);return t.setImageSource(e),t.generateMipmaps(),t.name=h||g||"texture_"+s,void 0!==l&&r._parseSampler(t,n.samplers[l]),t}))}))).then((function(e){t.textures=e}))},n._parseSampler=function(e,t){var n=t.magFilter,i=t.minFilter,a=t.wrapS,o=t.wrapT;(n||i)&&re.warn("texture use filterMode in engine"),a&&(e.wrapModeU=r._wrapMap[a]),o&&(e.wrapModeV=r._wrapMap[o])},r}(zs);Xs._wrapMap={33071:e.TextureWrapMode.Clamp,33648:e.TextureWrapMode.Mirror,10497:e.TextureWrapMode.Repeat};var Ks=function(e){function t(){return e.apply(this,arguments)||this}return Rs(t,e),t.prototype.parse=function(e){var t=e.gltf,r=t.asset.version,n=t.extensionsUsed,i=t.extensionsRequired,a=Number(r);if(!(a>=2&&a<3))throw"Only support gltf 2.x.";if(n){re.info("extensionsUsed: ",n);for(var o=0;o<n.length;o++)zs.hasExtensionParser(n[o])||re.warn("Extension "+n[o]+" is not implemented, you can customize this extension in gltf.")}if(i){re.info("extensionsRequired: "+i);for(var s=0;s<i.length;s++){var l=i[s];zs.hasExtensionParser(l)?zs.initialize(l):re.error("GLTF parser has not supported required extension "+l+".")}}},t}(zs),qs=function(){function e(e){var t=this;this._pipes=[],e.forEach((function(e,r){t._pipes[r]=new e}))}return e.prototype.parse=function(e){var t,r=this;return new Promise((function(n,i){r._pipes.forEach((function(r){t=t?t.then((function(){return r.parse(e)})):r.parse(e)})),t?t.then((function(){n(e)})).catch(i):n(e)}))},e}();qs.instance=new qs([Us,Ks,Xs,Gs,Hs,ks,js,Ns,Ws]);var Ys=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).url=void 0,t.gltf=void 0,t.buffers=void 0,t.textures=void 0,t.materials=void 0,t.meshes=void 0,t.skins=void 0,t.animations=void 0,t.entities=void 0,t.cameras=void 0,t.lights=void 0,t.sceneRoots=void 0,t.defaultSceneRoot=void 0,t.variants=void 0,t}return Rs(t,e),t}(Y);_e(e.AssetType.Prefab,["gltf","glb"])(function(e){function t(){return e.apply(this,arguments)||this}return Rs(t,e),t.prototype.load=function(e,t){var r=e.url;return new he((function(e,n){var i=new Ys(t.engine);i.url=r,qs.instance.parse(i).then(e).catch((function(e){console.error(e),n("Error loading glTF model from "+r+" .")}))}))},t}(Ii)),_e(e.AssetType.JSON,["json"],!1)(function(e){function t(){return e.apply(this,arguments)||this}return Rs(t,e),t.prototype.load=function(e){return this.request(e.url,Ms(Ms({},e),{},{type:"json"}))},t}(Ii));var Qs,Js=function(t,r,n,i){if(void 0===i&&(i=!1),!function(e){if(e.byteLength>=12){var t=new Uint8Array(e,0,12);if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&49===t[5]&&49===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])return!0}return!1}(t))throw new Error("khronosTextureContainerParser: invalid KTX file, texture missing KTX identifier");var a=Uint32Array.BYTES_PER_ELEMENT,o=new DataView(t,12,13*a),s=67305985===o.getUint32(0,!0),l={buffer:t,glType:o.getUint32(1*a,s),glTypeSize:o.getUint32(2*a,s),glFormat:o.getUint32(3*a,s),glInternalFormat:o.getUint32(4*a,s),glBaseInternalFormat:o.getUint32(5*a,s),pixelWidth:o.getUint32(6*a,s),pixelHeight:o.getUint32(7*a,s),pixelDepth:o.getUint32(8*a,s),numberOfArrayElements:o.getUint32(9*a,s),numberOfFaces:o.getUint32(10*a,s),numberOfMipmapLevels:o.getUint32(11*a,s),bytesOfKeyValueData:o.getUint32(12*a,s),loadType:0};if(0!==l.glType)throw new Error("only compressed formats currently supported");if(l.numberOfMipmapLevels=Math.max(1,l.numberOfMipmapLevels),0===l.pixelHeight||0!==l.pixelDepth)throw new Error("only 2D textures currently supported");if(0!==l.numberOfArrayElements)throw new Error("texture arrays not currently supported");if(l.numberOfFaces!==r)throw new Error("number of faces expected"+r+", but found "+l.numberOfFaces);return n&&(l.mipmaps=function(e,t){for(var r=[],n=64+e.bytesOfKeyValueData,i=e.pixelWidth,a=e.pixelHeight,o=e.numberOfMipmapLevels,s=0;s<o;s++){var l=new Int32Array(e.buffer,n,1)[0];n+=4;for(var u=0;u<e.numberOfFaces;u++){var c=new Uint8Array(e.buffer,n,l);r.push({data:c,width:i,height:a}),n+=l,n+=3-(l+3)%4}i=Math.max(1,.5*i),a=Math.max(1,.5*a)}return r}(l)),i&&(l.engineFormat=function(t){switch(t){case e.GLCompressedTextureInternalFormat.RGB_S3TC_DXT1_EXT:return e.TextureFormat.DXT1;case e.GLCompressedTextureInternalFormat.RGBA_S3TC_DXT5_EXT:return e.TextureFormat.DXT5;case e.GLCompressedTextureInternalFormat.RGB_ETC1_WEBGL:return e.TextureFormat.ETC1_RGB;case e.GLCompressedTextureInternalFormat.RGB8_ETC2:return e.TextureFormat.ETC2_RGB;case e.GLCompressedTextureInternalFormat.RGB8_PUNCHTHROUGH_ALPHA1_ETC2:return e.TextureFormat.ETC2_RGBA5;case e.GLCompressedTextureInternalFormat.RGBA8_ETC2_EAC:return e.TextureFormat.ETC2_RGBA8;case e.GLCompressedTextureInternalFormat.RGB_PVRTC_2BPPV1_IMG:return e.TextureFormat.PVRTC_RGB2;case e.GLCompressedTextureInternalFormat.RGBA_PVRTC_2BPPV1_IMG:return e.TextureFormat.PVRTC_RGBA2;case e.GLCompressedTextureInternalFormat.RGB_PVRTC_4BPPV1_IMG:return e.TextureFormat.PVRTC_RGB4;case e.GLCompressedTextureInternalFormat.RGBA_PVRTC_4BPPV1_IMG:return e.TextureFormat.PVRTC_RGBA4;case e.GLCompressedTextureInternalFormat.RGBA_ASTC_4X4_KHR:return e.TextureFormat.ASTC_4x4;case e.GLCompressedTextureInternalFormat.RGBA_ASTC_5X5_KHR:return e.TextureFormat.ASTC_5x5;case e.GLCompressedTextureInternalFormat.RGBA_ASTC_6X6_KHR:return e.TextureFormat.ASTC_6x6;case e.GLCompressedTextureInternalFormat.RGBA_ASTC_8X8_KHR:return e.TextureFormat.ASTC_8x8;case e.GLCompressedTextureInternalFormat.RGBA_ASTC_10X10_KHR:return e.TextureFormat.ASTC_10x10;case e.GLCompressedTextureInternalFormat.RGBA_ASTC_12X12_KHR:return e.TextureFormat.ASTC_12x12;default:var r=e.GLCompressedTextureInternalFormat[t];throw new Error("this format is not supported in Oasis Engine: "+r)}}(l.glInternalFormat)),l};function Zs(e){var t=Js(e,1,!0,!0);return{mipmaps:t.mipmaps,engineFormat:t.engineFormat,internalFormat:t.glInternalFormat,width:t.pixelWidth,height:t.pixelHeight}}_e(e.AssetType.KTXCube,[])(function(t){function r(){return t.apply(this,arguments)||this}return Rs(r,t),r.prototype.load=function(t,r){var n=this;return new he((function(i,a){Promise.all(t.urls.map((function(e){return n.request(e,Ms(Ms({},t),{},{type:"arraybuffer"}))}))).then((function(t){for(var n=function(e){for(var t,r,n,i,a=[],o=0;o<e.length;o++){var s=Js(e[o],1,!0,!0);a.push(s.mipmaps),0===o&&(n=s.pixelWidth,i=s.pixelHeight,t=s.glInternalFormat,r=s.engineFormat)}return{mipmapsFaces:a,engineFormat:r,internalFormat:t,width:n,height:i}}(t),a=n.width,o=n.mipmapsFaces,s=n.engineFormat,l=o[0].length>1,u=new Zr(r.engine,a,s,l),c=0;c<6;c++)for(var h=o[c].length,d=0;d<h;d++){var _=o[c][d],f=_.data,p=_.width,g=_.height;u.setPixelBuffer(e.TextureCubeFace.PositiveX+c,f,d,0,0,p,g)}i(u)})).catch((function(e){a(e)}))}))},r}(Ii)),_e(e.AssetType.KTX,["ktx"])(function(e){function t(){return e.apply(this,arguments)||this}return Rs(t,e),t.prototype.load=function(e,t){var r=this;return new he((function(n,i){r.request(e.url,Ms(Ms({},e),{},{type:"arraybuffer"})).then((function(e){for(var r=Zs(e),i=r.width,a=r.height,o=r.mipmaps,s=r.engineFormat,l=o.length>1,u=new ie(t.engine,i,a,s,l),c=0;c<o.length;c++){var h=o[c],d=h.width,_=h.height,f=h.data;u.setPixelBuffer(f,c,0,0,d,_)}n(u)})).catch((function(e){i(e)}))}))},t}(Ii)),_e(e.AssetType.Texture2D,["png","jpg","webp","jpeg"])(function(e){function t(){return e.apply(this,arguments)||this}return Rs(t,e),t.prototype.load=function(e,t){var r=this;return new he((function(n,i){r.request(e.url,Ms(Ms({},e),{},{type:"image"})).then((function(r){var i=new ie(t.engine,r.width,r.height);if(i._platformTexture){if(i.setImageSource(r),i.generateMipmaps(),0!==e.url.indexOf("data:")){var a=e.url.split("/");i.name=a[a.length-1]}n(i)}})).catch((function(e){i(e)}))}))},t}(Ii)),_e(e.AssetType.TextureCube,[""])(function(t){function r(){return t.apply(this,arguments)||this}return Rs(r,t),r.prototype.load=function(t,r){var n=this;return new he((function(i,a){Promise.all(t.urls.map((function(e){return n.request(e,Ms(Ms({},t),{},{type:"image"}))}))).then((function(t){var n=t[0],a=n.width;if(a===n.height){var o=new Zr(r.engine,a);if(o._platformTexture){for(var s=0;s<6;s++)o.setImageSource(e.TextureCubeFace.PositiveX+s,t[s],0);o.generateMipmaps(),i(o)}}else console.error("The cube texture must have the same width and height")})).catch((function(e){a(e)}))}))},r}(Ii)),_e(e.AssetType.SpriteAtlas,["atlas"],!1)(function(e){function t(){return e.apply(this,arguments)||this}return Rs(t,e),t.prototype.load=function(e,t){var r=this;return new he((function(n,i){r.request(e.url,Ms(Ms({},e),{},{type:"json"})).then((function(i){var a=i.atlasItems,o=i.format,s=a.length;Promise.all(a.map((function(t){var n=t.img;return r.request(Os.parseRelativeUrl(e.url,n),Ms(Ms({},e),{},{type:"image"}))}))).then((function(e){for(var r=t.engine,i=new w,l=new g,u=new ua(r),c=0;c<s;c++){var h=e[c],d=h.width,_=h.height,f=new ie(r,d,_,o);f.setImageSource(h),f.generateMipmaps();for(var p=a[c].sprites,v=1/d,m=1/_,y=p.length-1;y>=0;y--){var x=p[y],T=x.region,b=x.pivot,C=x.atlasRegionOffset,S=x.atlasRegion,M=x.id,A=new ca(r,f,T?i.setValue(T.x,T.y,T.w,T.h):void 0,b?l.setValue(b.x,b.y):void 0,x.pixelsPerUnit||void 0,x.name);if(A.atlasRegion.setValue(S.x*v,S.y*m,S.w*v,S.h*m),x.atlasRotated&&(A.atlasRotated=!0),C){var P=C.x,F=C.y,E=C.z,R=C.w,L=void 0,B=void 0;x.atlasRotated?(L=1/(P+S.h+E),B=1/(F+S.w+R)):(L=1/(P+S.w+E),B=1/(F+S.h+R)),A.atlasRegionOffset.setValue(P*L,F*B,E*L,R*B)}void 0!==M&&(A._assetID=M),u._addSprite(A)}}n(u)}))})).catch((function(e){i(e)}))}))},t}(Ii)),_e(e.AssetType.Env,["env"])(function(t){function r(){return t.apply(this,arguments)||this}return Rs(r,t),r.prototype.load=function(t,r){return new he((function(n,i){r.load({type:e.AssetType.Buffer,url:t.url}).then((function(t){var i,a=new Float32Array(t,0,27),o=null===(i=new Uint16Array(t,108,1))||void 0===i?void 0:i[0],s=new Zr(r.engine,o);s.filterMode=e.TextureFilterMode.Trilinear;for(var l=s.mipmapCount,u=110,c=0;c<l;c++)for(var h=o>>c,d=0;d<6;d++){var _=h*h*4,f=new Uint8Array(t,u,_);u+=_,s.setPixelBuffer(e.TextureCubeFace.PositiveX+d,f,c)}var p=new En,g=new b;p.diffuseMode=e.DiffuseMode.SphericalHarmonics,g.setValueByArray(a),p.diffuseSphericalHarmonics=g,p.specularTexture=s,p.specularTextureDecodeRGBM=!0,n(p)})).catch((function(e){i(e)}))}))},r}(Ii));var $s=Math.PI;_e(e.AssetType.HDR,["hdr"])(((Qs=function(t){function r(){return t.apply(this,arguments)||this}return Rs(r,t),r._convertToCubemap=function(e,t,r,n){if(!e)throw"ConvertPanoramaToCubemap: input cannot be null";if(e.length!=t*r*4)throw"ConvertPanoramaToCubemap: input size is wrong";return[this._createCubemapData(n,this._faceRight,e,t,r),this._createCubemapData(n,this._faceLeft,e,t,r),this._createCubemapData(n,this._faceUp,e,t,r),this._createCubemapData(n,this._faceBottom,e,t,r),this._createCubemapData(n,this._faceFront,e,t,r),this._createCubemapData(n,this._faceBack,e,t,r)]},r._createCubemapData=function(e,t,r,n,i){for(var a=new Uint8ClampedArray(e*e*4),o=this._tempVector3.setValue(0,0,0).add(t[1]).subtract(t[0]).scale(1/e),s=this._temp2Vector3.setValue(0,0,0).add(t[3]).subtract(t[2]).scale(1/e),l=1/e,u=0,c=0;c<e;c++){for(var h=this._temp3Vector3.setValue(0,0,0).add(t[0]),d=this._temp4Vector3.setValue(0,0,0).add(t[2]),_=0;_<e;_++){var f=this._temp5Vector3.setValue(0,0,0).add(d).subtract(h).scale(u).add(h);f.normalize();var p=this._calcProjectionSpherical(f,r,n,i);this._RGBEToLinear(p),this._linearToRGBM(p,5);var g=c*e*4+4*_;a[g]=p.r,a[g+1]=p.g,a[g+2]=p.b,a[g+3]=p.a,h.add(o),d.add(s)}u+=l}return a},r._calcProjectionSpherical=function(e,t,r,n){for(var i=Math.atan2(e.z,-e.x),a=Math.acos(e.y);i<-$s;)i+=2*$s;for(;i>$s;)i-=2*$s;var o=i/$s,s=a/$s;o=.5*o+.5;var l=Math.round(o*r);l<0?l=0:l>=r&&(l=r-1);var u=Math.round(s*n);u<0?u=0:u>=n&&(u=n-1);var c=(n-u-1)*r*4+4*l,h=t[c],d=t[c+1],_=t[c+2],f=t[c+3];return new T(h,d,_,f)},r._readStringLine=function(e,t){for(var r="",n="",i=t;i<e.length-t&&"\n"!=(n=String.fromCharCode(e[i]));i++)r+=n;return r},r._parseHeader=function(e){var t,r,n=this._readStringLine(e,0);if("#"!=n[0]||"?"!=n[1])throw"Bad HDR Format.";var i=!1,a=!1,o=0;do{o+=n.length+1,"FORMAT=32-bit_rle_rgbe"==(n=this._readStringLine(e,o))?a=!0:0==n.length&&(i=!0)}while(!i);if(!a)throw"HDR Bad header format, unsupported FORMAT";o+=n.length+1,n=this._readStringLine(e,o);var s=/^\-Y (.*) \+X (.*)$/g.exec(n);if(!s||s.length<3)throw"HDR Bad header format, no size";if(r=parseInt(s[2]),t=parseInt(s[1]),r<8||r>32767)throw"HDR Bad header format, unsupported size";return{height:t,width:r,dataPosition:o+=n.length+1}},r._readPixels=function(e,t,r){for(var n=t,i=e.byteLength,a=new Uint8Array(4*t*r),o=0,s=0,l=4*n,u=new Uint8Array(4),c=new Uint8Array(l),h=r;h>0&&s<i;){if(u[0]=e[s++],u[1]=e[s++],u[2]=e[s++],u[3]=e[s++],2!=u[0]||2!=u[1]||(u[2]<<8|u[3])!=n)throw"HDR Bad header format, wrong scan line width";for(var d=0,_=void 0;d<l&&s<i;){var f=(_=e[s++])>128;if(f&&(_-=128),0===_||d+_>l)throw"HDR Bad Format, bad scanline data (run)";if(f)for(var p=e[s++],g=0;g<_;g++)c[d++]=p;else c.set(e.subarray(s,s+_),d),d+=_,s+=_}for(var v=n,m=0;m<v;m++){var y=0;a[o]=c[m+y],y+=n,a[o+1]=c[m+y],y+=n,a[o+2]=c[m+y],y+=n,a[o+3]=c[m+y],o+=4}h--}return a},r._RGBEToLinear=function(e){var t=Math.pow(2,e.a-128)/255;e.r*=t,e.g*=t,e.b*=t,e.a=1},r._linearToRGBM=function(e,t){var r=Math.max(e.r,Math.max(e.g,e.b)),n=Math.min(r/t,1),i=65025/((n=Math.ceil(255*n))*t);e.r*=i,e.g*=i,e.b*=i,e.a*=n},r.prototype.load=function(t,n){return new he((function(i,a){var o=n.engine;n.load({url:t.url,type:e.AssetType.Buffer}).then((function(t){for(var n=new Uint8Array(t),a=r._parseHeader(n),s=a.width,l=a.height,u=a.dataPosition,c=r._readPixels(n.subarray(u),s,l),h=l>>1,d=r._convertToCubemap(c,s,l,h),_=new Zr(o,h),f=0;f<6;f++)_.setPixelBuffer(e.TextureCubeFace.PositiveX+f,d[f],0);_.generateMipmaps(),i(_)})).catch(a)}))},r}(Ii))._rightBottomBack=new o(1,-1,-1),Qs._rightBottomFront=new o(1,-1,1),Qs._rightUpBack=new o(1,1,-1),Qs._rightUpFront=new o(1,1,1),Qs._leftBottomBack=new o(-1,-1,-1),Qs._leftBottomFront=new o(-1,-1,1),Qs._leftUpBack=new o(-1,1,-1),Qs._leftUpFront=new o(-1,1,1),Qs._faceRight=[Qs._rightBottomBack,Qs._rightBottomFront,Qs._rightUpBack,Qs._rightUpFront],Qs._faceLeft=[Qs._leftBottomFront,Qs._leftBottomBack,Qs._leftUpFront,Qs._leftUpBack],Qs._faceUp=[Qs._leftBottomFront,Qs._rightBottomFront,Qs._leftBottomBack,Qs._rightBottomBack],Qs._faceBottom=[Qs._leftUpBack,Qs._rightUpBack,Qs._leftUpFront,Qs._rightUpFront],Qs._faceFront=[Qs._leftBottomBack,Qs._rightBottomBack,Qs._leftUpBack,Qs._rightUpBack],Qs._faceBack=[Qs._rightBottomFront,Qs._leftBottomFront,Qs._rightUpFront,Qs._leftUpFront],Qs._tempVector3=new o,Qs._temp2Vector3=new o,Qs._temp3Vector3=new o,Qs._temp4Vector3=new o,Qs._temp5Vector3=new o,Qs));var el,tl=function(){function e(){}var t=e.prototype;return t.initialize=function(){},t.parseEngineResource=function(e,t,r){},t.createEngineResource=function(e,t){return null},e}();Vs("KHR_draco_mesh_compression")(((el=function(e){function t(){return e.apply(this,arguments)||this}Rs(t,e);var r=t.prototype;return r.initialize=function(){t._decoder||(t._decoder=new Cs)},r.createEngineResource=function(e,r,n){var i=r.gltf,a=r.buffers,o=i.bufferViews,s=i.accessors,l=e.bufferView,u=e.attributes,c={},h={};for(var d in u)c[d]=u[d];for(var _ in n.attributes)if(void 0!==u[_]){var f=s[n.attributes[_]];h[_]=Os.getComponentType(f.componentType).name}var p=s[n.indices],g={attributeIDs:c,attributeTypes:h,useUniqueIDs:!0,indexType:Os.getComponentType(p.componentType).name},v=Os.getBufferViewData(o[l],a);return t._decoder.decode(v,g).then((function(e){return e}))},t}(tl))._decoder=void 0,el)),Vs("KHR_lights_punctual")(function(e){function t(){return e.apply(this,arguments)||this}return Rs(t,e),t.prototype.parseEngineResource=function(e,t,r){var n,i=e.color,a=e.intensity,o=void 0===a?1:a,s=e.type,l=e.range,u=e.spot;if("directional"===s?n=t.addComponent(Bn):"point"===s?n=t.addComponent(Dn):"spot"===s&&(n=t.addComponent(In)),i&&n.color.setValue(i[0],i[1],i[2],1),n.intensity=o,!l||n instanceof Bn||(n.distance=l),u&&n instanceof In){var c=u.innerConeAngle,h=void 0===c?0:c,d=u.outerConeAngle,_=void 0===d?Math.PI/4:d;n.angle=h,n.penumbra=_-h}r.lights||(r.lights=[]),r.lights.push(n)},t}(tl)),Vs("KHR_materials_clearcoat")(function(e){function t(){return e.apply(this,arguments)||this}return Rs(t,e),t.prototype.parseEngineResource=function(e,t,r){var n=r.textures,i=e.clearcoatFactor,a=void 0===i?0:i,o=e.clearcoatTexture,s=e.clearcoatRoughnessFactor,l=void 0===s?0:s,u=e.clearcoatRoughnessTexture,c=e.clearcoatNormalTexture;t.clearCoat=a,t.clearCoatRoughness=l,o&&(t.clearCoatTexture=n[o.index],Gs._parseTextureTransform(t,o.extensions,r)),u&&(t.clearCoatRoughnessTexture=n[u.index],Gs._parseTextureTransform(t,u.extensions,r)),c&&(t.clearCoatNormalTexture=n[c.index],Gs._parseTextureTransform(t,c.extensions,r))},t}(tl)),Vs("KHR_materials_pbrSpecularGlossiness")(function(e){function t(){return e.apply(this,arguments)||this}return Rs(t,e),t.prototype.createEngineResource=function(e,t){var r=t.engine,n=t.textures,i=new Ui(r),a=e.diffuseFactor,o=e.diffuseTexture,s=e.specularFactor,l=e.glossinessFactor,u=e.specularGlossinessTexture;return a&&(i.baseColor=new T(T.linearToGammaSpace(a[0]),T.linearToGammaSpace(a[1]),T.linearToGammaSpace(a[2]),a[3])),o&&(i.baseTexture=n[o.index],Gs._parseTextureTransform(i,o.extensions,t)),s&&(i.specularColor=new T(T.linearToGammaSpace(s[0]),T.linearToGammaSpace(s[1]),T.linearToGammaSpace(s[2]))),void 0!==l&&(i.glossiness=l),u&&(i.specularGlossinessTexture=n[u.index],Gs._parseTextureTransform(i,u.extensions,t)),i},t}(tl)),Vs("KHR_materials_unlit")(function(e){function t(){return e.apply(this,arguments)||this}return Rs(t,e),t.prototype.createEngineResource=function(e,t){var r=t.engine;return new ji(r)},t}(tl)),Vs("KHR_materials_variants")(function(e){function t(){return e.apply(this,arguments)||this}return Rs(t,e),t.prototype.parseEngineResource=function(e,t,r){for(var n=r.gltf.extensions.KHR_materials_variants.variants,i=r.materials,a=e.mappings,o=0;o<a.length;o++){var s=a[o],l=s.material,u=s.variants;r.variants||(r.variants=[]),r.variants.push({renderer:t,material:i[l],variants:u.map((function(e){return n[e].name}))})}},t}(tl)),Vs("KHR_mesh_quantization")(function(e){function t(){return e.apply(this,arguments)||this}return Rs(t,e),t}(tl)),Vs("KHR_texture_transform")(function(e){function t(){return e.apply(this,arguments)||this}return Rs(t,e),t.prototype.parseEngineResource=function(e,t,r){var n=e.offset,i=e.rotation,a=e.scale,o=e.texCoord;n&&(t.tilingOffset.z=n[0],t.tilingOffset.w=n[1]),a&&(t.tilingOffset.x=a[0],t.tilingOffset.y=a[1]),i&&re.warn("rotation in KHR_texture_transform is not supported now"),o&&re.warn("texCoord in KHR_texture_transform is not supported now")},t}(tl));var rl=function(e){function t(t){var r;return(r=e.call(this,t)||this)._animatorController=void 0,r._speed=1,r._animator=void 0,r._asset=void 0,r._glTFEntity=void 0,r._clipPreview=void 0,r._hasBuiltNode=!1,r._controllerUpdateFlag=void 0,r}Rs(t,e);var r=t.prototype;return r.init=function(e){var t=e.asset,r=void 0===t?null:t,n=e.speed,i=e.animatorController,a=e.clipPreview;if(e.isClone){var o=e.gltfRootName;o&&(this._glTFEntity=this.entity.findByName(o))}if(this._glTFEntity)this._hasBuiltNode=!0;else{var s="GLTF-"+Date.now();e.gltfRootName=s,this._glTFEntity=this.entity.createChild(s),this._hasBuiltNode=!1}this.asset=r,this.animatorController=i,this.speed=n,this.clipPreview=a},r.update=function(){var e;this._animator&&null!==(e=this._controllerUpdateFlag)&&void 0!==e&&e.flag&&this._playState()},r._onEnable=function(){this._glTFEntity&&(this._glTFEntity.isActive=!0),this.engine._componentsManager.addOnUpdateAnimations(this)},r._onDisable=function(){this._glTFEntity&&(this._glTFEntity.isActive=!1),this.engine._componentsManager.removeOnUpdateAnimations(this)},r._playState=function(){var e,t=this._clipPreview;t?"_default"===t?this._playDefaultState():this._animator.play(t,0):this._animator._reset(),null!==(e=this._controllerUpdateFlag)&&void 0!==e&&e.flag&&(this._controllerUpdateFlag.flag=!1)},r._playDefaultState=function(){var e=this._animatorController,t=this._animator;if(t&&e)for(var r=e.layers,n=0,i=r.length;n<i;++n){var a,o,s,l=null===(a=r[n])||void 0===a||null===(o=a.stateMachine)||void 0===o?void 0:o._defaultState,u=null==l?void 0:l.name;u?t.play(u,n):t._reset(),null!==(s=this._controllerUpdateFlag)&&void 0!==s&&s.flag&&(this._controllerUpdateFlag.flag=!1)}},Ps(t,[{key:"asset",get:function(){return this._asset},set:function(e){var t=this._animatorController,r=this._speed,n=this._glTFEntity;if(!e||e.defaultSceneRoot!==this._glTFEntity){if(!this._hasBuiltNode&&(n.clearChildren(),null!==e)){null==n||n.destroy();var i=e.defaultSceneRoot.clone();this._animator=i.getComponent(_o),this.entity.addChild(i),i.isActive=this.enabled,this._glTFEntity=i}t&&(this._animator.animatorController=t,this._animator.speed=r,this._playState()),this._asset=e}}},{key:"animatorController",get:function(){return this._animatorController},set:function(e){var t=this._animator;e!==this._animatorController&&(this._controllerUpdateFlag&&this._controllerUpdateFlag.clearFromManagers(),this._controllerUpdateFlag=e&&e._registerChangeFlag(),this._animatorController=e,t&&(t.animatorController=e,this._playState()))}},{key:"speed",get:function(){return this._speed},set:function(e){var t=this._animator;this._speed=e,t&&(t.speed=e,this._playState())}},{key:"animator",get:function(){return this._animator}},{key:"clipPreview",get:function(){return this._clipPreview},set:function(e){this._animator&&(e?"_default"===e?this._playDefaultState():this._animator.play(e,0):this._animator._reset()),this._clipPreview=e}}]),t}(Je),nl=function(e){function t(t){var r;return(r=e.call(this,t)||this)._props=null,r.setMaterial(new zi(r.engine)),r}Rs(t,e);var r=t.prototype;return r.setProps=function(e){switch(void 0===e&&(e={}),this._props!==e&&(this._props=e),e.geometryType){case"Sphere":this.mesh=mn.createSphere(this._engine,e.sphereRadius,e.sphereSegments);break;case"Cylinder":this.mesh=mn.createCylinder(this._engine,e.cylinderRadiusTop,e.cylinderRadiusBottom,e.cylinderHeight,e.cylinderRadialSegments,e.cylinderHeightSegments);break;case"Plane":this.mesh=mn.createPlane(this._engine,e.planeWidth,e.planeHeight,e.planeHorizontalSegments,e.planeVerticalSegments);break;case"Box":this.mesh=mn.createCuboid(this._engine,e.boxWidth,e.boxHeight,e.boxDepth)}},r.updateProp=function(e,t){var r=this._props;r[e]=t,this.setProps(r)},Ps(t,[{key:"material",get:function(){return this.getMaterial()},set:function(e){this.setMaterial(e)}}]),t}(gn),il=function(){function e(){this.registeredPlugins=new Set,this.plugins=[]}var t=e.prototype;return t.register=function(e){this.registeredPlugins.add(e)},t.boot=function(e){for(var t,r=function(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(r)return(r=r.call(e)).next.bind(r);if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return Ds(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Ds(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(this.registeredPlugins.values());!(t=r()).done;){var n=t.value;"function"==typeof n&&(n=n(e)),this.plugins.push(n)}},t.reset=function(){this.registeredPlugins.clear(),this.plugins=[]},t.nodeAdded=function(e){this.delegateMethod("nodeAdded",e)},t.delegateMethod=function(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];this.plugins.forEach((function(t){return t[e]&&t[e].apply(t,r)}))},e}();function al(e){return function(t,r,n){var i=n.value;n.value=function(){for(var t,r=this,n=arguments.length,a=new Array(n),o=0;o<n;o++)a[o]=arguments[o];return e.before&&(t=this.oasis.pluginManager).delegateMethod.apply(t,[e.before].concat(a)),Promise.resolve(i.apply(this,arguments)).then((function(t){return e.after&&r.oasis.pluginManager.delegateMethod(e.after,t),t}))}}}function ol(e){for(var t=Object.keys(e),r=0,n=t.length;r<n;++r){var i=t[r],a=e[i];Array.isArray(a)&&"object"!=typeof a[0]&&(-1!==["color","diffuseColor","specularColor"].indexOf(i)?e[i]=new T(a[0],a[1],a[2],a[3]):4===a.length?e[i]=new v(a[0],a[1],a[2],a[3]):3===a.length?e[i]=new o(a[0],a[1],a[2]):2===a.length&&(e[i]=new g(a[0],a[1])))}}function sl(e){for(var t=Object.keys(e),r=0,n=t.length;r<n;++r){var i=t[r],a=e[i];Array.isArray(a)&&"object"!=typeof a[0]&&(/color/i.test(i)?e[i]=new T(a[0],a[1],a[2],a[3]):4===a.length?e[i]=new v(a[0],a[1],a[2],a[3]):3===a.length?e[i]=new o(a[0],a[1],a[2]):2===a.length&&(e[i]=new g(a[0],a[1])))}}function ll(e){if(void 0===e&&(e={}),e)for(var t=Object.keys(e),r=0,n=t.length;r<n;r++){var i=t[r],a=e[i];"newMaterial"!==i&&"scripts"!==i&&Array.isArray(a)&&"object"!=typeof a[0]&&(-1!==["emissiveColor","diffuseColor","specularColor","baseColor"].indexOf(i)?e[i]=new T(a[0],a[1],a[2],a[3]):4===a.length?e[i]=new v(a[0],a[1],a[2],a[3]):3===a.length?e[i]=new o(a[0],a[1],a[2]):2===a.length&&(e[i]=new g(a[0],a[1])))}}var ul=function(){var e=t.prototype;function t(){this.pluginManager=new il}return e.parse=function(e){var t,r;return 3!==(null==e||null===(t=e.config)||void 0===t?void 0:t.version)&&console.warn('schema-parser: schema version "'+(null==e||null===(r=e.config)||void 0===r?void 0:r.version)+'" is out of date, please re-pull the latest version (version 3) of the schema'),function(e){for(var t=e.abilities,r=void 0===t?{}:t,n=e.assets,i=void 0===n?{}:n,a=e.scene,o=void 0===a?{}:a,s=Object.keys(r),l=Object.keys(i),u=Object.keys(o||{}),c=0,h=s.length;c<h;++c)ol(r[s[c]].props);for(var d=0,_=l.length;d<_;++d)ll(i[l[d]].props);for(var f=0,p=u.length;f<p;++f)sl(o[u[f]].props)}(e.config),iu.create(e,this.pluginManager)},e.register=function(e){this.pluginManager.register(e)},e.resetPlugins=function(){this.pluginManager.reset()},t.create=function(){return new t},t.registerComponents=function(e,t){this._components[e]||(this._components[e]={}),Es(this._components[e],t)},t}();ul._components={};var cl=ul.create();function hl(e,t,r){if(t!==r&&null!=r){var n=[e[r],e[t]];e[t]=n[0],e[r]=n[1]}}function dl(e){return e&&"asset"===e.type}function _l(e){for(var t=[],r=Object.getPrototypeOf(e),n=Object.getOwnPropertyDescriptors(r),i=0,a=Object.entries(n);i<a.length;i++){var o=a[i],s=o[0];"function"==typeof o[1].get&&t.push(s)}return t}var fl,pl=function(){var e=t.prototype;function t(e,t){this.resourceManager=e,this._resource=t,this._meta={},this._attachedResources=[],this.setMeta()}return e.setMeta=function(){},e.loadWithAttachedResources=function(e,t,r){var n=this;return new Promise((function(i,a){n.load(e,t,r).then((function(){i({resources:[n],structure:{index:0,props:{}}})})).catch((function(e){a(e)}))}))},e.getProps=function(){return{}},e.bind=function(){},e.attach=function(){},e.update=function(e,t){if(dl(t)){var r=this.resourceManager.get(t.id);r?this._resource[e]=r.resource:re.warn("SchemaResource: "+this.meta.name+" can't find asset, which id is: "+t.id)}else this._resource[e]=t},e.updateMeta=function(e,t){this._meta[e]=t},e.onDestroy=function(){},Ps(t,[{key:"resource",get:function(){return this._resource}},{key:"meta",get:function(){return this._meta}},{key:"attachedResources",get:function(){return this._attachedResources}}]),t}(),gl=function(e){function t(){return e.apply(this,arguments)||this}Rs(t,e);var r=t.prototype;return r.load=function(e,t){var r=this;return new Promise((function(e){r._resource=t.props||{},r.setMeta(),e(r)}))},r.loadWithAttachedResources=function(e,t){var r=this;return new Promise((function(n,i){var a;t.props?a=r.load(e,t):i("Load AnimationClip Error"),a&&a.then((function(){n({resources:[r],structure:{index:0,props:{}}})}))}))},r.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},r.getProps=function(){return this._resource},t}(pl),vl=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).gltf=void 0,t.animatorControllerData=void 0,t.animationClipAssets=void 0,t.animationsIndices=void 0,t}Rs(t,e);var r=t.prototype;return r.load=function(e,t){var r=this;return new Promise((function(e){var n=t.props||{},i=n.animatorController,a=n.animationClips,o=n.animationsIndices,s=n.gltf;r._resource=new fo,r.animatorControllerData=i,r.animationsIndices=o||[],r.animationClipAssets=a||[],r.gltf=s,!i&&r._setDefaultDataByAnimationClip(),r.setMetaData("name",t.name),e(r)}))},r.loadWithAttachedResources=function(e,t){var r=this;return new Promise((function(n,i){var a=[];r.load(e,t).then((function(){for(var t={resources:[r],structure:{index:0,props:{animationClips:[]}}},i=r.animationsIndices,o=0,s=i.length;o<s;++o){var l=i[o],u=new gl(r.resourceManager);r.attachedResources.push(u),a.push(u.loadWithAttachedResources(e,{type:"animationClip",name:l.name,props:l}))}Promise.all(a).then((function(e){var r=t.structure.props.animationClips;e.forEach((function(e){var n=e.structure,i=e.resources[n.index];t.resources.push(i),n.index=t.resources.length-1,r.push(n)})),n(t)}))}))}))},r.setMetaData=function(e,t){this._meta[e]=t},r.update=function(e,t){this._initAnimatorController(t)},r.bind=function(){var e=this.animatorControllerData,t=this.animationClipAssets;this._bindClips(t),e?this._initAnimatorController(e):this._setDefaultDataByAnimationClipAsset()},r._initAnimatorController=function(e){var t=(this.gltf||{}).animations,r=e.layers;if(t&&r){this._resource.clearLayers();for(var n=0,i=r.length;n<i;++n){var a=r[n],o=a.name,s=a.blending,l=a.weight,u=a.stateMachine;if(u){var c=new po(o);c.blendingMode=s,c.weight=l;for(var h=u.states,d=new mo,_=[],f=0,p=h.length;f<p;++f){var g=h[f],v=g.name,m=g.transitions,y=g.clip,x=g.speed,T=g.wrapMode,w=g.clipStartNormalizedTime,b=g.clipEndNormalizedTime,C=g.isDefaultState,S=(y||{}).id;if(S){var M=d.makeUniqueStateName(v);M!==v&&console.warn("AnimatorState name is existed, name: "+v+" reset to "+M);var A=d.addState(M);A.speed=x,A.wrapMode=T;var P=t[this.resourceManager.get(S).resource.index];if(P){A.clip=P,A.clipStartTime=w,A.clipEndTime=b;for(var F=0,E=m.length;F<E;++F){var R=m[F];m[F].srcState=A,_.push(R)}C&&(d._defaultState=A)}}}for(var L=0,B=_.length;L<B;++L){var D=_[L],I=new Qa;I.duration=D.duration,I.offset=D.offset,I.exitTime=D.exitTime,I.destinationState=d.findStateByName(D.targetStateName),D.srcState.addTransition(I),delete D.srcState}c.stateMachine=d,this._resource.addLayer(c)}}}},r._bindClips=function(e){for(var t=0,r=e.length;t<r;t++){var n=e[t],i=this.resourceManager.get(n.id);i?this._attachedResources.push(i):(this.meta.name,n.id)}},r._setDefaultDataByAnimationClipAsset=function(){var e=this.animationClipAssets;if(e.length){for(var t=[],r=0,n=e.length;r<n;r++){var i=this.resourceManager.get(e[r].id);t.push(i.resource)}this.animationsIndices=t,this._setDefaultDataByAnimationClip()}},r._setDefaultDataByAnimationClip=function(){var e=this.animationsIndices,t=this._resource,r=this.gltf;if(e.length&&r){var n=r.animations,i=new po("layer"),a=new mo;t.addLayer(i),i.stateMachine=a;for(var o=0,s=e.length;o<s;o++){var l=e[o],u=l.name,c=l.index,h=a.makeUniqueStateName(u);h!==u&&console.warn("AnimatorState name is existed, name: "+u+" reset to "+h),a.addState(h).clip=n[c]}}},t}(pl),ml=function(t){function r(){return t.apply(this,arguments)||this}Rs(r,t);var n=r.prototype;return n.load=function(t,r,n){var i=this;return new Promise((function(a,o){var s,l,u,c,h=e.AssetType.Texture2D;if(i.resourceManager.useCompressedTexture&&null!=r&&null!==(s=r.props)&&void 0!==s&&null!==(l=s.compression)&&void 0!==l&&l.compressions.length)for(var d=n.engine._hardwareRenderer,_=r.props.compression.compressions,f=0;f<_.length;f++){var p=_[f];if("ktx"===p.container&&d.canIUse(e.GLCapabilityType[p.type])){c=p.url,h=e.AssetType.KTX;break}}c=null!=(u=c)?u:r.url,t.load({url:c,type:h}).then((function(e){i._resource=e,a(i)})).catch((function(e){o(e)}))}))},n.setMeta=function(){this.resource&&(this._meta.name=this.resource.name)},r}(pl),yl=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).configProps=void 0,t}Rs(t,e);var r=t.prototype;return r.load=function(e,t){var r=this;return new Promise((function(n){var i=new zi(e.engine);for(var a in r.configProps=t.props,r._resource=i,r.configProps)dl(r.configProps[a])||(i[a]=r.configProps[a]);r.setMeta(),n(r)}))},r.loadWithAttachedResources=function(e,t){var r=this;return new Promise((function(n,i){var a;t.resource instanceof zi?a=new Promise((function(e){r._resource=t.resource,r.setMeta(),e(r)})):t.props?a=r.load(e,t):i("Load BlinnPhongMaterial Error"),a&&a.then((function(){var e={resources:[r],structure:{index:0,props:{}}},t=r._resource;_l(r._resource).forEach((function(n){if(t[n]instanceof ne){var i=new ml(r.resourceManager,t[n]);r.attachedResources.push(i),e.resources.push(i),e.structure.props[n]={index:e.resources.length-1}}})),n(e)}))}))},r.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},r.bind=function(){var e=this,t=this._resource;Object.keys(this.configProps).forEach((function(r){var n=e.configProps[r];if(dl(n)){var i=e.resourceManager.get(n.id);i&&i instanceof ml?(t[r]=i.resource,e._attachedResources.push(i)):(t[r]=null,re.warn("BlinnPhongMaterialResource: "+e.meta.name+" can't find asset \""+r+'", which id is: '+n.id))}else t[r]=n}))},t}(pl),xl=["metallic","roughness","roughnessMetallicTexture","tilingOffset","baseColor","normalTextureIntensity","emissiveColor","occlusionTextureIntensity","baseTexture","normalTexture","emissiveTexture","occlusionTexture","isTransparent","alphaCutoff","renderFace","blendMode"],Tl=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).configProps=void 0,t}Rs(t,e);var r=t.prototype;return r.load=function(e,t){var r=this;return new Promise((function(n){var i=new Ni(e.engine);for(var a in r.configProps=t.props,r.configProps)dl(r.configProps[a])||(i[a]=r.configProps[a]);r._resource=i,r.setMeta(),n(r)}))},r.loadWithAttachedResources=function(e,t){var r=this;return new Promise((function(n,i){var a;t.resource instanceof Ni?a=new Promise((function(e){r._resource=t.resource,r.setMeta(),e(r)})):t.props?a=r.load(e,t):i("Load PBRMaterial Error"),a&&a.then((function(){var e={resources:[r],structure:{index:0,props:{}}},t=r._resource;xl.forEach((function(n){if(t[n]instanceof ne){var i=new ml(r.resourceManager,t[n]);r.attachedResources.push(i),e.resources.push(i),e.structure.props[n]={index:e.resources.length-1}}})),n(e)}))}))},r.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},r.getProps=function(){var e=this,t={};return xl.forEach((function(r){return t[r]=e.resource[r]})),t},r.bind=function(){var e=this,t=this._resource;Object.keys(this.configProps).forEach((function(r){var n=e.configProps[r];if(dl(n)){var i=e.resourceManager.get(n.id);i&&i instanceof ml?(t[r]=i.resource,e._attachedResources.push(i)):(t[r]=null,re.warn("PBRMaterialResource: "+e.meta.name+" can't find asset \""+r+'", which id is: '+n.id))}else t[r]=n}))},t}(pl),wl=["specularColor","glossiness","specularGlossinessTexture","tilingOffset","baseColor","normalTextureIntensity","emissiveColor","occlusionTextureIntensity","baseTexture","normalTexture","emissiveTexture","occlusionTexture","isTransparent","alphaCutoff","renderFace","blendMode"],bl=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).configProps=void 0,t}Rs(t,e);var r=t.prototype;return r.load=function(e,t){var r=this;return new Promise((function(n){var i=new Ui(e.engine);for(var a in r.configProps=t.props,r._resource=i,r.configProps)dl(r.configProps[a])||(i[a]=r.configProps[a]);r.setMeta(),n(r)}))},r.loadWithAttachedResources=function(e,t){var r=this;return new Promise((function(n,i){var a;t.resource instanceof Ui?a=new Promise((function(e){r._resource=t.resource,r.setMeta(),e(r)})):t.props?a=r.load(e,t):i("Load PBRSpecularMaterial Error"),a&&a.then((function(){var e={resources:[r],structure:{index:0,props:{}}},t=r._resource;Object.keys(r._resource).forEach((function(n){if(t[n]instanceof ne){var i=new ml(r.resourceManager,t[n]);r.attachedResources.push(i),e.resources.push(i),e.structure.props[n]={index:e.resources.length-1}}})),n(e)}))}))},r.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},r.getProps=function(){var e=this,t={};return wl.forEach((function(r){return t[r]=e.resource[r]})),t},r.bind=function(){var e=this,t=this._resource;Object.keys(this.configProps).forEach((function(r){var n=e.configProps[r];if(dl(n)){var i=e.resourceManager.get(n.id);i&&i instanceof ml?(t[r]=i.resource,e._attachedResources.push(i)):(t[r]=null,re.warn("PBRSpecularMaterialResource: "+e.meta.name+" can't find asset \""+r+'", which id is: '+n.id))}else t[r]=n}))},t}(pl),Cl=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).configProps=void 0,t}Rs(t,e);var r=t.prototype;return r.load=function(e,t){var r=this;return new Promise((function(n){var i=new ji(e.engine);for(var a in r.configProps=t.props,r.configProps)dl(r.configProps[a])||(i[a]=r.configProps[a]);r._resource=i,r.setMeta(),n(r)}))},r.loadWithAttachedResources=function(e,t){var r=this;return new Promise((function(n,i){var a;t.resource instanceof ji?a=new Promise((function(e){r._resource=t.resource,r.setMeta(),e(r)})):t.props?a=r.load(e,t):i("Load PBRMaterial Error"),a&&a.then((function(){var e={resources:[r],structure:{index:0,props:{}}},t=r._resource;_l(r._resource).forEach((function(n){if(t[n]instanceof ne){var i=new ml(r.resourceManager,t[n]);r.attachedResources.push(i),e.resources.push(i),e.structure.props[n]={index:e.resources.length-1}}})),n(e)}))}))},r.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},r.getProps=function(){var e=this,t={};return _l(this.resource).forEach((function(r){return t[r]=e.resource[r]})),t},r.bind=function(){var e=this,t=this._resource;Object.keys(this.configProps).forEach((function(r){var n=e.configProps[r];if(dl(n)){var i=e.resourceManager.get(n.id);i&&i instanceof ml?(t[r]=i.resource,e._attachedResources.push(i)):(t[r]=null,re.warn("PBRMaterialResource: "+e.meta.name+" can't find asset \""+r+'", which id is: '+n.id))}else t[r]=n}))},t}(pl),Sl=function(t){function r(){return t.apply(this,arguments)||this}Rs(r,t);var n=r.prototype;return n.load=function(t,r,n){var i=this;return t.load({url:r.url,type:e.AssetType.Prefab}).then((function(e){var t=e;r.props&&(t.newMaterial=r.props.newMaterial,t.animatorControllers=r.props.animatorControllers),i._resource=t}))},n.loadWithAttachedResources=function(e,t,r){var n=this;return new Promise((function(i){n.load(e,t,r).then((function(){var t,r=n.resource,a=r.materials,o=void 0===a?[]:a,s=r._animationsIndices,l=void 0===s?[]:s,u=[],c={resources:[n],structure:{index:0,props:{newMaterial:[],animatorControllers:[]}}};if(null!=o&&o.length)for(var h=0;h<o.length;h++){var d=o[h],_=null,f="";d instanceof Ni?(_=new Tl(n.resourceManager),f="PBRMaterial"):d instanceof ji?(_=new Cl(n.resourceManager),f="UnlitMaterial"):d instanceof Ui?(_=new bl(n.resourceManager),f="PBRSpecularMaterial"):(_=new yl(n.resourceManager),f="BlinnPhongMaterial"),n._attachedResources.push(_),u.push(_.loadWithAttachedResources(e,{type:f,name:d.name,resource:d}))}if(l.length){var p=new vl(n.resourceManager);n._attachedResources.push(p),t=p.loadWithAttachedResources(e,{type:"animatorController",name:"AnimatorController",props:{animationsIndices:l,gltf:n._resource}})}var g=Promise.all(u).then((function(e){var t=c.structure.props.newMaterial;e.forEach((function(e){var r=e.structure,n=e.resources[r.index];for(var i in c.resources.push(n),r.index=c.resources.length-1,r.props)if(r.props.hasOwnProperty(i)){var a=r.props[i],o=e.resources[a.index];c.resources.push(o),a.index=c.resources.length-1}t.push(r)}))})),v=t?t.then((function(e){var t=c.structure.props.animatorControllers,r=e.structure,n=e.resources[r.index];c.resources.push(n),r.index=c.resources.length-1;var i=r.props.animationClips;if(i)for(var a=0,o=i.length;a<o;++a){var s=i[a],l=e.resources[s.index];c.resources.push(l),s.index=c.resources.length-1}t.push(r)})):Promise.resolve();Promise.all([g,v]).then((function(){i(c)}))}))}))},n.setMeta=function(e){e&&(this.meta.name=e.name)},n.bind=function(){var e=this._resource;this.bindMaterials(e.newMaterial),this.bindAnimatorControllers(e.animatorControllers)},n.update=function(e,t){"newMaterial"===e?this.bindMaterials(t):this._resource[e]=t},n.bindMaterials=function(e){var t=e.length;if(e&&e.length){var r=this._resource,n=new Array(t);r.newMaterial=n;for(var i=0;i<e.length;i++){var a=this.resourceManager.get(e[i].id);a?(this._attachedResources.push(a),n[i]=a.resource):re.warn("GLTFResource: "+this.meta.name+' can\'t find asset "material", which id is: '+e[i].id)}for(var o=r.defaultSceneRoot,s=r.materials,l=o.getComponentsIncludeChildren(gn,[]),u=0;u<t;u++)for(var c=n[u],h=s[u],d=0;d<l.length;d++)for(var _=l[d],f=_.getMaterials(),p=0;p<f.length;p++)h===f[p]&&_.setMaterial(p,c)}},n.bindAnimatorControllers=function(e){for(var t=0,r=e.length;t<r;t++){var n=e[t],i=this.resourceManager.get(n.id);i.gltf=this._resource,i?this._attachedResources.push(i):(this.meta.name,n.id)}},r}(pl),Ml={},Al=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=e.call.apply(e,[this].concat(n))||this).isInit=!1,t}Rs(t,e);var r=t.prototype;return r.initScriptContext=function(){this.isInit||(this.isInit=!0,window.__o3_script_context__={o3:ul._components.o3,script:function(e){return function(t){Ml[e]=t}}})},r.load=function(e,t,r){var n=this;return this.initScriptContext(),new Promise((function(e){var i=t.props.scripts;if(n.resourceManager.isLocal){for(var a=0;a<i.length;a++){var o,s=i[a].name;Ml[s]=null===(o=r.options)||void 0===o?void 0:o.scripts[s]}e(n)}else{var l=document.createElement("script");l.crossOrigin="anonymous",n.setMeta(t),l.onload=function(){for(var t=window.o3Scripts,r=0;r<i.length;r++){var a=i[r].name;n._resource=t&&t[a],Ml[a]=n._resource}e(n)},l.src=t.url,document.body.appendChild(l)}}))},r.setMeta=function(e){e&&(this._meta.name=e.name,this._meta.url=e.url,this._meta.source=e.source)},t}(pl),Pl=function(t){function r(){for(var e,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(e=t.call.apply(t,[this].concat(n))||this).configProps=void 0,e}Rs(r,t);var n=r.prototype;return n.load=function(t,r){var n=this;return new Promise((function(i){var a=new ca(t.engine);n.configProps=r.props;var o=n.configProps,s=o.pivotType,l=o.pivot;if(void 0!==l&&void 0!==s&&s!==e.SpritePivotType.Custom)switch(s){case e.SpritePivotType.Center:l.x=.5,l.y=.5;break;case e.SpritePivotType.TopLeft:l.x=0,l.y=1;break;case e.SpritePivotType.Top:l.x=.5,l.y=1;break;case e.SpritePivotType.TopRight:l.x=1,l.y=1;break;case e.SpritePivotType.Left:l.x=0,l.y=.5;break;case e.SpritePivotType.Right:l.x=1,l.y=.5;break;case e.SpritePivotType.BottomLeft:l.x=0,l.y=0;break;case e.SpritePivotType.Bottom:l.x=.5,l.y=0;break;case e.SpritePivotType.BottomRight:l.x=1,l.y=0}for(var u in o)dl(o[u])||void 0===o[u]||(a[u]=o[u]);n._resource=a,n.setMeta(),i(n)}))},n.loadWithAttachedResources=function(e,t){var n=this;return new Promise((function(i,a){var o;t.resource instanceof r?o=new Promise((function(e){n._resource=t.resource,n.setMeta(),e(n)})):t.props?o=n.load(e,t):a("Load Sprite Error"),o&&o.then((function(){var e={resources:[n],structure:{index:0,props:{}}},t=n._resource;_l(n._resource).forEach((function(r){if(t[r]instanceof ne){var i=new ml(n.resourceManager,t[r]);n.attachedResources.push(i),e.resources.push(i),e.structure.props[r]={index:e.resources.length-1}}})),i(e)}))}))},n.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},n.getProps=function(){var e=this,t={};return _l(this.resource).forEach((function(r){return t[r]=e.resource[r]})),t},n.bind=function(){var e=this,t=this._resource;this.configProps&&Object.keys(this.configProps).forEach((function(r){var n=e.configProps[r];if(dl(n)){var i=e.resourceManager.get(n.id);i&&i instanceof ml?(t[r]=i.resource,e._attachedResources.push(i)):(t[r]=null,re.warn("SpriteResource: "+e.meta.name+" can't find asset \""+r+'", which id is: '+n.id))}else t[r]=n}))},r}(pl);e.SpritePivotType=void 0,(fl=e.SpritePivotType||(e.SpritePivotType={}))[fl.Center=0]="Center",fl[fl.TopLeft=1]="TopLeft",fl[fl.Top=2]="Top",fl[fl.TopRight=3]="TopRight",fl[fl.Left=4]="Left",fl[fl.Right=5]="Right",fl[fl.BottomLeft=6]="BottomLeft",fl[fl.Bottom=7]="Bottom",fl[fl.BottomRight=8]="BottomRight",fl[fl.Custom=9]="Custom";var Fl,El,Rl,Ll,Bl,Dl,Il,Ol,zl,Vl,Nl,Ul,kl,Gl={px:0,nx:1,py:2,ny:3,pz:4,nz:5},Hl=function(t){function r(){return t.apply(this,arguments)||this}Rs(r,t);var n=r.prototype;return n.load=function(t,r,n){var i=this;return new Promise((function(a,o){var s,l,u=[],c=e.AssetType.TextureCube;if(i.resourceManager.useCompressedTexture&&null!=r&&null!==(s=r.props)&&void 0!==s&&null!==(l=s.compression)&&void 0!==l&&l.compressions.length)for(var h=n.engine._hardwareRenderer,d=r.props.compression.compressions,_=0;_<d.length;_++){var f=d[_];if("ktx"===f.container&&h.canIUse(e.GLCapabilityType[f.type])){for(var p in f.files)if(f.files.hasOwnProperty(p)){var g=f.files[p];u[Gl[p]]=g.url}console.warn(f.type),c=e.AssetType.KTXCube;break}}if(c===e.AssetType.TextureCube)for(var v in r.props.images)if(r.props.images.hasOwnProperty(v)){var m=r.props.images[v];u[Gl[v]]=m.url}t.load({urls:u,type:c}).then((function(e){i._resource=e,a(i)})).catch((function(e){o(e)}))}))},n.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},r}(pl),Wl=function(e){function t(){return e.apply(this,arguments)||this}Rs(t,e);var r=t.prototype;return r.load=function(e,t){var r=this;return new Promise((function(e){r._resource=t,r.setMetaData("name",r.resource.name),r.setMetaData("url",r.resource.url),e(r)}))},r.setMetaData=function(e,t){this._meta[e]=t},t}(pl),jl=function(t){function r(){return t.apply(this,arguments)||this}Rs(r,t);var n=r.prototype;return n.load=function(t,r,n){var i=this;return new Promise((function(n,a){var o=r.url;t.load({url:o,type:e.AssetType.Env}).then((function(e){i._resource=e,n(i)})).catch((function(e){a(e)}))}))},n.setMeta=function(){this.resource&&(this._meta.name=this.resource.name)},r}(pl),Xl=(Fl=al({after:"abilityAdded",before:"beforeAbilityAdded"}),El=al({before:"beforeAbilityUpdated",after:"abilityUpdated"}),Rl=al({after:"abilityDeleted",before:"beforeAbilityDeleted"}),Is((Ll=function(){function t(e){this.oasis=e,this.abilityMap={}}var r=t.prototype;return r.add=function(t){var r=t.type,n=t.node,i=t.props,a=t.id,s=t.index,l=this.oasis.nodeManager.get(n),u=this.getCompConstructor(r);if(u){var c=this.mixPropsToExplicitProps(i),h=l.addComponent(u),d=c.enabled;if(void 0!==d&&(h.enabled=d),"GLTFModel"===r)h.init(c);else if("Model"===r)h.setProps(c),c.material&&(h.material=c.material);else if("StaticCollider"===r||"DynamicCollider"===r)!function(t,r){t.isShowCollider=r.isShowCollider;for(var n=r.colliderShapes,i=0;i<n.length;i++){var a=n[i];switch(a._shapes){case"BoxColliderShape":var s=new gt;a.size&&s.setSize(a.size[0],a.size[1],a.size[2]),a.position&&s.setPosition(a.position[0],a.position[1],a.position[2]),a.isTrigger&&(s.isTrigger=a.isTrigger),t.addShape(s);break;case"CapsuleColliderShape":var l=new yt;if(a.radius&&(l.radius=a.radius),a.height&&(l.height=a.height),a.upAxis)switch(a.upAxis){case"X":l.upAxis=e.ColliderShapeUpAxis.X;break;case"Y":l.upAxis=e.ColliderShapeUpAxis.Y;break;case"Z":l.upAxis=e.ColliderShapeUpAxis.Z}a.position&&l.setPosition(a.position[0],a.position[1],a.position[2]),a.isTrigger&&(l.isTrigger=a.isTrigger),t.addShape(l);break;case"PlaneColliderShape":var u=new mt;a.rotation&&u.setRotation(a.rotation[0],a.rotation[1],a.rotation[2]),a.position&&u.setPosition(a.position[0],a.position[1],a.position[2]),a.isTrigger&&(u.isTrigger=a.isTrigger),t.addShape(u);break;case"SphereColliderShape":var c=new vt;a.radius&&(c.radius=a.radius),a.position&&c.setPosition(a.position[0],a.position[1],a.position[2]),a.isTrigger&&(c.isTrigger=a.isTrigger),t.addShape(c)}}if(t instanceof wt){var h=r.force;h&&t.applyForce(new o(h[0],h[1],h[2]));var d=r.torque;d&&t.applyTorque(new o(d[0],d[1],d[2]))}}(h,c);else for(var _ in c)null!==c[_]&&(h[_]=c[_]);var f=l._components;return hl(f,f.length-1,s),h.id=a,this.abilityMap[a]=h,h}re.error(r+" ability is not defined")},r.update=function(e,t,r){return r&&this.checkIsAsset(r)?this.get(e)[t]=this.oasis.resourceManager.get(r.id).resource:this.get(e).constructor===nl?this.get(e).updateProp(t,r):this.get(e)[t]=r,{id:e,key:t,value:r}},r.addRuntimeComponent=function(e,t){return t.id=e,this.abilityMap[e]=t,t},r.get=function(e){return this.abilityMap[e]},r.delete=function(e){return this.abilityMap[e].destroy(),delete this.abilityMap[e],e},r.getCompConstructor=function(e){var t=e.split(".");if("script"===t[0])return Ml[t[1]];var r=ul._components.o3[e];return r||console.warn(e+" is not defined"),r},r.mixPropsToExplicitProps=function(e){var t=Ms({},e);for(var r in e){var n=e[r];if(n&&this.checkIsAsset(n)){var i=this.oasis.resourceManager.get(n.id);i?t[r]=i.resource:(t[r]=null,re.warn("AbilityManager: can't get asset \""+r+'", which id is '+n.id))}}return t},r.checkIsAsset=function(e){return"asset"===e.type},t}()).prototype,"add",[Fl],Object.getOwnPropertyDescriptor(Ll.prototype,"add"),Ll.prototype),Is(Ll.prototype,"update",[El],Object.getOwnPropertyDescriptor(Ll.prototype,"update"),Ll.prototype),Is(Ll.prototype,"delete",[Rl],Object.getOwnPropertyDescriptor(Ll.prototype,"delete"),Ll.prototype),Ll),Kl=(Bl=al({after:"nodeAdded"}),Dl=al({before:"beforeNodeUpdated",after:"nodeUpdated"}),Il=al({before:"beforeNodeDeleted"}),Is((Ol=function(){function e(e){this.oasis=e,this.nodeMap={},this.root=void 0,this.root=new tt(this.oasis.engine,"root")}var t=e.prototype;return t.addRootEntity=function(){this.oasis.engine.sceneManager.activeScene.addRootEntity(this.root)},t.add=function(e){return this.create(e),this.append(e.id,e.parent,e.index),this.get(e.id)},t.update=function(e,t,r){return this.get(e)[t]=r,{id:e,key:t,value:r}},t.get=function(e){return this.nodeMap[e]},t.reset=function(){this.nodeMap={}},t.delete=function(e){this.nodeMap[e].destroy(),delete this.nodeMap[e]},t.create=function(e){var t=e.isActive,r=e.position,n=e.rotation,i=e.scale,a=e.id,s=e.name,l=new tt(this.oasis.engine,s);return l.isActive=t,l.transform.position=new o(r[0],r[1],r[2]),l.transform.rotation=new o(n[0],n[1],n[2]),l.transform.scale=new o(i[0],i[1],i[2]),l.id=a,this.nodeMap[a]=l,l},t.append=function(e,t,r){var n=this.nodeMap[e],i=this.nodeMap[t]||this.root;i.addChild(n);var a=i._children;hl(a,a.length-1,r)},e}()).prototype,"add",[Bl],Object.getOwnPropertyDescriptor(Ol.prototype,"add"),Ol.prototype),Is(Ol.prototype,"update",[Dl],Object.getOwnPropertyDescriptor(Ol.prototype,"update"),Ol.prototype),Is(Ol.prototype,"delete",[Il],Object.getOwnPropertyDescriptor(Ol.prototype,"delete"),Ol.prototype),Ol),ql=(zl=al({before:"beforeSceneUpdated",after:"sceneUpdated"}),Is((Vl=function(){function t(e){this.oasis=e}var r=t.prototype;return r.init=function(){var e=this,t=this.oasis.options.config.scene;t&&Object.keys(t).forEach((function(r){var n=t[r];Object.keys(n.props).forEach((function(t){var i=n.props[t];e.setProp(r,t,i)}))}))},r.update=function(e,t,r){return this.setProp(e,t,r),{field:e,key:t,value:r}},r.setProp=function(t,r,n){var i=this.oasis.engine.sceneManager.activeScene;if("background"===t&&"skyboxTexture"===r){var a=i.background.sky;if(n){a.mesh=mn.createCuboid(i.engine,2,2,2);var o=new So(i.engine);o.textureCubeMap=this.oasis.resourceManager.get(n.id).resource,a.material=o}else a.mesh=null,a.material=null}else if(i[t]&&"ambientLight"===t&&"specularTexture"===r)if(n&&"asset"===n.type){var s=this.oasis.resourceManager.get(n.id).resource;i.ambientLight.specularTexture=s.specularTexture,i.ambientLight.diffuseSphericalHarmonics=s.diffuseSphericalHarmonics,i.ambientLight.diffuseMode=e.DiffuseMode.SphericalHarmonics,i.ambientLight.specularTextureDecodeRGBM=!0}else i.ambientLight.specularTexture=null,i.ambientLight.diffuseMode=e.DiffuseMode.SolidColor;else i[t]&&(n&&"asset"===n.type?i[t][r]=this.oasis.resourceManager.get(n.id).resource:i[t][r]=n)},t}()).prototype,"update",[zl],Object.getOwnPropertyDescriptor(Vl.prototype,"update"),Vl.prototype),Vl),Yl=function(t){function r(){return t.apply(this,arguments)||this}Rs(r,t);var n=r.prototype;return n.load=function(t,n){var i=this;return new Promise((function(a){i.setMeta(),n.source?t.load({url:n.source,type:e.AssetType.SpriteAtlas}).then((function(e){i._resource=e;for(var t=e.sprites,r=i.resourceManager,n=t.length-1;n>=0;n--){var o=t[n],s=new Pl(r,o),l=o._assetID;r.maxId=Math.max(l,r.maxId),r.resourceMap[l]=s,r.resourceIdMap.set(s,""+l)}a(i)})):(r.defaultAtlas||(r.defaultAtlas=new ua(t.engine)),i._resource=r.defaultAtlas,a(i))}))},n.setMeta=function(){this.resource&&(this.meta.name=this.resource.name)},n.getProps=function(){var e=this,t={};return _l(this.resource).forEach((function(r){return t[r]=e.resource[r]})),t},n.update=function(){},r}(pl);Yl.defaultAtlas=void 0;var Ql={script:Al,gltf:Sl,texture:ml,cubeTexture:Hl,PBRMaterial:Tl,PBRSpecularMaterial:bl,UnlitMaterial:Cl,BlinnPhongMaterial:yl,base:Wl,sprite:Pl,SpriteAtlas:Yl,animatorController:vl,animationClip:gl,environment:jl},Jl=new Map;for(var Zl in Ql)if(Ql.hasOwnProperty(Zl)){var $l=Ql[Zl];Jl.set($l,Zl)}var eu,tu,ru=function(e,t){return new Ql[t](e)},nu=(Nl=al({before:"beforeResourceRemove"}),Ul=al({after:"resourceUpdated",before:"beforeResourceUpdate"}),Is((kl=function(){function e(e){this.oasis=e,this.resourceMap={},this.resourceIdMap=new WeakMap,this.maxId=0,this.engineResourceManager=void 0,this.engineResourceManager=this.oasis.engine.resourceManager}var t=e.prototype;return t.load=function(e){var t=this,r=ru(this,e.type),n=r.load(this.oasis.engine.resourceManager,e,this.oasis);return this.maxId=Math.max(+e.id,this.maxId),n.then((function(){t.resourceMap[e.id]=r,t.resourceIdMap.set(r,e.id)})),n},t.add=function(e){var t=this,r=ru(this,e.type);return new Promise((function(n){r.loadWithAttachedResources(t.oasis.engine.resourceManager,e,t.oasis).then((function(e){n(t.getAddResourceResult(e.resources,e.structure))}))}))},t.remove=function(e){var t=this;return new Promise((function(r){var n=t.resourceMap[e],i=[e],a=!1;if(delete t.resourceMap[e],n)for(var o=n.attachedResources,s=0;s<o.length;s++){var l=o[s],u=t.resourceIdMap.get(l);u&&(a=!0,t.remove(u).then((function(e){i.push.apply(i,e),r(i)})))}a||r(i)}))},t.update=function(e,t,r){var n=this.get(e);return n&&n.update(t,r),{resource:n,id:e,key:t,value:r}},t.updateMeta=function(e,t,r){var n=this.get(e);n&&n.updateMeta(t,r)},t.get=function(e){return this.resourceMap[e]},t.getAll=function(){return ce(this.resourceMap)},t.getAddResourceResult=function(e,t){var r=this,n={},i=e[t.index],a=""+ ++this.maxId;for(var o in this.resourceMap[a]=i,this.resourceIdMap.set(i,a),n.id=this.maxId,n.type=Jl.get(i.constructor),n.meta=i.meta,n.props={},t.props)if(t.props.hasOwnProperty(o)){var s=t.props[o];s&&(Array.isArray(s)?n.props[o]=s.map((function(t){return r.getAddResourceResult(e,t)})):n.props[o]=this.getAddResourceResult(e,s))}return n},Ps(e,[{key:"isLocal",get:function(){return this.oasis.options.local}},{key:"useCompressedTexture",get:function(){var e;return null==(e=this.oasis.options.useCompressedTexture)||e}}]),e}()).prototype,"remove",[Nl],Object.getOwnPropertyDescriptor(kl.prototype,"remove"),kl.prototype),Is(kl.prototype,"update",[Ul],Object.getOwnPropertyDescriptor(kl.prototype,"update"),kl.prototype),kl),iu=(eu=al({after:"schemaParsed"}),Is((tu=function(e){function t(t,r){var n,i;return(i=e.call(this)||this)._options=t,i.pluginManager=r,i.nodeManager=void 0,i.abilityManager=void 0,i.sceneManager=void 0,i.resourceManager=void 0,i._canvas=void 0,i.schema=void 0,i.timeout=void 0,i.oasis=Bs(i),i.engine=void 0,i.engine=t.engine,i.schema=t.config,i.timeout=t.timeout,t.scripts=null!=(n=t.scripts)?n:{},i.nodeManager=new Kl(Bs(i)),i.abilityManager=new Xl(Bs(i)),i.nodeManager.add=i.nodeManager.add.bind(i.nodeManager),i.abilityManager.add=i.abilityManager.add.bind(i.abilityManager),i.resourceManager=new nu(Bs(i)),i.sceneManager=new ql(Bs(i)),t.fps&&(i.engine.targetFrameRate=t.fps,i.engine.vSyncCount=0),i}Rs(t,e);var r=t.prototype;return r.updateConfig=function(e){this.schema=e,this.init()},r.init=function(){var e=this;return this.loadResources().then((function(){e.bindResources(),e.parseEntities(),e.attach(),e.nodeManager.addRootEntity(),e.sceneManager.init(),e.parseNodeAbilities(),e.pluginManager.boot(e)}))},r.loadResources=function(){var e=this,t=this.schema.assets,r=ce(void 0===t?{}:t).filter((function(e){return!!Ql[e.type]||(console.warn(e.type+" loader is not defined. the "+e.type+" type will be ignored."),!1)})).map((function(t){return e.resourceManager.load(t)}));return Promise.all(r)},r.bindResources=function(){this.resourceManager.getAll().forEach((function(e){e.bind()}))},r.parseEntities=function(){var e=this.schema.nodes;this.bfsNodes().map((function(t){return e[t]})).forEach(this.nodeManager.add)},r.parseNodeAbilities=function(){var e=this.schema.abilities;Object.keys(e).map((function(t){return Ms({id:t},e[t])})).forEach(this.abilityManager.add)},r.bfsNodes=function(){var e=this.schema.nodes,t=ce(e).filter((function(t){return!e[t.parent]})).map((function(e){return e.id})),r=[];return function t(n){r=r.concat(n),n.forEach((function(r){var n=e[r].children;n&&t(n)}))}(t),r},r.attach=function(){this.resourceManager.getAll().forEach((function(e){e.attach()}))},t.create=function(e,r){var n=new t(e,r);return n.init().then((function(){return e.autoPlay&&n.engine.run(),n}))},Ps(t,[{key:"canvas",get:function(){return this._options.canvas}},{key:"options",get:function(){return this._options}}]),t}(ye)).prototype,"init",[eu],Object.getOwnPropertyDescriptor(tu.prototype,"init"),tu.prototype),tu);ul.registerComponents("o3",{GLTFModel:rl,SpriteRenderer:da,SpriteMask:Ir,TextRenderer:Va,PointLight:Dn,AmbientLight:En,DirectLight:Bn,ParticleRenderer:Mo,Camera:Si,Model:nl,Component:Je,StaticCollider:Tt,DynamicCollider:wt,Animator:_o});var au="0.7.0-beta.2";console.log("oasis engine version: "+au),e.AmbientLight=En,e.AnimationClip=ja,e.AnimationClipCurveBinding=Ua,e.AnimationCurve=xo,e.AnimationEvent=ka,e.Animator=_o,e.AnimatorController=fo,e.AnimatorControllerLayer=po,e.AnimatorState=vo,e.AnimatorStateMachine=mo,e.AnimatorStateTransition=Qa,e.AssetPromise=he,e.Background=Fn,e.BaseMaterial=Oi,e.BasicRenderPipeline=bi,e.BlendShape=Tn,e.BlendShapeFrame=xn,e.BlinnPhongMaterial=zi,e.BoundingBox=l,e.BoundingFrustum=h,e.BoundingSphere=s,e.BoxColliderShape=gt,e.Buffer=kr,e.BufferMesh=yn,e.BufferUtil=Vr,e.Camera=Si,e.CapsuleColliderShape=yt,e.CloneManager=q,e.Collider=xt,e.ColliderShape=ct,e.CollisionUtil=u,e.Color=T,e.Component=Je,e.CubeProbe=zo,e.DirectLight=Bn,e.DynamicCollider=wt,e.EXP2Fog=Ro,e.Engine=Wn,e.EngineFeature=ri,e.EngineObject=Y,e.Entity=tt,e.Event=me,e.EventDispatcher=ye,e.Fog=Eo,e.Font=_a,e.GLTFModel=rl,e.GLTFResource=Ys,e.HitResult=st,e.IndexBufferBinding=Wr,e.InputManager=Pt,e.InterpolableKeyframe=wo,e.Keyframe=To,e.Light=Ln,e.LinearFog=Lo,e.Loader=Ii,e.Logger=re,e.Material=gr,e.MathUtil=a,e.Matrix=f,e.Matrix3x3=d,e.Mesh=Xr,e.MeshRenderer=gn,e.Model=nl,e.ModelMesh=en,e.Oasis=iu,e.ObjectValues=ce,e.PBRBaseMaterial=Vi,e.PBRMaterial=Ni,e.PBRSpecularMaterial=Ui,e.Parser=ul,e.ParticleRenderer=Mo,e.PhysicsManager=lt,e.PhysicsMaterial=ut,e.Plane=c,e.PlaneColliderShape=mt,e.PointLight=Dn,e.Pointer=Ct,e.PrimitiveMesh=mn,e.Probe=Bo,e.Quaternion=_,e.Ray=p,e.Rect=w,e.RefObject=Q,e.RenderElement=yr,e.RenderPass=ai,e.RenderQueue=wi,e.RenderTarget=Qr,e.Renderer=Rr,e.ResourceManager=de,e.Scene=zn,e.SceneFeature=Rn,e.SceneManager=Vn,e.SchemaResource=pl,e.Script=ni,e.Shader=zt,e.ShaderData=kt,e.ShaderFactory=Rt,e.Skin=pn,e.SkinnedMeshRenderer=vn,e.Sky=Pn,e.SkyBoxMaterial=So,e.SphereColliderShape=vt,e.SphericalHarmonics3=b,e.SpotLight=In,e.Sprite=ca,e.SpriteAtlas=ua,e.SpriteElement=xr,e.SpriteMask=Ir,e.SpriteRenderer=da,e.StateMachineScript=go,e.StaticCollider=Tt,e.SubMesh=jr,e.SystemInfo=ti,e.TextRenderer=Va,e.Texture=ne,e.Texture2D=ie,e.Texture2DArray=Jr,e.TextureCube=Zr,e.Time=xe,e.TrailMaterial=Ao,e.TrailRenderer=Fo,e.Transform=$e,e.UnlitMaterial=ji,e.UpdateFlag=Ye,e.Util=le,e.Vector2=g,e.Vector3=o,e.Vector4=v,e.VertexBufferBinding=Kr,e.VertexElement=Nr,e.WebCanvas=Zo,e.WebGLEngine=us,e.WebGLRenderer=ls,e.assignmentClone=k,e.deepClone=H,e.dependencies=Ae,e.ignoreClone=U,e.parseSingleKTX=Zs,e.parser=cl,e.registerResource=function(e,t){Ql.hasOwnProperty(e)||(Ql[e]=t,Jl.set(t,e))},e.request=Ai,e.resourceLoader=_e,e.script=function(e){return function(t){Ml[e]=t}},e.shallowClone=G,e.version=au,Object.defineProperty(e,"__esModule",{value:!0})}(t)}}]);